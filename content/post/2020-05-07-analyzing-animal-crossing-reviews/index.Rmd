---
title: Analyzing Animal Crossing Reviews
author: Qiushi Yan
date: '2020-05-07'
categories:
  - Data Analysis
  - Machine Learning
  - R
tags: []
subtitle: ''
draft: yes
image:
  caption: ''
  focal_point: ''
  preview_only: yes
---

Our modeling goal is to predict the rating for the life simulation video game, Animal Crossing, from its user reviews. The data comes from [this weeks's `#TidyTuesday`](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-05-05/readme.md), scraped from [VillagerDB](https://github.com/jefflomacy/villagerdb) and [Metacritic](https://www.metacritic.com/game/switch/animal-crossing-new-horizons/critic-reviews). 

```{r, echo = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, 
                      comment = "#>", collapse = TRUE)
```

```{r}
library(tidyverse)
library(tidytext)
set.seed(2020)
```

```{r, echo = FALSE}
theme_bar <- function(base_size = 12,
                      strip_text_size = 14,
                      strip_text_margin = 5,
                      subtitle_size = 14,
                      subtitle_margin = 10,
                      plot_title_size = 18,
                      plot_title_margin = 10,
                      ...) {
  ret <- ggplot2::theme_minimal(base_size = base_size, ...)
  ret$strip.text <- ggplot2::element_text(
    hjust = 0, size = strip_text_size,
    margin = ggplot2::margin(b = strip_text_margin)
  )
  ret$plot.subtitle <- ggplot2::element_text(
    hjust = 0, size = subtitle_size,
    margin = ggplot2::margin(b = subtitle_margin)
  )
  ret$plot.title <- ggplot2::element_text(
    hjust = 0, size = plot_title_size,
    margin = ggplot2::margin(b = plot_title_margin)
  )
  ret
}

theme_set(theme_bar())
```


# EDA and data cleaning

The reviews data contains four columns:

- `grade`: 0-100 score given by the critic (missing for some) where higher score = better.
- `user_name`: user name of the reviewer
- `text`: review of the reviewer
- `date`: when the review is published

```{r}
reviews <- readr::read_tsv("D:/RProjects/data/blog/animal-crossing-reviews.tsv")
glimpse(reviews)
```


 


An bar plot of all grades show a bimodal distribution. This is perhaps not that astonishing when it comes to reviewing, since people tend to go to extremes and give polarized opinions. This may suggest that we cut `grades` into discrete levels and build a classification model afterwards, rather than modeling bare grades itself with regression models. 
```{r}
reviews %>% 
  count(grade) %>% 
  ggplot() + 
  geom_col(aes(x = factor(grade), 
               y = n),
           fill = "midnightblue", alpha = 0.6) + 
  labs(x = "grade", y = NULL)
```


The data is messy in several ways (I have chosen 3 lines for example):  

- Review contains repetition. the following review where the first 4.5 lines are repeated in the following lines

___

"While the game itself is great, really relaxing and gorgeous, i can't ignore one thing that ruins the whole experience for me and a lot of other people as seen by the different user reviews.That thing is that you only have 1 island per console. This decision limits to one person being able to enjoy the full experience. It also nukes any creative control of the island, since you haveWhile the game itself is great, really relaxing and gorgeous, i can't ignore one thing that ruins the whole experience for me and a lot of other people as seen by the different user reviews.That thing is that you only have 1 island per console. This decision limits to one person being able to enjoy the full experience. It also nukes any creative control of the island, since you have the other usershouse and furniture. I hope nintendo can soon fix this big issue, because for now, this killed any intentions i had to play the game.… Expand"   
___


- Reviews that exceed certian length are incomplete and end with "Expand". The following review also contains repeated lines.

___

"One island per console is a design decision that is, at best, in poor taste, and at worst, straight-up predatory behavior.Per console, only one player gets to experience the game at its fullest. The other players see less dialogue, experience less events, and are locked out entirely from certain parts of the game.No matter how good a game is, I cannot stand behind a company thatOne island per console is a design decision that is, at best, in poor taste, and at worst, straight-up predatory behavior.Per console, only one player gets to experience the game at its fullest. The other players see less dialogue, experience less events, and are locked out entirely from certain parts of the game.No matter how good a game is, I cannot stand behind a company that sees fit to make such decisions.… Expand" 

___

- non-English reviews

___

"Una sola isla , es un asco . No puedes seguir avanzando, solo te queda recoger madera"  
___


I use regular expressions to remove reptitions and "Expand" at the end. Repetitions happen when the review is long, and the repetition part often takes up 4 to 5 lines (here I use 350 or more characters to indicate the repetition part). 

`clr::detect_language` is used to exclude non-English text. This a R wrapper around Google's Compact Language Detector 3, a neural network model for language identification . There will be misclassifications, though. As the proportion of exclusion is fairly low, we're OK.  

```{r}
library(cld3)
reviews %>% 
  mutate(language = detect_language(text)) %>% 
  count(language, sort = TRUE)
```



```{r}
reviews_en <- reviews %>% 
  filter(detect_language(text) == "en")


repetition_clean <- reviews %>% 
  filter(str_detect(text, "(.{350,})\\1.+")) %>% 
  mutate(text = str_replace(text, "(.{350,})\\1(.+)Expand$", "\\1\\2"))

reviews_clean <- anti_join(reviews_en, repetition_clean, 
                           by = c("user_name" = "user_name")) %>% 
  bind_rows(repetition_clean)

# draw some sample reviews
reviews_clean %>% 
  sample_n(3) %>% 
  pull(text)
```

We can examine how this cleaning process works by comparing the distribution of review length, before and after. The cleaning should reduce the amount of medium long and long reviews, in exchange for shorter ones.
```{r}
reviews %>%
  transmute(length = str_length(text),
            type = "before") %>% 
  bind_rows(reviews_clean %>%
              transmute(length = str_length(text), type = "after")) %>%
  ggplot() + 
  geom_density(aes(length, fill = type), alpha = 0.2) + 
  scale_fill_discrete(name = NULL) + 
  labs(title = "Distribution of review length before and after cleaning",
       x = NULL,
       y = NULL)
```

# Sentiment analysis of user reviews

# Predictive modeling for grades with user reviews  

```{r}

reviews %>% 
  transmute(rating = case_when(
    grade <= 4 ~ "low",
    grade > 4 & grade <= 8 ~ "medium",
    grade > 8 ~ "high",
  ),
  text) %>% 
  unnest_tokens(line, text, token = "lines") 
```



