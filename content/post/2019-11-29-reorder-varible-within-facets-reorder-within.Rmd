---
title: 'Reorder within facets: reorder_within'
author: Qiushi Yan
date: '2019-11-29'
slug: reorder-varible-within-facets-reorder-within
categories:
  - R
tags:
  - ggplot2
subtitle: ''
summary: ''
authors: []
lastmod: '2019-11-29T21:38:24+08:00'
featured: no
bibliography: bib/reorder-within.bib
biblio-style: apalike
link-citations: yes
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

This blog post is inspired by Julia Silge's [
Reordering and facetting for ggplot2
](https://juliasilge.com/blog/reorder-within/). By reproducing the original post using another different dataset, I hope this could still shed some light on a handful of ggplot2 tips.   

## Most common words in Jane Austen's books  

```{r,echo=F}
knitr::opts_chunk$set(message=F,fig.height=10,fig.asp=1)
```

Here is a simple task: we want to find the top-10 most common words in several Jane Austen's books, draw a bar graph, and then put them into different facets.  

```{r}
# load package
library(tidyverse)
library(tidytext)
library(janeaustenr)

austen_books()
```

Note that the raw data generated by calling `austen_books()`, provided in the **janeaustenr** package [@R-janeaustenr], is not in its most sensible format for analysis. Since each row is made up of multiple combined words.  


Here we use `unnest_tokens` from the **tidytext** package [@R-tidytext] to break the text into individual tokens and transform it into a tidy structure:  

```{r}
# calculate 10 most common words in each book
common_words <- austen_books() %>%
  unnest_tokens(word, text) %>% 
  anti_join(stop_words) %>% 
  count(book, word) %>% 
  group_by(book) %>% 
  top_n(10)
```

Take a look at our prepared data:  
```{r}
common_words
```

For details many and other useful text mining techniques in R, I recommend reading [Text mining with R: A tidy approach](Text Mining with R: A tidy approach) by Julia Silge and David Robinson[-@silge2017text].  

```{r}
# plot
common_words %>% 
  ggplot(aes(word, n, fill = book)) +
  geom_col() + 
  coord_flip() + 
  facet_wrap(~ book, ncol = 2, scales = "free_y") + 
  theme_classic() + 
  theme(legend.position = "none", 
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 14)) +
  rcartocolor::scale_fill_carto_d(palette = "PurpOr")
```

In its default setting, **ggplot2** puts the names in alphabetical order, because they are of type character.  One common solution is to use `fct_reorder()` or its equivalent `reorder()` in baes R`:  

```{r}
common_words %>% 
  ggplot(aes(fct_reorder(word, n), n, fill = book)) +
  geom_col() + 
  coord_flip() + 
  facet_wrap(~ book, ncol = 2, scales = "free_y") + 
  theme_classic() + 
  theme(legend.position = "none", 
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 14)) +
  rcartocolor::scale_fill_carto_d(palette = "PurpOr")
```

Well, our plot improve a bit, but is still wanting in some respects. In each facet, the order of words is not strictly in line with its frequency. In fact, `fct_reorder()` or `reorder` only reorder all of these together, meaning that `word` are reordered in an overall level so that it cannot guarantee order in any specific subset of data.  

## `reorder_within()` and `scale_x_reordered()`  

The **tidytext** package provides 2 new functions to reorder a variable on a facet level.

`reorder_within()` takes three arguments:
- **x**: the item we want to reorder
- **by**: what we want to reorder by
- **within**: the groups or categories we want to reorder within

After that, we use `scale_x_reordered()`(or `scale_y_reordered()`) to finish the plot, these 2 scales can take any argument in common scale functions(e.g., **name**, **labels**, **expand**).

Here is a final plot:  
```{r}
# reorder word by n, grouped by book
common_words %>% 
  ggplot(aes(reorder_within(word, n, book), n, fill = book)) +
  geom_col() + 
  coord_flip() + 
  scale_x_reordered() + 
  facet_wrap(~ book, ncol = 2, scales = "free_y") + 
  theme_classic() + 
  theme(legend.position = "none", 
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 14)) +
  rcartocolor::scale_fill_carto_d(palette = "PurpOr") +
  labs(title = "What are the most common words in Jane Austen's books?",
       x = NULL,
       y = NULL)
```


Without using `scale_x_reordered` to overide ggplot2's default scale, the label of the reordered variable will carry a suffix related to the group variable, which make its label way too long. Here is an simple example using the [babynames](https://github.com/hadley/babynames) data: 

```{r}
library(babynames)

top_names <- babynames %>% 
  filter(year >= 1950,
           year < 1990) %>% 
  mutate(decade = (year %/% 10) * 10) %>% 
  group_by(decade) %>%
  count(name, wt = n) %>% 
  group_by(decade) %>% 
  top_n(10)

top_names %>% 
  ggplot(aes(reorder_within(name, n, decade), n, fill = factor(decade))) + 
  geom_col() + 
  coord_flip() + 
  facet_wrap(~ decade, scales = "free_y") + 
  theme(legend.position = "none") + 
  labs(x = NULL, y = NULL)
```






## References  

Nowosad, J. (2018). 'CARTOColors' Palettes. R package version 1.0.0. https://nowosad.github.io/rcartocolor