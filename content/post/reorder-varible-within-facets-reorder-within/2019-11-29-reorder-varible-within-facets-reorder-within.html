---
title: 'Reorder within facets: reorder_within'
author: Qiushi Yan
date: '2019-11-29'
slug: reorder-varible-within-facets-reorder-within
categories:
  - R

image:
  placement: 2
  focal_point: ""
  preview_only: true

summary: '{ggetxt} provides graphing helpers to reorder an x or y axis within facets.'
lastmod: '2020-04-05T21:38:24+08:00'
bibliography: ../bib/reorder-within.bib
biblio-style: apalike
link-citations: yes
---



<p>This blog post is inspired by Julia Silge’s <a href="https://juliasilge.com/blog/reorder-within/">Reordering and facetting for ggplot2</a>. By reproducing the original post using another different dataset, I hope this could still shed some light on a handful of ggplot2 tips.</p>
<div id="most-common-words-in-jane-austens-books" class="section level2">
<h2>Most common words in Jane Austen’s books</h2>
<p>Here is a simple task: we want to find the top-10 most common words in several Jane Austen’s books, draw a bar graph, and then put them into different facets.</p>
<pre class="r"><code># load package
library(tidyverse)
library(tidytext)
library(janeaustenr)</code></pre>
<pre class="r"><code>austen_books()
#&gt; # A tibble: 73,422 x 2
#&gt;    text                    book               
#&gt;  * &lt;chr&gt;                   &lt;fct&gt;              
#&gt;  1 &quot;SENSE AND SENSIBILITY&quot; Sense &amp; Sensibility
#&gt;  2 &quot;&quot;                      Sense &amp; Sensibility
#&gt;  3 &quot;by Jane Austen&quot;        Sense &amp; Sensibility
#&gt;  4 &quot;&quot;                      Sense &amp; Sensibility
#&gt;  5 &quot;(1811)&quot;                Sense &amp; Sensibility
#&gt;  6 &quot;&quot;                      Sense &amp; Sensibility
#&gt;  7 &quot;&quot;                      Sense &amp; Sensibility
#&gt;  8 &quot;&quot;                      Sense &amp; Sensibility
#&gt;  9 &quot;&quot;                      Sense &amp; Sensibility
#&gt; 10 &quot;CHAPTER 1&quot;             Sense &amp; Sensibility
#&gt; # ... with 73,412 more rows</code></pre>
<p>Note that the raw data generated by calling <code>austen_books()</code>, provided in the <strong>janeaustenr</strong> package <span class="citation">(Silge <a href="#ref-R-janeaustenr" role="doc-biblioref">2017</a>)</span>, is not in its most sensible format for analysis. Since each row is made up of multiple combined words.</p>
<p>Here we use <code>unnest_tokens</code> from the <strong>tidytext</strong> package <span class="citation">(Robinson and Silge <a href="#ref-R-tidytext" role="doc-biblioref">2019</a>)</span> to break the text into individual tokens and transform it into a tidy structure:</p>
<pre class="r"><code># calculate 10 most common words in each book
common_words &lt;- austen_books() %&gt;%
  unnest_tokens(word, text) %&gt;% 
  anti_join(stop_words) %&gt;% 
  count(book, word) %&gt;% 
  group_by(book) %&gt;% 
  top_n(10)</code></pre>
<p>Take a look at our prepared data:</p>
<pre class="r"><code>common_words
#&gt; # A tibble: 60 x 3
#&gt; # Groups:   book [6]
#&gt;    book                word           n
#&gt;    &lt;fct&gt;               &lt;chr&gt;      &lt;int&gt;
#&gt;  1 Sense &amp; Sensibility dashwood     231
#&gt;  2 Sense &amp; Sensibility edward       220
#&gt;  3 Sense &amp; Sensibility elinor       623
#&gt;  4 Sense &amp; Sensibility jennings     199
#&gt;  5 Sense &amp; Sensibility marianne     492
#&gt;  6 Sense &amp; Sensibility miss         210
#&gt;  7 Sense &amp; Sensibility mother       213
#&gt;  8 Sense &amp; Sensibility sister       229
#&gt;  9 Sense &amp; Sensibility time         239
#&gt; 10 Sense &amp; Sensibility willoughby   181
#&gt; # ... with 50 more rows</code></pre>
<p>For details many and other useful text mining techniques in R, I recommend reading <a href="Text%20Mining%20with%20R:%20A%20tidy%20approach">Text mining with R: A tidy approach</a> by Julia Silge and David Robinson<span class="citation">(<a href="#ref-silge2017text" role="doc-biblioref">2017</a>)</span>.</p>
<pre class="r"><code># plot
common_words %&gt;% 
  ggplot(aes(word, n, fill = book)) +
  geom_col() + 
  coord_flip() + 
  facet_wrap(~ book, ncol = 2, scales = &quot;free_y&quot;) + 
  theme_classic() + 
  theme(legend.position = &quot;none&quot;, 
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 14)) +
  rcartocolor::scale_fill_carto_d(palette = &quot;PurpOr&quot;)</code></pre>
<p><img src="/post/reorder-varible-within-facets-reorder-within/2019-11-29-reorder-varible-within-facets-reorder-within_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>In its default setting, <strong>ggplot2</strong> puts the names in alphabetical order, because they are of type character. One common solution is to use <code>fct_reorder()</code> or its equivalent <code>reorder()</code> in baes R`:</p>
<pre class="r"><code>common_words %&gt;% 
  ggplot(aes(fct_reorder(word, n), n, fill = book)) +
  geom_col() + 
  coord_flip() + 
  facet_wrap(~ book, ncol = 2, scales = &quot;free_y&quot;) + 
  theme_classic() + 
  theme(legend.position = &quot;none&quot;, 
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 14)) +
  rcartocolor::scale_fill_carto_d(palette = &quot;PurpOr&quot;)</code></pre>
<p><img src="/post/reorder-varible-within-facets-reorder-within/2019-11-29-reorder-varible-within-facets-reorder-within_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Well, our plot improve a bit, but is still wanting in some respects. In each facet, the order of words is not strictly in line with its frequency. In fact, <code>fct_reorder()</code> or <code>reorder</code> only reorder all of these together, meaning that <code>word</code> are reordered in an overall level so that it cannot guarantee order in any specific subset of data.</p>
</div>
<div id="reorder_within-and-scale_x_reordered" class="section level2">
<h2><code>reorder_within()</code> and <code>scale_x_reordered()</code></h2>
<p>The <strong>tidytext</strong> package provides 2 new functions to reorder a variable on a facet level.</p>
<p><code>reorder_within()</code> takes three arguments:
- <strong>x</strong>: the item we want to reorder
- <strong>by</strong>: what we want to reorder by
- <strong>within</strong>: the groups or categories we want to reorder within</p>
<p>After that, we use <code>scale_x_reordered()</code>(or <code>scale_y_reordered()</code>) to finish the plot, these 2 scales can take any argument in common scale functions(e.g., <strong>name</strong>, <strong>labels</strong>, <strong>expand</strong>).</p>
<p>Here is a final plot:</p>
<pre class="r"><code># reorder word by n, grouped by book
common_words %&gt;% 
  ggplot(aes(reorder_within(word, n, book), n, fill = book)) +
  geom_col() + 
  coord_flip() + 
  scale_x_reordered() + 
  facet_wrap(~ book, ncol = 2, scales = &quot;free_y&quot;) + 
  theme_classic() + 
  theme(legend.position = &quot;none&quot;, 
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 14)) +
  rcartocolor::scale_fill_carto_d(palette = &quot;PurpOr&quot;) +
  labs(title = &quot;What are the most common words in Jane Austen&#39;s books?&quot;,
       x = NULL,
       y = NULL)</code></pre>
<p><img src="/post/reorder-varible-within-facets-reorder-within/2019-11-29-reorder-varible-within-facets-reorder-within_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>Without using <code>scale_x_reordered</code> to overide ggplot2’s default scale, the label of the reordered variable will carry a suffix related to the group variable, which make its label way too long. Here is an simple example using the <a href="https://github.com/hadley/babynames">babynames</a> data:</p>
<pre class="r"><code>library(babynames)</code></pre>
<pre class="r"><code>top_names &lt;- babynames %&gt;% 
  filter(year &gt;= 1950,
           year &lt; 1990) %&gt;% 
  mutate(decade = (year %/% 10) * 10) %&gt;% 
  group_by(decade) %&gt;%
  count(name, wt = n) %&gt;% 
  group_by(decade) %&gt;% 
  top_n(10)

top_names %&gt;% 
  ggplot(aes(reorder_within(name, n, decade), n, fill = factor(decade))) + 
  geom_col() + 
  coord_flip() + 
  facet_wrap(~ decade, scales = &quot;free_y&quot;) + 
  theme(legend.position = &quot;none&quot;) + 
  labs(x = NULL, y = NULL)</code></pre>
<p><img src="/post/reorder-varible-within-facets-reorder-within/2019-11-29-reorder-varible-within-facets-reorder-within_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<p>Nowosad, J. (2018). ‘CARTOColors’ Palettes. R package version 1.0.0. <a href="https://nowosad.github.io/rcartocolor" class="uri">https://nowosad.github.io/rcartocolor</a></p>
<div id="refs" class="references">
<div id="ref-R-tidytext">
<p>Robinson, David, and Julia Silge. 2019. <em>Tidytext: Text Mining Using ’Dplyr’, ’Ggplot2’, and Other Tidy Tools</em>. <a href="https://CRAN.R-project.org/package=tidytext">https://CRAN.R-project.org/package=tidytext</a>.</p>
</div>
<div id="ref-R-janeaustenr">
<p>Silge, Julia. 2017. <em>Janeaustenr: Jane Austen’s Complete Novels</em>. <a href="https://CRAN.R-project.org/package=janeaustenr">https://CRAN.R-project.org/package=janeaustenr</a>.</p>
</div>
<div id="ref-silge2017text">
<p>Silge, Julia, and David Robinson. 2017. <em>Text Mining with R: A Tidy Approach</em>. " O’Reilly Media, Inc.".</p>
</div>
</div>
</div>
