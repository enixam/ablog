<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>1 dplyr | R for data science: tidyverse and beyond</title>
  <meta name="description" content="1 dplyr | R for data science: tidyverse and beyond" />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="1 dplyr | R for data science: tidyverse and beyond" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="enixam/rfordatascience" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="1 dplyr | R for data science: tidyverse and beyond" />
  
  
  

<meta name="author" content="Maxine" />


<meta name="date" content="2020-01-07" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="tibble.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css\style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R4DS: tidyverse and beyond</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>前言</a></li>
<li class="part"><span><b>I R for data science</b></span></li>
<li class="chapter" data-level="1" data-path="dplyr.html"><a href="dplyr.html"><i class="fa fa-check"></i><b>1</b> dplyr</a><ul>
<li class="chapter" data-level="1.1" data-path="dplyr.html"><a href="dplyr.html#个数据转换核心函数"><i class="fa fa-check"></i><b>1.1</b> 5个数据转换核心函数</a></li>
<li class="chapter" data-level="1.2" data-path="dplyr.html"><a href="dplyr.html#filter筛选行"><i class="fa fa-check"></i><b>1.2</b> <code>filter()</code>筛选行</a><ul>
<li class="chapter" data-level="1.2.1" data-path="dplyr.html"><a href="dplyr.html#运算符"><i class="fa fa-check"></i><b>1.2.1</b> 运算符</a></li>
<li class="chapter" data-level="1.2.2" data-path="dplyr.html"><a href="dplyr.html#缺失值"><i class="fa fa-check"></i><b>1.2.2</b> 缺失值</a></li>
<li class="chapter" data-level="1.2.3" data-path="dplyr.html"><a href="dplyr.html#练习"><i class="fa fa-check"></i><b>1.2.3</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="dplyr.html"><a href="dplyr.html#arrange-排列行"><i class="fa fa-check"></i><b>1.3</b> <code>arrange()</code> 排列行</a><ul>
<li class="chapter" data-level="1.3.1" data-path="dplyr.html"><a href="dplyr.html#slice"><i class="fa fa-check"></i><b>1.3.1</b> <code>slice()</code></a></li>
<li class="chapter" data-level="1.3.2" data-path="dplyr.html"><a href="dplyr.html#练习-1"><i class="fa fa-check"></i><b>1.3.2</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="dplyr.html"><a href="dplyr.html#使用select选择列"><i class="fa fa-check"></i><b>1.4</b> 使用<code>select()</code>选择列</a><ul>
<li class="chapter" data-level="1.4.1" data-path="dplyr.html"><a href="dplyr.html#练习-2"><i class="fa fa-check"></i><b>1.4.1</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="dplyr.html"><a href="dplyr.html#mutate-创建变量"><i class="fa fa-check"></i><b>1.5</b> <code>mutate()</code> 创建变量</a><ul>
<li class="chapter" data-level="1.5.1" data-path="dplyr.html"><a href="dplyr.html#常用创建函数using-creation-functions"><i class="fa fa-check"></i><b>1.5.1</b> 常用创建函数（Using creation functions）</a></li>
<li class="chapter" data-level="1.5.2" data-path="dplyr.html"><a href="dplyr.html#练习-3"><i class="fa fa-check"></i><b>1.5.2</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="dplyr.html"><a href="dplyr.html#使用summarize进行分组摘要"><i class="fa fa-check"></i><b>1.6</b> 使用<code>summarize()</code>进行分组摘要</a><ul>
<li class="chapter" data-level="1.6.1" data-path="dplyr.html"><a href="dplyr.html#缺失值-1"><i class="fa fa-check"></i><b>1.6.1</b> 缺失值</a></li>
<li class="chapter" data-level="1.6.2" data-path="dplyr.html"><a href="dplyr.html#计数函数"><i class="fa fa-check"></i><b>1.6.2</b> 计数函数</a></li>
<li class="chapter" data-level="1.6.3" data-path="dplyr.html"><a href="dplyr.html#逻辑值的计数和比例sumx-10-和-meany-0"><i class="fa fa-check"></i><b>1.6.3</b> 逻辑值的计数和比例:<code>sum(x &gt; 10) 和 mean(y == 0)</code></a></li>
<li class="chapter" data-level="1.6.4" data-path="dplyr.html"><a href="dplyr.html#其他常用的摘要函数"><i class="fa fa-check"></i><b>1.6.4</b> 其他常用的摘要函数</a></li>
<li class="chapter" data-level="1.6.5" data-path="dplyr.html"><a href="dplyr.html#多个分组变量的消耗"><i class="fa fa-check"></i><b>1.6.5</b> 多个分组变量的消耗</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="dplyr.html"><a href="dplyr.html#group_by-结合其他函数"><i class="fa fa-check"></i><b>1.7</b> <code>group_by()</code> 结合其他函数</a></li>
<li class="chapter" data-level="1.8" data-path="dplyr.html"><a href="dplyr.html#练习-4"><i class="fa fa-check"></i><b>1.8</b> 练习</a></li>
<li class="chapter" data-level="1.9" data-path="dplyr.html"><a href="dplyr.html#作用域"><i class="fa fa-check"></i><b>1.9</b> 作用域</a><ul>
<li class="chapter" data-level="1.9.1" data-path="dplyr.html"><a href="dplyr.html#arrange"><i class="fa fa-check"></i><b>1.9.1</b> <code>arrange()</code></a></li>
<li class="chapter" data-level="1.9.2" data-path="dplyr.html"><a href="dplyr.html#mutate"><i class="fa fa-check"></i><b>1.9.2</b> <code>mutate()</code></a></li>
<li class="chapter" data-level="1.9.3" data-path="dplyr.html"><a href="dplyr.html#summarize"><i class="fa fa-check"></i><b>1.9.3</b> <code>summarize()</code></a></li>
<li class="chapter" data-level="1.9.4" data-path="dplyr.html"><a href="dplyr.html#dance"><i class="fa fa-check"></i><b>1.9.4</b> dance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="tibble.html"><a href="tibble.html"><i class="fa fa-check"></i><b>2</b> tibble</a><ul>
<li class="chapter" data-level="2.1" data-path="tibble.html"><a href="tibble.html#tibble-intro"><i class="fa fa-check"></i><b>2.1</b> 简介</a></li>
<li class="chapter" data-level="2.2" data-path="tibble.html"><a href="tibble.html#tibble-data.frame"><i class="fa fa-check"></i><b>2.2</b> 对比 tibble 和 data.frame</a><ul>
<li class="chapter" data-level="2.2.1" data-path="tibble.html"><a href="tibble.html#创建"><i class="fa fa-check"></i><b>2.2.1</b> 创建</a></li>
<li class="chapter" data-level="2.2.2" data-path="tibble.html"><a href="tibble.html#打印"><i class="fa fa-check"></i><b>2.2.2</b> 打印</a></li>
<li class="chapter" data-level="2.2.3" data-path="tibble.html"><a href="tibble.html#取子集"><i class="fa fa-check"></i><b>2.2.3</b> 取子集</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="tibble.html"><a href="tibble.html#tibble-exercise"><i class="fa fa-check"></i><b>2.3</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="readr.html"><a href="readr.html"><i class="fa fa-check"></i><b>3</b> readr</a><ul>
<li class="chapter" data-level="3.1" data-path="readr.html"><a href="readr.html#base-r-中的数据读取"><i class="fa fa-check"></i><b>3.1</b> base R 中的数据读取</a></li>
<li class="chapter" data-level="3.2" data-path="readr.html"><a href="readr.html#readr-简介"><i class="fa fa-check"></i><b>3.2</b> readr 简介</a><ul>
<li class="chapter" data-level="3.2.1" data-path="readr.html"><a href="readr.html#写入文件"><i class="fa fa-check"></i><b>3.2.1</b> 写入文件</a></li>
<li class="chapter" data-level="3.2.2" data-path="readr.html"><a href="readr.html#练习-5"><i class="fa fa-check"></i><b>3.2.2</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="readr.html"><a href="readr.html#解析向量parsing-a-vector"><i class="fa fa-check"></i><b>3.3</b> 解析向量(Parsing a vector)</a><ul>
<li class="chapter" data-level="3.3.1" data-path="readr.html"><a href="readr.html#数值"><i class="fa fa-check"></i><b>3.3.1</b> 数值</a></li>
<li class="chapter" data-level="3.3.2" data-path="readr.html"><a href="readr.html#字符串"><i class="fa fa-check"></i><b>3.3.2</b> 字符串</a></li>
<li class="chapter" data-level="3.3.3" data-path="readr.html"><a href="readr.html#因子"><i class="fa fa-check"></i><b>3.3.3</b> 因子</a></li>
<li class="chapter" data-level="3.3.4" data-path="readr.html"><a href="readr.html#日期时间日期时间"><i class="fa fa-check"></i><b>3.3.4</b> 日期时间、日期、时间</a></li>
<li class="chapter" data-level="3.3.5" data-path="readr.html"><a href="readr.html#练习-6"><i class="fa fa-check"></i><b>3.3.5</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="readr.html"><a href="readr.html#解析文件"><i class="fa fa-check"></i><b>3.4</b> 解析文件</a><ul>
<li class="chapter" data-level="3.4.1" data-path="readr.html"><a href="readr.html#解析策略strategies"><i class="fa fa-check"></i><b>3.4.1</b> 解析策略(strategies)</a></li>
<li class="chapter" data-level="3.4.2" data-path="readr.html"><a href="readr.html#可能遇到的问题"><i class="fa fa-check"></i><b>3.4.2</b> 可能遇到的问题</a></li>
<li class="chapter" data-level="3.4.3" data-path="readr.html"><a href="readr.html#其他技巧"><i class="fa fa-check"></i><b>3.4.3</b> 其他技巧</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="readr.html"><a href="readr.html#readxl"><i class="fa fa-check"></i><b>3.5</b> readxl</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="lubridate.html"><a href="lubridate.html"><i class="fa fa-check"></i><b>4</b> lubridate</a><ul>
<li class="chapter" data-level="4.1" data-path="lubridate.html"><a href="lubridate.html#创建日期和时间"><i class="fa fa-check"></i><b>4.1</b> 创建日期和时间</a><ul>
<li class="chapter" data-level="4.1.1" data-path="lubridate.html"><a href="lubridate.html#通过字符串创建"><i class="fa fa-check"></i><b>4.1.1</b> 通过字符串创建</a></li>
<li class="chapter" data-level="4.1.2" data-path="lubridate.html"><a href="lubridate.html#通过各个成分创建"><i class="fa fa-check"></i><b>4.1.2</b> 通过各个成分创建</a></li>
<li class="chapter" data-level="4.1.3" data-path="lubridate.html"><a href="lubridate.html#日期时间型和日期型数据的相互转换"><i class="fa fa-check"></i><b>4.1.3</b> 日期时间型和日期型数据的相互转换</a></li>
<li class="chapter" data-level="4.1.4" data-path="lubridate.html"><a href="lubridate.html#练习-7"><i class="fa fa-check"></i><b>4.1.4</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="lubridate.html"><a href="lubridate.html#日期时间成分"><i class="fa fa-check"></i><b>4.2</b> 日期时间成分</a><ul>
<li class="chapter" data-level="4.2.1" data-path="lubridate.html"><a href="lubridate.html#获取成分"><i class="fa fa-check"></i><b>4.2.1</b> 获取成分</a></li>
<li class="chapter" data-level="4.2.2" data-path="lubridate.html"><a href="lubridate.html#舍入rouding"><i class="fa fa-check"></i><b>4.2.2</b> 舍入（Rouding）</a></li>
<li class="chapter" data-level="4.2.3" data-path="lubridate.html"><a href="lubridate.html#设置成分"><i class="fa fa-check"></i><b>4.2.3</b> 设置成分</a></li>
<li class="chapter" data-level="4.2.4" data-path="lubridate.html"><a href="lubridate.html#练习-8"><i class="fa fa-check"></i><b>4.2.4</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="lubridate.html"><a href="lubridate.html#时间间隔time-span"><i class="fa fa-check"></i><b>4.3</b> 时间间隔（Time Span）</a><ul>
<li class="chapter" data-level="4.3.1" data-path="lubridate.html"><a href="lubridate.html#时期-durations"><i class="fa fa-check"></i><b>4.3.1</b> 时期 Durations</a></li>
<li class="chapter" data-level="4.3.2" data-path="lubridate.html"><a href="lubridate.html#阶段-periods"><i class="fa fa-check"></i><b>4.3.2</b> 阶段 Periods</a></li>
<li class="chapter" data-level="4.3.3" data-path="lubridate.html"><a href="lubridate.html#区间-intervals"><i class="fa fa-check"></i><b>4.3.3</b> 区间 Intervals</a></li>
<li class="chapter" data-level="4.3.4" data-path="lubridate.html"><a href="lubridate.html#小结"><i class="fa fa-check"></i><b>4.3.4</b> 小结</a></li>
<li class="chapter" data-level="4.3.5" data-path="lubridate.html"><a href="lubridate.html#练习-9"><i class="fa fa-check"></i><b>4.3.5</b> 练习</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="forcats.html"><a href="forcats.html"><i class="fa fa-check"></i><b>5</b> forcats</a><ul>
<li class="chapter" data-level="5.1" data-path="forcats.html"><a href="forcats.html#简介"><i class="fa fa-check"></i><b>5.1</b> 简介</a><ul>
<li class="chapter" data-level="5.1.1" data-path="forcats.html"><a href="forcats.html#因子基础"><i class="fa fa-check"></i><b>5.1.1</b> 因子基础</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="forcats.html"><a href="forcats.html#排序"><i class="fa fa-check"></i><b>5.2</b> 排序</a><ul>
<li class="chapter" data-level="5.2.1" data-path="forcats.html"><a href="forcats.html#按照水平的频次排序"><i class="fa fa-check"></i><b>5.2.1</b> 按照水平的频次排序</a></li>
<li class="chapter" data-level="5.2.2" data-path="forcats.html"><a href="forcats.html#按照其他变量排序"><i class="fa fa-check"></i><b>5.2.2</b> 按照其他变量排序</a></li>
<li class="chapter" data-level="5.2.3" data-path="forcats.html"><a href="forcats.html#人工指定顺序"><i class="fa fa-check"></i><b>5.2.3</b> 人工指定顺序</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="forcats.html"><a href="forcats.html#改变水平个数"><i class="fa fa-check"></i><b>5.3</b> 改变水平个数</a><ul>
<li class="chapter" data-level="5.3.1" data-path="forcats.html"><a href="forcats.html#合并水平"><i class="fa fa-check"></i><b>5.3.1</b> 合并水平</a></li>
<li class="chapter" data-level="5.3.2" data-path="forcats.html"><a href="forcats.html#增加水平"><i class="fa fa-check"></i><b>5.3.2</b> 增加水平</a></li>
<li class="chapter" data-level="5.3.3" data-path="forcats.html"><a href="forcats.html#舍弃水平dropping-unused-levels"><i class="fa fa-check"></i><b>5.3.3</b> 舍弃水平(Dropping unused levels)</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="forcats.html"><a href="forcats.html#编码"><i class="fa fa-check"></i><b>5.4</b> 编码</a><ul>
<li class="chapter" data-level="5.4.1" data-path="forcats.html"><a href="forcats.html#练习-10"><i class="fa fa-check"></i><b>5.4.1</b> 练习：</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="forcats.html"><a href="forcats.html#合并因子"><i class="fa fa-check"></i><b>5.5</b> 合并因子</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="tidyr.html"><a href="tidyr.html"><i class="fa fa-check"></i><b>6</b> tidyr</a><ul>
<li class="chapter" data-level="6.1" data-path="tidyr.html"><a href="tidyr.html#tidyr-intro"><i class="fa fa-check"></i><b>6.1</b> 简介</a><ul>
<li class="chapter" data-level="6.1.1" data-path="tidyr.html"><a href="tidyr.html#练习-11"><i class="fa fa-check"></i><b>6.1.1</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="tidyr.html"><a href="tidyr.html#spread和gather"><i class="fa fa-check"></i><b>6.2</b> <code>spread()</code>和<code>gather()</code></a><ul>
<li class="chapter" data-level="6.2.1" data-path="tidyr.html"><a href="tidyr.html#gather"><i class="fa fa-check"></i><b>6.2.1</b> <code>gather()</code></a></li>
<li class="chapter" data-level="6.2.2" data-path="tidyr.html"><a href="tidyr.html#spread"><i class="fa fa-check"></i><b>6.2.2</b> <code>spread()</code></a></li>
<li class="chapter" data-level="6.2.3" data-path="tidyr.html"><a href="tidyr.html#练习-12"><i class="fa fa-check"></i><b>6.2.3</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="tidyr.html"><a href="tidyr.html#separate和untie"><i class="fa fa-check"></i><b>6.3</b> <code>separate()</code>和<code>untie()</code></a><ul>
<li class="chapter" data-level="6.3.1" data-path="tidyr.html"><a href="tidyr.html#separate"><i class="fa fa-check"></i><b>6.3.1</b> <code>separate()</code></a></li>
<li class="chapter" data-level="6.3.2" data-path="tidyr.html"><a href="tidyr.html#unite"><i class="fa fa-check"></i><b>6.3.2</b> <code>unite()</code></a></li>
<li class="chapter" data-level="6.3.3" data-path="tidyr.html"><a href="tidyr.html#练习-13"><i class="fa fa-check"></i><b>6.3.3</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="tidyr.html"><a href="tidyr.html#tidyr-missing"><i class="fa fa-check"></i><b>6.4</b> 缺失值</a></li>
<li class="chapter" data-level="6.5" data-path="tidyr.html"><a href="tidyr.html#case-study"><i class="fa fa-check"></i><b>6.5</b> Case Study</a><ul>
<li class="chapter" data-level="6.5.1" data-path="tidyr.html"><a href="tidyr.html#练习-14"><i class="fa fa-check"></i><b>6.5.1</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="tidyr.html"><a href="tidyr.html#non-tidy"><i class="fa fa-check"></i><b>6.6</b> 拓展：None-tidy data</a></li>
<li class="chapter" data-level="6.7" data-path="tidyr.html"><a href="tidyr.html#tidyr-1.0.0"><i class="fa fa-check"></i><b>6.7</b> <code>tidyr 1.0.0</code></a><ul>
<li class="chapter" data-level="6.7.1" data-path="tidyr.html"><a href="tidyr.html#pivot_longer-和-pivot_wider"><i class="fa fa-check"></i><b>6.7.1</b> <code>pivot_longer</code> 和 <code>pivot_wider</code></a></li>
<li class="chapter" data-level="6.7.2" data-path="tidyr.html"><a href="tidyr.html#pivot_wider"><i class="fa fa-check"></i><b>6.7.2</b> <code>pivot_wider()</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="relational-data.html"><a href="relational-data.html"><i class="fa fa-check"></i><b>7</b> relational data</a><ul>
<li class="chapter" data-level="7.1" data-path="relational-data.html"><a href="relational-data.html#introduction"><i class="fa fa-check"></i><b>7.1</b> introduction</a></li>
<li class="chapter" data-level="7.2" data-path="relational-data.html"><a href="relational-data.html#mutating-joins"><i class="fa fa-check"></i><b>7.2</b> mutating joins</a></li>
<li class="chapter" data-level="7.3" data-path="relational-data.html"><a href="relational-data.html#filtering-join"><i class="fa fa-check"></i><b>7.3</b> filtering join</a></li>
<li class="chapter" data-level="7.4" data-path="relational-data.html"><a href="relational-data.html#fuzzy-join"><i class="fa fa-check"></i><b>7.4</b> fuzzy join</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="broom.html"><a href="broom.html"><i class="fa fa-check"></i><b>8</b> broom</a></li>
<li class="chapter" data-level="9" data-path="purrr.html"><a href="purrr.html"><i class="fa fa-check"></i><b>9</b> purrr</a><ul>
<li class="chapter" data-level="9.1" data-path="purrr.html"><a href="purrr.html#map-family"><i class="fa fa-check"></i><b>9.1</b> <code>map()</code> family</a></li>
<li class="chapter" data-level="9.2" data-path="purrr.html"><a href="purrr.html#producing-atomic-vectors"><i class="fa fa-check"></i><b>9.2</b> Producing atomic vectors</a><ul>
<li class="chapter" data-level="9.2.1" data-path="purrr.html"><a href="purrr.html#purrr-style-anonymous-functions"><i class="fa fa-check"></i><b>9.2.1</b> purrr-style anonymous functions</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="purrr.html"><a href="purrr.html#predicate-functions"><i class="fa fa-check"></i><b>9.3</b> Predicate functions</a><ul>
<li class="chapter" data-level="9.3.1" data-path="purrr.html"><a href="purrr.html#basics"><i class="fa fa-check"></i><b>9.3.1</b> Basics</a></li>
<li class="chapter" data-level="9.3.2" data-path="purrr.html"><a href="purrr.html#map-variants"><i class="fa fa-check"></i><b>9.3.2</b> Map variants</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="purrr.html"><a href="purrr.html#group_"><i class="fa fa-check"></i><b>9.4</b> group_</a><ul>
<li class="chapter" data-level="9.4.1" data-path="purrr.html"><a href="purrr.html#group_mapgroup_modify"><i class="fa fa-check"></i><b>9.4.1</b> group_map、group_modify</a></li>
<li class="chapter" data-level="9.4.2" data-path="purrr.html"><a href="purrr.html#group_splitgroup_keysgroup_data"><i class="fa fa-check"></i><b>9.4.2</b> group_split、group_keys、group_data</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Importing</b></span></li>
<li class="chapter" data-level="10" data-path="vroom.html"><a href="vroom.html"><i class="fa fa-check"></i><b>10</b> vroom</a></li>
<li class="chapter" data-level="11" data-path="data-apis.html"><a href="data-apis.html"><i class="fa fa-check"></i><b>11</b> Data APIs</a><ul>
<li class="chapter" data-level="11.1" data-path="data-apis.html"><a href="data-apis.html#wdi"><i class="fa fa-check"></i><b>11.1</b> WDI</a><ul>
<li class="chapter" data-level="11.1.1" data-path="data-apis.html"><a href="data-apis.html#wdisearch"><i class="fa fa-check"></i><b>11.1.1</b> <code>WDIsearch()</code></a></li>
<li class="chapter" data-level="11.1.2" data-path="data-apis.html"><a href="data-apis.html#wdi-1"><i class="fa fa-check"></i><b>11.1.2</b> <code>WDI</code></a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="data-apis.html"><a href="data-apis.html#ipumsr"><i class="fa fa-check"></i><b>11.2</b> ipumsr</a></li>
</ul></li>
<li class="part"><span><b>III Exploring and Wrangling</b></span></li>
<li class="chapter" data-level="12" data-path="data-table.html"><a href="data-table.html"><i class="fa fa-check"></i><b>12</b> data.table</a><ul>
<li class="chapter" data-level="12.1" data-path="data-table.html"><a href="data-table.html#dtplyr"><i class="fa fa-check"></i><b>12.1</b> dtplyr</a></li>
<li class="chapter" data-level="12.2" data-path="data-table.html"><a href="data-table.html#maditr"><i class="fa fa-check"></i><b>12.2</b> maditr</a></li>
<li class="chapter" data-level="12.3" data-path="data-table.html"><a href="data-table.html#tidyfast"><i class="fa fa-check"></i><b>12.3</b> tidyfast</a></li>
<li class="chapter" data-level="12.4" data-path="data-table.html"><a href="data-table.html#disk.frame"><i class="fa fa-check"></i><b>12.4</b> disk.frame</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="rowwise-operation.html"><a href="rowwise-operation.html"><i class="fa fa-check"></i><b>13</b> rowwise operation</a><ul>
<li class="chapter" data-level="13.1" data-path="rowwise-operation.html"><a href="rowwise-operation.html#do-rowwise"><i class="fa fa-check"></i><b>13.1</b> do() + rowwise()</a></li>
<li class="chapter" data-level="13.2" data-path="rowwise-operation.html"><a href="rowwise-operation.html#rap"><i class="fa fa-check"></i><b>13.2</b> rap</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="data-summary.html"><a href="data-summary.html"><i class="fa fa-check"></i><b>14</b> Data Summary</a><ul>
<li class="chapter" data-level="14.1" data-path="data-summary.html"><a href="data-summary.html#skimr"><i class="fa fa-check"></i><b>14.1</b> skimr</a></li>
<li class="chapter" data-level="14.2" data-path="data-summary.html"><a href="data-summary.html#visdat"><i class="fa fa-check"></i><b>14.2</b> visdat</a></li>
<li class="chapter" data-level="14.3" data-path="data-summary.html"><a href="data-summary.html#summarytools"><i class="fa fa-check"></i><b>14.3</b> summarytools</a><ul>
<li class="chapter" data-level="14.3.1" data-path="data-summary.html"><a href="data-summary.html#freq"><i class="fa fa-check"></i><b>14.3.1</b> <code>freq</code></a></li>
<li class="chapter" data-level="14.3.2" data-path="data-summary.html"><a href="data-summary.html#descr"><i class="fa fa-check"></i><b>14.3.2</b> <code>descr()</code></a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>IV Cleaning and Tidying</b></span></li>
<li class="chapter" data-level="15" data-path="janitor.html"><a href="janitor.html"><i class="fa fa-check"></i><b>15</b> Janitor</a><ul>
<li class="chapter" data-level="15.1" data-path="janitor.html"><a href="janitor.html#qingxi"><i class="fa fa-check"></i><b>15.1</b> 清洗</a><ul>
<li class="chapter" data-level="15.1.1" data-path="janitor.html"><a href="janitor.html#clean_names"><i class="fa fa-check"></i><b>15.1.1</b> <code>clean_names</code></a></li>
<li class="chapter" data-level="15.1.2" data-path="janitor.html"><a href="janitor.html#compare_df_cols"><i class="fa fa-check"></i><b>15.1.2</b> <code>compare_df_cols</code></a></li>
</ul></li>
<li class="chapter" data-level="15.2" data-path="janitor.html"><a href="janitor.html#tansuo"><i class="fa fa-check"></i><b>15.2</b> 探索</a><ul>
<li class="chapter" data-level="15.2.1" data-path="janitor.html"><a href="janitor.html#tabyl"><i class="fa fa-check"></i><b>15.2.1</b> <code>tabyl</code></a></li>
<li class="chapter" data-level="15.2.2" data-path="janitor.html"><a href="janitor.html#get_dupes"><i class="fa fa-check"></i><b>15.2.2</b> <code>get_dupes</code></a></li>
<li class="chapter" data-level="15.2.3" data-path="janitor.html"><a href="janitor.html#remove_"><i class="fa fa-check"></i><b>15.2.3</b> <code>remove_</code></a></li>
<li class="chapter" data-level="15.2.4" data-path="janitor.html"><a href="janitor.html#round_half_up"><i class="fa fa-check"></i><b>15.2.4</b> <code>round_half_up</code></a></li>
<li class="chapter" data-level="15.2.5" data-path="janitor.html"><a href="janitor.html#excel_numeric_to_date"><i class="fa fa-check"></i><b>15.2.5</b> <code>excel_numeric_to_date</code></a></li>
<li class="chapter" data-level="15.2.6" data-path="janitor.html"><a href="janitor.html#top_levels"><i class="fa fa-check"></i><b>15.2.6</b> <code>top_levels</code></a></li>
<li class="chapter" data-level="15.2.7" data-path="janitor.html"><a href="janitor.html#row_to_names"><i class="fa fa-check"></i><b>15.2.7</b> <code>row_to_names</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="16" data-path="missing-values.html"><a href="missing-values.html"><i class="fa fa-check"></i><b>16</b> 处理缺失值</a><ul>
<li class="chapter" data-level="16.1" data-path="missing-values.html"><a href="missing-values.html#explore-missing"><i class="fa fa-check"></i><b>16.1</b> 探索</a></li>
<li class="chapter" data-level="16.2" data-path="missing-values.html"><a href="missing-values.html#fill-missing"><i class="fa fa-check"></i><b>16.2</b> 填充</a></li>
</ul></li>
<li class="part"><span><b>V Modelling</b></span></li>
<li class="chapter" data-level="17" data-path="tidymodels.html"><a href="tidymodels.html"><i class="fa fa-check"></i><b>17</b> tidymodels</a></li>
<li class="chapter" data-level="18" data-path="caret.html"><a href="caret.html"><i class="fa fa-check"></i><b>18</b> caret</a></li>
<li class="chapter" data-level="19" data-path="vtreat.html"><a href="vtreat.html"><i class="fa fa-check"></i><b>19</b> vtreat</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">written with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R for data science: tidyverse and beyond</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="dplyr" class="section level1">
<h1><span class="header-section-number">1</span> dplyr</h1>
<p><strong>dplyr</strong> 承担了 tidyverse 中最基本也最重要的数据处理、转换、分析功能(to my mind)。它的设计思想是发展处一套简洁、统一的数据操作语法(a grammar of data manipulation)，用英语中常见的动词命名操作数据的函数，并充分利用管道符 <code>%&gt;%</code> 和更“现代”的数据框格式 <code>tibble</code> 增加代码可读性。<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<p>为了介绍 <strong>dplyr</strong> 中的基本数据操作。可以使用 <code>nycflights::flights</code>，这个数据集包含了 2013 年从纽约市处罚的所有 336776 次航班的信息。该数据来自于美国交通统计局。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">library</span>(nycflights13)</a>
<a class="sourceLine" id="cb2-2" title="2">flights</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 19</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></a>
<a class="sourceLine" id="cb2-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb2-13" title="13"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb2-14" title="14"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>这里的数据输出和我们之前用过的 <code>data.frame</code> 形式有一些差别：只显示了前几行和适合屏幕宽度的几列。这样的差别是因为 <code>flights</code> 数据集被存储在 tibble 当中，它是一种更简单的数据框，但更加适合在 tidyverse 中使用。相对于普通的数据框，它在打印和取子集两个方面进行了优化，更详细的内容会在后面的章节谈到。</p>
<p>同时，输出结果列名下面有一行 3 个或 4 个字母的缩写。它们描述了每个变量的类型。</p>
<ul>
<li><code>int</code> 表示整数型变量<br />
</li>
<li><code>dbl</code> 表示双精度浮点型变量<br />
</li>
<li><code>chr</code> 表示字符串<br />
</li>
<li><code>dttm</code> 表示日期时间（日期+时间）型变量</li>
</ul>
<p>还有另外三种常见的变量类型，虽然没有在本数据中出现，但很快就会用到：</p>
<ul>
<li><code>lgl</code> 表示逻辑型变量（即布尔变量）<br />
</li>
<li><code>fct</code> 表示因子<br />
</li>
<li><code>date</code> 表示日期型变量</li>
</ul>
<p>另外，还有一种专门为<code>tibble</code>数据格式编写的函数 <code>glimpse()</code>，它的功能和 <code>str()</code> 类似，但输出更为整洁，显示的数据也更多一些:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">glimpse</span>(flights)</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="co">#&gt; Observations: 336,776</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co">#&gt; Variables: 19</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">#&gt; $ year           &lt;int&gt; 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, …</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">#&gt; $ month          &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co">#&gt; $ day            &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co">#&gt; $ dep_time       &lt;int&gt; 517, 533, 542, 544, 554, 554, 555, 557, 557, 558, 558,…</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co">#&gt; $ sched_dep_time &lt;int&gt; 515, 529, 540, 545, 600, 558, 600, 600, 600, 600, 600,…</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co">#&gt; $ dep_delay      &lt;dbl&gt; 2, 4, 2, -1, -6, -4, -5, -3, -3, -2, -2, -2, -2, -2, -…</span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co">#&gt; $ arr_time       &lt;int&gt; 830, 850, 923, 1004, 812, 740, 913, 709, 838, 753, 849…</span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co">#&gt; $ sched_arr_time &lt;int&gt; 819, 830, 850, 1022, 837, 728, 854, 723, 846, 745, 851…</span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="co">#&gt; $ arr_delay      &lt;dbl&gt; 11, 20, 33, -18, -25, 12, 19, -14, -8, 8, -2, -3, 7, -…</span></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="co">#&gt; $ carrier        &lt;chr&gt; &quot;UA&quot;, &quot;UA&quot;, &quot;AA&quot;, &quot;B6&quot;, &quot;DL&quot;, &quot;UA&quot;, &quot;B6&quot;, &quot;EV&quot;, &quot;B6&quot;, …</span></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="co">#&gt; $ flight         &lt;int&gt; 1545, 1714, 1141, 725, 461, 1696, 507, 5708, 79, 301, …</span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="co">#&gt; $ tailnum        &lt;chr&gt; &quot;N14228&quot;, &quot;N24211&quot;, &quot;N619AA&quot;, &quot;N804JB&quot;, &quot;N668DN&quot;, &quot;N39…</span></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="co">#&gt; $ origin         &lt;chr&gt; &quot;EWR&quot;, &quot;LGA&quot;, &quot;JFK&quot;, &quot;JFK&quot;, &quot;LGA&quot;, &quot;EWR&quot;, &quot;EWR&quot;, &quot;LGA&quot;…</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="co">#&gt; $ dest           &lt;chr&gt; &quot;IAH&quot;, &quot;IAH&quot;, &quot;MIA&quot;, &quot;BQN&quot;, &quot;ATL&quot;, &quot;ORD&quot;, &quot;FLL&quot;, &quot;IAD&quot;…</span></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="co">#&gt; $ air_time       &lt;dbl&gt; 227, 227, 160, 183, 116, 150, 158, 53, 140, 138, 149, …</span></a>
<a class="sourceLine" id="cb3-19" title="19"><span class="co">#&gt; $ distance       &lt;dbl&gt; 1400, 1416, 1089, 1576, 762, 719, 1065, 229, 944, 733,…</span></a>
<a class="sourceLine" id="cb3-20" title="20"><span class="co">#&gt; $ hour           &lt;dbl&gt; 5, 5, 5, 5, 6, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 6, 6, …</span></a>
<a class="sourceLine" id="cb3-21" title="21"><span class="co">#&gt; $ minute         &lt;dbl&gt; 15, 29, 40, 45, 0, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, …</span></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="co">#&gt; $ time_hour      &lt;dttm&gt; 2013-01-01 05:00:00, 2013-01-01 05:00:00, 2013-01-01 …</span></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="kw">str</span>(flights)</a>
<a class="sourceLine" id="cb3-24" title="24"><span class="co">#&gt; Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    336776 obs. of  19 variables:</span></a>
<a class="sourceLine" id="cb3-25" title="25"><span class="co">#&gt;  $ year          : int  2013 2013 2013 2013 2013 2013 2013 2013 2013 2013 ...</span></a>
<a class="sourceLine" id="cb3-26" title="26"><span class="co">#&gt;  $ month         : int  1 1 1 1 1 1 1 1 1 1 ...</span></a>
<a class="sourceLine" id="cb3-27" title="27"><span class="co">#&gt;  $ day           : int  1 1 1 1 1 1 1 1 1 1 ...</span></a>
<a class="sourceLine" id="cb3-28" title="28"><span class="co">#&gt;  $ dep_time      : int  517 533 542 544 554 554 555 557 557 558 ...</span></a>
<a class="sourceLine" id="cb3-29" title="29"><span class="co">#&gt;  $ sched_dep_time: int  515 529 540 545 600 558 600 600 600 600 ...</span></a>
<a class="sourceLine" id="cb3-30" title="30"><span class="co">#&gt;  $ dep_delay     : num  2 4 2 -1 -6 -4 -5 -3 -3 -2 ...</span></a>
<a class="sourceLine" id="cb3-31" title="31"><span class="co">#&gt;  $ arr_time      : int  830 850 923 1004 812 740 913 709 838 753 ...</span></a>
<a class="sourceLine" id="cb3-32" title="32"><span class="co">#&gt;  $ sched_arr_time: int  819 830 850 1022 837 728 854 723 846 745 ...</span></a>
<a class="sourceLine" id="cb3-33" title="33"><span class="co">#&gt;  $ arr_delay     : num  11 20 33 -18 -25 12 19 -14 -8 8 ...</span></a>
<a class="sourceLine" id="cb3-34" title="34"><span class="co">#&gt;  $ carrier       : chr  &quot;UA&quot; &quot;UA&quot; &quot;AA&quot; &quot;B6&quot; ...</span></a>
<a class="sourceLine" id="cb3-35" title="35"><span class="co">#&gt;  $ flight        : int  1545 1714 1141 725 461 1696 507 5708 79 301 ...</span></a>
<a class="sourceLine" id="cb3-36" title="36"><span class="co">#&gt;  $ tailnum       : chr  &quot;N14228&quot; &quot;N24211&quot; &quot;N619AA&quot; &quot;N804JB&quot; ...</span></a>
<a class="sourceLine" id="cb3-37" title="37"><span class="co">#&gt;  $ origin        : chr  &quot;EWR&quot; &quot;LGA&quot; &quot;JFK&quot; &quot;JFK&quot; ...</span></a>
<a class="sourceLine" id="cb3-38" title="38"><span class="co">#&gt;  $ dest          : chr  &quot;IAH&quot; &quot;IAH&quot; &quot;MIA&quot; &quot;BQN&quot; ...</span></a>
<a class="sourceLine" id="cb3-39" title="39"><span class="co">#&gt;  $ air_time      : num  227 227 160 183 116 150 158 53 140 138 ...</span></a>
<a class="sourceLine" id="cb3-40" title="40"><span class="co">#&gt;  $ distance      : num  1400 1416 1089 1576 762 ...</span></a>
<a class="sourceLine" id="cb3-41" title="41"><span class="co">#&gt;  $ hour          : num  5 5 5 5 6 5 6 6 6 6 ...</span></a>
<a class="sourceLine" id="cb3-42" title="42"><span class="co">#&gt;  $ minute        : num  15 29 40 45 0 58 0 0 0 0 ...</span></a>
<a class="sourceLine" id="cb3-43" title="43"><span class="co">#&gt;  $ time_hour     : POSIXct, format: &quot;2013-01-01 05:00:00&quot; &quot;2013-01-01 05:00:00&quot; ...</span></a></code></pre></div>
<div id="个数据转换核心函数" class="section level2">
<h2><span class="header-section-number">1.1</span> 5个数据转换核心函数</h2>
<p>五个 <code>dplyr</code> 核心函数能解决数据转换中的绝大多数问题：</p>
<ul>
<li>使用 <code>filter()</code> 筛选行<br />
</li>
<li>使用 <code>arrange()</code> 排列行<br />
</li>
<li>使用 <code>select</code> 选取列<br />
</li>
<li>用现有的变量创建新变量 <code>mutate()</code><br />
</li>
<li>聚合并计算摘要统计量 <code>summarize()</code></li>
</ul>
<p>上面的所有函数都可以和 <code>group_by()</code> 函数联合起来使用，<code>group_by()</code> 函数可以改变以上每个函数的作用范围，让其从在整个数据集上操作变为在每个变量的水平上分别操作。这 6 个函数构成了数据处理的基本工具。</p>
<p>这些函数有完全相同的参数结构和工作方式：</p>
<ul>
<li>第一个参数是数据集，表明我们想对什么数据进行处理<br />
</li>
<li>随后的参数是变量名称（不带引号）描述了在数据上进行什么处理，不同的变量之间用逗号分隔<br />
</li>
<li>它们不会改变原数据，而是生成一个新的数据框</li>
</ul>
</div>
<div id="filter筛选行" class="section level2">
<h2><span class="header-section-number">1.2</span> <code>filter()</code>筛选行</h2>
<p><code>filter()</code>函数可以基于观测值筛选行，符合条件的行留下，不符合条件的被剔除，最终得到一个观测子集。第一个参数是数据集的名称，第二个参数以及随后的参数是用来筛选行的条件。例如，我们可以使用以下代码筛选出一月一日的所有航班（条件：月 = 1 且 日=1）</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(month <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, day <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="co">#&gt; # A tibble: 842 x 19</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="co">#&gt; # … with 836 more rows, and 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="co">#&gt; #   flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="co">#&gt; #   distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p><strong><code>filter()</code>函数的内部执行原理：</strong>
以行为单位，如果该行满足所指定的条件，则被筛选出 ； 若不满足，则被剔除。使用<code>filter()</code>时，总应该从每一行的角度来思考问题。</p>
<p>因为dplyr中的函数从不改变原数据，如果想储存<code>filter()</code>得出的结果，那么需要把它赋值给一个变量。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">jan =<span class="st"> </span>flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(month <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, day <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</a></code></pre></div>
<p>R 要么输出结果，要么将结果保存在变量中。如果想要在存储的同时显示结果，可以用括号将赋值语句括起来：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">(<span class="dt">jan =</span> flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(month <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, day <span class="op">==</span><span class="st"> </span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co">#&gt; # A tibble: 842 x 19</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="co">#&gt; # … with 836 more rows, and 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="co">#&gt; #   flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="co">#&gt; #   distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<div id="运算符" class="section level3">
<h3><span class="header-section-number">1.2.1</span> 运算符</h3>
<p>为了有效地进行筛选，R 提供了一套标准的运算符，包括比较运算符和逻辑运算符。</p>
<p><strong>比较运算符</strong>： <code>==、！= 、 &gt; 、 &gt;= 、 &lt; 、 &lt;=</code>
当开始编写条件时，最容易犯的错误就是用<code>=</code>而不是<code>==</code>来测试是否相等。R 对于这种错误会提供一条启发性的错误信息：</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="st">  </span><span class="kw">filter</span>(<span class="dt">month =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co">#&gt; Error: `month` (`month = 1`) must not be named, do you need `==`?</span></a></code></pre></div>
<p>在判断是否相等时，还有另一个常见问题：浮点数。例如，下面的结果可能出人意料：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">sqrt</span>(<span class="dv">2</span>)<span class="op">^</span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">#&gt; [1] FALSE</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="dv">1</span> <span class="op">/</span><span class="dv">49</span> <span class="op">*</span><span class="st"> </span><span class="dv">49</span> <span class="op">==</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="co">#&gt; [1] FALSE</span></a></code></pre></div>
<p>计算机使用的是有限位运算，不能存储无限位的数。因此我们看到的每个数都是一个近似值。比较浮点数是否相等时，不能用<code>==</code>,而应该用<code>near()</code>,它用于比较两个数值向量是否相等，且带有一定容忍度(tolerence):</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">near</span>(<span class="kw">sqrt</span>(<span class="dv">2</span>) <span class="op">^</span><span class="st"> </span><span class="dv">2</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="kw">near</span>(<span class="dv">1</span> <span class="op">/</span><span class="dv">49</span> <span class="op">*</span><span class="st"> </span><span class="dv">49</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb9-4" title="4"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
<p>**逻辑运算符*
<code>filter()</code>中的多个参数是“与”的关系，如<code>data %&gt;% filter(condition_1,condition_2,···,condition_n)</code>表示的是“我希望同时筛选出满足这n个条件的行。如果要实现其他类型的组合，需要使用逻辑（布尔）运算符。<code>&amp;</code>表示与，<code>|</code>表示或，<code>!</code>表示非。下图给出了布尔运算的完整集合：</p>
<p><img src="images/18.png" /></p>
<p>例如，想要找出11月<strong>或</strong>12月出发的所有航班：</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(month <span class="op">==</span><span class="st"> </span><span class="dv">11</span> <span class="op">|</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">12</span>)</a>
<a class="sourceLine" id="cb10-2" title="2"><span class="co">#&gt; # A tibble: 55,403 x 19</span></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb10-5" title="5"><span class="co">#&gt; 1  2013    11     1        5           2359         6      352            345</span></a>
<a class="sourceLine" id="cb10-6" title="6"><span class="co">#&gt; 2  2013    11     1       35           2250       105      123           2356</span></a>
<a class="sourceLine" id="cb10-7" title="7"><span class="co">#&gt; 3  2013    11     1      455            500        -5      641            651</span></a>
<a class="sourceLine" id="cb10-8" title="8"><span class="co">#&gt; 4  2013    11     1      539            545        -6      856            827</span></a>
<a class="sourceLine" id="cb10-9" title="9"><span class="co">#&gt; 5  2013    11     1      542            545        -3      831            855</span></a>
<a class="sourceLine" id="cb10-10" title="10"><span class="co">#&gt; 6  2013    11     1      549            600       -11      912            923</span></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co">#&gt; # … with 5.54e+04 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb10-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>表达式中的运算顺序和正常语言中的是不一样的。你不能写成<code>flights %&gt;% filter(month == 11 | 12)</code>，这种形式的文字翻译确实是“找出11月或12月的所有航班”，但在代码中不是这个意思。代码中的含义是找出所有月份为<code>11|12</code>的航班，这个表达式的逻辑值为TRUE，在数字语境中R会将它解读为1，所以这段代码实际上找出的 1 月出发的所有航班。<br />
这种问题有一个有用的简写形式：<code>x %in% y</code>，这个表达式在x被包含于y的时候返回TRUE，我们可以这样改写上面的代码：</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(month <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">11</span>, <span class="dv">12</span>))  <span class="co">## 找出所有月份值包含在该向量里的行</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="co">#&gt; # A tibble: 55,403 x 19</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="co">#&gt; 1  2013    11     1        5           2359         6      352            345</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="co">#&gt; 2  2013    11     1       35           2250       105      123           2356</span></a>
<a class="sourceLine" id="cb11-7" title="7"><span class="co">#&gt; 3  2013    11     1      455            500        -5      641            651</span></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="co">#&gt; 4  2013    11     1      539            545        -6      856            827</span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="co">#&gt; 5  2013    11     1      542            545        -3      831            855</span></a>
<a class="sourceLine" id="cb11-10" title="10"><span class="co">#&gt; 6  2013    11     1      549            600       -11      912            923</span></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="co">#&gt; # … with 5.54e+04 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>有时可以使用德摩根律来将筛选条件简化：<code>!(x &amp; y)</code>等价于<code>!x | !y</code>，而<code>!(x | y)</code>等价于<code>!x &amp; !y</code>。例如，如果想要找出延误时间（到达和出发)都不多于两个小时的航班，以下两种方式均可：
<code>flights %&gt;% filter(arr_delay &lt;= 120 &amp; dep_dealy &lt;= 120 )</code><br />
<code>flights %&gt;% filter(!(arr_delay &gt; 120| dep_delay &gt; 120 ))</code></p>
<p>dplyr中另外一个对筛选有帮助的函数是<code>between(x,left,right)</code>，它用于判断x是否落在left和right两个值确定的闭区间里。
例如找出所有在11月和12月出发的航班也可以这样表达：</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">between</span>(month, <span class="dv">11</span>, <span class="dv">12</span>))</a>
<a class="sourceLine" id="cb12-2" title="2"><span class="co">#&gt; # A tibble: 55,403 x 19</span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="co">#&gt; 1  2013    11     1        5           2359         6      352            345</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="co">#&gt; 2  2013    11     1       35           2250       105      123           2356</span></a>
<a class="sourceLine" id="cb12-7" title="7"><span class="co">#&gt; 3  2013    11     1      455            500        -5      641            651</span></a>
<a class="sourceLine" id="cb12-8" title="8"><span class="co">#&gt; 4  2013    11     1      539            545        -6      856            827</span></a>
<a class="sourceLine" id="cb12-9" title="9"><span class="co">#&gt; 5  2013    11     1      542            545        -3      831            855</span></a>
<a class="sourceLine" id="cb12-10" title="10"><span class="co">#&gt; 6  2013    11     1      549            600       -11      912            923</span></a>
<a class="sourceLine" id="cb12-11" title="11"><span class="co">#&gt; # … with 5.54e+04 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb12-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb12-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>有些时候，<code>filter()</code>函数中用来筛选的条件可能比较复杂，需要书写令人费解的逻辑表达式，这时候可以考虑创建一个新变量代表逻辑判断的结果。这样检查代码会容易很多。我们很快就会介绍如何创建新变量。</p>

<div class="rmdcaution">
&amp; and &amp;&amp; indicate logical AND and | and || indicate logical OR. The shorter form performs elementwise comparisons in much the same way as arithmetic operators. The longer form evaluates left to right examining only the first element of each vector. Evaluation proceeds only until the result is determined. The longer form is appropriate for programming control-flow and typically preferred in if clauses.
</div>

</div>
<div id="缺失值" class="section level3">
<h3><span class="header-section-number">1.2.2</span> 缺失值</h3>
<p>NA(not available)表示未知的值、缺失值，缺失值一个很重要的特点是它是“可传染的”。如果运算中包含了缺失值，那么运算结果一般来说也会是缺失值。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="ot">NA</span> <span class="op">&gt;</span><span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="co">#&gt; [1] NA</span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="ot">NA</span> <span class="op">==</span><span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="co">#&gt; [1] NA</span></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="ot">NA</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb13-6" title="6"><span class="co">#&gt; [1] NA</span></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="ot">NA</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb13-8" title="8"><span class="co">#&gt; [1] NA</span></a></code></pre></div>
<p>以上的表达式的结果都是NA，这很好理解，如果R不知道表达式其中的一个量究竟是什么值，自然表达式的结果也就不可知。<br />
还要注意一件事：</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="ot">NA</span> <span class="op">==</span><span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="co">#&gt; [1] NA</span></a></code></pre></div>
<p>我们可以这么理解这个结果：</p>
<blockquote>
<p>令x为Mary的年龄，我们不知道她有多大：x &lt;- NA<br />
令y为John的年龄，我们同样不知道他又多大：x &lt;- NA<br />
Mary和John的年龄相同吗？： x == y<br />
不知道！</p>
</blockquote>
<p>鉴于此，使用<code>NA == x</code>来判断x是否是缺失值不可行。我们用函数<code>is.na()</code>进行判断：</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">x =<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="kw">is.na</span>(x)</a>
<a class="sourceLine" id="cb15-3" title="3"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
<p>前面说过，<code>filter()</code> 实际上是在提问：某行的某个 \ 某些变量满足给定的条件吗？如果为 TRUE，则筛选出该行。如果该行在涉及变量上的取值是 NA，那么逻辑表达式也会返回 NA，这些行将被返回结果为 FALSE 的行一并被排除。如果想保留缺失值，同样可以利用逻辑表达式指出：</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="ot">NA</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb16-2" title="2">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">is.na</span>(x) <span class="op">|</span><span class="st"> </span>x <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb16-3" title="3"><span class="co">#&gt; # A tibble: 2 x 1</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="co">#&gt;       x</span></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="co">#&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb16-6" title="6"><span class="co">#&gt; 1    NA</span></a>
<a class="sourceLine" id="cb16-7" title="7"><span class="co">#&gt; 2     3</span></a></code></pre></div>
</div>
<div id="练习" class="section level3">
<h3><span class="header-section-number">1.2.3</span> 练习</h3>

<div class="exercise">
<span id="exr:unnamed-chunk-19" class="exercise"><strong>Exercise 1.1  </strong></span>找出满足以下条件的所有航班:
</div>

<blockquote>
<p>到达时间延误两小时或更多的航班</p>
</blockquote>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(arr_delay <span class="op">&gt;=</span><span class="st"> </span><span class="dv">120</span>)</a>
<a class="sourceLine" id="cb17-2" title="2"><span class="co">#&gt; # A tibble: 10,200 x 19</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="co">#&gt; 1  2013     1     1      811            630       101     1047            830</span></a>
<a class="sourceLine" id="cb17-6" title="6"><span class="co">#&gt; 2  2013     1     1      848           1835       853     1001           1950</span></a>
<a class="sourceLine" id="cb17-7" title="7"><span class="co">#&gt; 3  2013     1     1      957            733       144     1056            853</span></a>
<a class="sourceLine" id="cb17-8" title="8"><span class="co">#&gt; 4  2013     1     1     1114            900       134     1447           1222</span></a>
<a class="sourceLine" id="cb17-9" title="9"><span class="co">#&gt; 5  2013     1     1     1505           1310       115     1638           1431</span></a>
<a class="sourceLine" id="cb17-10" title="10"><span class="co">#&gt; 6  2013     1     1     1525           1340       105     1831           1626</span></a>
<a class="sourceLine" id="cb17-11" title="11"><span class="co">#&gt; # … with 1.019e+04 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb17-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb17-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<blockquote>
<p>飞往休斯顿（IAH机场或者HOU机场）的航班</p>
</blockquote>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(dest <span class="op">==</span><span class="st"> &quot;IAH&quot;</span> <span class="op">|</span><span class="st"> </span>dest <span class="op">==</span><span class="st"> &quot;HOU&quot;</span>)</a>
<a class="sourceLine" id="cb18-2" title="2"><span class="co">#&gt; # A tibble: 9,313 x 19</span></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb18-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb18-5" title="5"><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></a>
<a class="sourceLine" id="cb18-6" title="6"><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></a>
<a class="sourceLine" id="cb18-7" title="7"><span class="co">#&gt; 3  2013     1     1      623            627        -4      933            932</span></a>
<a class="sourceLine" id="cb18-8" title="8"><span class="co">#&gt; 4  2013     1     1      728            732        -4     1041           1038</span></a>
<a class="sourceLine" id="cb18-9" title="9"><span class="co">#&gt; 5  2013     1     1      739            739         0     1104           1038</span></a>
<a class="sourceLine" id="cb18-10" title="10"><span class="co">#&gt; 6  2013     1     1      908            908         0     1228           1219</span></a>
<a class="sourceLine" id="cb18-11" title="11"><span class="co">#&gt; # … with 9,307 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb18-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb18-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>也可以写成<code>filter(flights, dest %in% c("HOU","IAH"))</code></p>
<blockquote>
<p>由联合航空（United）、美利坚航空（American）或者三角洲航空（Delat）运营的航班
<code>carrier</code>列代表了航空公司，但是用两个字母缩写表示：</p>
</blockquote>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">flights[<span class="st">&quot;carrier&quot;</span>]</a>
<a class="sourceLine" id="cb19-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 1</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="co">#&gt;   carrier</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="co">#&gt;   &lt;chr&gt;  </span></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="co">#&gt; 1 UA     </span></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="co">#&gt; 2 UA     </span></a>
<a class="sourceLine" id="cb19-7" title="7"><span class="co">#&gt; 3 AA     </span></a>
<a class="sourceLine" id="cb19-8" title="8"><span class="co">#&gt; 4 B6     </span></a>
<a class="sourceLine" id="cb19-9" title="9"><span class="co">#&gt; 5 DL     </span></a>
<a class="sourceLine" id="cb19-10" title="10"><span class="co">#&gt; 6 UA     </span></a>
<a class="sourceLine" id="cb19-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<p>我们可以在<code>airlines</code>数据集中找到这些缩写的含义：</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">airlines</a>
<a class="sourceLine" id="cb20-2" title="2"><span class="co">#&gt; # A tibble: 16 x 2</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="co">#&gt;   carrier name                    </span></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;                   </span></a>
<a class="sourceLine" id="cb20-5" title="5"><span class="co">#&gt; 1 9E      Endeavor Air Inc.       </span></a>
<a class="sourceLine" id="cb20-6" title="6"><span class="co">#&gt; 2 AA      American Airlines Inc.  </span></a>
<a class="sourceLine" id="cb20-7" title="7"><span class="co">#&gt; 3 AS      Alaska Airlines Inc.    </span></a>
<a class="sourceLine" id="cb20-8" title="8"><span class="co">#&gt; 4 B6      JetBlue Airways         </span></a>
<a class="sourceLine" id="cb20-9" title="9"><span class="co">#&gt; 5 DL      Delta Air Lines Inc.    </span></a>
<a class="sourceLine" id="cb20-10" title="10"><span class="co">#&gt; 6 EV      ExpressJet Airlines Inc.</span></a>
<a class="sourceLine" id="cb20-11" title="11"><span class="co">#&gt; # … with 10 more rows</span></a></code></pre></div>
<p>三角洲航空对应 “DL”，“UA” 代表联合航空，“AA”代表美利坚航空</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(carrier <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;DL&quot;</span>, <span class="st">&quot;UA&quot;</span>, <span class="st">&quot;AA&quot;</span>))</a>
<a class="sourceLine" id="cb21-2" title="2"><span class="co">#&gt; # A tibble: 139,504 x 19</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></a>
<a class="sourceLine" id="cb21-8" title="8"><span class="co">#&gt; 4  2013     1     1      554            600        -6      812            837</span></a>
<a class="sourceLine" id="cb21-9" title="9"><span class="co">#&gt; 5  2013     1     1      554            558        -4      740            728</span></a>
<a class="sourceLine" id="cb21-10" title="10"><span class="co">#&gt; 6  2013     1     1      558            600        -2      753            745</span></a>
<a class="sourceLine" id="cb21-11" title="11"><span class="co">#&gt; # … with 1.395e+05 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb21-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb21-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<blockquote>
<p>夏季(7月、8月、9月)出发的航班</p>
</blockquote>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(month <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>))</a>
<a class="sourceLine" id="cb22-2" title="2"><span class="co">#&gt; # A tibble: 86,326 x 19</span></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb22-5" title="5"><span class="co">#&gt; 1  2013     7     1        1           2029       212      236           2359</span></a>
<a class="sourceLine" id="cb22-6" title="6"><span class="co">#&gt; 2  2013     7     1        2           2359         3      344            344</span></a>
<a class="sourceLine" id="cb22-7" title="7"><span class="co">#&gt; 3  2013     7     1       29           2245       104      151              1</span></a>
<a class="sourceLine" id="cb22-8" title="8"><span class="co">#&gt; 4  2013     7     1       43           2130       193      322             14</span></a>
<a class="sourceLine" id="cb22-9" title="9"><span class="co">#&gt; 5  2013     7     1       44           2150       174      300            100</span></a>
<a class="sourceLine" id="cb22-10" title="10"><span class="co">#&gt; 6  2013     7     1       46           2051       235      304           2358</span></a>
<a class="sourceLine" id="cb22-11" title="11"><span class="co">#&gt; # … with 8.632e+04 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb22-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb22-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>另一种写法：<code>filter(flgihts,month &gt;= 7, month &lt;= 9)</code><br />
用<code>between()</code>函数的写法：</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">between</span>(month,<span class="dv">7</span>,<span class="dv">9</span>))</a>
<a class="sourceLine" id="cb23-2" title="2"><span class="co">#&gt; # A tibble: 86,326 x 19</span></a>
<a class="sourceLine" id="cb23-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb23-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb23-5" title="5"><span class="co">#&gt; 1  2013     7     1        1           2029       212      236           2359</span></a>
<a class="sourceLine" id="cb23-6" title="6"><span class="co">#&gt; 2  2013     7     1        2           2359         3      344            344</span></a>
<a class="sourceLine" id="cb23-7" title="7"><span class="co">#&gt; 3  2013     7     1       29           2245       104      151              1</span></a>
<a class="sourceLine" id="cb23-8" title="8"><span class="co">#&gt; 4  2013     7     1       43           2130       193      322             14</span></a>
<a class="sourceLine" id="cb23-9" title="9"><span class="co">#&gt; 5  2013     7     1       44           2150       174      300            100</span></a>
<a class="sourceLine" id="cb23-10" title="10"><span class="co">#&gt; 6  2013     7     1       46           2051       235      304           2358</span></a>
<a class="sourceLine" id="cb23-11" title="11"><span class="co">#&gt; # … with 8.632e+04 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb23-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb23-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<blockquote>
<p>到达时间延误超过两小时，但出发时间没有延误的航班</p>
</blockquote>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(dep_delay <span class="op">&gt;</span><span class="st"> </span><span class="dv">120</span> ,</a>
<a class="sourceLine" id="cb24-2" title="2">                   arr_delay <span class="op">&lt;=</span><span class="st"> </span><span class="dv">120</span>)</a>
<a class="sourceLine" id="cb24-3" title="3"><span class="co">#&gt; # A tibble: 1,262 x 19</span></a>
<a class="sourceLine" id="cb24-4" title="4"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb24-5" title="5"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb24-6" title="6"><span class="co">#&gt; 1  2013     1     1     1540           1338       122     2020           1825</span></a>
<a class="sourceLine" id="cb24-7" title="7"><span class="co">#&gt; 2  2013     1     2     2334           2129       125       33           2242</span></a>
<a class="sourceLine" id="cb24-8" title="8"><span class="co">#&gt; 3  2013     1     3     1321           1115       126     1450           1257</span></a>
<a class="sourceLine" id="cb24-9" title="9"><span class="co">#&gt; 4  2013     1     3     1758           1550       128     2240           2050</span></a>
<a class="sourceLine" id="cb24-10" title="10"><span class="co">#&gt; 5  2013     1     3     1933           1730       123     2131           1953</span></a>
<a class="sourceLine" id="cb24-11" title="11"><span class="co">#&gt; 6  2013     1     4     1602           1359       123     1715           1517</span></a>
<a class="sourceLine" id="cb24-12" title="12"><span class="co">#&gt; # … with 1,256 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb24-13" title="13"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb24-14" title="14"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<blockquote>
<p>延误至少一小时，但飞行过程弥补回30分钟的航班</p>
</blockquote>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(dep_delay <span class="op">-</span><span class="st"> </span>arr_delay <span class="op">&gt;</span><span class="st"> </span><span class="dv">30</span>)</a>
<a class="sourceLine" id="cb25-2" title="2"><span class="co">#&gt; # A tibble: 17,950 x 19</span></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb25-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb25-5" title="5"><span class="co">#&gt; 1  2013     1     1      701            700         1     1123           1154</span></a>
<a class="sourceLine" id="cb25-6" title="6"><span class="co">#&gt; 2  2013     1     1      820            820         0     1249           1329</span></a>
<a class="sourceLine" id="cb25-7" title="7"><span class="co">#&gt; 3  2013     1     1      840            845        -5     1311           1350</span></a>
<a class="sourceLine" id="cb25-8" title="8"><span class="co">#&gt; 4  2013     1     1      857            851         6     1157           1222</span></a>
<a class="sourceLine" id="cb25-9" title="9"><span class="co">#&gt; 5  2013     1     1      909            810        59     1331           1315</span></a>
<a class="sourceLine" id="cb25-10" title="10"><span class="co">#&gt; 6  2013     1     1     1025            951        34     1258           1302</span></a>
<a class="sourceLine" id="cb25-11" title="11"><span class="co">#&gt; # … with 1.794e+04 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb25-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb25-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<blockquote>
<p>出发时间在午夜和早上6点之间（包括0点和6点）的航班</p>
</blockquote>
<p>在变量<code>dep_time</code>中，0 点用数值 2400 代表：</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">summary</span>(flights<span class="op">$</span>dep_time)</a>
<a class="sourceLine" id="cb26-2" title="2"><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA&#39;s </span></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="co">#&gt;       1     907    1401    1349    1744    2400    8255</span></a></code></pre></div>
<p>出于这点，不能简单写成<code>dep_time &lt;= 600</code>，而是如下：</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1">flights <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">filter</span>(dep_time <span class="op">&lt;=</span><span class="st"> </span><span class="dv">600</span> <span class="op">|</span><span class="st"> </span>dep_time <span class="op">==</span><span class="st"> </span><span class="dv">2400</span>)</a>
<a class="sourceLine" id="cb27-2" title="2"><span class="co">#&gt; # A tibble: 9,373 x 19</span></a>
<a class="sourceLine" id="cb27-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb27-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb27-5" title="5"><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></a>
<a class="sourceLine" id="cb27-6" title="6"><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></a>
<a class="sourceLine" id="cb27-7" title="7"><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></a>
<a class="sourceLine" id="cb27-8" title="8"><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></a>
<a class="sourceLine" id="cb27-9" title="9"><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></a>
<a class="sourceLine" id="cb27-10" title="10"><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></a>
<a class="sourceLine" id="cb27-11" title="11"><span class="co">#&gt; # … with 9,367 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb27-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb27-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>

<div class="exercise">
<span id="exr:unnamed-chunk-31" class="exercise"><strong>Exercise 1.2  </strong></span>dep_time`有缺失值的航班有多少？其他变量的缺失值情况如何？
</div>

<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1"><span class="kw">sum</span>(<span class="kw">is.na</span>(flights<span class="op">$</span>dep_time))</a>
<a class="sourceLine" id="cb28-2" title="2"><span class="co">#&gt; [1] 8255</span></a>
<a class="sourceLine" id="cb28-3" title="3">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">is.na</span>(dep_time))</a>
<a class="sourceLine" id="cb28-4" title="4"><span class="co">#&gt; # A tibble: 8,255 x 19</span></a>
<a class="sourceLine" id="cb28-5" title="5"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb28-6" title="6"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb28-7" title="7"><span class="co">#&gt; 1  2013     1     1       NA           1630        NA       NA           1815</span></a>
<a class="sourceLine" id="cb28-8" title="8"><span class="co">#&gt; 2  2013     1     1       NA           1935        NA       NA           2240</span></a>
<a class="sourceLine" id="cb28-9" title="9"><span class="co">#&gt; 3  2013     1     1       NA           1500        NA       NA           1825</span></a>
<a class="sourceLine" id="cb28-10" title="10"><span class="co">#&gt; 4  2013     1     1       NA            600        NA       NA            901</span></a>
<a class="sourceLine" id="cb28-11" title="11"><span class="co">#&gt; 5  2013     1     2       NA           1540        NA       NA           1747</span></a>
<a class="sourceLine" id="cb28-12" title="12"><span class="co">#&gt; 6  2013     1     2       NA           1620        NA       NA           1746</span></a>
<a class="sourceLine" id="cb28-13" title="13"><span class="co">#&gt; # … with 8,249 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb28-14" title="14"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb28-15" title="15"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>注意到，所有<code>dep_time</code>为 NA 的航班在有关实际到达、出发情况的变量上取值皆为 NA，这些很可能是被取消的航班。</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1"><span class="co"># 其他变量中的缺失值</span></a>
<a class="sourceLine" id="cb29-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb29-3" title="3"><span class="st">  </span><span class="kw">summarize_all</span>( <span class="op">~</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">is.na</span>(.)))</a>
<a class="sourceLine" id="cb29-4" title="4"><span class="co">#&gt; # A tibble: 1 x 19</span></a>
<a class="sourceLine" id="cb29-5" title="5"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb29-6" title="6"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;int&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb29-7" title="7"><span class="co">#&gt; 1     0     0     0     8255              0      8255     8713              0</span></a>
<a class="sourceLine" id="cb29-8" title="8"><span class="co">#&gt; # … with 11 more variables: arr_delay &lt;int&gt;, carrier &lt;int&gt;, flight &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb29-9" title="9"><span class="co">#&gt; #   tailnum &lt;int&gt;, origin &lt;int&gt;, dest &lt;int&gt;, air_time &lt;int&gt;, distance &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb29-10" title="10"><span class="co">#&gt; #   hour &lt;int&gt;, minute &lt;int&gt;, time_hour &lt;int&gt;</span></a></code></pre></div>
<blockquote>
<ol start="3" style="list-style-type: decimal">
<li>为什么<code>NA ^ 0</code>的值不是NA，而<code>NA * 0</code>的值是NA ？为什么NA | TRUE 的值不是NA？为什么FALSE &amp; NA的值不是NA，能找出一般规律吗？</li>
</ol>
</blockquote>
<p><strong>只要表达式的值被NA背后的未知量所决定，就返回NA</strong>
对于所有x的取值，都有<span class="math inline">\(x ^ 0 = 1\)</span>，<code>NA ^ 0</code>不取决于 NA 到底可能是什么值。<br />
但对于<span class="math inline">\(x * 0\)</span>，如果x趋近于正负无穷（ R 用<code>-inf</code> 和 <code>inf</code>代表），则R会返回 <code>NaN</code> 错误（not a number），只要知道 NA 究竟是什么，才能知道该表达式的结果</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1"><span class="ot">NA</span> <span class="op">^</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb30-2" title="2"><span class="co">#&gt; [1] 1</span></a>
<a class="sourceLine" id="cb30-3" title="3"><span class="ot">NA</span> <span class="op">*</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb30-4" title="4"><span class="co">#&gt; [1] NA</span></a>
<a class="sourceLine" id="cb30-5" title="5"><span class="kw">c</span>(<span class="ot">Inf</span>,<span class="op">-</span><span class="ot">Inf</span>) <span class="op">*</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb30-6" title="6"><span class="co">#&gt; [1] NaN NaN</span></a></code></pre></div>
<p>同样，对于 <code>NA | TRUE</code>，不论 NA 是什么，该表达式总为真 ； 对于<code>NA &amp; FALSE</code>，不论 NA 是什么，该表达式总为假。</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1"><span class="ot">NA</span> <span class="op">|</span><span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb31-2" title="2"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb31-3" title="3"><span class="ot">NA</span> <span class="op">&amp;</span><span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb31-4" title="4"><span class="co">#&gt; [1] FALSE</span></a></code></pre></div>
<p>而 <code>NA &amp; TRUE</code>和<code>NA | FALSE</code>则会返回 NA：</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1"><span class="ot">NA</span> <span class="op">&amp;</span><span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb32-2" title="2"><span class="co">#&gt; [1] NA</span></a>
<a class="sourceLine" id="cb32-3" title="3"><span class="ot">NA</span> <span class="op">|</span><span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb32-4" title="4"><span class="co">#&gt; [1] NA</span></a></code></pre></div>
</div>
</div>
<div id="arrange-排列行" class="section level2">
<h2><span class="header-section-number">1.3</span> <code>arrange()</code> 排列行</h2>
<p><code>arrange()</code>函数的工作方式与<code>filter()</code>函数非常相似，但它不是筛选行，而是改变行的顺序。它接受一个数据集和一组作为排序依据的列名（或者更复杂的表达式）作为参数，如果列名不止一个，那么就是用后面的列在前面排序的基础上继续排序：</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(year, month, day)  <span class="co">## 依次按照year/month/day三个变量按升序排序</span></a>
<a class="sourceLine" id="cb33-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 19</span></a>
<a class="sourceLine" id="cb33-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb33-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb33-5" title="5"><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></a>
<a class="sourceLine" id="cb33-6" title="6"><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></a>
<a class="sourceLine" id="cb33-7" title="7"><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></a>
<a class="sourceLine" id="cb33-8" title="8"><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></a>
<a class="sourceLine" id="cb33-9" title="9"><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></a>
<a class="sourceLine" id="cb33-10" title="10"><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></a>
<a class="sourceLine" id="cb33-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb33-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb33-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>如果想要按某列降序排列行，可以对该列名使用函数<code>desc()</code>：</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(arr_delay))  <span class="co">## 按照到达延误时间从大到小排序</span></a>
<a class="sourceLine" id="cb34-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 19</span></a>
<a class="sourceLine" id="cb34-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb34-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb34-5" title="5"><span class="co">#&gt; 1  2013     1     9      641            900      1301     1242           1530</span></a>
<a class="sourceLine" id="cb34-6" title="6"><span class="co">#&gt; 2  2013     6    15     1432           1935      1137     1607           2120</span></a>
<a class="sourceLine" id="cb34-7" title="7"><span class="co">#&gt; 3  2013     1    10     1121           1635      1126     1239           1810</span></a>
<a class="sourceLine" id="cb34-8" title="8"><span class="co">#&gt; 4  2013     9    20     1139           1845      1014     1457           2210</span></a>
<a class="sourceLine" id="cb34-9" title="9"><span class="co">#&gt; 5  2013     7    22      845           1600      1005     1044           1815</span></a>
<a class="sourceLine" id="cb34-10" title="10"><span class="co">#&gt; 6  2013     4    10     1100           1900       960     1342           2211</span></a>
<a class="sourceLine" id="cb34-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb34-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb34-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>缺失值总是排在最后：</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">2</span>, <span class="ot">NA</span>))</a>
<a class="sourceLine" id="cb35-2" title="2">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(x)</a>
<a class="sourceLine" id="cb35-3" title="3"><span class="co">#&gt; # A tibble: 3 x 1</span></a>
<a class="sourceLine" id="cb35-4" title="4"><span class="co">#&gt;       x</span></a>
<a class="sourceLine" id="cb35-5" title="5"><span class="co">#&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb35-6" title="6"><span class="co">#&gt; 1     2</span></a>
<a class="sourceLine" id="cb35-7" title="7"><span class="co">#&gt; 2     5</span></a>
<a class="sourceLine" id="cb35-8" title="8"><span class="co">#&gt; 3    NA</span></a></code></pre></div>
<p>如果参数是一个关于某些列的表达式<code>expression(variable_n)</code>，它的意思是告诉<code>arrange()</code>：“按照各行在这个表达式上的取值的从小到大的顺序，排列<strong>原来的</strong>数据集。</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>((dep_delay <span class="op">**</span><span class="st"> </span><span class="dv">2</span>))   <span class="co">## dep_delay的绝对值小的行被排在前面</span></a>
<a class="sourceLine" id="cb36-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 19</span></a>
<a class="sourceLine" id="cb36-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb36-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb36-5" title="5"><span class="co">#&gt; 1  2013     1     1      559            559         0      702            706</span></a>
<a class="sourceLine" id="cb36-6" title="6"><span class="co">#&gt; 2  2013     1     1      600            600         0      851            858</span></a>
<a class="sourceLine" id="cb36-7" title="7"><span class="co">#&gt; 3  2013     1     1      600            600         0      837            825</span></a>
<a class="sourceLine" id="cb36-8" title="8"><span class="co">#&gt; 4  2013     1     1      607            607         0      858            915</span></a>
<a class="sourceLine" id="cb36-9" title="9"><span class="co">#&gt; 5  2013     1     1      615            615         0     1039           1100</span></a>
<a class="sourceLine" id="cb36-10" title="10"><span class="co">#&gt; 6  2013     1     1      615            615         0      833            842</span></a>
<a class="sourceLine" id="cb36-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb36-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>例如，我们希望找到总延误时间(dep_delay + arr_delay)最长的航班</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1"><span class="co">## 延误时间最长的航班</span></a>
<a class="sourceLine" id="cb37-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(arr_delay <span class="op">+</span><span class="st"> </span>dep_delay))</a>
<a class="sourceLine" id="cb37-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 19</span></a>
<a class="sourceLine" id="cb37-4" title="4"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb37-5" title="5"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb37-6" title="6"><span class="co">#&gt; 1  2013     1     9      641            900      1301     1242           1530</span></a>
<a class="sourceLine" id="cb37-7" title="7"><span class="co">#&gt; 2  2013     6    15     1432           1935      1137     1607           2120</span></a>
<a class="sourceLine" id="cb37-8" title="8"><span class="co">#&gt; 3  2013     1    10     1121           1635      1126     1239           1810</span></a>
<a class="sourceLine" id="cb37-9" title="9"><span class="co">#&gt; 4  2013     9    20     1139           1845      1014     1457           2210</span></a>
<a class="sourceLine" id="cb37-10" title="10"><span class="co">#&gt; 5  2013     7    22      845           1600      1005     1044           1815</span></a>
<a class="sourceLine" id="cb37-11" title="11"><span class="co">#&gt; 6  2013     4    10     1100           1900       960     1342           2211</span></a>
<a class="sourceLine" id="cb37-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb37-13" title="13"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb37-14" title="14"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>如果A行在两个量上的取值是(2,5)，B行是(1,10)，B会出现在A后面，因为<code>arrange()</code>按照这个表达式来进行排列。</p>
<div id="slice" class="section level3">
<h3><span class="header-section-number">1.3.1</span> <code>slice()</code></h3>
<p><code>slice()</code>函数按照索引选择指定的观测行，与传统的 “[” 选择方法相比，它与 dplyr 函数的配合更好，支持管道操作：</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" title="1"><span class="co">## 选择前5行</span></a>
<a class="sourceLine" id="cb38-2" title="2">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb38-3" title="3"><span class="co">#&gt;    mpg cyl disp  hp drat   wt qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb38-4" title="4"><span class="co">#&gt; 1 21.0   6  160 110 3.90 2.62 16.5  0  1    4    4</span></a>
<a class="sourceLine" id="cb38-5" title="5"><span class="co">#&gt; 2 21.0   6  160 110 3.90 2.88 17.0  0  1    4    4</span></a>
<a class="sourceLine" id="cb38-6" title="6"><span class="co">#&gt; 3 22.8   4  108  93 3.85 2.32 18.6  1  1    4    1</span></a>
<a class="sourceLine" id="cb38-7" title="7"><span class="co">#&gt; 4 21.4   6  258 110 3.08 3.21 19.4  1  0    3    1</span></a>
<a class="sourceLine" id="cb38-8" title="8"><span class="co">#&gt; 5 18.7   8  360 175 3.15 3.44 17.0  0  0    3    2</span></a>
<a class="sourceLine" id="cb38-9" title="9"><span class="co">## 选择最后一行,类似于tail(mtcars,1)</span></a>
<a class="sourceLine" id="cb38-10" title="10">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(1L)</a>
<a class="sourceLine" id="cb38-11" title="11"><span class="co">#&gt;   mpg cyl disp  hp drat   wt qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb38-12" title="12"><span class="co">#&gt; 1  21   6  160 110  3.9 2.62 16.5  0  1    4    4</span></a>
<a class="sourceLine" id="cb38-13" title="13"><span class="co"># Rows can be dropped with negative indices:</span></a>
<a class="sourceLine" id="cb38-14" title="14"><span class="kw">slice</span>(mtcars, <span class="dv">-5</span><span class="op">:-</span><span class="kw">n</span>())</a>
<a class="sourceLine" id="cb38-15" title="15"><span class="co">#&gt;    mpg cyl disp  hp drat   wt qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb38-16" title="16"><span class="co">#&gt; 1 21.0   6  160 110 3.90 2.62 16.5  0  1    4    4</span></a>
<a class="sourceLine" id="cb38-17" title="17"><span class="co">#&gt; 2 21.0   6  160 110 3.90 2.88 17.0  0  1    4    4</span></a>
<a class="sourceLine" id="cb38-18" title="18"><span class="co">#&gt; 3 22.8   4  108  93 3.85 2.32 18.6  1  1    4    1</span></a>
<a class="sourceLine" id="cb38-19" title="19"><span class="co">#&gt; 4 21.4   6  258 110 3.08 3.21 19.4  1  0    3    1</span></a>
<a class="sourceLine" id="cb38-20" title="20"><span class="co"># In this case, the result will be equivalent to:</span></a>
<a class="sourceLine" id="cb38-21" title="21"><span class="kw">slice</span>(mtcars, <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb38-22" title="22"><span class="co">#&gt;    mpg cyl disp  hp drat   wt qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb38-23" title="23"><span class="co">#&gt; 1 21.0   6  160 110 3.90 2.62 16.5  0  1    4    4</span></a>
<a class="sourceLine" id="cb38-24" title="24"><span class="co">#&gt; 2 21.0   6  160 110 3.90 2.88 17.0  0  1    4    4</span></a>
<a class="sourceLine" id="cb38-25" title="25"><span class="co">#&gt; 3 22.8   4  108  93 3.85 2.32 18.6  1  1    4    1</span></a>
<a class="sourceLine" id="cb38-26" title="26"><span class="co">#&gt; 4 21.4   6  258 110 3.08 3.21 19.4  1  0    3    1</span></a>
<a class="sourceLine" id="cb38-27" title="27"><span class="co"># Equivalent code using filter that will also work with databases,</span></a>
<a class="sourceLine" id="cb38-28" title="28"><span class="co"># but won&#39;t be as fast for in-memory data. For many databases, you&#39;ll</span></a>
<a class="sourceLine" id="cb38-29" title="29"><span class="co"># need to supply an explicit variable to use to compute the row number.</span></a>
<a class="sourceLine" id="cb38-30" title="30"><span class="kw">filter</span>(mtcars, <span class="kw">row_number</span>() <span class="op">==</span><span class="st"> </span>1L)</a>
<a class="sourceLine" id="cb38-31" title="31"><span class="co">#&gt;   mpg cyl disp  hp drat   wt qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb38-32" title="32"><span class="co">#&gt; 1  21   6  160 110  3.9 2.62 16.5  0  1    4    4</span></a>
<a class="sourceLine" id="cb38-33" title="33"><span class="kw">filter</span>(mtcars, <span class="kw">row_number</span>() <span class="op">==</span><span class="st"> </span><span class="kw">n</span>())</a>
<a class="sourceLine" id="cb38-34" title="34"><span class="co">#&gt;    mpg cyl disp  hp drat   wt qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb38-35" title="35"><span class="co">#&gt; 1 21.4   4  121 109 4.11 2.78 18.6  1  1    4    2</span></a>
<a class="sourceLine" id="cb38-36" title="36"><span class="kw">filter</span>(mtcars, <span class="kw">between</span>(<span class="kw">row_number</span>(), <span class="dv">5</span>, <span class="kw">n</span>()))</a>
<a class="sourceLine" id="cb38-37" title="37"><span class="co">#&gt;     mpg cyl  disp  hp drat   wt qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb38-38" title="38"><span class="co">#&gt; 1  18.7   8 360.0 175 3.15 3.44 17.0  0  0    3    2</span></a>
<a class="sourceLine" id="cb38-39" title="39"><span class="co">#&gt; 2  18.1   6 225.0 105 2.76 3.46 20.2  1  0    3    1</span></a>
<a class="sourceLine" id="cb38-40" title="40"><span class="co">#&gt; 3  14.3   8 360.0 245 3.21 3.57 15.8  0  0    3    4</span></a>
<a class="sourceLine" id="cb38-41" title="41"><span class="co">#&gt; 4  24.4   4 146.7  62 3.69 3.19 20.0  1  0    4    2</span></a>
<a class="sourceLine" id="cb38-42" title="42"><span class="co">#&gt; 5  22.8   4 140.8  95 3.92 3.15 22.9  1  0    4    2</span></a>
<a class="sourceLine" id="cb38-43" title="43"><span class="co">#&gt; 6  19.2   6 167.6 123 3.92 3.44 18.3  1  0    4    4</span></a>
<a class="sourceLine" id="cb38-44" title="44"><span class="co">#&gt; 7  17.8   6 167.6 123 3.92 3.44 18.9  1  0    4    4</span></a>
<a class="sourceLine" id="cb38-45" title="45"><span class="co">#&gt; 8  16.4   8 275.8 180 3.07 4.07 17.4  0  0    3    3</span></a>
<a class="sourceLine" id="cb38-46" title="46"><span class="co">#&gt; 9  17.3   8 275.8 180 3.07 3.73 17.6  0  0    3    3</span></a>
<a class="sourceLine" id="cb38-47" title="47"><span class="co">#&gt; 10 15.2   8 275.8 180 3.07 3.78 18.0  0  0    3    3</span></a>
<a class="sourceLine" id="cb38-48" title="48"><span class="co">#&gt; 11 10.4   8 472.0 205 2.93 5.25 18.0  0  0    3    4</span></a>
<a class="sourceLine" id="cb38-49" title="49"><span class="co">#&gt; 12 10.4   8 460.0 215 3.00 5.42 17.8  0  0    3    4</span></a>
<a class="sourceLine" id="cb38-50" title="50"><span class="co">#&gt; 13 14.7   8 440.0 230 3.23 5.34 17.4  0  0    3    4</span></a>
<a class="sourceLine" id="cb38-51" title="51"><span class="co">#&gt; 14 32.4   4  78.7  66 4.08 2.20 19.5  1  1    4    1</span></a>
<a class="sourceLine" id="cb38-52" title="52"><span class="co">#&gt; 15 30.4   4  75.7  52 4.93 1.61 18.5  1  1    4    2</span></a>
<a class="sourceLine" id="cb38-53" title="53"><span class="co">#&gt; 16 33.9   4  71.1  65 4.22 1.83 19.9  1  1    4    1</span></a>
<a class="sourceLine" id="cb38-54" title="54"><span class="co">#&gt; 17 21.5   4 120.1  97 3.70 2.46 20.0  1  0    3    1</span></a>
<a class="sourceLine" id="cb38-55" title="55"><span class="co">#&gt; 18 15.5   8 318.0 150 2.76 3.52 16.9  0  0    3    2</span></a>
<a class="sourceLine" id="cb38-56" title="56"><span class="co">#&gt; 19 15.2   8 304.0 150 3.15 3.44 17.3  0  0    3    2</span></a>
<a class="sourceLine" id="cb38-57" title="57"><span class="co">#&gt; 20 13.3   8 350.0 245 3.73 3.84 15.4  0  0    3    4</span></a>
<a class="sourceLine" id="cb38-58" title="58"><span class="co">#&gt; 21 19.2   8 400.0 175 3.08 3.85 17.1  0  0    3    2</span></a>
<a class="sourceLine" id="cb38-59" title="59"><span class="co">#&gt; 22 27.3   4  79.0  66 4.08 1.94 18.9  1  1    4    1</span></a>
<a class="sourceLine" id="cb38-60" title="60"><span class="co">#&gt; 23 26.0   4 120.3  91 4.43 2.14 16.7  0  1    5    2</span></a>
<a class="sourceLine" id="cb38-61" title="61"><span class="co">#&gt; 24 30.4   4  95.1 113 3.77 1.51 16.9  1  1    5    2</span></a>
<a class="sourceLine" id="cb38-62" title="62"><span class="co">#&gt; 25 15.8   8 351.0 264 4.22 3.17 14.5  0  1    5    4</span></a>
<a class="sourceLine" id="cb38-63" title="63"><span class="co">#&gt; 26 19.7   6 145.0 175 3.62 2.77 15.5  0  1    5    6</span></a>
<a class="sourceLine" id="cb38-64" title="64"><span class="co">#&gt; 27 15.0   8 301.0 335 3.54 3.57 14.6  0  1    5    8</span></a>
<a class="sourceLine" id="cb38-65" title="65"><span class="co">#&gt; 28 21.4   4 121.0 109 4.11 2.78 18.6  1  1    4    2</span></a></code></pre></div>
<p>当要求依据某种排序选出前/后n个观测时，<code>arrange()</code>配合<code>slice()</code>会很方便。例如，下面的代码都选出出发时间最早的10架航班，但是第一种方法更简单一些：</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1"><span class="co">## arrange + slice</span></a>
<a class="sourceLine" id="cb39-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(dep_time) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb39-3" title="3"><span class="co">#&gt; # A tibble: 10 x 19</span></a>
<a class="sourceLine" id="cb39-4" title="4"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb39-5" title="5"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb39-6" title="6"><span class="co">#&gt; 1  2013     1    13        1           2249        72      108           2357</span></a>
<a class="sourceLine" id="cb39-7" title="7"><span class="co">#&gt; 2  2013     1    31        1           2100       181      124           2225</span></a>
<a class="sourceLine" id="cb39-8" title="8"><span class="co">#&gt; 3  2013    11    13        1           2359         2      442            440</span></a>
<a class="sourceLine" id="cb39-9" title="9"><span class="co">#&gt; 4  2013    12    16        1           2359         2      447            437</span></a>
<a class="sourceLine" id="cb39-10" title="10"><span class="co">#&gt; 5  2013    12    20        1           2359         2      430            440</span></a>
<a class="sourceLine" id="cb39-11" title="11"><span class="co">#&gt; 6  2013    12    26        1           2359         2      437            440</span></a>
<a class="sourceLine" id="cb39-12" title="12"><span class="co">#&gt; # … with 4 more rows, and 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb39-13" title="13"><span class="co">#&gt; #   flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb39-14" title="14"><span class="co">#&gt; #   distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a>
<a class="sourceLine" id="cb39-15" title="15"><span class="co">## filter</span></a>
<a class="sourceLine" id="cb39-16" title="16">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">min_rank</span>(dep_time)<span class="op">&lt;=</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb39-17" title="17"><span class="co">#&gt; # A tibble: 25 x 19</span></a>
<a class="sourceLine" id="cb39-18" title="18"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb39-19" title="19"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb39-20" title="20"><span class="co">#&gt; 1  2013     1    13        1           2249        72      108           2357</span></a>
<a class="sourceLine" id="cb39-21" title="21"><span class="co">#&gt; 2  2013     1    31        1           2100       181      124           2225</span></a>
<a class="sourceLine" id="cb39-22" title="22"><span class="co">#&gt; 3  2013    11    13        1           2359         2      442            440</span></a>
<a class="sourceLine" id="cb39-23" title="23"><span class="co">#&gt; 4  2013    12    16        1           2359         2      447            437</span></a>
<a class="sourceLine" id="cb39-24" title="24"><span class="co">#&gt; 5  2013    12    20        1           2359         2      430            440</span></a>
<a class="sourceLine" id="cb39-25" title="25"><span class="co">#&gt; 6  2013    12    26        1           2359         2      437            440</span></a>
<a class="sourceLine" id="cb39-26" title="26"><span class="co">#&gt; # … with 19 more rows, and 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb39-27" title="27"><span class="co">#&gt; #   flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb39-28" title="28"><span class="co">#&gt; #   distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
</div>
<div id="练习-1" class="section level3">
<h3><span class="header-section-number">1.3.2</span> 练习</h3>

<div class="exercise">
<span id="exr:unnamed-chunk-44" class="exercise"><strong>Exercise 1.3  </strong></span>如何使用<code>arrange()</code>将缺失值排在最前面？（提示：使用is.na())<br />
例：把 flights 数据集中<code>dep_time</code>上的 NA 值排在最前面( to sort the data frame by departure time (dep_time) in ascending order but NA values first)
</div>

<p>首先<code>is.na(dep_time)</code>将把所有NA变为TRUE（1），其他数值变成FALSE（0），所以<code>desc(is.na(dep_time))</code>是一个排序依据,它告诉<code>arrange()</code>，把那些经过运算<code>is.na(dep_time)</code>后值大的行排在前面，即原先的NA值 ； 之后，我们还要处理那些不是NA的值的排列，所以添加一个参数<code>dep_time</code>：</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(<span class="kw">is.na</span>(dep_time)), dep_time)</a>
<a class="sourceLine" id="cb40-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 19</span></a>
<a class="sourceLine" id="cb40-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb40-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb40-5" title="5"><span class="co">#&gt; 1  2013     1     1       NA           1630        NA       NA           1815</span></a>
<a class="sourceLine" id="cb40-6" title="6"><span class="co">#&gt; 2  2013     1     1       NA           1935        NA       NA           2240</span></a>
<a class="sourceLine" id="cb40-7" title="7"><span class="co">#&gt; 3  2013     1     1       NA           1500        NA       NA           1825</span></a>
<a class="sourceLine" id="cb40-8" title="8"><span class="co">#&gt; 4  2013     1     1       NA            600        NA       NA            901</span></a>
<a class="sourceLine" id="cb40-9" title="9"><span class="co">#&gt; 5  2013     1     2       NA           1540        NA       NA           1747</span></a>
<a class="sourceLine" id="cb40-10" title="10"><span class="co">#&gt; 6  2013     1     2       NA           1620        NA       NA           1746</span></a>
<a class="sourceLine" id="cb40-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb40-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb40-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>

<div class="exercise">
<p><span id="exr:unnamed-chunk-46" class="exercise"><strong>Exercise 1.4  </strong></span>对<code>flights</code>排序以找出延误时间最长的航班。找出出发时间最早的航班。</p>
</div>

<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" title="1"><span class="co">## 延误时间最长的航班</span></a>
<a class="sourceLine" id="cb41-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(dep_delay))</a>
<a class="sourceLine" id="cb41-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 19</span></a>
<a class="sourceLine" id="cb41-4" title="4"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb41-5" title="5"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb41-6" title="6"><span class="co">#&gt; 1  2013     1     9      641            900      1301     1242           1530</span></a>
<a class="sourceLine" id="cb41-7" title="7"><span class="co">#&gt; 2  2013     6    15     1432           1935      1137     1607           2120</span></a>
<a class="sourceLine" id="cb41-8" title="8"><span class="co">#&gt; 3  2013     1    10     1121           1635      1126     1239           1810</span></a>
<a class="sourceLine" id="cb41-9" title="9"><span class="co">#&gt; 4  2013     9    20     1139           1845      1014     1457           2210</span></a>
<a class="sourceLine" id="cb41-10" title="10"><span class="co">#&gt; 5  2013     7    22      845           1600      1005     1044           1815</span></a>
<a class="sourceLine" id="cb41-11" title="11"><span class="co">#&gt; 6  2013     4    10     1100           1900       960     1342           2211</span></a>
<a class="sourceLine" id="cb41-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb41-13" title="13"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb41-14" title="14"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" title="1"><span class="co">## 出发时间最早的航班</span></a>
<a class="sourceLine" id="cb42-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(dep_time)</a>
<a class="sourceLine" id="cb42-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 19</span></a>
<a class="sourceLine" id="cb42-4" title="4"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb42-5" title="5"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb42-6" title="6"><span class="co">#&gt; 1  2013     1    13        1           2249        72      108           2357</span></a>
<a class="sourceLine" id="cb42-7" title="7"><span class="co">#&gt; 2  2013     1    31        1           2100       181      124           2225</span></a>
<a class="sourceLine" id="cb42-8" title="8"><span class="co">#&gt; 3  2013    11    13        1           2359         2      442            440</span></a>
<a class="sourceLine" id="cb42-9" title="9"><span class="co">#&gt; 4  2013    12    16        1           2359         2      447            437</span></a>
<a class="sourceLine" id="cb42-10" title="10"><span class="co">#&gt; 5  2013    12    20        1           2359         2      430            440</span></a>
<a class="sourceLine" id="cb42-11" title="11"><span class="co">#&gt; 6  2013    12    26        1           2359         2      437            440</span></a>
<a class="sourceLine" id="cb42-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb42-13" title="13"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb42-14" title="14"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>

<div class="exercise">
<p><span id="exr:unnamed-chunk-49" class="exercise"><strong>Exercise 1.5  </strong></span>对<code>flights</code>排序以找出速度最快的航班</p>
</div>

<p>这个排序条件需要用到表达式，<code>速度 = distance / air_time</code></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(distance <span class="op">/</span><span class="st"> </span>air_time)</a>
<a class="sourceLine" id="cb43-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 19</span></a>
<a class="sourceLine" id="cb43-3" title="3"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb43-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb43-5" title="5"><span class="co">#&gt; 1  2013     1    28     1917           1825        52     2118           1935</span></a>
<a class="sourceLine" id="cb43-6" title="6"><span class="co">#&gt; 2  2013     6    29      755            800        -5     1035            909</span></a>
<a class="sourceLine" id="cb43-7" title="7"><span class="co">#&gt; 3  2013     8    28      932            940        -8     1116           1051</span></a>
<a class="sourceLine" id="cb43-8" title="8"><span class="co">#&gt; 4  2013     1    30     1037            955        42     1221           1100</span></a>
<a class="sourceLine" id="cb43-9" title="9"><span class="co">#&gt; 5  2013    11    27      556            600        -4      727            658</span></a>
<a class="sourceLine" id="cb43-10" title="10"><span class="co">#&gt; 6  2013     5    21      558            600        -2      721            657</span></a>
<a class="sourceLine" id="cb43-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb43-12" title="12"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb43-13" title="13"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
</div>
</div>
<div id="使用select选择列" class="section level2">
<h2><span class="header-section-number">1.4</span> 使用<code>select()</code>选择列</h2>
<p>如今，数据集有几百个甚至几千个变量已经司空见惯。这种情况下，如何找出真正感兴趣的变量经常是一个挑战。通过基于变量名的操作，<code>select()</code>函数可以让我们快速生成一个有用的变量子集。</p>
<p>虽然航班数据只有 19 个变量，但还是可以用来了解一下<code>select()</code>函数的大致用法：</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" title="1"><span class="co">## 只选择year,month,day 三个变量</span></a>
<a class="sourceLine" id="cb44-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(year, month, day)</a>
<a class="sourceLine" id="cb44-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 3</span></a>
<a class="sourceLine" id="cb44-4" title="4"><span class="co">#&gt;    year month   day</span></a>
<a class="sourceLine" id="cb44-5" title="5"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb44-6" title="6"><span class="co">#&gt; 1  2013     1     1</span></a>
<a class="sourceLine" id="cb44-7" title="7"><span class="co">#&gt; 2  2013     1     1</span></a>
<a class="sourceLine" id="cb44-8" title="8"><span class="co">#&gt; 3  2013     1     1</span></a>
<a class="sourceLine" id="cb44-9" title="9"><span class="co">#&gt; 4  2013     1     1</span></a>
<a class="sourceLine" id="cb44-10" title="10"><span class="co">#&gt; 5  2013     1     1</span></a>
<a class="sourceLine" id="cb44-11" title="11"><span class="co">#&gt; 6  2013     1     1</span></a>
<a class="sourceLine" id="cb44-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<p>顺便说一句，如果把变量名变成字符串或者它在所有变量中的顺序也可以正常工作,如<code>flights %&gt;% select("year", "month", "day")</code>和<code>flights %&gt;% select(1, 2, 3)</code>和上面代码会返回一样结果，但是这两种方法都不值得推荐。</p>
<p>当希望选择的列比较多时，可以先用一个向量储存，但用向量储存的必须是字符串形式的列名：</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" title="1">vars =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;arr_delay&quot;</span>, <span class="st">&quot;dep_delay&quot;</span>)</a>
<a class="sourceLine" id="cb45-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(vars)</a>
<a class="sourceLine" id="cb45-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 2</span></a>
<a class="sourceLine" id="cb45-4" title="4"><span class="co">#&gt;   arr_delay dep_delay</span></a>
<a class="sourceLine" id="cb45-5" title="5"><span class="co">#&gt;       &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb45-6" title="6"><span class="co">#&gt; 1        11         2</span></a>
<a class="sourceLine" id="cb45-7" title="7"><span class="co">#&gt; 2        20         4</span></a>
<a class="sourceLine" id="cb45-8" title="8"><span class="co">#&gt; 3        33         2</span></a>
<a class="sourceLine" id="cb45-9" title="9"><span class="co">#&gt; 4       -18        -1</span></a>
<a class="sourceLine" id="cb45-10" title="10"><span class="co">#&gt; 5       -25        -6</span></a>
<a class="sourceLine" id="cb45-11" title="11"><span class="co">#&gt; 6        12        -4</span></a>
<a class="sourceLine" id="cb45-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<p>另一个问题是，如果<code>vars</code>本身就是一个变量名，<code>select()</code>函数将会只选择出<code>vars</code>这一类，而不会读取其中的值，在前面加上操作符<code>!!!</code>将会使<code>select()</code>按照我们希望的那样工作。</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" title="1">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">vars =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), </a>
<a class="sourceLine" id="cb46-2" title="2">             <span class="dt">number_1 =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>),</a>
<a class="sourceLine" id="cb46-3" title="3">             <span class="dt">number_2 =</span> <span class="kw">c</span>(<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>))</a>
<a class="sourceLine" id="cb46-4" title="4">vars =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;number_1&quot;</span>,<span class="st">&quot;number_2&quot;</span>)</a>
<a class="sourceLine" id="cb46-5" title="5"><span class="co">## 希望选取number_1和number_2两列的错误做法</span></a>
<a class="sourceLine" id="cb46-6" title="6">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(vars)</a>
<a class="sourceLine" id="cb46-7" title="7"><span class="co">#&gt; # A tibble: 3 x 1</span></a>
<a class="sourceLine" id="cb46-8" title="8"><span class="co">#&gt;    vars</span></a>
<a class="sourceLine" id="cb46-9" title="9"><span class="co">#&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb46-10" title="10"><span class="co">#&gt; 1     1</span></a>
<a class="sourceLine" id="cb46-11" title="11"><span class="co">#&gt; 2     2</span></a>
<a class="sourceLine" id="cb46-12" title="12"><span class="co">#&gt; 3     3</span></a>
<a class="sourceLine" id="cb46-13" title="13"><span class="co">## 正确做法</span></a>
<a class="sourceLine" id="cb46-14" title="14">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">!!!</span>vars)</a>
<a class="sourceLine" id="cb46-15" title="15"><span class="co">#&gt; # A tibble: 3 x 2</span></a>
<a class="sourceLine" id="cb46-16" title="16"><span class="co">#&gt;   number_1 number_2</span></a>
<a class="sourceLine" id="cb46-17" title="17"><span class="co">#&gt;      &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb46-18" title="18"><span class="co">#&gt; 1        4        7</span></a>
<a class="sourceLine" id="cb46-19" title="19"><span class="co">#&gt; 2        5        8</span></a>
<a class="sourceLine" id="cb46-20" title="20"><span class="co">#&gt; 3        6        9</span></a></code></pre></div>
<p><code>select()</code> 还可以重命名变量，但我们很少这样使用它，因为这样会丢掉所有未明确提及的变量。我们应该使用<code>select()</code> 函数的变体 <code>rename()</code> 函数来重命名变量，它会把未提及的那些变量按照原名字放到生成的数据框里：</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" title="1"><span class="co">## 将tail_num 重命名为tailnum</span></a>
<a class="sourceLine" id="cb47-2" title="2"><span class="kw">rename</span>(flights, <span class="dt">tail_num =</span> tailnum)</a>
<a class="sourceLine" id="cb47-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 19</span></a>
<a class="sourceLine" id="cb47-4" title="4"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb47-5" title="5"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb47-6" title="6"><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></a>
<a class="sourceLine" id="cb47-7" title="7"><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></a>
<a class="sourceLine" id="cb47-8" title="8"><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></a>
<a class="sourceLine" id="cb47-9" title="9"><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></a>
<a class="sourceLine" id="cb47-10" title="10"><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></a>
<a class="sourceLine" id="cb47-11" title="11"><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></a>
<a class="sourceLine" id="cb47-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb47-13" title="13"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tail_num &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb47-14" title="14"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>其他常见的<code>select()</code>函数用法如下所示：</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" title="1"><span class="co">## 选择“year”和“day”之间的所有变量，使用冒号</span></a>
<a class="sourceLine" id="cb48-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(year<span class="op">:</span>day)</a>
<a class="sourceLine" id="cb48-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 3</span></a>
<a class="sourceLine" id="cb48-4" title="4"><span class="co">#&gt;    year month   day</span></a>
<a class="sourceLine" id="cb48-5" title="5"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb48-6" title="6"><span class="co">#&gt; 1  2013     1     1</span></a>
<a class="sourceLine" id="cb48-7" title="7"><span class="co">#&gt; 2  2013     1     1</span></a>
<a class="sourceLine" id="cb48-8" title="8"><span class="co">#&gt; 3  2013     1     1</span></a>
<a class="sourceLine" id="cb48-9" title="9"><span class="co">#&gt; 4  2013     1     1</span></a>
<a class="sourceLine" id="cb48-10" title="10"><span class="co">#&gt; 5  2013     1     1</span></a>
<a class="sourceLine" id="cb48-11" title="11"><span class="co">#&gt; 6  2013     1     1</span></a>
<a class="sourceLine" id="cb48-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" title="1"><span class="co">## 选择不在“year”和“day”之间的所有列，使用减号</span></a>
<a class="sourceLine" id="cb49-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>(year<span class="op">:</span>day))</a>
<a class="sourceLine" id="cb49-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 16</span></a>
<a class="sourceLine" id="cb49-4" title="4"><span class="co">#&gt;   dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay carrier</span></a>
<a class="sourceLine" id="cb49-5" title="5"><span class="co">#&gt;      &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt; &lt;chr&gt;  </span></a>
<a class="sourceLine" id="cb49-6" title="6"><span class="co">#&gt; 1      517            515         2      830            819        11 UA     </span></a>
<a class="sourceLine" id="cb49-7" title="7"><span class="co">#&gt; 2      533            529         4      850            830        20 UA     </span></a>
<a class="sourceLine" id="cb49-8" title="8"><span class="co">#&gt; 3      542            540         2      923            850        33 AA     </span></a>
<a class="sourceLine" id="cb49-9" title="9"><span class="co">#&gt; 4      544            545        -1     1004           1022       -18 B6     </span></a>
<a class="sourceLine" id="cb49-10" title="10"><span class="co">#&gt; 5      554            600        -6      812            837       -25 DL     </span></a>
<a class="sourceLine" id="cb49-11" title="11"><span class="co">#&gt; 6      554            558        -4      740            728        12 UA     </span></a>
<a class="sourceLine" id="cb49-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows, and 9 more variables: flight &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb49-13" title="13"><span class="co">#&gt; #   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb49-14" title="14"><span class="co">#&gt; #   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
<p>还可以在<code>select()</code>函数中使用一些辅助函数：<br />
* <code>starts_with("abc")</code>：匹配以名字以“abc”开头的列</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;arr&quot;</span>))  <span class="co">## 所有以arr开头的列</span></a>
<a class="sourceLine" id="cb50-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 2</span></a>
<a class="sourceLine" id="cb50-3" title="3"><span class="co">#&gt;   arr_time arr_delay</span></a>
<a class="sourceLine" id="cb50-4" title="4"><span class="co">#&gt;      &lt;int&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb50-5" title="5"><span class="co">#&gt; 1      830        11</span></a>
<a class="sourceLine" id="cb50-6" title="6"><span class="co">#&gt; 2      850        20</span></a>
<a class="sourceLine" id="cb50-7" title="7"><span class="co">#&gt; 3      923        33</span></a>
<a class="sourceLine" id="cb50-8" title="8"><span class="co">#&gt; 4     1004       -18</span></a>
<a class="sourceLine" id="cb50-9" title="9"><span class="co">#&gt; 5      812       -25</span></a>
<a class="sourceLine" id="cb50-10" title="10"><span class="co">#&gt; 6      740        12</span></a>
<a class="sourceLine" id="cb50-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<ul>
<li><code>ends_with("xyz")</code>: 匹配名字以“xyz”结尾的列</li>
</ul>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" title="1"><span class="co">## 所有以&quot;delay&quot;结尾的列</span></a>
<a class="sourceLine" id="cb51-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;delay&quot;</span>))</a>
<a class="sourceLine" id="cb51-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 2</span></a>
<a class="sourceLine" id="cb51-4" title="4"><span class="co">#&gt;   dep_delay arr_delay</span></a>
<a class="sourceLine" id="cb51-5" title="5"><span class="co">#&gt;       &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb51-6" title="6"><span class="co">#&gt; 1         2        11</span></a>
<a class="sourceLine" id="cb51-7" title="7"><span class="co">#&gt; 2         4        20</span></a>
<a class="sourceLine" id="cb51-8" title="8"><span class="co">#&gt; 3         2        33</span></a>
<a class="sourceLine" id="cb51-9" title="9"><span class="co">#&gt; 4        -1       -18</span></a>
<a class="sourceLine" id="cb51-10" title="10"><span class="co">#&gt; 5        -6       -25</span></a>
<a class="sourceLine" id="cb51-11" title="11"><span class="co">#&gt; 6        -4        12</span></a>
<a class="sourceLine" id="cb51-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<ul>
<li><code>contains("ijk")</code>，匹配名字包含“ijk”的列</li>
</ul>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" title="1"><span class="co">## 所有包含&quot;time&quot;的列</span></a>
<a class="sourceLine" id="cb52-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">contains</span>(<span class="st">&quot;time&quot;</span>))</a>
<a class="sourceLine" id="cb52-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 6</span></a>
<a class="sourceLine" id="cb52-4" title="4"><span class="co">#&gt;   dep_time sched_dep_time arr_time sched_arr_time air_time time_hour          </span></a>
<a class="sourceLine" id="cb52-5" title="5"><span class="co">#&gt;      &lt;int&gt;          &lt;int&gt;    &lt;int&gt;          &lt;int&gt;    &lt;dbl&gt; &lt;dttm&gt;             </span></a>
<a class="sourceLine" id="cb52-6" title="6"><span class="co">#&gt; 1      517            515      830            819      227 2013-01-01 05:00:00</span></a>
<a class="sourceLine" id="cb52-7" title="7"><span class="co">#&gt; 2      533            529      850            830      227 2013-01-01 05:00:00</span></a>
<a class="sourceLine" id="cb52-8" title="8"><span class="co">#&gt; 3      542            540      923            850      160 2013-01-01 05:00:00</span></a>
<a class="sourceLine" id="cb52-9" title="9"><span class="co">#&gt; 4      544            545     1004           1022      183 2013-01-01 05:00:00</span></a>
<a class="sourceLine" id="cb52-10" title="10"><span class="co">#&gt; 5      554            600      812            837      116 2013-01-01 06:00:00</span></a>
<a class="sourceLine" id="cb52-11" title="11"><span class="co">#&gt; 6      554            558      740            728      150 2013-01-01 05:00:00</span></a>
<a class="sourceLine" id="cb52-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<ul>
<li><code>matches("(.)\\1")</code>：选择名字符合正则表达式要求的列，后面将具体讲述正则表达式<br />
</li>
<li><code>num_range("x",c(1,2,3))</code>，选择名字为“x1”、“x2”、“x3”的列</li>
</ul>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" title="1">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">x1 =</span> <span class="dv">1</span>,<span class="dt">x2 =</span> <span class="dv">2</span>,<span class="dt">x3 =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb53-2" title="2">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">num_range</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>))</a>
<a class="sourceLine" id="cb53-3" title="3"><span class="co">#&gt; # A tibble: 1 x 0</span></a></code></pre></div>
<ul>
<li><code>one_of(character_1,···,character_n)</code>:如果某个列的名字出现在序列里，则选出它</li>
</ul>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">one_of</span>(<span class="st">&quot;arr_delay&quot;</span>, <span class="st">&quot;dep_delay&quot;</span>, <span class="st">&quot;xyz&quot;</span>))</a>
<a class="sourceLine" id="cb54-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 2</span></a>
<a class="sourceLine" id="cb54-3" title="3"><span class="co">#&gt;   arr_delay dep_delay</span></a>
<a class="sourceLine" id="cb54-4" title="4"><span class="co">#&gt;       &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb54-5" title="5"><span class="co">#&gt; 1        11         2</span></a>
<a class="sourceLine" id="cb54-6" title="6"><span class="co">#&gt; 2        20         4</span></a>
<a class="sourceLine" id="cb54-7" title="7"><span class="co">#&gt; 3        33         2</span></a>
<a class="sourceLine" id="cb54-8" title="8"><span class="co">#&gt; 4       -18        -1</span></a>
<a class="sourceLine" id="cb54-9" title="9"><span class="co">#&gt; 5       -25        -6</span></a>
<a class="sourceLine" id="cb54-10" title="10"><span class="co">#&gt; 6        12        -4</span></a>
<a class="sourceLine" id="cb54-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<ul>
<li><code>everything()</code>：匹配所有(剩余)变量，当想要将几个变量移到数据集开头时，这种方法很有用</li>
</ul>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" title="1"><span class="co">## 将time_hour和air_time两个变量移到flights数据的开头</span></a>
<a class="sourceLine" id="cb55-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(time_hour,air_time, <span class="kw">everything</span>())</a>
<a class="sourceLine" id="cb55-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 19</span></a>
<a class="sourceLine" id="cb55-4" title="4"><span class="co">#&gt;   time_hour           air_time  year month   day dep_time sched_dep_time</span></a>
<a class="sourceLine" id="cb55-5" title="5"><span class="co">#&gt;   &lt;dttm&gt;                 &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb55-6" title="6"><span class="co">#&gt; 1 2013-01-01 05:00:00      227  2013     1     1      517            515</span></a>
<a class="sourceLine" id="cb55-7" title="7"><span class="co">#&gt; 2 2013-01-01 05:00:00      227  2013     1     1      533            529</span></a>
<a class="sourceLine" id="cb55-8" title="8"><span class="co">#&gt; 3 2013-01-01 05:00:00      160  2013     1     1      542            540</span></a>
<a class="sourceLine" id="cb55-9" title="9"><span class="co">#&gt; 4 2013-01-01 05:00:00      183  2013     1     1      544            545</span></a>
<a class="sourceLine" id="cb55-10" title="10"><span class="co">#&gt; 5 2013-01-01 06:00:00      116  2013     1     1      554            600</span></a>
<a class="sourceLine" id="cb55-11" title="11"><span class="co">#&gt; 6 2013-01-01 05:00:00      150  2013     1     1      554            558</span></a>
<a class="sourceLine" id="cb55-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows, and 12 more variables: dep_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb55-13" title="13"><span class="co">#&gt; #   arr_time &lt;int&gt;, sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb55-14" title="14"><span class="co">#&gt; #   flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, distance &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb55-15" title="15"><span class="co">#&gt; #   hour &lt;dbl&gt;, minute &lt;dbl&gt;</span></a></code></pre></div>
<ul>
<li><code>last_col(offset = n)</code>：选择倒数第n列，不设置offset时，默认选择最后一列</li>
</ul>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">last_col</span>())</a>
<a class="sourceLine" id="cb56-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 1</span></a>
<a class="sourceLine" id="cb56-3" title="3"><span class="co">#&gt;   time_hour          </span></a>
<a class="sourceLine" id="cb56-4" title="4"><span class="co">#&gt;   &lt;dttm&gt;             </span></a>
<a class="sourceLine" id="cb56-5" title="5"><span class="co">#&gt; 1 2013-01-01 05:00:00</span></a>
<a class="sourceLine" id="cb56-6" title="6"><span class="co">#&gt; 2 2013-01-01 05:00:00</span></a>
<a class="sourceLine" id="cb56-7" title="7"><span class="co">#&gt; 3 2013-01-01 05:00:00</span></a>
<a class="sourceLine" id="cb56-8" title="8"><span class="co">#&gt; 4 2013-01-01 05:00:00</span></a>
<a class="sourceLine" id="cb56-9" title="9"><span class="co">#&gt; 5 2013-01-01 06:00:00</span></a>
<a class="sourceLine" id="cb56-10" title="10"><span class="co">#&gt; 6 2013-01-01 05:00:00</span></a>
<a class="sourceLine" id="cb56-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<p>利用这些帮助函数，我们可以为选择列设置任意数目的条件，<code>select()</code>中以逗号分隔的列表示<strong>“或”</strong> 关系，如：</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" title="1"><span class="co">## 找出以“arr”开头或者以“time”结尾的列</span></a>
<a class="sourceLine" id="cb57-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;arr&quot;</span>), <span class="kw">ends_with</span>(<span class="st">&quot;time&quot;</span>))</a>
<a class="sourceLine" id="cb57-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 6</span></a>
<a class="sourceLine" id="cb57-4" title="4"><span class="co">#&gt;   arr_time arr_delay dep_time sched_dep_time sched_arr_time air_time</span></a>
<a class="sourceLine" id="cb57-5" title="5"><span class="co">#&gt;      &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;          &lt;int&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb57-6" title="6"><span class="co">#&gt; 1      830        11      517            515            819      227</span></a>
<a class="sourceLine" id="cb57-7" title="7"><span class="co">#&gt; 2      850        20      533            529            830      227</span></a>
<a class="sourceLine" id="cb57-8" title="8"><span class="co">#&gt; 3      923        33      542            540            850      160</span></a>
<a class="sourceLine" id="cb57-9" title="9"><span class="co">#&gt; 4     1004       -18      544            545           1022      183</span></a>
<a class="sourceLine" id="cb57-10" title="10"><span class="co">#&gt; 5      812       -25      554            600            837      116</span></a>
<a class="sourceLine" id="cb57-11" title="11"><span class="co">#&gt; 6      740        12      554            558            728      150</span></a>
<a class="sourceLine" id="cb57-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<p><strong>注意</strong>
所有帮助函数都忽略大小写，如下所示</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;DELAY&quot;</span>))</a>
<a class="sourceLine" id="cb58-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 2</span></a>
<a class="sourceLine" id="cb58-3" title="3"><span class="co">#&gt;   dep_delay arr_delay</span></a>
<a class="sourceLine" id="cb58-4" title="4"><span class="co">#&gt;       &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb58-5" title="5"><span class="co">#&gt; 1         2        11</span></a>
<a class="sourceLine" id="cb58-6" title="6"><span class="co">#&gt; 2         4        20</span></a>
<a class="sourceLine" id="cb58-7" title="7"><span class="co">#&gt; 3         2        33</span></a>
<a class="sourceLine" id="cb58-8" title="8"><span class="co">#&gt; 4        -1       -18</span></a>
<a class="sourceLine" id="cb58-9" title="9"><span class="co">#&gt; 5        -6       -25</span></a>
<a class="sourceLine" id="cb58-10" title="10"><span class="co">#&gt; 6        -4        12</span></a>
<a class="sourceLine" id="cb58-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<p>如果要区分大小写，可以设置任意帮助函数的参数<code>ignore.case = FALSE</code></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;DELAY&quot;</span>,<span class="dt">ignore.case =</span> F))   <span class="co">## 将不会选择出任何列</span></a>
<a class="sourceLine" id="cb59-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 0</span></a></code></pre></div>
<div id="练习-2" class="section level3">
<h3><span class="header-section-number">1.4.1</span> 练习</h3>

<div class="exercise">
<p><span id="exr:unnamed-chunk-67" class="exercise"><strong>Exercise 1.6  </strong></span>从flights数据集中选择<code>dep_time、dep_delay、arr_time、arr_delay</code>，找出尽可能多的方法</p>
</div>

<p>先查看这些变量的位置：</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" title="1"><span class="kw">glimpse</span>(flights)</a>
<a class="sourceLine" id="cb60-2" title="2"><span class="co">#&gt; Observations: 336,776</span></a>
<a class="sourceLine" id="cb60-3" title="3"><span class="co">#&gt; Variables: 19</span></a>
<a class="sourceLine" id="cb60-4" title="4"><span class="co">#&gt; $ year           &lt;int&gt; 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, …</span></a>
<a class="sourceLine" id="cb60-5" title="5"><span class="co">#&gt; $ month          &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span></a>
<a class="sourceLine" id="cb60-6" title="6"><span class="co">#&gt; $ day            &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span></a>
<a class="sourceLine" id="cb60-7" title="7"><span class="co">#&gt; $ dep_time       &lt;int&gt; 517, 533, 542, 544, 554, 554, 555, 557, 557, 558, 558,…</span></a>
<a class="sourceLine" id="cb60-8" title="8"><span class="co">#&gt; $ sched_dep_time &lt;int&gt; 515, 529, 540, 545, 600, 558, 600, 600, 600, 600, 600,…</span></a>
<a class="sourceLine" id="cb60-9" title="9"><span class="co">#&gt; $ dep_delay      &lt;dbl&gt; 2, 4, 2, -1, -6, -4, -5, -3, -3, -2, -2, -2, -2, -2, -…</span></a>
<a class="sourceLine" id="cb60-10" title="10"><span class="co">#&gt; $ arr_time       &lt;int&gt; 830, 850, 923, 1004, 812, 740, 913, 709, 838, 753, 849…</span></a>
<a class="sourceLine" id="cb60-11" title="11"><span class="co">#&gt; $ sched_arr_time &lt;int&gt; 819, 830, 850, 1022, 837, 728, 854, 723, 846, 745, 851…</span></a>
<a class="sourceLine" id="cb60-12" title="12"><span class="co">#&gt; $ arr_delay      &lt;dbl&gt; 11, 20, 33, -18, -25, 12, 19, -14, -8, 8, -2, -3, 7, -…</span></a>
<a class="sourceLine" id="cb60-13" title="13"><span class="co">#&gt; $ carrier        &lt;chr&gt; &quot;UA&quot;, &quot;UA&quot;, &quot;AA&quot;, &quot;B6&quot;, &quot;DL&quot;, &quot;UA&quot;, &quot;B6&quot;, &quot;EV&quot;, &quot;B6&quot;, …</span></a>
<a class="sourceLine" id="cb60-14" title="14"><span class="co">#&gt; $ flight         &lt;int&gt; 1545, 1714, 1141, 725, 461, 1696, 507, 5708, 79, 301, …</span></a>
<a class="sourceLine" id="cb60-15" title="15"><span class="co">#&gt; $ tailnum        &lt;chr&gt; &quot;N14228&quot;, &quot;N24211&quot;, &quot;N619AA&quot;, &quot;N804JB&quot;, &quot;N668DN&quot;, &quot;N39…</span></a>
<a class="sourceLine" id="cb60-16" title="16"><span class="co">#&gt; $ origin         &lt;chr&gt; &quot;EWR&quot;, &quot;LGA&quot;, &quot;JFK&quot;, &quot;JFK&quot;, &quot;LGA&quot;, &quot;EWR&quot;, &quot;EWR&quot;, &quot;LGA&quot;…</span></a>
<a class="sourceLine" id="cb60-17" title="17"><span class="co">#&gt; $ dest           &lt;chr&gt; &quot;IAH&quot;, &quot;IAH&quot;, &quot;MIA&quot;, &quot;BQN&quot;, &quot;ATL&quot;, &quot;ORD&quot;, &quot;FLL&quot;, &quot;IAD&quot;…</span></a>
<a class="sourceLine" id="cb60-18" title="18"><span class="co">#&gt; $ air_time       &lt;dbl&gt; 227, 227, 160, 183, 116, 150, 158, 53, 140, 138, 149, …</span></a>
<a class="sourceLine" id="cb60-19" title="19"><span class="co">#&gt; $ distance       &lt;dbl&gt; 1400, 1416, 1089, 1576, 762, 719, 1065, 229, 944, 733,…</span></a>
<a class="sourceLine" id="cb60-20" title="20"><span class="co">#&gt; $ hour           &lt;dbl&gt; 5, 5, 5, 5, 6, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 6, 6, …</span></a>
<a class="sourceLine" id="cb60-21" title="21"><span class="co">#&gt; $ minute         &lt;dbl&gt; 15, 29, 40, 45, 0, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, …</span></a>
<a class="sourceLine" id="cb60-22" title="22"><span class="co">#&gt; $ time_hour      &lt;dttm&gt; 2013-01-01 05:00:00, 2013-01-01 05:00:00, 2013-01-01 …</span></a></code></pre></div>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" title="1"><span class="co"># 常规方法</span></a>
<a class="sourceLine" id="cb61-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(dep_time, dep_delay, arr_time, arr_delay)</a>
<a class="sourceLine" id="cb61-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 4</span></a>
<a class="sourceLine" id="cb61-4" title="4"><span class="co">#&gt;   dep_time dep_delay arr_time arr_delay</span></a>
<a class="sourceLine" id="cb61-5" title="5"><span class="co">#&gt;      &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb61-6" title="6"><span class="co">#&gt; 1      517         2      830        11</span></a>
<a class="sourceLine" id="cb61-7" title="7"><span class="co">#&gt; 2      533         4      850        20</span></a>
<a class="sourceLine" id="cb61-8" title="8"><span class="co">#&gt; 3      542         2      923        33</span></a>
<a class="sourceLine" id="cb61-9" title="9"><span class="co">#&gt; 4      544        -1     1004       -18</span></a>
<a class="sourceLine" id="cb61-10" title="10"><span class="co">#&gt; 5      554        -6      812       -25</span></a>
<a class="sourceLine" id="cb61-11" title="11"><span class="co">#&gt; 6      554        -4      740        12</span></a>
<a class="sourceLine" id="cb61-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" title="1"><span class="co"># 用one_of()</span></a>
<a class="sourceLine" id="cb62-2" title="2">vars =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;dep_time&quot;</span>, <span class="st">&quot;dep_delay&quot;</span>, <span class="st">&quot;arr_time&quot;</span>, <span class="st">&quot;arr_delay&quot;</span>)</a>
<a class="sourceLine" id="cb62-3" title="3">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">one_of</span>(vars))</a>
<a class="sourceLine" id="cb62-4" title="4"><span class="co">#&gt; # A tibble: 336,776 x 4</span></a>
<a class="sourceLine" id="cb62-5" title="5"><span class="co">#&gt;   dep_time dep_delay arr_time arr_delay</span></a>
<a class="sourceLine" id="cb62-6" title="6"><span class="co">#&gt;      &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb62-7" title="7"><span class="co">#&gt; 1      517         2      830        11</span></a>
<a class="sourceLine" id="cb62-8" title="8"><span class="co">#&gt; 2      533         4      850        20</span></a>
<a class="sourceLine" id="cb62-9" title="9"><span class="co">#&gt; 3      542         2      923        33</span></a>
<a class="sourceLine" id="cb62-10" title="10"><span class="co">#&gt; 4      544        -1     1004       -18</span></a>
<a class="sourceLine" id="cb62-11" title="11"><span class="co">#&gt; 5      554        -6      812       -25</span></a>
<a class="sourceLine" id="cb62-12" title="12"><span class="co">#&gt; 6      554        -4      740        12</span></a>
<a class="sourceLine" id="cb62-13" title="13"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" title="1"><span class="co"># 多个条件</span></a>
<a class="sourceLine" id="cb63-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;arr_&quot;</span>), <span class="kw">starts_with</span>(<span class="st">&quot;dep_&quot;</span>))</a>
<a class="sourceLine" id="cb63-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 4</span></a>
<a class="sourceLine" id="cb63-4" title="4"><span class="co">#&gt;   arr_time arr_delay dep_time dep_delay</span></a>
<a class="sourceLine" id="cb63-5" title="5"><span class="co">#&gt;      &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb63-6" title="6"><span class="co">#&gt; 1      830        11      517         2</span></a>
<a class="sourceLine" id="cb63-7" title="7"><span class="co">#&gt; 2      850        20      533         4</span></a>
<a class="sourceLine" id="cb63-8" title="8"><span class="co">#&gt; 3      923        33      542         2</span></a>
<a class="sourceLine" id="cb63-9" title="9"><span class="co">#&gt; 4     1004       -18      544        -1</span></a>
<a class="sourceLine" id="cb63-10" title="10"><span class="co">#&gt; 5      812       -25      554        -6</span></a>
<a class="sourceLine" id="cb63-11" title="11"><span class="co">#&gt; 6      740        12      554        -4</span></a>
<a class="sourceLine" id="cb63-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>

<div class="exercise">
<span id="exr:unnamed-chunk-72" class="exercise"><strong>Exercise 1.7  </strong></span>
如果在<code>select()</code>中多次计入一个变量名，会发生什么情况？
</div>

<p><code>select()</code>函数将会忽略重复出现的变量，只选出一列，同时也不会报错：</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(year, month, day, year, month, day)</a>
<a class="sourceLine" id="cb64-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 3</span></a>
<a class="sourceLine" id="cb64-3" title="3"><span class="co">#&gt;    year month   day</span></a>
<a class="sourceLine" id="cb64-4" title="4"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb64-5" title="5"><span class="co">#&gt; 1  2013     1     1</span></a>
<a class="sourceLine" id="cb64-6" title="6"><span class="co">#&gt; 2  2013     1     1</span></a>
<a class="sourceLine" id="cb64-7" title="7"><span class="co">#&gt; 3  2013     1     1</span></a>
<a class="sourceLine" id="cb64-8" title="8"><span class="co">#&gt; 4  2013     1     1</span></a>
<a class="sourceLine" id="cb64-9" title="9"><span class="co">#&gt; 5  2013     1     1</span></a>
<a class="sourceLine" id="cb64-10" title="10"><span class="co">#&gt; 6  2013     1     1</span></a>
<a class="sourceLine" id="cb64-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
</div>
</div>
<div id="mutate-创建变量" class="section level2">
<h2><span class="header-section-number">1.5</span> <code>mutate()</code> 创建变量</h2>
<p>除了选择现有的列，经常还需要添加新列。新列是现有列的函数，这就 <code>mutate()</code> 函数的作用。<br />
<code>mutate()</code> 总是将新列添加在最后,格式为<code>新列名= 表达式</code>。为了便于观察它的效果，我们需要先创建一个更狭窄的数据集，以便能看到新变量。<br />
例如，我们希望创建两个新列<code>gain</code>和<code>hours</code>，分别表示飞机在飞行过程中弥补的延误时间 (<code>gain = arr_dealy - dep_delay</code>)，然后把飞行时间换算成小时 <code>hours = air_time / 60</code></p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" title="1">(flights_gain &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-2" title="2"><span class="st">   </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;delay&quot;</span>),air_time) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-3" title="3"><span class="st">   </span><span class="kw">mutate</span>(<span class="dt">gain =</span> arr_delay <span class="op">-</span><span class="st"> </span>dep_delay,</a>
<a class="sourceLine" id="cb65-4" title="4">            <span class="dt">hours =</span> air_time <span class="op">/</span><span class="st"> </span><span class="dv">60</span>))</a>
<a class="sourceLine" id="cb65-5" title="5"><span class="co">#&gt; # A tibble: 336,776 x 5</span></a>
<a class="sourceLine" id="cb65-6" title="6"><span class="co">#&gt;   dep_delay arr_delay air_time  gain hours</span></a>
<a class="sourceLine" id="cb65-7" title="7"><span class="co">#&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb65-8" title="8"><span class="co">#&gt; 1         2        11      227     9  3.78</span></a>
<a class="sourceLine" id="cb65-9" title="9"><span class="co">#&gt; 2         4        20      227    16  3.78</span></a>
<a class="sourceLine" id="cb65-10" title="10"><span class="co">#&gt; 3         2        33      160    31  2.67</span></a>
<a class="sourceLine" id="cb65-11" title="11"><span class="co">#&gt; 4        -1       -18      183   -17  3.05</span></a>
<a class="sourceLine" id="cb65-12" title="12"><span class="co">#&gt; 5        -6       -25      116   -19  1.93</span></a>
<a class="sourceLine" id="cb65-13" title="13"><span class="co">#&gt; 6        -4        12      150    16  2.5 </span></a>
<a class="sourceLine" id="cb65-14" title="14"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<p>一旦新列被创建，就可以立即使用。例如，可能想知道对gain做时间上的平均：</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" title="1">flights_gain <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">gain_per_hour =</span> gain <span class="op">/</span><span class="st"> </span>hours)</a>
<a class="sourceLine" id="cb66-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 6</span></a>
<a class="sourceLine" id="cb66-3" title="3"><span class="co">#&gt;   dep_delay arr_delay air_time  gain hours gain_per_hour</span></a>
<a class="sourceLine" id="cb66-4" title="4"><span class="co">#&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb66-5" title="5"><span class="co">#&gt; 1         2        11      227     9  3.78          2.38</span></a>
<a class="sourceLine" id="cb66-6" title="6"><span class="co">#&gt; 2         4        20      227    16  3.78          4.23</span></a>
<a class="sourceLine" id="cb66-7" title="7"><span class="co">#&gt; 3         2        33      160    31  2.67         11.6 </span></a>
<a class="sourceLine" id="cb66-8" title="8"><span class="co">#&gt; 4        -1       -18      183   -17  3.05         -5.57</span></a>
<a class="sourceLine" id="cb66-9" title="9"><span class="co">#&gt; 5        -6       -25      116   -19  1.93         -9.83</span></a>
<a class="sourceLine" id="cb66-10" title="10"><span class="co">#&gt; 6        -4        12      150    16  2.5           6.4 </span></a>
<a class="sourceLine" id="cb66-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<p>以上的数据转换也可以通过<code>mutate()</code>一次完成：</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb67-2" title="2"><span class="st">  </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;delay&quot;</span>),air_time) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb67-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb67-4" title="4">    <span class="dt">gain =</span> arr_delay <span class="op">-</span><span class="st"> </span>dep_delay,</a>
<a class="sourceLine" id="cb67-5" title="5">    <span class="dt">hours =</span> air_time <span class="op">/</span><span class="st"> </span><span class="dv">60</span>,</a>
<a class="sourceLine" id="cb67-6" title="6">    <span class="dt">gain_per_hour =</span> gain<span class="op">/</span>hours)</a>
<a class="sourceLine" id="cb67-7" title="7"><span class="co">#&gt; # A tibble: 336,776 x 6</span></a>
<a class="sourceLine" id="cb67-8" title="8"><span class="co">#&gt;   dep_delay arr_delay air_time  gain hours gain_per_hour</span></a>
<a class="sourceLine" id="cb67-9" title="9"><span class="co">#&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb67-10" title="10"><span class="co">#&gt; 1         2        11      227     9  3.78          2.38</span></a>
<a class="sourceLine" id="cb67-11" title="11"><span class="co">#&gt; 2         4        20      227    16  3.78          4.23</span></a>
<a class="sourceLine" id="cb67-12" title="12"><span class="co">#&gt; 3         2        33      160    31  2.67         11.6 </span></a>
<a class="sourceLine" id="cb67-13" title="13"><span class="co">#&gt; 4        -1       -18      183   -17  3.05         -5.57</span></a>
<a class="sourceLine" id="cb67-14" title="14"><span class="co">#&gt; 5        -6       -25      116   -19  1.93         -9.83</span></a>
<a class="sourceLine" id="cb67-15" title="15"><span class="co">#&gt; 6        -4        12      150    16  2.5           6.4 </span></a>
<a class="sourceLine" id="cb67-16" title="16"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<p>如果只想在保留新变量，可以使用<code>transmute()</code>：</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb68-2" title="2"><span class="st">  </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;delay&quot;</span>),air_time) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb68-3" title="3"><span class="st">  </span><span class="kw">transmute</span>(</a>
<a class="sourceLine" id="cb68-4" title="4">    <span class="dt">gain =</span> arr_delay <span class="op">-</span><span class="st"> </span>dep_delay,</a>
<a class="sourceLine" id="cb68-5" title="5">    <span class="dt">hours =</span> air_time <span class="op">/</span><span class="st"> </span><span class="dv">60</span>,</a>
<a class="sourceLine" id="cb68-6" title="6">    <span class="dt">gain_per_hour =</span> gain<span class="op">/</span>hours)</a>
<a class="sourceLine" id="cb68-7" title="7"><span class="co">#&gt; # A tibble: 336,776 x 3</span></a>
<a class="sourceLine" id="cb68-8" title="8"><span class="co">#&gt;    gain hours gain_per_hour</span></a>
<a class="sourceLine" id="cb68-9" title="9"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb68-10" title="10"><span class="co">#&gt; 1     9  3.78          2.38</span></a>
<a class="sourceLine" id="cb68-11" title="11"><span class="co">#&gt; 2    16  3.78          4.23</span></a>
<a class="sourceLine" id="cb68-12" title="12"><span class="co">#&gt; 3    31  2.67         11.6 </span></a>
<a class="sourceLine" id="cb68-13" title="13"><span class="co">#&gt; 4   -17  3.05         -5.57</span></a>
<a class="sourceLine" id="cb68-14" title="14"><span class="co">#&gt; 5   -19  1.93         -9.83</span></a>
<a class="sourceLine" id="cb68-15" title="15"><span class="co">#&gt; 6    16  2.5           6.4 </span></a>
<a class="sourceLine" id="cb68-16" title="16"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<div id="常用创建函数using-creation-functions" class="section level3">
<h3><span class="header-section-number">1.5.1</span> 常用创建函数（Using creation functions）</h3>
<p>有多种函数可以帮助<code>mutate()</code>创建新变量。比较重要的一点是，这些函数必须是向量化的：它能接受一个向量作为输入，并返回一个向量作为输出，而且输入和输出向量长度相等。下面介绍一些比较常用的函数。</p>
<p>**算术运算符 +、-、*、/、^**<br />
它们都是向量化的，使用所谓的“循环法则(recycling rules)”。如果一个参数比另一个参数短，那么前者会自动扩展到相同的长度，但某个参数是单个数值时，这种方式是最有效的，如<code>air_time * 60 或者 hours * 60 + minute</code>等。<br />
算术运算符的另一个用途是与我们后面将很快学到的聚集函数结合起来使用。例如,<code>x / sum(x)</code>可以计算出x的各个分量在总数中的比例，<code>y - mean(y)</code>计算出y的各个分量与均值之间的差异。</p>
<p><strong>模运算符 %/% 和 % </strong><br />
%/%（整除）和%%（求余）满足<code>x == y * (x %/% y) + （x %% y</code>, 这两个运算符在Python中分别是// 和 % 。<br />
模运算非常好用，因为它可以拆分整数。例如，在flights数据集中，可以根据<code>dep_time</code>计算出hour和minute：</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" title="1"><span class="co">## air_time中表示时间的方式是“xyz”表示x点yz分</span></a>
<a class="sourceLine" id="cb69-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-3" title="3"><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">hour =</span> air_time <span class="op">%/%</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb69-4" title="4">            <span class="dt">minute =</span> air_time <span class="op">%%</span><span class="st"> </span><span class="dv">100</span>)   </a>
<a class="sourceLine" id="cb69-5" title="5"><span class="co">#&gt; # A tibble: 336,776 x 2</span></a>
<a class="sourceLine" id="cb69-6" title="6"><span class="co">#&gt;    hour minute</span></a>
<a class="sourceLine" id="cb69-7" title="7"><span class="co">#&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb69-8" title="8"><span class="co">#&gt; 1     2     27</span></a>
<a class="sourceLine" id="cb69-9" title="9"><span class="co">#&gt; 2     2     27</span></a>
<a class="sourceLine" id="cb69-10" title="10"><span class="co">#&gt; 3     1     60</span></a>
<a class="sourceLine" id="cb69-11" title="11"><span class="co">#&gt; 4     1     83</span></a>
<a class="sourceLine" id="cb69-12" title="12"><span class="co">#&gt; 5     1     16</span></a>
<a class="sourceLine" id="cb69-13" title="13"><span class="co">#&gt; 6     1     50</span></a>
<a class="sourceLine" id="cb69-14" title="14"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<p><strong>对数函数 log()/log2()/log10()</strong><br />
在处理取值范围变化多个数量级的数据时，对数变换很有用。其他条件相同的情况下，更推荐使用<code>log2()</code>函数，因为它的解释很容易，对数变换后的变量每增加一个单位，意味着原始变量加倍 ； 减少一个单位，则原始数据变为原来的一半。</p>
<p><strong>偏移函数</strong><br />
<code>lead()</code>和<code>lag()</code>函数分别将一个向量向前或向后移动指定的单位：</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" title="1">x &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">10</span></a>
<a class="sourceLine" id="cb70-2" title="2"><span class="co">## 将x向前移动2个单位</span></a>
<a class="sourceLine" id="cb70-3" title="3"><span class="kw">lead</span>(x,<span class="dt">n=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb70-4" title="4"><span class="co">#&gt;  [1]  3  4  5  6  7  8  9 10 NA NA</span></a>
<a class="sourceLine" id="cb70-5" title="5"><span class="co">## 将x向后移动一个单位（默认n=1）</span></a>
<a class="sourceLine" id="cb70-6" title="6"><span class="kw">lag</span>(x)</a>
<a class="sourceLine" id="cb70-7" title="7"><span class="co">#&gt;  [1] NA  1  2  3  4  5  6  7  8  9</span></a></code></pre></div>
<p><strong>累加和滚动聚合</strong><br />
R的基础包提供了计算累加和、累加积、累加最小值和累加最大值的函数：<code>cumsum()、cumprod()、cummax()、cummin()</code>；dplyr包还提供了<code>cummean()</code>函数以计算累积平均值。</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" title="1">x &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">10</span></a>
<a class="sourceLine" id="cb71-2" title="2"><span class="kw">cumsum</span>(x)</a>
<a class="sourceLine" id="cb71-3" title="3"><span class="co">#&gt;  [1]  1  3  6 10 15 21 28 36 45 55</span></a>
<a class="sourceLine" id="cb71-4" title="4"><span class="kw">cumprod</span>(x)</a>
<a class="sourceLine" id="cb71-5" title="5"><span class="co">#&gt;  [1]       1       2       6      24     120     720    5040   40320  362880</span></a>
<a class="sourceLine" id="cb71-6" title="6"><span class="co">#&gt; [10] 3628800</span></a>
<a class="sourceLine" id="cb71-7" title="7"><span class="kw">cummax</span>(x)</a>
<a class="sourceLine" id="cb71-8" title="8"><span class="co">#&gt;  [1]  1  2  3  4  5  6  7  8  9 10</span></a>
<a class="sourceLine" id="cb71-9" title="9"><span class="kw">cummin</span>(x)</a>
<a class="sourceLine" id="cb71-10" title="10"><span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1</span></a>
<a class="sourceLine" id="cb71-11" title="11"><span class="kw">cummean</span>(x)</a>
<a class="sourceLine" id="cb71-12" title="12"><span class="co">#&gt;  [1] 1.0 1.5 2.0 2.5 3.0 3.5 4.0 4.5 5.0 5.5</span></a></code></pre></div>
<p><strong>逻辑比较 &gt;、&lt;=、&gt;、&gt;=、==、!=</strong><br />
如果要进行一系列复杂的逻辑运算，最好将中间结果保存在新变量中，这样就可以检查每一步是否都符合预期。</p>
<p><strong>排秩</strong><br />
排秩函数有很多，从<code>min_rank()</code>开始，它可以完成最常用的排秩任务。默认的排秩方式是，最小的值获得最前面的秩（升序），使用<code>desc(x)</code>可以让最大的值获得前面的名次,NA值对应的秩也是NA：</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" title="1">x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="ot">NA</span>,<span class="dv">3</span>,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb72-2" title="2"><span class="kw">min_rank</span>(x)</a>
<a class="sourceLine" id="cb72-3" title="3"><span class="co">#&gt; [1]  1  2  2 NA  4  5</span></a>
<a class="sourceLine" id="cb72-4" title="4"><span class="kw">min_rank</span>(<span class="kw">desc</span>(x))</a>
<a class="sourceLine" id="cb72-5" title="5"><span class="co">#&gt; [1]  5  3  3 NA  2  1</span></a></code></pre></div>
<p><code>min_rank()</code>函数把相同值赋予相同的秩，如果有n个值秩相同为x，则下一个值的秩会直接从x+n开始
如果<code>min_rank()</code>无法满足需要，可以看一下它的一些变体：</p>
<ul>
<li><code>row_number()</code>,相同值不同秩</li>
</ul>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" title="1">x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="ot">NA</span>,<span class="dv">3</span>,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb73-2" title="2"><span class="kw">min_rank</span>(x)</a>
<a class="sourceLine" id="cb73-3" title="3"><span class="co">#&gt; [1]  1  2  2 NA  4  5</span></a>
<a class="sourceLine" id="cb73-4" title="4"><span class="kw">row_number</span>(x)</a>
<a class="sourceLine" id="cb73-5" title="5"><span class="co">#&gt; [1]  1  2  3 NA  4  5</span></a></code></pre></div>
<ul>
<li><code>dense_rank</code>：相同值的秩相同，但下一个值的秩不会跳转</li>
</ul>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" title="1">x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="ot">NA</span>,<span class="dv">3</span>,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb74-2" title="2"><span class="kw">min_rank</span>(x)</a>
<a class="sourceLine" id="cb74-3" title="3"><span class="co">#&gt; [1]  1  2  2 NA  4  5</span></a>
<a class="sourceLine" id="cb74-4" title="4"><span class="kw">row_number</span>(x)</a>
<a class="sourceLine" id="cb74-5" title="5"><span class="co">#&gt; [1]  1  2  3 NA  4  5</span></a>
<a class="sourceLine" id="cb74-6" title="6"><span class="kw">dense_rank</span>(x)</a>
<a class="sourceLine" id="cb74-7" title="7"><span class="co">#&gt; [1]  1  2  2 NA  3  4</span></a></code></pre></div>
<ul>
<li><code>percent_rank()</code>: 将秩按照比例压缩为[0,1]的值</li>
</ul>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" title="1">x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="ot">NA</span>,<span class="dv">3</span>,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb75-2" title="2"><span class="kw">percent_rank</span>(x)</a>
<a class="sourceLine" id="cb75-3" title="3"><span class="co">#&gt; [1] 0.00 0.25 0.25   NA 0.75 1.00</span></a></code></pre></div>
<ul>
<li><code>ntile()</code>：breaks the input vector into n buckets.</li>
</ul>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" title="1">x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">8</span>)</a>
<a class="sourceLine" id="cb76-2" title="2"><span class="kw">ntile</span>(x,<span class="dt">n=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb76-3" title="3"><span class="co">#&gt; [1] 1 1 1 2 2 2</span></a>
<a class="sourceLine" id="cb76-4" title="4"><span class="kw">ntile</span>(x,<span class="dt">n=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb76-5" title="5"><span class="co">#&gt; [1] 1 1 2 2 3 3</span></a></code></pre></div>
</div>
<div id="练习-3" class="section level3">
<h3><span class="header-section-number">1.5.2</span> 练习</h3>
<ol style="list-style-type: decimal">
<li>虽然现在的<code>dep_time</code>和<code>sched_dep_time</code>变量方便阅读，但不适合计算，因为它们实际上并不是连续型数值。将它们转换为一种更方便的表示形式，即从0点开始的分钟数</li>
</ol>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" title="1"><span class="co">## 观察两个变量的存储方式</span></a>
<a class="sourceLine" id="cb77-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-3" title="3"><span class="st">  </span><span class="kw">select</span>(dep_time,sched_dep_time)</a>
<a class="sourceLine" id="cb77-4" title="4"><span class="co">#&gt; # A tibble: 336,776 x 2</span></a>
<a class="sourceLine" id="cb77-5" title="5"><span class="co">#&gt;   dep_time sched_dep_time</span></a>
<a class="sourceLine" id="cb77-6" title="6"><span class="co">#&gt;      &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb77-7" title="7"><span class="co">#&gt; 1      517            515</span></a>
<a class="sourceLine" id="cb77-8" title="8"><span class="co">#&gt; 2      533            529</span></a>
<a class="sourceLine" id="cb77-9" title="9"><span class="co">#&gt; 3      542            540</span></a>
<a class="sourceLine" id="cb77-10" title="10"><span class="co">#&gt; 4      544            545</span></a>
<a class="sourceLine" id="cb77-11" title="11"><span class="co">#&gt; 5      554            600</span></a>
<a class="sourceLine" id="cb77-12" title="12"><span class="co">#&gt; 6      554            558</span></a>
<a class="sourceLine" id="cb77-13" title="13"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<p>xyz表示x点yz分，则总分钟数为<code>x %/% 100 * 60 + x %% 100</code> ; 但有一个问题是，由于0点是用2400代表的，经过这样的转换它变为1440，我们希望它变为0，所以在外层再套一个<code>%% 1440</code></p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">transmute</span>(<span class="dt">dep_time_mins =</span> (dep_time <span class="op">%/%</span><span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="dv">60</span> <span class="op">+</span><span class="st"> </span>dep_time <span class="op">%%</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">1440</span>, <span class="dt">sched_dep_time_mins =</span> (sched_dep_time <span class="op">%/%</span><span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="dv">60</span> <span class="op">+</span><span class="st"> </span>sched_dep_time <span class="op">%%</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">1440</span>)</a>
<a class="sourceLine" id="cb78-2" title="2"><span class="co">#&gt; # A tibble: 336,776 x 2</span></a>
<a class="sourceLine" id="cb78-3" title="3"><span class="co">#&gt;   dep_time_mins sched_dep_time_mins</span></a>
<a class="sourceLine" id="cb78-4" title="4"><span class="co">#&gt;           &lt;dbl&gt;               &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb78-5" title="5"><span class="co">#&gt; 1           317                 315</span></a>
<a class="sourceLine" id="cb78-6" title="6"><span class="co">#&gt; 2           333                 329</span></a>
<a class="sourceLine" id="cb78-7" title="7"><span class="co">#&gt; 3           342                 340</span></a>
<a class="sourceLine" id="cb78-8" title="8"><span class="co">#&gt; 4           344                 345</span></a>
<a class="sourceLine" id="cb78-9" title="9"><span class="co">#&gt; 5           354                 360</span></a>
<a class="sourceLine" id="cb78-10" title="10"><span class="co">#&gt; 6           354                 358</span></a>
<a class="sourceLine" id="cb78-11" title="11"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>比较<code>dep_time、sched_dep_time和dep_delay</code>，这三者应该是何种关系？</li>
</ol>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" title="1">flights_deptime &lt;-</a>
<a class="sourceLine" id="cb79-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(flights,</a>
<a class="sourceLine" id="cb79-3" title="3">    <span class="dt">dep_time_min =</span> (dep_time <span class="op">%/%</span><span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="dv">60</span> <span class="op">+</span><span class="st"> </span>dep_time <span class="op">%%</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">1440</span>,</a>
<a class="sourceLine" id="cb79-4" title="4">    <span class="dt">sched_dep_time_min =</span> (sched_dep_time <span class="op">%/%</span><span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="dv">60</span> <span class="op">+</span></a>
<a class="sourceLine" id="cb79-5" title="5"><span class="st">                          </span>sched_dep_time <span class="op">%%</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">1440</span>,</a>
<a class="sourceLine" id="cb79-6" title="6">    <span class="dt">dep_delay_diff =</span> dep_delay <span class="op">-</span><span class="st"> </span>dep_time_min <span class="op">+</span><span class="st"> </span>sched_dep_time_min</a>
<a class="sourceLine" id="cb79-7" title="7">  )</a>
<a class="sourceLine" id="cb79-8" title="8"><span class="kw">filter</span>(flights_deptime, dep_delay_diff <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(dep_delay_diff)</a>
<a class="sourceLine" id="cb79-9" title="9"><span class="co">#&gt; # A tibble: 1,236 x 1</span></a>
<a class="sourceLine" id="cb79-10" title="10"><span class="co">#&gt;   dep_delay_diff</span></a>
<a class="sourceLine" id="cb79-11" title="11"><span class="co">#&gt;            &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb79-12" title="12"><span class="co">#&gt; 1           1440</span></a>
<a class="sourceLine" id="cb79-13" title="13"><span class="co">#&gt; 2           1440</span></a>
<a class="sourceLine" id="cb79-14" title="14"><span class="co">#&gt; 3           1440</span></a>
<a class="sourceLine" id="cb79-15" title="15"><span class="co">#&gt; 4           1440</span></a>
<a class="sourceLine" id="cb79-16" title="16"><span class="co">#&gt; 5           1440</span></a>
<a class="sourceLine" id="cb79-17" title="17"><span class="co">#&gt; 6           1440</span></a>
<a class="sourceLine" id="cb79-18" title="18"><span class="co">#&gt; # … with 1,230 more rows</span></a></code></pre></div>
<p>如上所示，经过分钟的转换后，有1236行的<code>dep_delay</code> 不等于 <code>dep_time - sched_dep_time</code>. 有趣的是，这些差值全部等于1440。<br />
&gt; the discrepancies could be because a flight was scheduled to depart before midnight, but was delayed after midnight. All of these discrepancies are exactly equal to 1440 (24 hours), and the flights with these discrepancies were scheduled to depart later in the day.</p>
<ol start="3" style="list-style-type: decimal">
<li>使用排秩函数找出10个出发延误时间最长的航班</li>
</ol>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" title="1"><span class="co">## 使min_rank默认小的值获得小的秩，arrange()默认降序排列，其中一个函数中要使用desc()</span></a>
<a class="sourceLine" id="cb80-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">delay_rank =</span> <span class="kw">min_rank</span>(<span class="kw">desc</span>(dep_delay))) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(delay_rank) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(year,month,day,dep_delay,delay_rank)</a>
<a class="sourceLine" id="cb80-3" title="3"><span class="co">#&gt; # A tibble: 336,776 x 5</span></a>
<a class="sourceLine" id="cb80-4" title="4"><span class="co">#&gt;    year month   day dep_delay delay_rank</span></a>
<a class="sourceLine" id="cb80-5" title="5"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;      &lt;int&gt;</span></a>
<a class="sourceLine" id="cb80-6" title="6"><span class="co">#&gt; 1  2013     1     9      1301          1</span></a>
<a class="sourceLine" id="cb80-7" title="7"><span class="co">#&gt; 2  2013     6    15      1137          2</span></a>
<a class="sourceLine" id="cb80-8" title="8"><span class="co">#&gt; 3  2013     1    10      1126          3</span></a>
<a class="sourceLine" id="cb80-9" title="9"><span class="co">#&gt; 4  2013     9    20      1014          4</span></a>
<a class="sourceLine" id="cb80-10" title="10"><span class="co">#&gt; 5  2013     7    22      1005          5</span></a>
<a class="sourceLine" id="cb80-11" title="11"><span class="co">#&gt; 6  2013     4    10       960          6</span></a>
<a class="sourceLine" id="cb80-12" title="12"><span class="co">#&gt; # … with 3.368e+05 more rows</span></a></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li><code>1:3 + 1:10</code>会返回什么？为什么？</li>
</ol>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" title="1"><span class="dv">1</span><span class="op">:</span><span class="dv">3</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">10</span></a>
<a class="sourceLine" id="cb81-2" title="2"><span class="co">#&gt;  [1]  2  4  6  5  7  9  8 10 12 11</span></a></code></pre></div>
<p>当一个向量中的值不够用时，这个向量会被循环使用
<code>1:3 + 1:10</code>等价于<code>c(1 + 1, 2 + 2, 3 + 3, 1 + 4, 2 + 5, 3 + 6, 1 + 7, 2 + 8, 3 + 9, 1 + 10)</code></p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" title="1"><span class="kw">c</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="dv">3</span> <span class="op">+</span><span class="st"> </span><span class="dv">3</span>, <span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">4</span>, <span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">5</span>, <span class="dv">3</span> <span class="op">+</span><span class="st"> </span><span class="dv">6</span>, <span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">7</span>, <span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">8</span>, <span class="dv">3</span> <span class="op">+</span><span class="st"> </span><span class="dv">9</span>, <span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb82-2" title="2"><span class="co">#&gt;  [1]  2  4  6  5  7  9  8 10 12 11</span></a></code></pre></div>
</div>
</div>
<div id="使用summarize进行分组摘要" class="section level2">
<h2><span class="header-section-number">1.6</span> 使用<code>summarize()</code>进行分组摘要</h2>
<p>最后一个核心函数是<code>summarize()</code>，它用来计算摘要统计量，可以将数据框折叠成一行：</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" title="1"><span class="co">## 计算平均出发延误时间</span></a>
<a class="sourceLine" id="cb83-2" title="2"><span class="kw">summarize</span>(flights,<span class="dt">delay =</span> <span class="kw">mean</span>(dep_delay,<span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb83-3" title="3"><span class="co">#&gt; # A tibble: 1 x 1</span></a>
<a class="sourceLine" id="cb83-4" title="4"><span class="co">#&gt;   delay</span></a>
<a class="sourceLine" id="cb83-5" title="5"><span class="co">#&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb83-6" title="6"><span class="co">#&gt; 1  12.6</span></a></code></pre></div>
<p>如果不和 <code>group_by()</code> 一起使用，那么 <code>summarize()</code> 也就没什么大用。<code>group_by()</code> 函数与 <code>summarize()</code> 联合使用的时候可以将分析单位从整个数据集更改为单个分组，接下来，在分组后的数据框上使用dplyr函数时，它们会自动应用到每个分组。更简单第说，你想从哪个层级上分析问题，就在<code>group_by</code>中对什么层级进行分组。<code>group_by() + summarize()</code>可以实现类似<code>aggregate()</code>函数的效果。
例如，我们想知道每一天的平均出发延误时间，可以先对<code>(year,month,day)</code>进行分组，然后再使用<code>summarize()</code>：</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb84-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(year,month,day) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb84-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">delay =</span> <span class="kw">mean</span>(dep_delay,<span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb84-4" title="4"><span class="co">#&gt; # A tibble: 365 x 4</span></a>
<a class="sourceLine" id="cb84-5" title="5"><span class="co">#&gt; # Groups:   year, month [12]</span></a>
<a class="sourceLine" id="cb84-6" title="6"><span class="co">#&gt;    year month   day delay</span></a>
<a class="sourceLine" id="cb84-7" title="7"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb84-8" title="8"><span class="co">#&gt; 1  2013     1     1 11.5 </span></a>
<a class="sourceLine" id="cb84-9" title="9"><span class="co">#&gt; 2  2013     1     2 13.9 </span></a>
<a class="sourceLine" id="cb84-10" title="10"><span class="co">#&gt; 3  2013     1     3 11.0 </span></a>
<a class="sourceLine" id="cb84-11" title="11"><span class="co">#&gt; 4  2013     1     4  8.95</span></a>
<a class="sourceLine" id="cb84-12" title="12"><span class="co">#&gt; 5  2013     1     5  5.73</span></a>
<a class="sourceLine" id="cb84-13" title="13"><span class="co">#&gt; 6  2013     1     6  7.15</span></a>
<a class="sourceLine" id="cb84-14" title="14"><span class="co">#&gt; # … with 359 more rows</span></a></code></pre></div>
<p>注意，<code>summarize()</code>很不同的一点就是它会自动选择列，只在结果中显示之前在<code>group_by</code>中进行分类的变量和<code>summarize()</code>中算出的摘要统计量。</p>
<p>这个生成的数据框只有365行，因为flights数据集中的时间跨度只有一年，(year, month, day)的唯一组合只可能有365个，这就是<code>summarize()</code>中的摘要函数的折叠效果：接受一个向量，只返回一个值，然后再用分组变量的一个组合来标识这个摘要量的对象（哪个层级上的平均值、最大值？）。从这个角度看，<code>summarize()和mutate()</code>对函数的要求恰好相反。</p>
<p>用<code>aggregate()</code>函数的写法：</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" title="1"><span class="kw">aggregate</span>(dep_delay<span class="op">~</span>year<span class="op">+</span>month<span class="op">+</span>day,</a>
<a class="sourceLine" id="cb85-2" title="2">          <span class="dt">FUN =</span> mean,</a>
<a class="sourceLine" id="cb85-3" title="3">          <span class="dt">data =</span> flights) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb85-4" title="4"><span class="st">  </span><span class="kw">head</span>(<span class="dv">20</span>)</a>
<a class="sourceLine" id="cb85-5" title="5"><span class="co">#&gt;    year month day dep_delay</span></a>
<a class="sourceLine" id="cb85-6" title="6"><span class="co">#&gt; 1  2013     1   1    11.549</span></a>
<a class="sourceLine" id="cb85-7" title="7"><span class="co">#&gt; 2  2013     2   1    10.853</span></a>
<a class="sourceLine" id="cb85-8" title="8"><span class="co">#&gt; 3  2013     3   1    11.016</span></a>
<a class="sourceLine" id="cb85-9" title="9"><span class="co">#&gt; 4  2013     4   1    12.421</span></a>
<a class="sourceLine" id="cb85-10" title="10"><span class="co">#&gt; 5  2013     5   1     2.903</span></a>
<a class="sourceLine" id="cb85-11" title="11"><span class="co">#&gt; 6  2013     6   1     2.778</span></a>
<a class="sourceLine" id="cb85-12" title="12"><span class="co">#&gt; 7  2013     7   1    56.234</span></a>
<a class="sourceLine" id="cb85-13" title="13"><span class="co">#&gt; 8  2013     8   1    34.574</span></a>
<a class="sourceLine" id="cb85-14" title="14"><span class="co">#&gt; 9  2013     9   1     4.233</span></a>
<a class="sourceLine" id="cb85-15" title="15"><span class="co">#&gt; 10 2013    10   1    -0.099</span></a>
<a class="sourceLine" id="cb85-16" title="16"><span class="co">#&gt; 11 2013    11   1    13.273</span></a>
<a class="sourceLine" id="cb85-17" title="17"><span class="co">#&gt; 12 2013    12   1     9.004</span></a>
<a class="sourceLine" id="cb85-18" title="18"><span class="co">#&gt; 13 2013     1   2    13.859</span></a>
<a class="sourceLine" id="cb85-19" title="19"><span class="co">#&gt; 14 2013     2   2     5.422</span></a>
<a class="sourceLine" id="cb85-20" title="20"><span class="co">#&gt; 15 2013     3   2     8.027</span></a>
<a class="sourceLine" id="cb85-21" title="21"><span class="co">#&gt; 16 2013     4   2     8.260</span></a>
<a class="sourceLine" id="cb85-22" title="22"><span class="co">#&gt; 17 2013     5   2     6.389</span></a>
<a class="sourceLine" id="cb85-23" title="23"><span class="co">#&gt; 18 2013     6   2    34.013</span></a>
<a class="sourceLine" id="cb85-24" title="24"><span class="co">#&gt; 19 2013     7   2    19.285</span></a>
<a class="sourceLine" id="cb85-25" title="25"><span class="co">#&gt; 20 2013     8   2    13.254</span></a></code></pre></div>
<p>比较这两个结果，我们可以发现<code>group_by()</code>中越靠后的参数是越基本的单位，<code>group_by(year,month,day)</code>将按照 day, month, year 的顺序开始循环 ； 而 <code>aggregate()</code> 函数则正好相反</p>
<div id="缺失值-1" class="section level3">
<h3><span class="header-section-number">1.6.1</span> 缺失值</h3>
<p>在按照日期计算平均出发延误时间的例子中，使用<code>mean()</code>时设置了参数<code>na.rm =  T</code>，如果没有这样做，很多日期的平均延误时间将是缺失值：</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb86-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(year,month,day) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb86-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">delay =</span> <span class="kw">mean</span>(dep_delay))</a>
<a class="sourceLine" id="cb86-4" title="4"><span class="co">#&gt; # A tibble: 365 x 4</span></a>
<a class="sourceLine" id="cb86-5" title="5"><span class="co">#&gt; # Groups:   year, month [12]</span></a>
<a class="sourceLine" id="cb86-6" title="6"><span class="co">#&gt;    year month   day delay</span></a>
<a class="sourceLine" id="cb86-7" title="7"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb86-8" title="8"><span class="co">#&gt; 1  2013     1     1    NA</span></a>
<a class="sourceLine" id="cb86-9" title="9"><span class="co">#&gt; 2  2013     1     2    NA</span></a>
<a class="sourceLine" id="cb86-10" title="10"><span class="co">#&gt; 3  2013     1     3    NA</span></a>
<a class="sourceLine" id="cb86-11" title="11"><span class="co">#&gt; 4  2013     1     4    NA</span></a>
<a class="sourceLine" id="cb86-12" title="12"><span class="co">#&gt; 5  2013     1     5    NA</span></a>
<a class="sourceLine" id="cb86-13" title="13"><span class="co">#&gt; 6  2013     1     6    NA</span></a>
<a class="sourceLine" id="cb86-14" title="14"><span class="co">#&gt; # … with 359 more rows</span></a></code></pre></div>
<p>这是因为聚合函数遵循缺失值的一般规则：如果输入中有缺失值，那么输出也是缺失值。好在所有聚合函数都有一个 <code>na.rm</code> 参数，可以在计算前出去缺失值。<br />
在这个示例中，缺失值来源于取消的航班。我们也可以先取出取消的航班来解决却实质问题。保存去除缺失值的数据集为<code>not_cancelled</code>，以便我们可以在接下来的几个示例中继续使用：</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" title="1">not_cancelled &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-2" title="2"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(dep_delay), <span class="op">!</span><span class="kw">is.na</span>(arr_delay))</a>
<a class="sourceLine" id="cb87-3" title="3"></a>
<a class="sourceLine" id="cb87-4" title="4">not_cancelled <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-5" title="5"><span class="st">  </span><span class="kw">group_by</span>(year,month,day) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-6" title="6"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">delay =</span> <span class="kw">mean</span>(dep_delay))</a>
<a class="sourceLine" id="cb87-7" title="7"><span class="co">#&gt; # A tibble: 365 x 4</span></a>
<a class="sourceLine" id="cb87-8" title="8"><span class="co">#&gt; # Groups:   year, month [12]</span></a>
<a class="sourceLine" id="cb87-9" title="9"><span class="co">#&gt;    year month   day delay</span></a>
<a class="sourceLine" id="cb87-10" title="10"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb87-11" title="11"><span class="co">#&gt; 1  2013     1     1 11.4 </span></a>
<a class="sourceLine" id="cb87-12" title="12"><span class="co">#&gt; 2  2013     1     2 13.7 </span></a>
<a class="sourceLine" id="cb87-13" title="13"><span class="co">#&gt; 3  2013     1     3 10.9 </span></a>
<a class="sourceLine" id="cb87-14" title="14"><span class="co">#&gt; 4  2013     1     4  8.97</span></a>
<a class="sourceLine" id="cb87-15" title="15"><span class="co">#&gt; 5  2013     1     5  5.73</span></a>
<a class="sourceLine" id="cb87-16" title="16"><span class="co">#&gt; 6  2013     1     6  7.15</span></a>
<a class="sourceLine" id="cb87-17" title="17"><span class="co">#&gt; # … with 359 more rows</span></a></code></pre></div>
</div>
<div id="计数函数" class="section level3">
<h3><span class="header-section-number">1.6.2</span> 计数函数</h3>
<p><code>n()</code> 函数是一个与摘要函数<code>summarize()</code>配合的计数函数，它不需要任何参数，单独使用时，它计算的就是行计数：</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb88-2" title="2"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>())</a>
<a class="sourceLine" id="cb88-3" title="3"><span class="co">#&gt; # A tibble: 1 x 1</span></a>
<a class="sourceLine" id="cb88-4" title="4"><span class="co">#&gt;        n</span></a>
<a class="sourceLine" id="cb88-5" title="5"><span class="co">#&gt;    &lt;int&gt;</span></a>
<a class="sourceLine" id="cb88-6" title="6"><span class="co">#&gt; 1 336776</span></a></code></pre></div>
<p>和<code>group_by</code>联合使用时，它可以计算分组变量的每个水平上各有多少个观测：</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb89-1" title="1"><span class="co">## 每个月各有多少趟航班</span></a>
<a class="sourceLine" id="cb89-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb89-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(month) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb89-4" title="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>())  <span class="co">## 等价于summarize(n = sum(month))</span></a>
<a class="sourceLine" id="cb89-5" title="5"><span class="co">#&gt; # A tibble: 12 x 2</span></a>
<a class="sourceLine" id="cb89-6" title="6"><span class="co">#&gt;   month     n</span></a>
<a class="sourceLine" id="cb89-7" title="7"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb89-8" title="8"><span class="co">#&gt; 1     1 27004</span></a>
<a class="sourceLine" id="cb89-9" title="9"><span class="co">#&gt; 2     2 24951</span></a>
<a class="sourceLine" id="cb89-10" title="10"><span class="co">#&gt; 3     3 28834</span></a>
<a class="sourceLine" id="cb89-11" title="11"><span class="co">#&gt; 4     4 28330</span></a>
<a class="sourceLine" id="cb89-12" title="12"><span class="co">#&gt; 5     5 28796</span></a>
<a class="sourceLine" id="cb89-13" title="13"><span class="co">#&gt; 6     6 28243</span></a>
<a class="sourceLine" id="cb89-14" title="14"><span class="co">#&gt; # … with 6 more rows</span></a></code></pre></div>
<p><code>n()</code>会把缺失值也包含到计数中，如果想要计算出非缺失值的数量，可以使用<code>sum(is.na(x))</code>。如果想要计算唯一值的数量，可以使用<code>n_distinct()</code></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" title="1"><span class="co">## 哪个目的地有最多的航空公司？</span></a>
<a class="sourceLine" id="cb90-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb90-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(dest) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb90-4" title="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">carriers =</span> <span class="kw">n_distinct</span>(carrier)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb90-5" title="5"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(carriers))</a>
<a class="sourceLine" id="cb90-6" title="6"><span class="co">#&gt; # A tibble: 105 x 2</span></a>
<a class="sourceLine" id="cb90-7" title="7"><span class="co">#&gt;   dest  carriers</span></a>
<a class="sourceLine" id="cb90-8" title="8"><span class="co">#&gt;   &lt;chr&gt;    &lt;int&gt;</span></a>
<a class="sourceLine" id="cb90-9" title="9"><span class="co">#&gt; 1 ATL          7</span></a>
<a class="sourceLine" id="cb90-10" title="10"><span class="co">#&gt; 2 BOS          7</span></a>
<a class="sourceLine" id="cb90-11" title="11"><span class="co">#&gt; 3 CLT          7</span></a>
<a class="sourceLine" id="cb90-12" title="12"><span class="co">#&gt; 4 ORD          7</span></a>
<a class="sourceLine" id="cb90-13" title="13"><span class="co">#&gt; 5 TPA          7</span></a>
<a class="sourceLine" id="cb90-14" title="14"><span class="co">#&gt; 6 AUS          6</span></a>
<a class="sourceLine" id="cb90-15" title="15"><span class="co">#&gt; # … with 99 more rows</span></a></code></pre></div>
<p>除了<code>n()</code> 以外， dplyr 提供了 4 个正式的计数函数：</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" title="1"><span class="kw">tally</span>(x, <span class="dt">wt =</span> <span class="ot">NULL</span>, <span class="dt">sort =</span> <span class="ot">FALSE</span>, <span class="dt">name =</span> <span class="st">&quot;n&quot;</span>)</a>
<a class="sourceLine" id="cb91-2" title="2"></a>
<a class="sourceLine" id="cb91-3" title="3"><span class="kw">count</span>(x, ..., <span class="dt">wt =</span> <span class="ot">NULL</span>, <span class="dt">sort =</span> <span class="ot">FALSE</span>, <span class="dt">name =</span> <span class="st">&quot;n&quot;</span>,</a>
<a class="sourceLine" id="cb91-4" title="4">  <span class="dt">.drop =</span> <span class="kw">group_by_drop_default</span>(x))</a>
<a class="sourceLine" id="cb91-5" title="5"></a>
<a class="sourceLine" id="cb91-6" title="6"><span class="kw">add_tally</span>(x, wt, <span class="dt">sort =</span> <span class="ot">FALSE</span>, <span class="dt">name =</span> <span class="st">&quot;n&quot;</span>)</a>
<a class="sourceLine" id="cb91-7" title="7"></a>
<a class="sourceLine" id="cb91-8" title="8"><span class="kw">add_count</span>(x, ..., <span class="dt">wt =</span> <span class="ot">NULL</span>, <span class="dt">sort =</span> <span class="ot">FALSE</span>, <span class="dt">name =</span> <span class="st">&quot;n&quot;</span>)</a></code></pre></div>
<p><code>x %&gt;% group_by(var) %&gt;% tally()</code> 是简化版的 <code>group_by(var) + summarize(n())</code><br />
<code>x %&gt;% count(var)</code> 等价于 <code>x %&gt;% gruop_by(var) %&gt;% tally()</code></p>
<p><code>x %&gt;% group_by(var) %&gt;% add_tally</code> 在 <strong>原数据集</strong> 中增添一列，记录 <code>var</code> 的不同水平的计数，等价于 <code>x %&gt;% add_count(var)</code>，注意这两个函数返回值的维度和<strong>原数据框</strong>相同(摘要数据框往往不利于细节观察)！！它们等价于 <code>group_by() %&gt;% mutate(n())</code></p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" title="1"><span class="co">## 无分组时，tally()即为样本数</span></a>
<a class="sourceLine" id="cb92-2" title="2">mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-3" title="3"><span class="st">  </span>tally</a>
<a class="sourceLine" id="cb92-4" title="4"><span class="co">#&gt;    n</span></a>
<a class="sourceLine" id="cb92-5" title="5"><span class="co">#&gt; 1 32</span></a>
<a class="sourceLine" id="cb92-6" title="6"></a>
<a class="sourceLine" id="cb92-7" title="7"><span class="co">## tally() 的一般用法  </span></a>
<a class="sourceLine" id="cb92-8" title="8">mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-9" title="9"><span class="st">  </span><span class="kw">group_by</span>(cyl) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-10" title="10"><span class="st">  </span><span class="kw">tally</span>()</a>
<a class="sourceLine" id="cb92-11" title="11"><span class="co">#&gt; # A tibble: 3 x 2</span></a>
<a class="sourceLine" id="cb92-12" title="12"><span class="co">#&gt;     cyl     n</span></a>
<a class="sourceLine" id="cb92-13" title="13"><span class="co">#&gt;   &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb92-14" title="14"><span class="co">#&gt; 1     4    11</span></a>
<a class="sourceLine" id="cb92-15" title="15"><span class="co">#&gt; 2     6     7</span></a>
<a class="sourceLine" id="cb92-16" title="16"><span class="co">#&gt; 3     8    14</span></a>
<a class="sourceLine" id="cb92-17" title="17"></a>
<a class="sourceLine" id="cb92-18" title="18"><span class="co">## count() 等价 group_by() + tally()</span></a>
<a class="sourceLine" id="cb92-19" title="19">mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-20" title="20"><span class="st">  </span><span class="kw">count</span>(cyl)</a>
<a class="sourceLine" id="cb92-21" title="21"><span class="co">#&gt; # A tibble: 3 x 2</span></a>
<a class="sourceLine" id="cb92-22" title="22"><span class="co">#&gt;     cyl     n</span></a>
<a class="sourceLine" id="cb92-23" title="23"><span class="co">#&gt;   &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb92-24" title="24"><span class="co">#&gt; 1     4    11</span></a>
<a class="sourceLine" id="cb92-25" title="25"><span class="co">#&gt; 2     6     7</span></a>
<a class="sourceLine" id="cb92-26" title="26"><span class="co">#&gt; 3     8    14</span></a>
<a class="sourceLine" id="cb92-27" title="27"></a>
<a class="sourceLine" id="cb92-28" title="28"><span class="co">## count() 也可以在已有分组上继续分组  </span></a>
<a class="sourceLine" id="cb92-29" title="29">mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-30" title="30"><span class="st">  </span><span class="kw">group_by</span>(gear) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-31" title="31"><span class="st">  </span><span class="kw">count</span>(carb)</a>
<a class="sourceLine" id="cb92-32" title="32"><span class="co">#&gt; # A tibble: 11 x 3</span></a>
<a class="sourceLine" id="cb92-33" title="33"><span class="co">#&gt; # Groups:   gear [3]</span></a>
<a class="sourceLine" id="cb92-34" title="34"><span class="co">#&gt;    gear  carb     n</span></a>
<a class="sourceLine" id="cb92-35" title="35"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb92-36" title="36"><span class="co">#&gt; 1     3     1     3</span></a>
<a class="sourceLine" id="cb92-37" title="37"><span class="co">#&gt; 2     3     2     4</span></a>
<a class="sourceLine" id="cb92-38" title="38"><span class="co">#&gt; 3     3     3     3</span></a>
<a class="sourceLine" id="cb92-39" title="39"><span class="co">#&gt; 4     3     4     5</span></a>
<a class="sourceLine" id="cb92-40" title="40"><span class="co">#&gt; 5     4     1     4</span></a>
<a class="sourceLine" id="cb92-41" title="41"><span class="co">#&gt; 6     4     2     4</span></a>
<a class="sourceLine" id="cb92-42" title="42"><span class="co">#&gt; # … with 5 more rows</span></a>
<a class="sourceLine" id="cb92-43" title="43"></a>
<a class="sourceLine" id="cb92-44" title="44"><span class="co">## add_tally() is short-hand for mutate()</span></a>
<a class="sourceLine" id="cb92-45" title="45">mtcars <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb92-46" title="46"><span class="st">  </span><span class="kw">add_tally</span>()</a>
<a class="sourceLine" id="cb92-47" title="47"><span class="co">#&gt; # A tibble: 32 x 12</span></a>
<a class="sourceLine" id="cb92-48" title="48"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb     n</span></a>
<a class="sourceLine" id="cb92-49" title="49"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb92-50" title="50"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4    32</span></a>
<a class="sourceLine" id="cb92-51" title="51"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4    32</span></a>
<a class="sourceLine" id="cb92-52" title="52"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1    32</span></a>
<a class="sourceLine" id="cb92-53" title="53"><span class="co">#&gt; 4  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1    32</span></a>
<a class="sourceLine" id="cb92-54" title="54"><span class="co">#&gt; 5  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2    32</span></a>
<a class="sourceLine" id="cb92-55" title="55"><span class="co">#&gt; 6  18.1     6   225   105  2.76  3.46  20.2     1     0     3     1    32</span></a>
<a class="sourceLine" id="cb92-56" title="56"><span class="co">#&gt; # … with 26 more rows</span></a>
<a class="sourceLine" id="cb92-57" title="57"></a>
<a class="sourceLine" id="cb92-58" title="58"><span class="co">## add_count() is a short-hand for group_by() + add_tally()</span></a>
<a class="sourceLine" id="cb92-59" title="59">mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-60" title="60"><span class="st">  </span><span class="kw">add_count</span>(cyl, <span class="dt">name =</span> <span class="st">&quot;count&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-61" title="61"><span class="st">  </span><span class="kw">select</span>(cyl, count)</a>
<a class="sourceLine" id="cb92-62" title="62"><span class="co">#&gt; # A tibble: 32 x 2</span></a>
<a class="sourceLine" id="cb92-63" title="63"><span class="co">#&gt;     cyl count</span></a>
<a class="sourceLine" id="cb92-64" title="64"><span class="co">#&gt;   &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb92-65" title="65"><span class="co">#&gt; 1     6     7</span></a>
<a class="sourceLine" id="cb92-66" title="66"><span class="co">#&gt; 2     6     7</span></a>
<a class="sourceLine" id="cb92-67" title="67"><span class="co">#&gt; 3     4    11</span></a>
<a class="sourceLine" id="cb92-68" title="68"><span class="co">#&gt; 4     6     7</span></a>
<a class="sourceLine" id="cb92-69" title="69"><span class="co">#&gt; 5     8    14</span></a>
<a class="sourceLine" id="cb92-70" title="70"><span class="co">#&gt; 6     6     7</span></a>
<a class="sourceLine" id="cb92-71" title="71"><span class="co">#&gt; # … with 26 more rows</span></a>
<a class="sourceLine" id="cb92-72" title="72"></a>
<a class="sourceLine" id="cb92-73" title="73"><span class="co"># add_count() is useful for groupwise filtering</span></a>
<a class="sourceLine" id="cb92-74" title="74"><span class="co"># e.g.: show details for species that have a single member</span></a>
<a class="sourceLine" id="cb92-75" title="75">starwars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-76" title="76"><span class="st">  </span><span class="kw">add_count</span>(species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-77" title="77"><span class="st">  </span><span class="kw">filter</span>(n <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb92-78" title="78"><span class="co">#&gt; # A tibble: 29 x 14</span></a>
<a class="sourceLine" id="cb92-79" title="79"><span class="co">#&gt;   name  height  mass hair_color skin_color eye_color birth_year gender homeworld</span></a>
<a class="sourceLine" id="cb92-80" title="80"><span class="co">#&gt;   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></a>
<a class="sourceLine" id="cb92-81" title="81"><span class="co">#&gt; 1 Gree…    173    74 &lt;NA&gt;       green      black             44 male   Rodia    </span></a>
<a class="sourceLine" id="cb92-82" title="82"><span class="co">#&gt; 2 Jabb…    175  1358 &lt;NA&gt;       green-tan… orange           600 herma… Nal Hutta</span></a>
<a class="sourceLine" id="cb92-83" title="83"><span class="co">#&gt; 3 Yoda      66    17 white      green      brown            896 male   &lt;NA&gt;     </span></a>
<a class="sourceLine" id="cb92-84" title="84"><span class="co">#&gt; 4 Bossk    190   113 none       green      red               53 male   Trandosha</span></a>
<a class="sourceLine" id="cb92-85" title="85"><span class="co">#&gt; 5 Ackb…    180    83 none       brown mot… orange            41 male   Mon Cala </span></a>
<a class="sourceLine" id="cb92-86" title="86"><span class="co">#&gt; 6 Wick…     88    20 brown      brown      brown              8 male   Endor    </span></a>
<a class="sourceLine" id="cb92-87" title="87"><span class="co">#&gt; # … with 23 more rows, and 5 more variables: species &lt;chr&gt;, films &lt;list&gt;,</span></a>
<a class="sourceLine" id="cb92-88" title="88"><span class="co">#&gt; #   vehicles &lt;list&gt;, starships &lt;list&gt;, n &lt;int&gt;</span></a></code></pre></div>
<p>另外，在z和一些函数中函数中设置<code>sort = T</code>可以使观测按照计数倒序排列，<code>name</code>参数可以指定新生成的计数行名字（默认为“n”):</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb93-1" title="1">not_cancelled <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb93-2" title="2"><span class="st">  </span><span class="kw">count</span>(dest, <span class="dt">sort =</span> T, <span class="dt">name =</span> <span class="st">&quot;count&quot;</span>)</a>
<a class="sourceLine" id="cb93-3" title="3"><span class="co">#&gt; # A tibble: 104 x 2</span></a>
<a class="sourceLine" id="cb93-4" title="4"><span class="co">#&gt;   dest  count</span></a>
<a class="sourceLine" id="cb93-5" title="5"><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb93-6" title="6"><span class="co">#&gt; 1 ATL   16837</span></a>
<a class="sourceLine" id="cb93-7" title="7"><span class="co">#&gt; 2 ORD   16566</span></a>
<a class="sourceLine" id="cb93-8" title="8"><span class="co">#&gt; 3 LAX   16026</span></a>
<a class="sourceLine" id="cb93-9" title="9"><span class="co">#&gt; 4 BOS   15022</span></a>
<a class="sourceLine" id="cb93-10" title="10"><span class="co">#&gt; 5 MCO   13967</span></a>
<a class="sourceLine" id="cb93-11" title="11"><span class="co">#&gt; 6 CLT   13674</span></a>
<a class="sourceLine" id="cb93-12" title="12"><span class="co">#&gt; # … with 98 more rows</span></a></code></pre></div>
<p>还可以提供一个加权变量。例如，可以使用一下代码算出每架飞机飞行的总里程（实际上就是按计算某变量分组上另一个变量的和）：</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" title="1">not_cancelled <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb94-2" title="2"><span class="st">  </span><span class="kw">count</span>(tailnum, <span class="dt">wt =</span> distance)  </a>
<a class="sourceLine" id="cb94-3" title="3"><span class="co">#&gt; # A tibble: 4,037 x 2</span></a>
<a class="sourceLine" id="cb94-4" title="4"><span class="co">#&gt;   tailnum      n</span></a>
<a class="sourceLine" id="cb94-5" title="5"><span class="co">#&gt;   &lt;chr&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb94-6" title="6"><span class="co">#&gt; 1 D942DN    3418</span></a>
<a class="sourceLine" id="cb94-7" title="7"><span class="co">#&gt; 2 N0EGMQ  239143</span></a>
<a class="sourceLine" id="cb94-8" title="8"><span class="co">#&gt; 3 N10156  109664</span></a>
<a class="sourceLine" id="cb94-9" title="9"><span class="co">#&gt; 4 N102UW   25722</span></a>
<a class="sourceLine" id="cb94-10" title="10"><span class="co">#&gt; 5 N103US   24619</span></a>
<a class="sourceLine" id="cb94-11" title="11"><span class="co">#&gt; 6 N104UW   24616</span></a>
<a class="sourceLine" id="cb94-12" title="12"><span class="co">#&gt; # … with 4,031 more rows</span></a></code></pre></div>
<p>进行聚合时，包含一列计数<code>n()</code>或非缺失值的计数<code>sum(!is.na())</code>很有用。这样就可以检查一下，以确保自己没有基于非常有限的样本做结论。<br />
例如，查看一下具有最长平均到达延误时间的飞机（基于飞机编号进行识别):</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" title="1">delays &lt;-<span class="st"> </span>not_cancelled <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb95-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(tailnum) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb95-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">delay =</span> <span class="kw">mean</span>(arr_delay))</a>
<a class="sourceLine" id="cb95-4" title="4"></a>
<a class="sourceLine" id="cb95-5" title="5"><span class="kw">ggplot</span>(delays) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb95-6" title="6"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(delay))</a></code></pre></div>
<p><img src="dplyr_files/figure-html/unnamed-chunk-103-1.svg" width="80%" /></p>
<p>有些飞机的<strong>平均</strong>到达延误事件竟然接近300分钟，我们可以画一张航班数量和平均延误时间的散点图，一遍获得更深刻的理解:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb96-1" title="1"><span class="co">## n = n()对group_by中的变量水平进行计数，生成一个计数变量命名为n</span></a>
<a class="sourceLine" id="cb96-2" title="2">delays &lt;-<span class="st"> </span>not_cancelled <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb96-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(tailnum) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb96-4" title="4"><span class="st">  </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb96-5" title="5">    <span class="dt">delay =</span> <span class="kw">mean</span>(arr_delay),</a>
<a class="sourceLine" id="cb96-6" title="6">    <span class="dt">n =</span> <span class="kw">n</span>())</a>
<a class="sourceLine" id="cb96-7" title="7"></a>
<a class="sourceLine" id="cb96-8" title="8"><span class="kw">ggplot</span>(delays) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> n,<span class="dt">y =</span> delay),<span class="dt">alpha =</span> <span class="fl">0.1</span>)</a></code></pre></div>
<p><img src="dplyr_files/figure-html/unnamed-chunk-104-1.svg" width="80%" /></p>
<p>从散点图可以看出，如果航班对应的出航次数非常少时，平均延误时间的变动特别大，所有延误时间较长的航班的出航次数几乎都在 0 右边一点点。这张图的形状非常能说明问题:当绘制均值（或其他摘要统计量）和分组规模的关系时，总能看到样本量的增加，变动在不断减小。（样本统计量的方差随样本数变小）。</p>
<p>这种数据模式还有另外一种常见的变体。我们来看一下棒球击球手的平均表现与击球次数之间的关系。我们用Lahman包中的数据埃及算棒球大联盟中的每个棒球队员的加大率（安打数 / 打数):</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb97-1" title="1"><span class="kw">library</span>(Lahman)</a>
<a class="sourceLine" id="cb97-2" title="2">batters &lt;-<span class="st"> </span>Batting <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb97-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(playerID) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb97-4" title="4"><span class="st">  </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb97-5" title="5">    <span class="dt">ba =</span> <span class="kw">sum</span>(H,<span class="dt">na.rm =</span> T) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(AB,<span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb97-6" title="6">    <span class="dt">ab =</span> <span class="kw">sum</span>(AB,<span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb97-7" title="7"></a>
<a class="sourceLine" id="cb97-8" title="8">batters <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb97-9" title="9"><span class="st">  </span><span class="kw">filter</span>(ab <span class="op">&gt;</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb97-10" title="10"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ab, ba)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb97-11" title="11"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb97-12" title="12"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">se =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p><img src="dplyr_files/figure-html/unnamed-chunk-105-1.svg" width="80%" /></p>
<p>当绘制击球手的能力（用打击率 ba 衡量）与击球机会数量（用总打数ab衡量）之间的关系时，可以看到两个趋势：</p>
<ul>
<li>总大数越多，不同击球手的打击率之间变动越小<br />
</li>
<li>能力（ba）和击球机会数量（ab）之间存在正相关。这是因为球队会控制击球手的出场，很显然，球队会优先选择最好的队员。</li>
</ul>
<p>这对球员排名也有重要印象，如果只是使用<code>desc(ba)</code>进行排序，明显受益的将是那些因为出场数很少而侥幸有很高击打率的球员，而不是真正能力最高的球员：</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb98-1" title="1">batters <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb98-2" title="2"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(ba))</a>
<a class="sourceLine" id="cb98-3" title="3"><span class="co">#&gt; # A tibble: 19,428 x 3</span></a>
<a class="sourceLine" id="cb98-4" title="4"><span class="co">#&gt;   playerID     ba    ab</span></a>
<a class="sourceLine" id="cb98-5" title="5"><span class="co">#&gt;   &lt;chr&gt;     &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb98-6" title="6"><span class="co">#&gt; 1 abramge01     1     1</span></a>
<a class="sourceLine" id="cb98-7" title="7"><span class="co">#&gt; 2 alberan01     1     1</span></a>
<a class="sourceLine" id="cb98-8" title="8"><span class="co">#&gt; 3 allarko01     1     1</span></a>
<a class="sourceLine" id="cb98-9" title="9"><span class="co">#&gt; 4 banisje01     1     1</span></a>
<a class="sourceLine" id="cb98-10" title="10"><span class="co">#&gt; 5 bartocl01     1     1</span></a>
<a class="sourceLine" id="cb98-11" title="11"><span class="co">#&gt; 6 bassdo01      1     1</span></a>
<a class="sourceLine" id="cb98-12" title="12"><span class="co">#&gt; # … with 1.942e+04 more rows</span></a></code></pre></div>
</div>
<div id="逻辑值的计数和比例sumx-10-和-meany-0" class="section level3">
<h3><span class="header-section-number">1.6.3</span> 逻辑值的计数和比例:<code>sum(x &gt; 10) 和 mean(y == 0)</code></h3>
<p>当与数值型函数一同使用时，<code>TRUE</code>会转换为1，<code>FALSE</code>会转换为0。这使得<code>sum()</code>和<code>mean()</code>非常适用于逻辑值：<code>sum()</code>可以找出x中TRUE的数量，<code>mean()</code>则可以找出比例。</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb99-1" title="1"><span class="co">## 每天中有多少架航班是在早上5点前出发的？（这通常表明前一天延误的航班数量）</span></a>
<a class="sourceLine" id="cb99-2" title="2">not_cancelled <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(year,month,day) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-4" title="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n_early =</span> <span class="kw">sum</span>(dep_time <span class="op">&lt;</span><span class="st"> </span><span class="dv">500</span>))</a>
<a class="sourceLine" id="cb99-5" title="5"><span class="co">#&gt; # A tibble: 365 x 4</span></a>
<a class="sourceLine" id="cb99-6" title="6"><span class="co">#&gt; # Groups:   year, month [12]</span></a>
<a class="sourceLine" id="cb99-7" title="7"><span class="co">#&gt;    year month   day n_early</span></a>
<a class="sourceLine" id="cb99-8" title="8"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;</span></a>
<a class="sourceLine" id="cb99-9" title="9"><span class="co">#&gt; 1  2013     1     1       0</span></a>
<a class="sourceLine" id="cb99-10" title="10"><span class="co">#&gt; 2  2013     1     2       3</span></a>
<a class="sourceLine" id="cb99-11" title="11"><span class="co">#&gt; 3  2013     1     3       4</span></a>
<a class="sourceLine" id="cb99-12" title="12"><span class="co">#&gt; 4  2013     1     4       3</span></a>
<a class="sourceLine" id="cb99-13" title="13"><span class="co">#&gt; 5  2013     1     5       3</span></a>
<a class="sourceLine" id="cb99-14" title="14"><span class="co">#&gt; 6  2013     1     6       2</span></a>
<a class="sourceLine" id="cb99-15" title="15"><span class="co">#&gt; # … with 359 more rows</span></a>
<a class="sourceLine" id="cb99-16" title="16"><span class="co">## 每天中到达时间误超过一小时的航班比例是多少？</span></a>
<a class="sourceLine" id="cb99-17" title="17">not_cancelled <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-18" title="18"><span class="st">  </span><span class="kw">group_by</span>(year,month,day) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-19" title="19"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">hour_perc =</span> <span class="kw">mean</span>(arr_delay <span class="op">&gt;</span><span class="st"> </span><span class="dv">60</span>))</a>
<a class="sourceLine" id="cb99-20" title="20"><span class="co">#&gt; # A tibble: 365 x 4</span></a>
<a class="sourceLine" id="cb99-21" title="21"><span class="co">#&gt; # Groups:   year, month [12]</span></a>
<a class="sourceLine" id="cb99-22" title="22"><span class="co">#&gt;    year month   day hour_perc</span></a>
<a class="sourceLine" id="cb99-23" title="23"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb99-24" title="24"><span class="co">#&gt; 1  2013     1     1    0.0722</span></a>
<a class="sourceLine" id="cb99-25" title="25"><span class="co">#&gt; 2  2013     1     2    0.0851</span></a>
<a class="sourceLine" id="cb99-26" title="26"><span class="co">#&gt; 3  2013     1     3    0.0567</span></a>
<a class="sourceLine" id="cb99-27" title="27"><span class="co">#&gt; 4  2013     1     4    0.0396</span></a>
<a class="sourceLine" id="cb99-28" title="28"><span class="co">#&gt; 5  2013     1     5    0.0349</span></a>
<a class="sourceLine" id="cb99-29" title="29"><span class="co">#&gt; 6  2013     1     6    0.0470</span></a>
<a class="sourceLine" id="cb99-30" title="30"><span class="co">#&gt; # … with 359 more rows</span></a></code></pre></div>
</div>
<div id="其他常用的摘要函数" class="section level3">
<h3><span class="header-section-number">1.6.4</span> 其他常用的摘要函数</h3>
<p>R中还提供了许多常用的摘要函数</p>
<p><strong>位置度量</strong><br />
我们已经使用过<code>mean(x)</code>、但用 <code>median(x)</code> 计算中位数也非常有用。</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb100-1" title="1"><span class="co">## 将聚合函数和逻辑筛选组合起来使用</span></a>
<a class="sourceLine" id="cb100-2" title="2">not_cancelled <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(year,month,day) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb100-3" title="3">  <span class="co">## 延误时间的中位数</span></a>
<a class="sourceLine" id="cb100-4" title="4">  <span class="dt">arr_delay1 =</span> <span class="kw">median</span>(arr_delay),</a>
<a class="sourceLine" id="cb100-5" title="5">  <span class="co">## 正延误时间的中位数</span></a>
<a class="sourceLine" id="cb100-6" title="6">  <span class="dt">arr_delay2 =</span> <span class="kw">median</span>(arr_delay[arr_delay <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>])</a>
<a class="sourceLine" id="cb100-7" title="7">)</a>
<a class="sourceLine" id="cb100-8" title="8"><span class="co">#&gt; # A tibble: 365 x 5</span></a>
<a class="sourceLine" id="cb100-9" title="9"><span class="co">#&gt; # Groups:   year, month [12]</span></a>
<a class="sourceLine" id="cb100-10" title="10"><span class="co">#&gt;    year month   day arr_delay1 arr_delay2</span></a>
<a class="sourceLine" id="cb100-11" title="11"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb100-12" title="12"><span class="co">#&gt; 1  2013     1     1          3         17</span></a>
<a class="sourceLine" id="cb100-13" title="13"><span class="co">#&gt; 2  2013     1     2          4         16</span></a>
<a class="sourceLine" id="cb100-14" title="14"><span class="co">#&gt; 3  2013     1     3          1         16</span></a>
<a class="sourceLine" id="cb100-15" title="15"><span class="co">#&gt; 4  2013     1     4         -8         16</span></a>
<a class="sourceLine" id="cb100-16" title="16"><span class="co">#&gt; 5  2013     1     5         -7         11</span></a>
<a class="sourceLine" id="cb100-17" title="17"><span class="co">#&gt; 6  2013     1     6         -1         15</span></a>
<a class="sourceLine" id="cb100-18" title="18"><span class="co">#&gt; # … with 359 more rows</span></a></code></pre></div>
<p><strong>分散程度度量<code>sd(x)、IQR(x)和mad(x)</code></strong><br />
标准差是分散程度的标准度量方式。四分位距INterquartile Range<code>IQR(x)</code>和绝对中位差<code>mad(x)</code>基本等价，更适合有离群点的情况：</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb101-1" title="1"><span class="co">## 为什么到某些目的地距离比到其他目的地更多变？</span></a>
<a class="sourceLine" id="cb101-2" title="2">not_cancelled <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(dest) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">distance_sd =</span> <span class="kw">sd</span>(distance)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(distance_sd))</a>
<a class="sourceLine" id="cb101-3" title="3"><span class="co">#&gt; # A tibble: 104 x 2</span></a>
<a class="sourceLine" id="cb101-4" title="4"><span class="co">#&gt;   dest  distance_sd</span></a>
<a class="sourceLine" id="cb101-5" title="5"><span class="co">#&gt;   &lt;chr&gt;       &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb101-6" title="6"><span class="co">#&gt; 1 EGE         10.5 </span></a>
<a class="sourceLine" id="cb101-7" title="7"><span class="co">#&gt; 2 SAN         10.4 </span></a>
<a class="sourceLine" id="cb101-8" title="8"><span class="co">#&gt; 3 SFO         10.2 </span></a>
<a class="sourceLine" id="cb101-9" title="9"><span class="co">#&gt; 4 HNL         10.0 </span></a>
<a class="sourceLine" id="cb101-10" title="10"><span class="co">#&gt; 5 SEA          9.98</span></a>
<a class="sourceLine" id="cb101-11" title="11"><span class="co">#&gt; 6 LAS          9.91</span></a>
<a class="sourceLine" id="cb101-12" title="12"><span class="co">#&gt; # … with 98 more rows</span></a></code></pre></div>
<p><strong>秩的度量:<code>min(x)、quantile(x,0.25)和max(x)</code></strong><br />
分位数是中位数的扩展。例如<code>quantile(x,0.25)</code>会找出x中按从小到大顺序大于前25%而小于后75%的值（即下四分位数）</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb102-1" title="1"><span class="co">## 每天最早和最晚的航班何时出发？</span></a>
<a class="sourceLine" id="cb102-2" title="2">not_cancelled <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(year,month,day) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">first =</span> <span class="kw">min</span>(dep_time),<span class="dt">last =</span> <span class="kw">max</span>(dep_time)) </a>
<a class="sourceLine" id="cb102-3" title="3"><span class="co">#&gt; # A tibble: 365 x 5</span></a>
<a class="sourceLine" id="cb102-4" title="4"><span class="co">#&gt; # Groups:   year, month [12]</span></a>
<a class="sourceLine" id="cb102-5" title="5"><span class="co">#&gt;    year month   day first  last</span></a>
<a class="sourceLine" id="cb102-6" title="6"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb102-7" title="7"><span class="co">#&gt; 1  2013     1     1   517  2356</span></a>
<a class="sourceLine" id="cb102-8" title="8"><span class="co">#&gt; 2  2013     1     2    42  2354</span></a>
<a class="sourceLine" id="cb102-9" title="9"><span class="co">#&gt; 3  2013     1     3    32  2349</span></a>
<a class="sourceLine" id="cb102-10" title="10"><span class="co">#&gt; 4  2013     1     4    25  2358</span></a>
<a class="sourceLine" id="cb102-11" title="11"><span class="co">#&gt; 5  2013     1     5    14  2357</span></a>
<a class="sourceLine" id="cb102-12" title="12"><span class="co">#&gt; 6  2013     1     6    16  2355</span></a>
<a class="sourceLine" id="cb102-13" title="13"><span class="co">#&gt; # … with 359 more rows</span></a></code></pre></div>
<p><strong>定位度量:<code>first(x)、nth(x,n)、last(x)</code></strong><br />
这几个函数的作用与<code>x[1]、x[n]和x[length(x)]</code>相同，只是当定位不存在时（比如尝试从只有两个元素的分组中得到第三个元素），这些函数允许通过参数<code>default</code>设置一个默认值，而后者不能正常工作。</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb103-1" title="1"><span class="co">## 找出每天排在第10的的出发时间记录</span></a>
<a class="sourceLine" id="cb103-2" title="2">not_cancelled <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb103-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(month,year,day) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb103-4" title="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">tenth_dep =</span> <span class="kw">nth</span>(dep_time,<span class="dv">10</span>))</a>
<a class="sourceLine" id="cb103-5" title="5"><span class="co">#&gt; # A tibble: 365 x 4</span></a>
<a class="sourceLine" id="cb103-6" title="6"><span class="co">#&gt; # Groups:   month, year [12]</span></a>
<a class="sourceLine" id="cb103-7" title="7"><span class="co">#&gt;   month  year   day tenth_dep</span></a>
<a class="sourceLine" id="cb103-8" title="8"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;int&gt;</span></a>
<a class="sourceLine" id="cb103-9" title="9"><span class="co">#&gt; 1     1  2013     1       558</span></a>
<a class="sourceLine" id="cb103-10" title="10"><span class="co">#&gt; 2     1  2013     2       554</span></a>
<a class="sourceLine" id="cb103-11" title="11"><span class="co">#&gt; 3     1  2013     3       552</span></a>
<a class="sourceLine" id="cb103-12" title="12"><span class="co">#&gt; 4     1  2013     4       553</span></a>
<a class="sourceLine" id="cb103-13" title="13"><span class="co">#&gt; 5     1  2013     5       555</span></a>
<a class="sourceLine" id="cb103-14" title="14"><span class="co">#&gt; 6     1  2013     6       558</span></a>
<a class="sourceLine" id="cb103-15" title="15"><span class="co">#&gt; # … with 359 more rows</span></a></code></pre></div>
</div>
<div id="多个分组变量的消耗" class="section level3">
<h3><span class="header-section-number">1.6.5</span> 多个分组变量的消耗</h3>
<p>当时用多个分组变量时，每使用一次<code>summarize</code>就会消耗掉一个分组变量，如<code>group_by(year,month,day)</code>经过一次<code>summarize</code>后生成的数据集默认在<code>(year,month)</code>上分组，这使得我们可以对数据集进行循序渐进的分析：</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb104-1" title="1">daily &lt;-<span class="st"> </span>not_cancelled <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(year,month,day) </a>
<a class="sourceLine" id="cb104-2" title="2"><span class="co">## 每天有多少架航班记录</span></a>
<a class="sourceLine" id="cb104-3" title="3">(per_day &lt;-<span class="st"> </span>daily <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-4" title="4"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">flights =</span> <span class="kw">n</span>()))  </a>
<a class="sourceLine" id="cb104-5" title="5"><span class="co">#&gt; # A tibble: 365 x 4</span></a>
<a class="sourceLine" id="cb104-6" title="6"><span class="co">#&gt; # Groups:   year, month [12]</span></a>
<a class="sourceLine" id="cb104-7" title="7"><span class="co">#&gt;    year month   day flights</span></a>
<a class="sourceLine" id="cb104-8" title="8"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;</span></a>
<a class="sourceLine" id="cb104-9" title="9"><span class="co">#&gt; 1  2013     1     1     831</span></a>
<a class="sourceLine" id="cb104-10" title="10"><span class="co">#&gt; 2  2013     1     2     928</span></a>
<a class="sourceLine" id="cb104-11" title="11"><span class="co">#&gt; 3  2013     1     3     900</span></a>
<a class="sourceLine" id="cb104-12" title="12"><span class="co">#&gt; 4  2013     1     4     908</span></a>
<a class="sourceLine" id="cb104-13" title="13"><span class="co">#&gt; 5  2013     1     5     717</span></a>
<a class="sourceLine" id="cb104-14" title="14"><span class="co">#&gt; 6  2013     1     6     829</span></a>
<a class="sourceLine" id="cb104-15" title="15"><span class="co">#&gt; # … with 359 more rows</span></a>
<a class="sourceLine" id="cb104-16" title="16"></a>
<a class="sourceLine" id="cb104-17" title="17"><span class="co">## 每月有多少架航班记录</span></a>
<a class="sourceLine" id="cb104-18" title="18">(per_month &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb104-19" title="19"><span class="st">    </span>per_day <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-20" title="20"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">flights =</span> <span class="kw">sum</span>(flights))) </a>
<a class="sourceLine" id="cb104-21" title="21"><span class="co">#&gt; # A tibble: 12 x 3</span></a>
<a class="sourceLine" id="cb104-22" title="22"><span class="co">#&gt; # Groups:   year [1]</span></a>
<a class="sourceLine" id="cb104-23" title="23"><span class="co">#&gt;    year month flights</span></a>
<a class="sourceLine" id="cb104-24" title="24"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt;   &lt;int&gt;</span></a>
<a class="sourceLine" id="cb104-25" title="25"><span class="co">#&gt; 1  2013     1   26398</span></a>
<a class="sourceLine" id="cb104-26" title="26"><span class="co">#&gt; 2  2013     2   23611</span></a>
<a class="sourceLine" id="cb104-27" title="27"><span class="co">#&gt; 3  2013     3   27902</span></a>
<a class="sourceLine" id="cb104-28" title="28"><span class="co">#&gt; 4  2013     4   27564</span></a>
<a class="sourceLine" id="cb104-29" title="29"><span class="co">#&gt; 5  2013     5   28128</span></a>
<a class="sourceLine" id="cb104-30" title="30"><span class="co">#&gt; 6  2013     6   27075</span></a>
<a class="sourceLine" id="cb104-31" title="31"><span class="co">#&gt; # … with 6 more rows</span></a>
<a class="sourceLine" id="cb104-32" title="32"><span class="co">## 等价于not_cancelled %&gt;% group_by(year,month) %&gt;% summarize(flights = n()) </span></a>
<a class="sourceLine" id="cb104-33" title="33"></a>
<a class="sourceLine" id="cb104-34" title="34"><span class="co">## 每年有多少架航班记录</span></a>
<a class="sourceLine" id="cb104-35" title="35">(per_year &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb104-36" title="36"><span class="st">    </span>per_month <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-37" title="37"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">flights =</span> <span class="kw">sum</span>(flights)))</a>
<a class="sourceLine" id="cb104-38" title="38"><span class="co">#&gt; # A tibble: 1 x 2</span></a>
<a class="sourceLine" id="cb104-39" title="39"><span class="co">#&gt;    year flights</span></a>
<a class="sourceLine" id="cb104-40" title="40"><span class="co">#&gt;   &lt;int&gt;   &lt;int&gt;</span></a>
<a class="sourceLine" id="cb104-41" title="41"><span class="co">#&gt; 1  2013  327346</span></a>
<a class="sourceLine" id="cb104-42" title="42"><span class="co">## 等价于not_cancelled %&gt;% group_by(year) %&gt;% summarize(flights = n()) </span></a></code></pre></div>
<p>由于分组操作拥有这样的“继承性质”，有的时候可能想要取消分组，并回到未分组的数据继续操作，那么可以使用<code>ungroup()</code>函数取消分组：</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb105-1" title="1">daily <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-2" title="2"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">flights =</span> <span class="kw">n</span>())  <span class="co">## 对数据集整体进行摘要统计</span></a>
<a class="sourceLine" id="cb105-4" title="4"><span class="co">#&gt; # A tibble: 1 x 1</span></a>
<a class="sourceLine" id="cb105-5" title="5"><span class="co">#&gt;   flights</span></a>
<a class="sourceLine" id="cb105-6" title="6"><span class="co">#&gt;     &lt;int&gt;</span></a>
<a class="sourceLine" id="cb105-7" title="7"><span class="co">#&gt; 1  327346</span></a></code></pre></div>
<p>在循序渐进地进行摘要分析的时候，需要小心：使用求和与计数操作是没有问题的，但如果想要使用加权平均和方差的话，就要仔细考虑一下，任何基于秩的统计数据（如中位数，分为差）都不支持这样的操作。换句话说，对分组结果再求和就是对整体求和，但各分组中的中位数的中位数可不是整体的中位数。</p>
</div>
</div>
<div id="group_by-结合其他函数" class="section level2">
<h2><span class="header-section-number">1.7</span> <code>group_by()</code> 结合其他函数</h2>
<p>虽然与<code>summarize()</code>函数结合起来使用是最有效的，但分组也可以和<code>mutate()</code>和<code>filter()</code>函数结合使用,以完成非常便捷的操作。<br />
当<code>group_by</code>和<code>mutate()</code>函数结合使用时，摘要函数(summary functions，如<code>mean,median等</code>)将会自动以分组为基础，一些非摘要函数也会受到分组的影响，如偏移函数<code>lead()、lag()</code>和排秩函数<code>min_rank()、row_number()</code>。而普通的数字运算符<code>+ , -</code>、逻辑运算符<code>&lt; , ==</code>，对数运算<code>log()</code>和余数运算<code>%/% , %%</code>等将无视分组。<br />
同理，当 <code>group_by</code> 和 <code>filter()</code> 结合使用时，如果用于筛选的条件是上述提到的受分组影响的函数，那么筛选的结果也依赖于分组。</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb106-1" title="1"><span class="co">## 分组前后mutate()函数效果的对比</span></a>
<a class="sourceLine" id="cb106-2" title="2">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb106-3" title="3">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,</a>
<a class="sourceLine" id="cb106-4" title="4">  <span class="dt">group =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dt">each =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb106-5" title="5">)</a>
<a class="sourceLine" id="cb106-6" title="6"></a>
<a class="sourceLine" id="cb106-7" title="7">df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-8" title="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x_mean =</span> <span class="kw">mean</span>(x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-9" title="9"><span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-10" title="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x_mean_2 =</span> <span class="kw">mean</span>(x))</a>
<a class="sourceLine" id="cb106-11" title="11"><span class="co">#&gt; # A tibble: 9 x 4</span></a>
<a class="sourceLine" id="cb106-12" title="12"><span class="co">#&gt; # Groups:   group [3]</span></a>
<a class="sourceLine" id="cb106-13" title="13"><span class="co">#&gt;       x group x_mean x_mean_2</span></a>
<a class="sourceLine" id="cb106-14" title="14"><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb106-15" title="15"><span class="co">#&gt; 1     1 a          5        2</span></a>
<a class="sourceLine" id="cb106-16" title="16"><span class="co">#&gt; 2     2 a          5        2</span></a>
<a class="sourceLine" id="cb106-17" title="17"><span class="co">#&gt; 3     3 a          5        2</span></a>
<a class="sourceLine" id="cb106-18" title="18"><span class="co">#&gt; 4     4 b          5        5</span></a>
<a class="sourceLine" id="cb106-19" title="19"><span class="co">#&gt; 5     5 b          5        5</span></a>
<a class="sourceLine" id="cb106-20" title="20"><span class="co">#&gt; 6     6 b          5        5</span></a>
<a class="sourceLine" id="cb106-21" title="21"><span class="co">#&gt; # … with 3 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb107-1" title="1"><span class="co">## Arithmetic operators +, -, *, /, ^ are not affected by group_by().</span></a>
<a class="sourceLine" id="cb107-2" title="2">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb107-3" title="3">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,</a>
<a class="sourceLine" id="cb107-4" title="4">  <span class="dt">group =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dt">each =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb107-5" title="5">) </a>
<a class="sourceLine" id="cb107-6" title="6"></a>
<a class="sourceLine" id="cb107-7" title="7">df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb107-8" title="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">y =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb107-9" title="9"><span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb107-10" title="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">z =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb107-11" title="11"><span class="co">#&gt; # A tibble: 9 x 4</span></a>
<a class="sourceLine" id="cb107-12" title="12"><span class="co">#&gt; # Groups:   group [3]</span></a>
<a class="sourceLine" id="cb107-13" title="13"><span class="co">#&gt;       x group     y     z</span></a>
<a class="sourceLine" id="cb107-14" title="14"><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb107-15" title="15"><span class="co">#&gt; 1     1 a         3     3</span></a>
<a class="sourceLine" id="cb107-16" title="16"><span class="co">#&gt; 2     2 a         4     4</span></a>
<a class="sourceLine" id="cb107-17" title="17"><span class="co">#&gt; 3     3 a         5     5</span></a>
<a class="sourceLine" id="cb107-18" title="18"><span class="co">#&gt; 4     4 b         6     6</span></a>
<a class="sourceLine" id="cb107-19" title="19"><span class="co">#&gt; 5     5 b         7     7</span></a>
<a class="sourceLine" id="cb107-20" title="20"><span class="co">#&gt; 6     6 b         8     8</span></a>
<a class="sourceLine" id="cb107-21" title="21"><span class="co">#&gt; # … with 3 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb108-1" title="1"><span class="co">## The modular arithmetic operators %/% and %% are not affected by group_by()</span></a>
<a class="sourceLine" id="cb108-2" title="2">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb108-3" title="3">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,</a>
<a class="sourceLine" id="cb108-4" title="4">  <span class="dt">group =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dt">each =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb108-5" title="5">) </a>
<a class="sourceLine" id="cb108-6" title="6"></a>
<a class="sourceLine" id="cb108-7" title="7">df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb108-8" title="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">y =</span> x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb108-9" title="9"><span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb108-10" title="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">z =</span> x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb108-11" title="11"><span class="co">#&gt; # A tibble: 9 x 4</span></a>
<a class="sourceLine" id="cb108-12" title="12"><span class="co">#&gt; # Groups:   group [3]</span></a>
<a class="sourceLine" id="cb108-13" title="13"><span class="co">#&gt;       x group     y     z</span></a>
<a class="sourceLine" id="cb108-14" title="14"><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb108-15" title="15"><span class="co">#&gt; 1     1 a         1     1</span></a>
<a class="sourceLine" id="cb108-16" title="16"><span class="co">#&gt; 2     2 a         0     0</span></a>
<a class="sourceLine" id="cb108-17" title="17"><span class="co">#&gt; 3     3 a         1     1</span></a>
<a class="sourceLine" id="cb108-18" title="18"><span class="co">#&gt; 4     4 b         0     0</span></a>
<a class="sourceLine" id="cb108-19" title="19"><span class="co">#&gt; 5     5 b         1     1</span></a>
<a class="sourceLine" id="cb108-20" title="20"><span class="co">#&gt; 6     6 b         0     0</span></a>
<a class="sourceLine" id="cb108-21" title="21"><span class="co">#&gt; # … with 3 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb109-1" title="1"><span class="co">## The logarithmic functions log(), log2(), and log10() are not affected by group_by().</span></a>
<a class="sourceLine" id="cb109-2" title="2">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb109-3" title="3">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,</a>
<a class="sourceLine" id="cb109-4" title="4">  <span class="dt">group =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dt">each =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb109-5" title="5">) </a>
<a class="sourceLine" id="cb109-6" title="6"></a>
<a class="sourceLine" id="cb109-7" title="7">df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb109-8" title="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">y =</span> <span class="kw">log</span>(x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb109-9" title="9"><span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb109-10" title="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">z =</span> <span class="kw">log</span>(x))</a>
<a class="sourceLine" id="cb109-11" title="11"><span class="co">#&gt; # A tibble: 9 x 4</span></a>
<a class="sourceLine" id="cb109-12" title="12"><span class="co">#&gt; # Groups:   group [3]</span></a>
<a class="sourceLine" id="cb109-13" title="13"><span class="co">#&gt;       x group     y     z</span></a>
<a class="sourceLine" id="cb109-14" title="14"><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb109-15" title="15"><span class="co">#&gt; 1     1 a     0     0    </span></a>
<a class="sourceLine" id="cb109-16" title="16"><span class="co">#&gt; 2     2 a     0.693 0.693</span></a>
<a class="sourceLine" id="cb109-17" title="17"><span class="co">#&gt; 3     3 a     1.10  1.10 </span></a>
<a class="sourceLine" id="cb109-18" title="18"><span class="co">#&gt; 4     4 b     1.39  1.39 </span></a>
<a class="sourceLine" id="cb109-19" title="19"><span class="co">#&gt; 5     5 b     1.61  1.61 </span></a>
<a class="sourceLine" id="cb109-20" title="20"><span class="co">#&gt; 6     6 b     1.79  1.79 </span></a>
<a class="sourceLine" id="cb109-21" title="21"><span class="co">#&gt; # … with 3 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb110-1" title="1"><span class="co">## The offset functions lead() and lag() respect the groupings in group_by(). The functions lag() and lead() will only return values within each group.</span></a>
<a class="sourceLine" id="cb110-2" title="2"></a>
<a class="sourceLine" id="cb110-3" title="3">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb110-4" title="4">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,</a>
<a class="sourceLine" id="cb110-5" title="5">  <span class="dt">group =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dt">each =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb110-6" title="6">) </a>
<a class="sourceLine" id="cb110-7" title="7"></a>
<a class="sourceLine" id="cb110-8" title="8">df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb110-9" title="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lag_x =</span> <span class="kw">lag</span>(x),</a>
<a class="sourceLine" id="cb110-10" title="10">         <span class="dt">lead_x =</span> <span class="kw">lead</span>(x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb110-11" title="11"><span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb110-12" title="12"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb110-13" title="13">    <span class="dt">lag_x_grouped =</span> <span class="kw">lag</span>(x),</a>
<a class="sourceLine" id="cb110-14" title="14">    <span class="dt">lead_x_grouped =</span> <span class="kw">lead</span>(x)</a>
<a class="sourceLine" id="cb110-15" title="15">  )</a>
<a class="sourceLine" id="cb110-16" title="16"><span class="co">#&gt; # A tibble: 9 x 6</span></a>
<a class="sourceLine" id="cb110-17" title="17"><span class="co">#&gt; # Groups:   group [3]</span></a>
<a class="sourceLine" id="cb110-18" title="18"><span class="co">#&gt;       x group lag_x lead_x lag_x_grouped lead_x_grouped</span></a>
<a class="sourceLine" id="cb110-19" title="19"><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;int&gt;  &lt;int&gt;         &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb110-20" title="20"><span class="co">#&gt; 1     1 a        NA      2            NA              2</span></a>
<a class="sourceLine" id="cb110-21" title="21"><span class="co">#&gt; 2     2 a         1      3             1              3</span></a>
<a class="sourceLine" id="cb110-22" title="22"><span class="co">#&gt; 3     3 a         2      4             2             NA</span></a>
<a class="sourceLine" id="cb110-23" title="23"><span class="co">#&gt; 4     4 b         3      5            NA              5</span></a>
<a class="sourceLine" id="cb110-24" title="24"><span class="co">#&gt; 5     5 b         4      6             4              6</span></a>
<a class="sourceLine" id="cb110-25" title="25"><span class="co">#&gt; 6     6 b         5      7             5             NA</span></a>
<a class="sourceLine" id="cb110-26" title="26"><span class="co">#&gt; # … with 3 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb111-1" title="1"><span class="co">## The cumulative and rolling aggregate functions cumsum(), cumprod(), cummin(), cummax(), and cummean() calculate values within each group.</span></a>
<a class="sourceLine" id="cb111-2" title="2">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb111-3" title="3">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,</a>
<a class="sourceLine" id="cb111-4" title="4">  <span class="dt">group =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dt">each =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb111-5" title="5">) </a>
<a class="sourceLine" id="cb111-6" title="6"></a>
<a class="sourceLine" id="cb111-7" title="7">df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb111-8" title="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x_cumsum =</span> <span class="kw">cumsum</span>(x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb111-9" title="9"><span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb111-10" title="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x_cumsum_2 =</span> <span class="kw">cumsum</span>(x))</a>
<a class="sourceLine" id="cb111-11" title="11"><span class="co">#&gt; # A tibble: 9 x 4</span></a>
<a class="sourceLine" id="cb111-12" title="12"><span class="co">#&gt; # Groups:   group [3]</span></a>
<a class="sourceLine" id="cb111-13" title="13"><span class="co">#&gt;       x group x_cumsum x_cumsum_2</span></a>
<a class="sourceLine" id="cb111-14" title="14"><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;    &lt;int&gt;      &lt;int&gt;</span></a>
<a class="sourceLine" id="cb111-15" title="15"><span class="co">#&gt; 1     1 a            1          1</span></a>
<a class="sourceLine" id="cb111-16" title="16"><span class="co">#&gt; 2     2 a            3          3</span></a>
<a class="sourceLine" id="cb111-17" title="17"><span class="co">#&gt; 3     3 a            6          6</span></a>
<a class="sourceLine" id="cb111-18" title="18"><span class="co">#&gt; 4     4 b           10          4</span></a>
<a class="sourceLine" id="cb111-19" title="19"><span class="co">#&gt; 5     5 b           15          9</span></a>
<a class="sourceLine" id="cb111-20" title="20"><span class="co">#&gt; 6     6 b           21         15</span></a>
<a class="sourceLine" id="cb111-21" title="21"><span class="co">#&gt; # … with 3 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb112-1" title="1"><span class="co">## Logical comparisons, &lt;, &lt;=, &gt;, &gt;=, !=, and == are not affected by group_by().</span></a>
<a class="sourceLine" id="cb112-2" title="2">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb112-3" title="3">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,</a>
<a class="sourceLine" id="cb112-4" title="4">  <span class="dt">y =</span> <span class="dv">9</span><span class="op">:</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb112-5" title="5">  <span class="dt">group =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dt">each =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb112-6" title="6">) </a>
<a class="sourceLine" id="cb112-7" title="7"></a>
<a class="sourceLine" id="cb112-8" title="8">df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb112-9" title="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x_lte_y =</span> x <span class="op">&lt;=</span><span class="st"> </span>y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb112-10" title="10"><span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb112-11" title="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x_lte_y_2 =</span> x <span class="op">&lt;=</span><span class="st"> </span>y)</a>
<a class="sourceLine" id="cb112-12" title="12"><span class="co">#&gt; # A tibble: 9 x 5</span></a>
<a class="sourceLine" id="cb112-13" title="13"><span class="co">#&gt; # Groups:   group [3]</span></a>
<a class="sourceLine" id="cb112-14" title="14"><span class="co">#&gt;       x     y group x_lte_y x_lte_y_2</span></a>
<a class="sourceLine" id="cb112-15" title="15"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;lgl&gt;   &lt;lgl&gt;    </span></a>
<a class="sourceLine" id="cb112-16" title="16"><span class="co">#&gt; 1     1     9 a     TRUE    TRUE     </span></a>
<a class="sourceLine" id="cb112-17" title="17"><span class="co">#&gt; 2     2     8 a     TRUE    TRUE     </span></a>
<a class="sourceLine" id="cb112-18" title="18"><span class="co">#&gt; 3     3     7 a     TRUE    TRUE     </span></a>
<a class="sourceLine" id="cb112-19" title="19"><span class="co">#&gt; 4     4     6 b     TRUE    TRUE     </span></a>
<a class="sourceLine" id="cb112-20" title="20"><span class="co">#&gt; 5     5     5 b     TRUE    TRUE     </span></a>
<a class="sourceLine" id="cb112-21" title="21"><span class="co">#&gt; 6     6     4 b     FALSE   FALSE    </span></a>
<a class="sourceLine" id="cb112-22" title="22"><span class="co">#&gt; # … with 3 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb113-1" title="1"><span class="co">## Ranking functions like min_rank() work within each group when used with group_by().</span></a>
<a class="sourceLine" id="cb113-2" title="2">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb113-3" title="3">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,</a>
<a class="sourceLine" id="cb113-4" title="4">  <span class="dt">group =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dt">each =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb113-5" title="5">) </a>
<a class="sourceLine" id="cb113-6" title="6"></a>
<a class="sourceLine" id="cb113-7" title="7">df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb113-8" title="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rnk =</span> <span class="kw">min_rank</span>(x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb113-9" title="9"><span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb113-10" title="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rnk2 =</span> <span class="kw">min_rank</span>(x))</a>
<a class="sourceLine" id="cb113-11" title="11"><span class="co">#&gt; # A tibble: 9 x 4</span></a>
<a class="sourceLine" id="cb113-12" title="12"><span class="co">#&gt; # Groups:   group [3]</span></a>
<a class="sourceLine" id="cb113-13" title="13"><span class="co">#&gt;       x group   rnk  rnk2</span></a>
<a class="sourceLine" id="cb113-14" title="14"><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb113-15" title="15"><span class="co">#&gt; 1     1 a         1     1</span></a>
<a class="sourceLine" id="cb113-16" title="16"><span class="co">#&gt; 2     2 a         2     2</span></a>
<a class="sourceLine" id="cb113-17" title="17"><span class="co">#&gt; 3     3 a         3     3</span></a>
<a class="sourceLine" id="cb113-18" title="18"><span class="co">#&gt; 4     4 b         4     1</span></a>
<a class="sourceLine" id="cb113-19" title="19"><span class="co">#&gt; 5     5 b         5     2</span></a>
<a class="sourceLine" id="cb113-20" title="20"><span class="co">#&gt; 6     6 b         6     3</span></a>
<a class="sourceLine" id="cb113-21" title="21"><span class="co">#&gt; # … with 3 more rows</span></a></code></pre></div>
<p>此外,基于 <code>arrange()</code> 函数进行的排序一般也无视分组。不过，如果我们在 <code>arrange()</code> 中使用表达式作为排序依据，且这个表达式又和分组有关系，那么 <code>arrange()</code> 的排序结果就和是否分组有关了，不过这并不算是<code>arrange()</code>本身受分组影响。</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb114-1" title="1"><span class="co">## arrange() ignores groups when sorting values.</span></a>
<a class="sourceLine" id="cb114-2" title="2">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb114-3" title="3">  <span class="dt">x =</span> <span class="kw">runif</span>(<span class="dv">9</span>),</a>
<a class="sourceLine" id="cb114-4" title="4">  <span class="dt">group =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dt">each =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb114-5" title="5">) </a>
<a class="sourceLine" id="cb114-6" title="6"></a>
<a class="sourceLine" id="cb114-7" title="7">df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb114-8" title="8"><span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-9" title="9"><span class="st">  </span><span class="kw">arrange</span>(x)</a>
<a class="sourceLine" id="cb114-10" title="10"><span class="co">#&gt; # A tibble: 9 x 2</span></a>
<a class="sourceLine" id="cb114-11" title="11"><span class="co">#&gt; # Groups:   group [3]</span></a>
<a class="sourceLine" id="cb114-12" title="12"><span class="co">#&gt;        x group</span></a>
<a class="sourceLine" id="cb114-13" title="13"><span class="co">#&gt;    &lt;dbl&gt; &lt;chr&gt;</span></a>
<a class="sourceLine" id="cb114-14" title="14"><span class="co">#&gt; 1 0.0562 c    </span></a>
<a class="sourceLine" id="cb114-15" title="15"><span class="co">#&gt; 2 0.337  a    </span></a>
<a class="sourceLine" id="cb114-16" title="16"><span class="co">#&gt; 3 0.514  b    </span></a>
<a class="sourceLine" id="cb114-17" title="17"><span class="co">#&gt; 4 0.523  b    </span></a>
<a class="sourceLine" id="cb114-18" title="18"><span class="co">#&gt; 5 0.525  a    </span></a>
<a class="sourceLine" id="cb114-19" title="19"><span class="co">#&gt; 6 0.557  b    </span></a>
<a class="sourceLine" id="cb114-20" title="20"><span class="co">#&gt; # … with 3 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb115-1" title="1"><span class="co">## 和上面的结果进行比较</span></a>
<a class="sourceLine" id="cb115-2" title="2">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb115-3" title="3">  <span class="dt">x =</span> <span class="kw">runif</span>(<span class="dv">9</span>),</a>
<a class="sourceLine" id="cb115-4" title="4">  <span class="dt">group =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dt">each =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb115-5" title="5">) </a>
<a class="sourceLine" id="cb115-6" title="6"></a>
<a class="sourceLine" id="cb115-7" title="7">df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb115-8" title="8"><span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb115-9" title="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(x)) <span class="op">%&gt;%</span><span class="st">   </span><span class="co">## mean受分组影响，最后的排序结果也受分组影响</span></a>
<a class="sourceLine" id="cb115-10" title="10"><span class="st">  </span><span class="kw">arrange</span>(mean)</a>
<a class="sourceLine" id="cb115-11" title="11"><span class="co">#&gt; # A tibble: 9 x 3</span></a>
<a class="sourceLine" id="cb115-12" title="12"><span class="co">#&gt; # Groups:   group [3]</span></a>
<a class="sourceLine" id="cb115-13" title="13"><span class="co">#&gt;       x group  mean</span></a>
<a class="sourceLine" id="cb115-14" title="14"><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb115-15" title="15"><span class="co">#&gt; 1 0.188 a     0.493</span></a>
<a class="sourceLine" id="cb115-16" title="16"><span class="co">#&gt; 2 0.725 a     0.493</span></a>
<a class="sourceLine" id="cb115-17" title="17"><span class="co">#&gt; 3 0.567 a     0.493</span></a>
<a class="sourceLine" id="cb115-18" title="18"><span class="co">#&gt; 4 0.888 b     0.511</span></a>
<a class="sourceLine" id="cb115-19" title="19"><span class="co">#&gt; 5 0.268 b     0.511</span></a>
<a class="sourceLine" id="cb115-20" title="20"><span class="co">#&gt; 6 0.378 b     0.511</span></a>
<a class="sourceLine" id="cb115-21" title="21"><span class="co">#&gt; # … with 3 more rows</span></a></code></pre></div>
</div>
<div id="练习-4" class="section level2">
<h2><span class="header-section-number">1.8</span> 练习</h2>

<div class="exercise">
<span id="exr:unnamed-chunk-124" class="exercise"><strong>Exercise 1.8  </strong></span>找到每个日期分组中到达时间延迟最长的10条记录
</div>

<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb116-1" title="1"><span class="co">## min_rank自动在分组内排序</span></a>
<a class="sourceLine" id="cb116-2" title="2">not_cancelled <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb116-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(year,month,day) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb116-4" title="4"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">rank</span>(<span class="kw">desc</span>(arr_delay)) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb116-5" title="5"><span class="st">  </span><span class="kw">select</span>(month,year,day,arr_delay)</a>
<a class="sourceLine" id="cb116-6" title="6"><span class="co">#&gt; # A tibble: 3,609 x 4</span></a>
<a class="sourceLine" id="cb116-7" title="7"><span class="co">#&gt; # Groups:   year, month, day [365]</span></a>
<a class="sourceLine" id="cb116-8" title="8"><span class="co">#&gt;   month  year   day arr_delay</span></a>
<a class="sourceLine" id="cb116-9" title="9"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb116-10" title="10"><span class="co">#&gt; 1     1  2013     1       851</span></a>
<a class="sourceLine" id="cb116-11" title="11"><span class="co">#&gt; 2     1  2013     1       338</span></a>
<a class="sourceLine" id="cb116-12" title="12"><span class="co">#&gt; 3     1  2013     1       263</span></a>
<a class="sourceLine" id="cb116-13" title="13"><span class="co">#&gt; 4     1  2013     1       166</span></a>
<a class="sourceLine" id="cb116-14" title="14"><span class="co">#&gt; 5     1  2013     1       174</span></a>
<a class="sourceLine" id="cb116-15" title="15"><span class="co">#&gt; 6     1  2013     1       222</span></a>
<a class="sourceLine" id="cb116-16" title="16"><span class="co">#&gt; # … with 3,603 more rows</span></a></code></pre></div>

<div class="exercise">
<span id="exr:unnamed-chunk-126" class="exercise"><strong>Exercise 1.9  </strong></span>找出一年中到达航班多于 365 次的目的地：
</div>

<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb117-1" title="1"><span class="co">## n()以分组为基础</span></a>
<a class="sourceLine" id="cb117-2" title="2">not_cancelled <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb117-3" title="3"><span class="st">  </span><span class="kw">count</span>(dest, <span class="dt">sort =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb117-4" title="4"><span class="st">  </span><span class="kw">filter</span>(n <span class="op">&gt;</span><span class="st"> </span><span class="dv">365</span>)</a>
<a class="sourceLine" id="cb117-5" title="5"><span class="co">#&gt; # A tibble: 75 x 2</span></a>
<a class="sourceLine" id="cb117-6" title="6"><span class="co">#&gt;   dest      n</span></a>
<a class="sourceLine" id="cb117-7" title="7"><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb117-8" title="8"><span class="co">#&gt; 1 ATL   16837</span></a>
<a class="sourceLine" id="cb117-9" title="9"><span class="co">#&gt; 2 ORD   16566</span></a>
<a class="sourceLine" id="cb117-10" title="10"><span class="co">#&gt; 3 LAX   16026</span></a>
<a class="sourceLine" id="cb117-11" title="11"><span class="co">#&gt; 4 BOS   15022</span></a>
<a class="sourceLine" id="cb117-12" title="12"><span class="co">#&gt; 5 MCO   13967</span></a>
<a class="sourceLine" id="cb117-13" title="13"><span class="co">#&gt; 6 CLT   13674</span></a>
<a class="sourceLine" id="cb117-14" title="14"><span class="co">#&gt; # … with 69 more rows</span></a></code></pre></div>

<div class="exercise">
<p><span id="exr:unnamed-chunk-128" class="exercise"><strong>Exercise 1.10  </strong></span>哪一架飞机（用飞机尾号来识别，<code>tailnum</code>)具有最差的准点记录：</p>
</div>

<p>衡量一个飞机的准点情况有很多种可能的选择，这里只提供两个方向：</p>
<ul>
<li>该航班未取消且延误（到达和出发）次数占总飞行次数的比例最小<br />
</li>
<li>该航班的平均到达延误时间最长</li>
</ul>
<p>从第一个方向出发：</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb118-1" title="1"><span class="co">## 查看飞机飞行次数的分布</span></a>
<a class="sourceLine" id="cb118-2" title="2">count_by_tail &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb118-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(tailnum) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb118-4" title="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>())</a>
<a class="sourceLine" id="cb118-5" title="5"></a>
<a class="sourceLine" id="cb118-6" title="6"><span class="kw">quantile</span>(count_by_tail<span class="op">$</span>n)</a>
<a class="sourceLine" id="cb118-7" title="7"><span class="co">#&gt;   0%  25%  50%  75% 100% </span></a>
<a class="sourceLine" id="cb118-8" title="8"><span class="co">#&gt;    1   23   54  110 2512</span></a>
<a class="sourceLine" id="cb118-9" title="9"></a>
<a class="sourceLine" id="cb118-10" title="10"></a>
<a class="sourceLine" id="cb118-11" title="11">flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-12" title="12"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(tailnum)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-13" title="13"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">on_time =</span> <span class="op">!</span><span class="kw">is.na</span>(arr_time) <span class="op">&amp;</span><span class="st"> </span>(arr_delay <span class="op">&lt;=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">&amp;</span><span class="st"> </span>(dep_delay <span class="op">&lt;=</span><span class="st"> </span><span class="dv">0</span>) ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb118-14" title="14"><span class="st">  </span><span class="kw">group_by</span>(tailnum) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb118-15" title="15"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">on_time =</span> <span class="kw">mean</span>(on_time), <span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="co">## mean和逻辑值结合计算比例</span></a>
<a class="sourceLine" id="cb118-16" title="16"><span class="st">  </span><span class="kw">filter</span>(n <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co">## 避免因频次过少做出结论,选择20是因为它是飞行次数的下四分位数</span></a>
<a class="sourceLine" id="cb118-17" title="17"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">min_rank</span>(on_time) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)     <span class="co">## 未取消且准点比例最低的飞机</span></a>
<a class="sourceLine" id="cb118-18" title="18"><span class="co">#&gt; # A tibble: 1 x 3</span></a>
<a class="sourceLine" id="cb118-19" title="19"><span class="co">#&gt;   tailnum on_time     n</span></a>
<a class="sourceLine" id="cb118-20" title="20"><span class="co">#&gt;   &lt;chr&gt;     &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb118-21" title="21"><span class="co">#&gt; 1 N988AT   0.0541    37</span></a></code></pre></div>
<p>接下来是第二个方向：</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb119-1" title="1">flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb119-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(tailnum) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb119-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">arr_delay =</span> <span class="kw">mean</span>(arr_delay,<span class="dt">na.rm =</span> T),<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st">  </span><span class="co">##注意这一步的mean中的参数</span></a>
<a class="sourceLine" id="cb119-4" title="4"><span class="st">  </span><span class="kw">filter</span>(n <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb119-5" title="5"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">min_rank</span>(<span class="kw">desc</span>(arr_delay)) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb119-6" title="6"><span class="co">#&gt; # A tibble: 1 x 3</span></a>
<a class="sourceLine" id="cb119-7" title="7"><span class="co">#&gt;   tailnum arr_delay     n</span></a>
<a class="sourceLine" id="cb119-8" title="8"><span class="co">#&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb119-9" title="9"><span class="co">#&gt; 1 N203FR       59.1    41</span></a></code></pre></div>

<div class="exercise">
<p><span id="exr:unnamed-chunk-131" class="exercise"><strong>Exercise 1.11  </strong></span>如果想要尽量避免航班延误，应该在一天中的哪个时间搭乘飞机？</p>
</div>

<p>对 <code>hour</code> 分组计算平均到达延误时间：</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb120-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb120-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(hour) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">arr_delay =</span> <span class="kw">mean</span>(arr_delay, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-4" title="4"><span class="st">  </span><span class="kw">arrange</span>(arr_delay) </a>
<a class="sourceLine" id="cb120-5" title="5"><span class="co">#&gt; # A tibble: 20 x 2</span></a>
<a class="sourceLine" id="cb120-6" title="6"><span class="co">#&gt;    hour arr_delay</span></a>
<a class="sourceLine" id="cb120-7" title="7"><span class="co">#&gt;   &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb120-8" title="8"><span class="co">#&gt; 1     7    -5.30 </span></a>
<a class="sourceLine" id="cb120-9" title="9"><span class="co">#&gt; 2     5    -4.80 </span></a>
<a class="sourceLine" id="cb120-10" title="10"><span class="co">#&gt; 3     6    -3.38 </span></a>
<a class="sourceLine" id="cb120-11" title="11"><span class="co">#&gt; 4     9    -1.45 </span></a>
<a class="sourceLine" id="cb120-12" title="12"><span class="co">#&gt; 5     8    -1.11 </span></a>
<a class="sourceLine" id="cb120-13" title="13"><span class="co">#&gt; 6    10     0.954</span></a>
<a class="sourceLine" id="cb120-14" title="14"><span class="co">#&gt; # … with 14 more rows</span></a></code></pre></div>

<div class="exercise">
<span id="exr:unnamed-chunk-133" class="exercise"><strong>Exercise 1.12  </strong></span>计算每个目的地的到达延误总时间的分钟数，以及每条记录到每个目的地的延误时间比例
</div>

<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb121-1" title="1">flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb121-2" title="2"><span class="st">  </span><span class="kw">filter</span>(arr_delay <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb121-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(dest) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb121-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb121-5" title="5">    <span class="dt">arr_delay_total =</span> <span class="kw">sum</span>(arr_delay),  <span class="co">## 经过分组后，求和在组内操作</span></a>
<a class="sourceLine" id="cb121-6" title="6">    <span class="dt">arr_delay_prop =</span> arr_delay <span class="op">/</span><span class="st"> </span>arr_delay_total</a>
<a class="sourceLine" id="cb121-7" title="7">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb121-8" title="8"><span class="st">  </span><span class="kw">select</span>(</a>
<a class="sourceLine" id="cb121-9" title="9">    dest, tailnum,</a>
<a class="sourceLine" id="cb121-10" title="10">    arr_delay, arr_delay_prop</a>
<a class="sourceLine" id="cb121-11" title="11">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb121-12" title="12"><span class="st">  </span><span class="kw">arrange</span>(dest, <span class="kw">desc</span>(arr_delay_prop))</a>
<a class="sourceLine" id="cb121-13" title="13"><span class="co">#&gt; # A tibble: 133,004 x 4</span></a>
<a class="sourceLine" id="cb121-14" title="14"><span class="co">#&gt; # Groups:   dest [103]</span></a>
<a class="sourceLine" id="cb121-15" title="15"><span class="co">#&gt;   dest  tailnum arr_delay arr_delay_prop</span></a>
<a class="sourceLine" id="cb121-16" title="16"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;          &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb121-17" title="17"><span class="co">#&gt; 1 ABQ   N784JB        153         0.0341</span></a>
<a class="sourceLine" id="cb121-18" title="18"><span class="co">#&gt; 2 ABQ   N659JB        149         0.0332</span></a>
<a class="sourceLine" id="cb121-19" title="19"><span class="co">#&gt; 3 ABQ   N640JB        138         0.0308</span></a>
<a class="sourceLine" id="cb121-20" title="20"><span class="co">#&gt; 4 ABQ   N589JB        137         0.0305</span></a>
<a class="sourceLine" id="cb121-21" title="21"><span class="co">#&gt; 5 ABQ   N556JB        136         0.0303</span></a>
<a class="sourceLine" id="cb121-22" title="22"><span class="co">#&gt; 6 ABQ   N598JB        126         0.0281</span></a>
<a class="sourceLine" id="cb121-23" title="23"><span class="co">#&gt; # … with 1.33e+05 more rows</span></a></code></pre></div>

<div class="exercise">
<span id="exr:unnamed-chunk-135" class="exercise"><strong>Exercise 1.13  </strong></span>延误通常是由临时原因造成的：即使最初引起延误的问题已经解决，但因为要让前面的航班先起飞，所以后面的航班也会延误。使用<code>lag()</code> 探究一架航班延误与前一架航班延误之间的关系。
</div>

<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb122-1" title="1"><span class="co">## This calculates the departure delay of the preceding flight from the same airport.</span></a>
<a class="sourceLine" id="cb122-2" title="2"> (lagged_delays &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb122-3" title="3"><span class="st">  </span><span class="kw">arrange</span>(origin, month, day, dep_time) <span class="op">%&gt;%</span><span class="st">  </span><span class="co">## 这一步排序确保了偏移是有意义的</span></a>
<a class="sourceLine" id="cb122-4" title="4"><span class="st">  </span><span class="kw">group_by</span>(origin) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">dep_delay_lag =</span> <span class="kw">lag</span>(dep_delay)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co">## 偏移函数基于分组</span></a>
<a class="sourceLine" id="cb122-6" title="6"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(dep_delay),<span class="op">!</span><span class="kw">is.na</span>(dep_delay_lag)))</a>
<a class="sourceLine" id="cb122-7" title="7"><span class="co">#&gt; # A tibble: 327,649 x 20</span></a>
<a class="sourceLine" id="cb122-8" title="8"><span class="co">#&gt; # Groups:   origin [3]</span></a>
<a class="sourceLine" id="cb122-9" title="9"><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb122-10" title="10"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb122-11" title="11"><span class="co">#&gt; 1  2013     1     1      554            558        -4      740            728</span></a>
<a class="sourceLine" id="cb122-12" title="12"><span class="co">#&gt; 2  2013     1     1      555            600        -5      913            854</span></a>
<a class="sourceLine" id="cb122-13" title="13"><span class="co">#&gt; 3  2013     1     1      558            600        -2      923            937</span></a>
<a class="sourceLine" id="cb122-14" title="14"><span class="co">#&gt; 4  2013     1     1      559            600        -1      854            902</span></a>
<a class="sourceLine" id="cb122-15" title="15"><span class="co">#&gt; 5  2013     1     1      601            600         1      844            850</span></a>
<a class="sourceLine" id="cb122-16" title="16"><span class="co">#&gt; 6  2013     1     1      606            610        -4      858            910</span></a>
<a class="sourceLine" id="cb122-17" title="17"><span class="co">#&gt; # … with 3.276e+05 more rows, and 12 more variables: arr_delay &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb122-18" title="18"><span class="co">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb122-19" title="19"><span class="co">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;,</span></a>
<a class="sourceLine" id="cb122-20" title="20"><span class="co">#&gt; #   dep_delay_lag &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb122-21" title="21"></a>
<a class="sourceLine" id="cb122-22" title="22">lagged_delays <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-23" title="23"><span class="st">  </span><span class="kw">group_by</span>(dep_delay_lag) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-24" title="24"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">dep_delay_mean =</span> <span class="kw">mean</span>(dep_delay)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-25" title="25"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> dep_delay_mean, <span class="dt">x =</span> dep_delay_lag)) <span class="op">+</span></a>
<a class="sourceLine" id="cb122-26" title="26"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb122-27" title="27"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1500</span>, <span class="dt">by =</span> <span class="dv">120</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb122-28" title="28"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Departure Delay&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Previous Departure Delay&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb122-29" title="29"><span class="st">  </span><span class="kw">theme_classic</span>()</a></code></pre></div>
<p><img src="dplyr_files/figure-html/unnamed-chunk-136-1.svg" width="80%" /></p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb123-1" title="1">    </a>
<a class="sourceLine" id="cb123-2" title="2"><span class="co">## This plots the relationship between the mean delay of a flight for all values of the previous flight. For delays less than two hours, the relationship between the delay of the preceding flight and the current flight is nearly a line. After that the relationship becomes more variable, as long-delayed flights are interspersed with flights leaving on-time. After about 8-hours, a delayed flight is likely to be followed by a flight leaving on time.</span></a></code></pre></div>

<div class="exercise">
<span id="exr:unnamed-chunk-137" class="exercise"><strong>Exercise 1.14  </strong></span>根据到达地点的数量，对航空公司进行排序 ; 找出至少有两个航空公司的目的地
</div>

<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb124-1" title="1"><span class="co">## rank carriers by numer of destinations</span></a>
<a class="sourceLine" id="cb124-2" title="2">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb124-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(carrier) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-4" title="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n_dest =</span> <span class="kw">n_distinct</span>(dest)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-5" title="5"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n_dest))</a>
<a class="sourceLine" id="cb124-6" title="6"><span class="co">#&gt; # A tibble: 16 x 2</span></a>
<a class="sourceLine" id="cb124-7" title="7"><span class="co">#&gt;   carrier n_dest</span></a>
<a class="sourceLine" id="cb124-8" title="8"><span class="co">#&gt;   &lt;chr&gt;    &lt;int&gt;</span></a>
<a class="sourceLine" id="cb124-9" title="9"><span class="co">#&gt; 1 EV          61</span></a>
<a class="sourceLine" id="cb124-10" title="10"><span class="co">#&gt; 2 9E          49</span></a>
<a class="sourceLine" id="cb124-11" title="11"><span class="co">#&gt; 3 UA          47</span></a>
<a class="sourceLine" id="cb124-12" title="12"><span class="co">#&gt; 4 B6          42</span></a>
<a class="sourceLine" id="cb124-13" title="13"><span class="co">#&gt; 5 DL          40</span></a>
<a class="sourceLine" id="cb124-14" title="14"><span class="co">#&gt; 6 MQ          20</span></a>
<a class="sourceLine" id="cb124-15" title="15"><span class="co">#&gt; # … with 10 more rows</span></a>
<a class="sourceLine" id="cb124-16" title="16"></a>
<a class="sourceLine" id="cb124-17" title="17"><span class="co">## find all airports with &gt; 1 carrier</span></a>
<a class="sourceLine" id="cb124-18" title="18">flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-19" title="19"><span class="st">  </span><span class="kw">group_by</span>(dest) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-20" title="20"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n_carriers =</span> <span class="kw">n_distinct</span>(carrier)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-21" title="21"><span class="st">  </span><span class="kw">filter</span>(n_carriers <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb124-22" title="22"><span class="co">#&gt; # A tibble: 76 x 2</span></a>
<a class="sourceLine" id="cb124-23" title="23"><span class="co">#&gt;   dest  n_carriers</span></a>
<a class="sourceLine" id="cb124-24" title="24"><span class="co">#&gt;   &lt;chr&gt;      &lt;int&gt;</span></a>
<a class="sourceLine" id="cb124-25" title="25"><span class="co">#&gt; 1 ATL            7</span></a>
<a class="sourceLine" id="cb124-26" title="26"><span class="co">#&gt; 2 AUS            6</span></a>
<a class="sourceLine" id="cb124-27" title="27"><span class="co">#&gt; 3 AVL            2</span></a>
<a class="sourceLine" id="cb124-28" title="28"><span class="co">#&gt; 4 BDL            2</span></a>
<a class="sourceLine" id="cb124-29" title="29"><span class="co">#&gt; 5 BGR            2</span></a>
<a class="sourceLine" id="cb124-30" title="30"><span class="co">#&gt; 6 BNA            5</span></a>
<a class="sourceLine" id="cb124-31" title="31"><span class="co">#&gt; # … with 70 more rows</span></a></code></pre></div>

<div class="exercise">
<span id="exr:unnamed-chunk-139" class="exercise"><strong>Exercise 1.15  </strong></span>每天取消的航班数量和总航班数量存在什么关系？每天的平均到达延误时间和取消航班的比例有什么关系？
</div>

<p>取消的航班定义为<code>is.na(arr_delay) | is.na(dep_delay)</code></p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb125-1" title="1"><span class="co">## One pattern in cancelled flights per day is that </span></a>
<a class="sourceLine" id="cb125-2" title="2"><span class="co">## the number of cancelled flights increases with the total number of flights per day. </span></a>
<a class="sourceLine" id="cb125-3" title="3">flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb125-4" title="4"><span class="st">  </span><span class="kw">group_by</span>(year,month,day) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb125-5" title="5"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n_cancelled =</span> <span class="kw">sum</span>(<span class="kw">is.na</span>(arr_delay) <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(dep_delay)),<span class="dt">n_total =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb125-6" title="6"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> n_total,<span class="dt">y =</span> n_cancelled)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</a></code></pre></div>
<p><img src="dplyr_files/figure-html/unnamed-chunk-140-1.svg" width="80%" /></p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb126-1" title="1"></a>
<a class="sourceLine" id="cb126-2" title="2"><span class="co">#2</span></a>
<a class="sourceLine" id="cb126-3" title="3">flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb126-4" title="4"><span class="st">  </span><span class="kw">group_by</span>(year,month,day) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb126-5" title="5"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">cancelled_prop =</span> <span class="kw">mean</span>(<span class="kw">is.na</span>(arr_delay) <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(dep_delay)),</a>
<a class="sourceLine" id="cb126-6" title="6">            <span class="dt">avg_arr_delay =</span> <span class="kw">mean</span>(arr_delay,<span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb126-7" title="7"><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> avg_arr_delay,<span class="dt">y =</span> cancelled_prop))</a></code></pre></div>
<p><img src="dplyr_files/figure-html/unnamed-chunk-140-2.svg" width="80%" /></p>

<div class="exercise">
<span id="exr:unnamed-chunk-141" class="exercise"><strong>Exercise 1.16  </strong></span>
哪个航空公司的延误情况最严重？你能否分清这是因为糟糕的机场设备，还是航空公司的问题？（考虑一下<code>flights %&gt;% group_by(carrier,dest) %&gt;% summarize(n())</code>
</div>

<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb127-1" title="1">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb127-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(carrier) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb127-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">avg_arr_delay =</span> <span class="kw">mean</span>(arr_delay,<span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb127-4" title="4"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(avg_arr_delay))</a>
<a class="sourceLine" id="cb127-5" title="5"><span class="co">#&gt; # A tibble: 16 x 2</span></a>
<a class="sourceLine" id="cb127-6" title="6"><span class="co">#&gt;   carrier avg_arr_delay</span></a>
<a class="sourceLine" id="cb127-7" title="7"><span class="co">#&gt;   &lt;chr&gt;           &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb127-8" title="8"><span class="co">#&gt; 1 F9               21.9</span></a>
<a class="sourceLine" id="cb127-9" title="9"><span class="co">#&gt; 2 FL               20.1</span></a>
<a class="sourceLine" id="cb127-10" title="10"><span class="co">#&gt; 3 EV               15.8</span></a>
<a class="sourceLine" id="cb127-11" title="11"><span class="co">#&gt; 4 YV               15.6</span></a>
<a class="sourceLine" id="cb127-12" title="12"><span class="co">#&gt; 5 OO               11.9</span></a>
<a class="sourceLine" id="cb127-13" title="13"><span class="co">#&gt; 6 MQ               10.8</span></a>
<a class="sourceLine" id="cb127-14" title="14"><span class="co">#&gt; # … with 10 more rows</span></a>
<a class="sourceLine" id="cb127-15" title="15"></a>
<a class="sourceLine" id="cb127-16" title="16"><span class="co">## What airline corresponds to the &quot;F9&quot; carrier code?</span></a>
<a class="sourceLine" id="cb127-17" title="17"><span class="kw">filter</span>(airlines,carrier <span class="op">==</span><span class="st"> &quot;F9&quot;</span>)</a>
<a class="sourceLine" id="cb127-18" title="18"><span class="co">#&gt; # A tibble: 1 x 2</span></a>
<a class="sourceLine" id="cb127-19" title="19"><span class="co">#&gt;   carrier name                  </span></a>
<a class="sourceLine" id="cb127-20" title="20"><span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;                 </span></a>
<a class="sourceLine" id="cb127-21" title="21"><span class="co">#&gt; 1 F9      Frontier Airlines Inc.</span></a></code></pre></div>
<blockquote>
<p>You can get part of the way to disentangling the effects of airports versus bad carriers by comparing the average delay of each carrier to the average delay of flights within a route (flights from the same origin to the same destination). Comparing delays between carriers and within each route disentangles the effect of carriers and airports. A better analysis would compare the average delay of a carrier’s flights to the average delay of all other carrier’s flights within a route.</p>
</blockquote>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb128-1" title="1">flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-2" title="2"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(arr_delay)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-3" title="3"><span class="st">  </span><span class="co"># Total delay by carrier within each origin, dest</span></a>
<a class="sourceLine" id="cb128-4" title="4"><span class="st">  </span><span class="kw">group_by</span>(origin, dest, carrier) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-5" title="5"><span class="st">  </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb128-6" title="6">    <span class="dt">arr_delay =</span> <span class="kw">sum</span>(arr_delay),</a>
<a class="sourceLine" id="cb128-7" title="7">    <span class="dt">flights =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb128-8" title="8">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-9" title="9"><span class="st">  </span><span class="co"># Total delay within each origin dest</span></a>
<a class="sourceLine" id="cb128-10" title="10"><span class="st">  </span><span class="kw">group_by</span>(origin, dest) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-11" title="11"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb128-12" title="12">    <span class="dt">arr_delay_total =</span> <span class="kw">sum</span>(arr_delay),</a>
<a class="sourceLine" id="cb128-13" title="13">    <span class="dt">flights_total =</span> <span class="kw">sum</span>(flights)</a>
<a class="sourceLine" id="cb128-14" title="14">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-15" title="15"><span class="st">  </span><span class="co"># average delay of each carrier - average delay of other carriers</span></a>
<a class="sourceLine" id="cb128-16" title="16"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-17" title="17"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb128-18" title="18">    <span class="dt">arr_delay_others =</span> (arr_delay_total <span class="op">-</span><span class="st"> </span>arr_delay) <span class="op">/</span></a>
<a class="sourceLine" id="cb128-19" title="19"><span class="st">      </span>(flights_total <span class="op">-</span><span class="st"> </span>flights),</a>
<a class="sourceLine" id="cb128-20" title="20">    <span class="dt">arr_delay_mean =</span> arr_delay <span class="op">/</span><span class="st"> </span>flights,</a>
<a class="sourceLine" id="cb128-21" title="21">    <span class="dt">arr_delay_diff =</span> arr_delay_mean <span class="op">-</span><span class="st"> </span>arr_delay_others</a>
<a class="sourceLine" id="cb128-22" title="22">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-23" title="23"><span class="st">  </span><span class="co"># remove NaN values (when there is only one carrier)</span></a>
<a class="sourceLine" id="cb128-24" title="24"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.finite</span>(arr_delay_diff)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-25" title="25"><span class="st">  </span><span class="co"># average over all airports it flies to</span></a>
<a class="sourceLine" id="cb128-26" title="26"><span class="st">  </span><span class="kw">group_by</span>(carrier) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-27" title="27"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">arr_delay_diff =</span> <span class="kw">mean</span>(arr_delay_diff)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-28" title="28"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(arr_delay_diff))</a>
<a class="sourceLine" id="cb128-29" title="29"><span class="co">#&gt; # A tibble: 15 x 2</span></a>
<a class="sourceLine" id="cb128-30" title="30"><span class="co">#&gt;   carrier arr_delay_diff</span></a>
<a class="sourceLine" id="cb128-31" title="31"><span class="co">#&gt;   &lt;chr&gt;            &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb128-32" title="32"><span class="co">#&gt; 1 OO              27.3  </span></a>
<a class="sourceLine" id="cb128-33" title="33"><span class="co">#&gt; 2 F9              17.3  </span></a>
<a class="sourceLine" id="cb128-34" title="34"><span class="co">#&gt; 3 EV              11.0  </span></a>
<a class="sourceLine" id="cb128-35" title="35"><span class="co">#&gt; 4 B6               6.41 </span></a>
<a class="sourceLine" id="cb128-36" title="36"><span class="co">#&gt; 5 FL               2.57 </span></a>
<a class="sourceLine" id="cb128-37" title="37"><span class="co">#&gt; 6 VX              -0.202</span></a>
<a class="sourceLine" id="cb128-38" title="38"><span class="co">#&gt; # … with 9 more rows</span></a></code></pre></div>
</div>
<div id="作用域" class="section level2">
<h2><span class="header-section-number">1.9</span> 作用域</h2>
<p>这里的作用域是指 <code>dplyr</code> 函数能影响的变量范围。一般而言，<code>arrange()</code>、<code>mutate()</code>、<code>summarize()</code> 作用的变量需要显式指明，而它们的一些变体 (scoped variants) 有更加复杂的作用域规则。</p>
<p><strong>Scoped variants of a function operates on a selection of variables.</strong></p>
<p>The variants suffixed with <code>_if</code>, <code>_at</code> or <code>_all</code> apply an expression (sometimes several) to all variables <strong>within a specified subset</strong>. This subset can contain all variables (<code>_all</code> variants), a vars() selection (<code>_at</code> variants), or variables selected with a predicate (<code>_if</code> variants).</p>
<p><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="uri">https://dplyr.tidyverse.org/reference/mutate_all.html</a></p>
<p><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="uri">https://dplyr.tidyverse.org/reference/summarise_all.html</a></p>
<p><a href="https://dplyr.tidyverse.org/reference/filter_all.html" class="uri">https://dplyr.tidyverse.org/reference/filter_all.html</a></p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb129-1" title="1"><span class="kw">library</span>(tidyverse)</a></code></pre></div>
<div id="arrange" class="section level3">
<h3><span class="header-section-number">1.9.1</span> <code>arrange()</code></h3>
</div>
<div id="mutate" class="section level3">
<h3><span class="header-section-number">1.9.2</span> <code>mutate()</code></h3>
<p>The <strong>scoped</strong> variants of <code>mutate()</code> and <code>transmute()</code> make it easy to apply the same transformation to multiple variables. There are three variants:</p>
<ul>
<li><p><code>_all</code> affects every variable</p></li>
<li><p><code>_at</code> affects variables selected with a character vector or <code>vars()</code></p></li>
<li><p>_if affects variables selected with a predicate function</p></li>
</ul>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb130-1" title="1"><span class="kw">mutate_all</span>(.tbl, .funs, ...)</a>
<a class="sourceLine" id="cb130-2" title="2"></a>
<a class="sourceLine" id="cb130-3" title="3"><span class="kw">mutate_if</span>(.tbl, .predicate, .funs, ...)</a>
<a class="sourceLine" id="cb130-4" title="4"></a>
<a class="sourceLine" id="cb130-5" title="5"><span class="kw">mutate_at</span>(.tbl, .vars, .funs, ..., <span class="dt">.cols =</span> <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb130-6" title="6"></a>
<a class="sourceLine" id="cb130-7" title="7"><span class="kw">transmute_all</span>(.tbl, .funs, ...)</a>
<a class="sourceLine" id="cb130-8" title="8"></a>
<a class="sourceLine" id="cb130-9" title="9"><span class="kw">transmute_if</span>(.tbl, .predicate, .funs, ...)</a>
<a class="sourceLine" id="cb130-10" title="10"></a>
<a class="sourceLine" id="cb130-11" title="11"><span class="kw">transmute_at</span>(.tbl, .vars, .funs, ..., <span class="dt">.cols =</span> <span class="ot">NULL</span>)</a></code></pre></div>
<p><strong>Arguments</strong></p>
<ul>
<li><code>tbl</code>: A tbl object<br />
</li>
<li><code>.funs</code>: a function to transform the selection of variables<br />
</li>
<li><code>...</code>: Additional arguments for the function calls in <code>.funs</code><br />
</li>
<li><code>.predicate</code>: <code>_if</code> 变体进行逻辑判断的函数</li>
</ul>
<hr />
<p><code>_all()</code> 影响所有变量：</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb131-1" title="1">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">100</span>, <span class="ot">NA</span>), <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">1000</span>, <span class="ot">NA</span>, <span class="dv">10000</span>))</a>
<a class="sourceLine" id="cb131-2" title="2">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_all</span>(log10)</a>
<a class="sourceLine" id="cb131-3" title="3"><span class="co">#&gt; # A tibble: 3 x 2</span></a>
<a class="sourceLine" id="cb131-4" title="4"><span class="co">#&gt;       x     y</span></a>
<a class="sourceLine" id="cb131-5" title="5"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb131-6" title="6"><span class="co">#&gt; 1     1     3</span></a>
<a class="sourceLine" id="cb131-7" title="7"><span class="co">#&gt; 2     2    NA</span></a>
<a class="sourceLine" id="cb131-8" title="8"><span class="co">#&gt; 3    NA     4</span></a></code></pre></div>
<p>所有 scoped variants 都可以传入任何函数及其参数：</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb132-1" title="1">scale2 &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>) (x <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(x, <span class="dt">na.rm =</span> na.rm)) <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(x, na.rm)</a>
<a class="sourceLine" id="cb132-2" title="2">df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb132-3" title="3"><span class="st">  </span><span class="kw">mutate_all</span>(scale2, <span class="dt">na.rm =</span> T)</a>
<a class="sourceLine" id="cb132-4" title="4"><span class="co">#&gt; # A tibble: 3 x 2</span></a>
<a class="sourceLine" id="cb132-5" title="5"><span class="co">#&gt;        x      y</span></a>
<a class="sourceLine" id="cb132-6" title="6"><span class="co">#&gt;    &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb132-7" title="7"><span class="co">#&gt; 1 -0.707 -0.707</span></a>
<a class="sourceLine" id="cb132-8" title="8"><span class="co">#&gt; 2  0.707 NA    </span></a>
<a class="sourceLine" id="cb132-9" title="9"><span class="co">#&gt; 3 NA      0.707</span></a></code></pre></div>
<p><code>_at</code> 变体作用于变量的某个子集，可以用一个字符向量指定，也可以使用 <a href="dplyr.html#使用select选择列">使用<code>select()</code>选择列</a> 中的帮助函数，但这些帮助函数必须包裹在 <code>vars()</code> 之内，可以把 <code>vars()</code> 看作是 scoped variants 内部的 <code>select()</code></p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb133-1" title="1">starwars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_at</span>(<span class="kw">c</span>(<span class="st">&quot;height&quot;</span>, <span class="st">&quot;mass&quot;</span>), scale2, <span class="dt">na.rm =</span> T)</a>
<a class="sourceLine" id="cb133-2" title="2"><span class="co">#&gt; # A tibble: 87 x 13</span></a>
<a class="sourceLine" id="cb133-3" title="3"><span class="co">#&gt;   name   height   mass hair_color skin_color eye_color birth_year gender</span></a>
<a class="sourceLine" id="cb133-4" title="4"><span class="co">#&gt;   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; </span></a>
<a class="sourceLine" id="cb133-5" title="5"><span class="co">#&gt; 1 Luke… -0.0678 -0.120 blond      fair       blue            19   male  </span></a>
<a class="sourceLine" id="cb133-6" title="6"><span class="co">#&gt; 2 C-3PO -0.212  -0.132 &lt;NA&gt;       gold       yellow         112   &lt;NA&gt;  </span></a>
<a class="sourceLine" id="cb133-7" title="7"><span class="co">#&gt; 3 R2-D2 -2.25   -0.385 &lt;NA&gt;       white, bl… red             33   &lt;NA&gt;  </span></a>
<a class="sourceLine" id="cb133-8" title="8"><span class="co">#&gt; 4 Dart…  0.795   0.228 none       white      yellow          41.9 male  </span></a>
<a class="sourceLine" id="cb133-9" title="9"><span class="co">#&gt; 5 Leia… -0.701  -0.285 brown      light      brown           19   female</span></a>
<a class="sourceLine" id="cb133-10" title="10"><span class="co">#&gt; 6 Owen…  0.105   0.134 brown, gr… light      blue            52   male  </span></a>
<a class="sourceLine" id="cb133-11" title="11"><span class="co">#&gt; # … with 81 more rows, and 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb133-12" title="12"><span class="co">#&gt; #   films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;</span></a>
<a class="sourceLine" id="cb133-13" title="13"></a>
<a class="sourceLine" id="cb133-14" title="14"><span class="co"># You can also supply selection helpers to _at() functions but you have</span></a>
<a class="sourceLine" id="cb133-15" title="15"><span class="co"># to quote them with vars():</span></a>
<a class="sourceLine" id="cb133-16" title="16">iris &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(iris)</a>
<a class="sourceLine" id="cb133-17" title="17">iris <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="kw">matches</span>(<span class="st">&quot;Sepal&quot;</span>)), scale2)</a>
<a class="sourceLine" id="cb133-18" title="18"><span class="co">#&gt; # A tibble: 150 x 5</span></a>
<a class="sourceLine" id="cb133-19" title="19"><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></a>
<a class="sourceLine" id="cb133-20" title="20"><span class="co">#&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  </span></a>
<a class="sourceLine" id="cb133-21" title="21"><span class="co">#&gt; 1       -0.898      1.02            1.4         0.2 setosa </span></a>
<a class="sourceLine" id="cb133-22" title="22"><span class="co">#&gt; 2       -1.14      -0.132           1.4         0.2 setosa </span></a>
<a class="sourceLine" id="cb133-23" title="23"><span class="co">#&gt; 3       -1.38       0.327           1.3         0.2 setosa </span></a>
<a class="sourceLine" id="cb133-24" title="24"><span class="co">#&gt; 4       -1.50       0.0979          1.5         0.2 setosa </span></a>
<a class="sourceLine" id="cb133-25" title="25"><span class="co">#&gt; 5       -1.02       1.25            1.4         0.2 setosa </span></a>
<a class="sourceLine" id="cb133-26" title="26"><span class="co">#&gt; 6       -0.535      1.93            1.7         0.4 setosa </span></a>
<a class="sourceLine" id="cb133-27" title="27"><span class="co">#&gt; # … with 144 more rows</span></a>
<a class="sourceLine" id="cb133-28" title="28">iris <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="kw">contains</span>(<span class="st">&quot;Length&quot;</span>)), scale2)</a>
<a class="sourceLine" id="cb133-29" title="29"><span class="co">#&gt; # A tibble: 150 x 5</span></a>
<a class="sourceLine" id="cb133-30" title="30"><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></a>
<a class="sourceLine" id="cb133-31" title="31"><span class="co">#&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  </span></a>
<a class="sourceLine" id="cb133-32" title="32"><span class="co">#&gt; 1       -0.898         3.5        -1.34         0.2 setosa </span></a>
<a class="sourceLine" id="cb133-33" title="33"><span class="co">#&gt; 2       -1.14          3          -1.34         0.2 setosa </span></a>
<a class="sourceLine" id="cb133-34" title="34"><span class="co">#&gt; 3       -1.38          3.2        -1.39         0.2 setosa </span></a>
<a class="sourceLine" id="cb133-35" title="35"><span class="co">#&gt; 4       -1.50          3.1        -1.28         0.2 setosa </span></a>
<a class="sourceLine" id="cb133-36" title="36"><span class="co">#&gt; 5       -1.02          3.6        -1.34         0.2 setosa </span></a>
<a class="sourceLine" id="cb133-37" title="37"><span class="co">#&gt; 6       -0.535         3.9        -1.17         0.4 setosa </span></a>
<a class="sourceLine" id="cb133-38" title="38"><span class="co">#&gt; # … with 144 more rows</span></a></code></pre></div>
<p><code>_if</code> 变体作用于 predicate function 返回的逻辑值为真的变量，注意这个参数的位置：</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb134-1" title="1"><span class="co"># The _if() variants apply a predicate function (a function that</span></a>
<a class="sourceLine" id="cb134-2" title="2"><span class="co"># returns TRUE or FALSE) to determine the relevant subset of</span></a>
<a class="sourceLine" id="cb134-3" title="3"><span class="co"># columns. Here we divide all the numeric columns by 100:</span></a>
<a class="sourceLine" id="cb134-4" title="4">starwars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(is.numeric, scale2, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb134-5" title="5"><span class="co">#&gt; # A tibble: 87 x 13</span></a>
<a class="sourceLine" id="cb134-6" title="6"><span class="co">#&gt;   name   height   mass hair_color skin_color eye_color birth_year gender</span></a>
<a class="sourceLine" id="cb134-7" title="7"><span class="co">#&gt;   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; </span></a>
<a class="sourceLine" id="cb134-8" title="8"><span class="co">#&gt; 1 Luke… -0.0678 -0.120 blond      fair       blue          -0.443 male  </span></a>
<a class="sourceLine" id="cb134-9" title="9"><span class="co">#&gt; 2 C-3PO -0.212  -0.132 &lt;NA&gt;       gold       yellow         0.158 &lt;NA&gt;  </span></a>
<a class="sourceLine" id="cb134-10" title="10"><span class="co">#&gt; 3 R2-D2 -2.25   -0.385 &lt;NA&gt;       white, bl… red           -0.353 &lt;NA&gt;  </span></a>
<a class="sourceLine" id="cb134-11" title="11"><span class="co">#&gt; 4 Dart…  0.795   0.228 none       white      yellow        -0.295 male  </span></a>
<a class="sourceLine" id="cb134-12" title="12"><span class="co">#&gt; 5 Leia… -0.701  -0.285 brown      light      brown         -0.443 female</span></a>
<a class="sourceLine" id="cb134-13" title="13"><span class="co">#&gt; 6 Owen…  0.105   0.134 brown, gr… light      blue          -0.230 male  </span></a>
<a class="sourceLine" id="cb134-14" title="14"><span class="co">#&gt; # … with 81 more rows, and 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;,</span></a>
<a class="sourceLine" id="cb134-15" title="15"><span class="co">#&gt; #   films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;</span></a></code></pre></div>
<p>当需要转换某些变量的类型时，<code>mutate_if</code> 会很方便：</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb135-1" title="1"><span class="co">## 解决 data.frame 的强制转换  </span></a>
<a class="sourceLine" id="cb135-2" title="2">iris <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(is.factor, as.character)</a>
<a class="sourceLine" id="cb135-3" title="3"><span class="co">#&gt; # A tibble: 150 x 5</span></a>
<a class="sourceLine" id="cb135-4" title="4"><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></a>
<a class="sourceLine" id="cb135-5" title="5"><span class="co">#&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;  </span></a>
<a class="sourceLine" id="cb135-6" title="6"><span class="co">#&gt; 1          5.1         3.5          1.4         0.2 setosa </span></a>
<a class="sourceLine" id="cb135-7" title="7"><span class="co">#&gt; 2          4.9         3            1.4         0.2 setosa </span></a>
<a class="sourceLine" id="cb135-8" title="8"><span class="co">#&gt; 3          4.7         3.2          1.3         0.2 setosa </span></a>
<a class="sourceLine" id="cb135-9" title="9"><span class="co">#&gt; 4          4.6         3.1          1.5         0.2 setosa </span></a>
<a class="sourceLine" id="cb135-10" title="10"><span class="co">#&gt; 5          5           3.6          1.4         0.2 setosa </span></a>
<a class="sourceLine" id="cb135-11" title="11"><span class="co">#&gt; 6          5.4         3.9          1.7         0.4 setosa </span></a>
<a class="sourceLine" id="cb135-12" title="12"><span class="co">#&gt; # … with 144 more rows</span></a>
<a class="sourceLine" id="cb135-13" title="13"></a>
<a class="sourceLine" id="cb135-14" title="14"><span class="co">## 双精度转换为整型 </span></a>
<a class="sourceLine" id="cb135-15" title="15">iris <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(is.double, as.integer)</a>
<a class="sourceLine" id="cb135-16" title="16"><span class="co">#&gt; # A tibble: 150 x 5</span></a>
<a class="sourceLine" id="cb135-17" title="17"><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></a>
<a class="sourceLine" id="cb135-18" title="18"><span class="co">#&gt;          &lt;int&gt;       &lt;int&gt;        &lt;int&gt;       &lt;int&gt; &lt;fct&gt;  </span></a>
<a class="sourceLine" id="cb135-19" title="19"><span class="co">#&gt; 1            5           3            1           0 setosa </span></a>
<a class="sourceLine" id="cb135-20" title="20"><span class="co">#&gt; 2            4           3            1           0 setosa </span></a>
<a class="sourceLine" id="cb135-21" title="21"><span class="co">#&gt; 3            4           3            1           0 setosa </span></a>
<a class="sourceLine" id="cb135-22" title="22"><span class="co">#&gt; 4            4           3            1           0 setosa </span></a>
<a class="sourceLine" id="cb135-23" title="23"><span class="co">#&gt; 5            5           3            1           0 setosa </span></a>
<a class="sourceLine" id="cb135-24" title="24"><span class="co">#&gt; 6            5           3            1           0 setosa </span></a>
<a class="sourceLine" id="cb135-25" title="25"><span class="co">#&gt; # … with 144 more rows</span></a></code></pre></div>
<p>某些情况下，可能希望进行多种数据函数，可以在 <code>,funs</code> 中传入一个函数列表，则列表中的每个函数均会作用于所有符合筛选条件的变量。有多个函数时，<code>mutate</code> 的 scoped vairiants 生成新列，而非就地修改原来的变量</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb136-1" title="1">iris <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(is.numeric, <span class="kw">list</span>(scale2, log)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb136-2" title="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>))</a>
<a class="sourceLine" id="cb136-3" title="3"><span class="co">#&gt; # A tibble: 150 x 8</span></a>
<a class="sourceLine" id="cb136-4" title="4"><span class="co">#&gt;   Sepal.Length_fn1 Sepal.Width_fn1 Petal.Length_fn1 Petal.Width_fn1</span></a>
<a class="sourceLine" id="cb136-5" title="5"><span class="co">#&gt;              &lt;dbl&gt;           &lt;dbl&gt;            &lt;dbl&gt;           &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb136-6" title="6"><span class="co">#&gt; 1           -0.898          1.02              -1.34           -1.31</span></a>
<a class="sourceLine" id="cb136-7" title="7"><span class="co">#&gt; 2           -1.14          -0.132             -1.34           -1.31</span></a>
<a class="sourceLine" id="cb136-8" title="8"><span class="co">#&gt; 3           -1.38           0.327             -1.39           -1.31</span></a>
<a class="sourceLine" id="cb136-9" title="9"><span class="co">#&gt; 4           -1.50           0.0979            -1.28           -1.31</span></a>
<a class="sourceLine" id="cb136-10" title="10"><span class="co">#&gt; 5           -1.02           1.25              -1.34           -1.31</span></a>
<a class="sourceLine" id="cb136-11" title="11"><span class="co">#&gt; 6           -0.535          1.93              -1.17           -1.05</span></a>
<a class="sourceLine" id="cb136-12" title="12"><span class="co">#&gt; # … with 144 more rows, and 4 more variables: Sepal.Length_fn2 &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb136-13" title="13"><span class="co">#&gt; #   Sepal.Width_fn2 &lt;dbl&gt;, Petal.Length_fn2 &lt;dbl&gt;, Petal.Width_fn2 &lt;dbl&gt;</span></a></code></pre></div>
<p>通过具名列表，可以控制生成的新列的名称：</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb137-1" title="1">iris <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(is.numeric, <span class="kw">list</span>(<span class="dt">scale =</span> scale2, <span class="dt">log =</span> log)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-2" title="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>))</a>
<a class="sourceLine" id="cb137-3" title="3"><span class="co">#&gt; # A tibble: 150 x 8</span></a>
<a class="sourceLine" id="cb137-4" title="4"><span class="co">#&gt;   Sepal.Length_sc… Sepal.Width_sca… Petal.Length_sc… Petal.Width_sca…</span></a>
<a class="sourceLine" id="cb137-5" title="5"><span class="co">#&gt;              &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb137-6" title="6"><span class="co">#&gt; 1           -0.898           1.02              -1.34            -1.31</span></a>
<a class="sourceLine" id="cb137-7" title="7"><span class="co">#&gt; 2           -1.14           -0.132             -1.34            -1.31</span></a>
<a class="sourceLine" id="cb137-8" title="8"><span class="co">#&gt; 3           -1.38            0.327             -1.39            -1.31</span></a>
<a class="sourceLine" id="cb137-9" title="9"><span class="co">#&gt; 4           -1.50            0.0979            -1.28            -1.31</span></a>
<a class="sourceLine" id="cb137-10" title="10"><span class="co">#&gt; 5           -1.02            1.25              -1.34            -1.31</span></a>
<a class="sourceLine" id="cb137-11" title="11"><span class="co">#&gt; 6           -0.535           1.93              -1.17            -1.05</span></a>
<a class="sourceLine" id="cb137-12" title="12"><span class="co">#&gt; # … with 144 more rows, and 4 more variables: Sepal.Length_log &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb137-13" title="13"><span class="co">#&gt; #   Sepal.Width_log &lt;dbl&gt;, Petal.Length_log &lt;dbl&gt;, Petal.Width_log &lt;dbl&gt;</span></a></code></pre></div>
<p>若列表中只有一个函数，scoped variants 还是会就地修改原变量，传入具名列表可以避免这一点：</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb138-1" title="1"><span class="co"># When there&#39;s only one function in the list, it modifies existing</span></a>
<a class="sourceLine" id="cb138-2" title="2"><span class="co"># variables in place. Give it a name to instead create new variables:</span></a>
<a class="sourceLine" id="cb138-3" title="3">iris <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(is.numeric, <span class="kw">list</span>(scale2))</a>
<a class="sourceLine" id="cb138-4" title="4"><span class="co">#&gt; # A tibble: 150 x 5</span></a>
<a class="sourceLine" id="cb138-5" title="5"><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></a>
<a class="sourceLine" id="cb138-6" title="6"><span class="co">#&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  </span></a>
<a class="sourceLine" id="cb138-7" title="7"><span class="co">#&gt; 1       -0.898      1.02          -1.34       -1.31 setosa </span></a>
<a class="sourceLine" id="cb138-8" title="8"><span class="co">#&gt; 2       -1.14      -0.132         -1.34       -1.31 setosa </span></a>
<a class="sourceLine" id="cb138-9" title="9"><span class="co">#&gt; 3       -1.38       0.327         -1.39       -1.31 setosa </span></a>
<a class="sourceLine" id="cb138-10" title="10"><span class="co">#&gt; 4       -1.50       0.0979        -1.28       -1.31 setosa </span></a>
<a class="sourceLine" id="cb138-11" title="11"><span class="co">#&gt; 5       -1.02       1.25          -1.34       -1.31 setosa </span></a>
<a class="sourceLine" id="cb138-12" title="12"><span class="co">#&gt; 6       -0.535      1.93          -1.17       -1.05 setosa </span></a>
<a class="sourceLine" id="cb138-13" title="13"><span class="co">#&gt; # … with 144 more rows</span></a>
<a class="sourceLine" id="cb138-14" title="14">iris <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(is.numeric, <span class="kw">list</span>(<span class="dt">scale =</span> scale2))</a>
<a class="sourceLine" id="cb138-15" title="15"><span class="co">#&gt; # A tibble: 150 x 9</span></a>
<a class="sourceLine" id="cb138-16" title="16"><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species Sepal.Length_sc…</span></a>
<a class="sourceLine" id="cb138-17" title="17"><span class="co">#&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;              &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb138-18" title="18"><span class="co">#&gt; 1          5.1         3.5          1.4         0.2 setosa            -0.898</span></a>
<a class="sourceLine" id="cb138-19" title="19"><span class="co">#&gt; 2          4.9         3            1.4         0.2 setosa            -1.14 </span></a>
<a class="sourceLine" id="cb138-20" title="20"><span class="co">#&gt; 3          4.7         3.2          1.3         0.2 setosa            -1.38 </span></a>
<a class="sourceLine" id="cb138-21" title="21"><span class="co">#&gt; 4          4.6         3.1          1.5         0.2 setosa            -1.50 </span></a>
<a class="sourceLine" id="cb138-22" title="22"><span class="co">#&gt; 5          5           3.6          1.4         0.2 setosa            -1.02 </span></a>
<a class="sourceLine" id="cb138-23" title="23"><span class="co">#&gt; 6          5.4         3.9          1.7         0.4 setosa            -0.535</span></a>
<a class="sourceLine" id="cb138-24" title="24"><span class="co">#&gt; # … with 144 more rows, and 3 more variables: Sepal.Width_scale &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb138-25" title="25"><span class="co">#&gt; #   Petal.Length_scale &lt;dbl&gt;, Petal.Width_scale &lt;dbl&gt;</span></a></code></pre></div>
</div>
<div id="summarize" class="section level3">
<h3><span class="header-section-number">1.9.3</span> <code>summarize()</code></h3>
</div>
<div id="dance" class="section level3">
<h3><span class="header-section-number">1.9.4</span> dance</h3>
<p><code>summarize_()</code> 不能对某些列执行一个action，另一些列执行另一个action，必须同时执行:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb139-1" title="1">iris <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb139-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Species) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb139-3" title="3"><span class="st">  </span><span class="kw">summarize_at</span>(<span class="kw">vars</span>(Petal.Length, Petal.Width), <span class="kw">list</span>(<span class="dt">mean =</span> mean, <span class="dt">median =</span> median))</a>
<a class="sourceLine" id="cb139-4" title="4"><span class="co">#&gt; # A tibble: 3 x 5</span></a>
<a class="sourceLine" id="cb139-5" title="5"><span class="co">#&gt;   Species  Petal.Length_mean Petal.Width_mean Petal.Length_med… Petal.Width_med…</span></a>
<a class="sourceLine" id="cb139-6" title="6"><span class="co">#&gt;   &lt;fct&gt;                &lt;dbl&gt;            &lt;dbl&gt;             &lt;dbl&gt;            &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb139-7" title="7"><span class="co">#&gt; 1 setosa                1.46            0.246              1.5               0.2</span></a>
<a class="sourceLine" id="cb139-8" title="8"><span class="co">#&gt; 2 versico…              4.26            1.33               4.35              1.3</span></a>
<a class="sourceLine" id="cb139-9" title="9"><span class="co">#&gt; 3 virgini…              5.55            2.03               5.55              2</span></a></code></pre></div>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb140-1" title="1"><span class="co"># devtools::install_github(&quot;romainfrancois/dance&quot;)</span></a>
<a class="sourceLine" id="cb140-2" title="2"><span class="kw">library</span>(dance)</a>
<a class="sourceLine" id="cb140-3" title="3">iris <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb140-4" title="4"><span class="st">  </span><span class="kw">group_by</span>(Species) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb140-5" title="5"><span class="st">  </span><span class="kw">tango</span>(</a>
<a class="sourceLine" id="cb140-6" title="6">    <span class="kw">swing</span>(mean, <span class="kw">starts_with</span>(<span class="st">&quot;Petal&quot;</span>)),</a>
<a class="sourceLine" id="cb140-7" title="7">    <span class="kw">swing</span>(median, <span class="kw">starts_with</span>(<span class="st">&quot;Sepal&quot;</span>))</a>
<a class="sourceLine" id="cb140-8" title="8">  )</a>
<a class="sourceLine" id="cb140-9" title="9"><span class="co">#&gt; # A tibble: 3 x 5</span></a>
<a class="sourceLine" id="cb140-10" title="10"><span class="co">#&gt;   Species    Petal.Length Petal.Width Sepal.Length Sepal.Width</span></a>
<a class="sourceLine" id="cb140-11" title="11"><span class="co">#&gt;   &lt;fct&gt;             &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb140-12" title="12"><span class="co">#&gt; 1 setosa             1.46       0.246          5           3.4</span></a>
<a class="sourceLine" id="cb140-13" title="13"><span class="co">#&gt; 2 versicolor         4.26       1.33           5.9         2.8</span></a>
<a class="sourceLine" id="cb140-14" title="14"><span class="co">#&gt; 3 virginica          5.55       2.03           6.5         3</span></a></code></pre></div>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="1">
<li id="fn1"><p>tidyverse 之外，<a href="data-table.html#data-table">12</a> 中介绍的以 <code>data.table</code> 为中心的数据整理方法也值得一看<a href="dplyr.html#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="tibble.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/enixam/rfordatascience/edit/master/dplyr.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
