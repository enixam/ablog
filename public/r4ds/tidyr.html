<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6 tidyr | R for data science: tidyverse and beyond</title>
  <meta name="description" content="6 tidyr | R for data science: tidyverse and beyond" />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="6 tidyr | R for data science: tidyverse and beyond" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="enixam/rfordatascience" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 tidyr | R for data science: tidyverse and beyond" />
  
  
  

<meta name="author" content="Maxine" />


<meta name="date" content="2019-12-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="forcats.html"/>
<link rel="next" href="broom.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css\style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R4DS: tidyverse and beyond</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>前言</a></li>
<li class="part"><span><b>I R for data science</b></span></li>
<li class="chapter" data-level="1" data-path="dplyr.html"><a href="dplyr.html"><i class="fa fa-check"></i><b>1</b> dplyr</a><ul>
<li class="chapter" data-level="1.1" data-path="dplyr.html"><a href="dplyr.html#个数据转换核心函数"><i class="fa fa-check"></i><b>1.1</b> 5个数据转换核心函数</a></li>
<li class="chapter" data-level="1.2" data-path="dplyr.html"><a href="dplyr.html#filter筛选行"><i class="fa fa-check"></i><b>1.2</b> <code>filter()</code>筛选行</a><ul>
<li class="chapter" data-level="1.2.1" data-path="dplyr.html"><a href="dplyr.html#运算符"><i class="fa fa-check"></i><b>1.2.1</b> 运算符</a></li>
<li class="chapter" data-level="1.2.2" data-path="dplyr.html"><a href="dplyr.html#缺失值"><i class="fa fa-check"></i><b>1.2.2</b> 缺失值</a></li>
<li class="chapter" data-level="1.2.3" data-path="dplyr.html"><a href="dplyr.html#练习"><i class="fa fa-check"></i><b>1.2.3</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="dplyr.html"><a href="dplyr.html#arrange-排列行"><i class="fa fa-check"></i><b>1.3</b> <code>arrange()</code> 排列行</a><ul>
<li class="chapter" data-level="1.3.1" data-path="dplyr.html"><a href="dplyr.html#slice"><i class="fa fa-check"></i><b>1.3.1</b> <code>slice()</code></a></li>
<li class="chapter" data-level="1.3.2" data-path="dplyr.html"><a href="dplyr.html#练习-1"><i class="fa fa-check"></i><b>1.3.2</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="dplyr.html"><a href="dplyr.html#使用select选择列"><i class="fa fa-check"></i><b>1.4</b> 使用<code>select()</code>选择列</a><ul>
<li class="chapter" data-level="1.4.1" data-path="dplyr.html"><a href="dplyr.html#练习-2"><i class="fa fa-check"></i><b>1.4.1</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="dplyr.html"><a href="dplyr.html#mutate-创建变量"><i class="fa fa-check"></i><b>1.5</b> <code>mutate()</code> 创建变量</a><ul>
<li class="chapter" data-level="1.5.1" data-path="dplyr.html"><a href="dplyr.html#常用创建函数using-creation-functions"><i class="fa fa-check"></i><b>1.5.1</b> 常用创建函数（Using creation functions）</a></li>
<li class="chapter" data-level="1.5.2" data-path="dplyr.html"><a href="dplyr.html#练习-3"><i class="fa fa-check"></i><b>1.5.2</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="dplyr.html"><a href="dplyr.html#使用summarize进行分组摘要"><i class="fa fa-check"></i><b>1.6</b> 使用<code>summarize()</code>进行分组摘要</a><ul>
<li class="chapter" data-level="1.6.1" data-path="dplyr.html"><a href="dplyr.html#缺失值-1"><i class="fa fa-check"></i><b>1.6.1</b> 缺失值</a></li>
<li class="chapter" data-level="1.6.2" data-path="dplyr.html"><a href="dplyr.html#计数函数"><i class="fa fa-check"></i><b>1.6.2</b> 计数函数</a></li>
<li class="chapter" data-level="1.6.3" data-path="dplyr.html"><a href="dplyr.html#逻辑值的计数和比例sumx-10-和-meany-0"><i class="fa fa-check"></i><b>1.6.3</b> 逻辑值的计数和比例:<code>sum(x &gt; 10) 和 mean(y == 0)</code></a></li>
<li class="chapter" data-level="1.6.4" data-path="dplyr.html"><a href="dplyr.html#其他常用的摘要函数"><i class="fa fa-check"></i><b>1.6.4</b> 其他常用的摘要函数</a></li>
<li class="chapter" data-level="1.6.5" data-path="dplyr.html"><a href="dplyr.html#多个分组变量的消耗"><i class="fa fa-check"></i><b>1.6.5</b> 多个分组变量的消耗</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="dplyr.html"><a href="dplyr.html#group_by-结合其他函数"><i class="fa fa-check"></i><b>1.7</b> <code>group_by()</code> 结合其他函数</a></li>
<li class="chapter" data-level="1.8" data-path="dplyr.html"><a href="dplyr.html#练习-4"><i class="fa fa-check"></i><b>1.8</b> 练习</a></li>
<li class="chapter" data-level="1.9" data-path="dplyr.html"><a href="dplyr.html#作用域"><i class="fa fa-check"></i><b>1.9</b> 作用域</a><ul>
<li class="chapter" data-level="1.9.1" data-path="dplyr.html"><a href="dplyr.html#arrange"><i class="fa fa-check"></i><b>1.9.1</b> <code>arrange()</code></a></li>
<li class="chapter" data-level="1.9.2" data-path="dplyr.html"><a href="dplyr.html#mutate"><i class="fa fa-check"></i><b>1.9.2</b> <code>mutate()</code></a></li>
<li class="chapter" data-level="1.9.3" data-path="dplyr.html"><a href="dplyr.html#summarize"><i class="fa fa-check"></i><b>1.9.3</b> <code>summarize()</code></a></li>
<li class="chapter" data-level="1.9.4" data-path="dplyr.html"><a href="dplyr.html#dance"><i class="fa fa-check"></i><b>1.9.4</b> dance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="tibble.html"><a href="tibble.html"><i class="fa fa-check"></i><b>2</b> tibble</a><ul>
<li class="chapter" data-level="2.1" data-path="tibble.html"><a href="tibble.html#tibble-intro"><i class="fa fa-check"></i><b>2.1</b> 简介</a></li>
<li class="chapter" data-level="2.2" data-path="tibble.html"><a href="tibble.html#tibble-data.frame"><i class="fa fa-check"></i><b>2.2</b> 对比 tibble 和 data.frame</a><ul>
<li class="chapter" data-level="2.2.1" data-path="tibble.html"><a href="tibble.html#创建"><i class="fa fa-check"></i><b>2.2.1</b> 创建</a></li>
<li class="chapter" data-level="2.2.2" data-path="tibble.html"><a href="tibble.html#打印"><i class="fa fa-check"></i><b>2.2.2</b> 打印</a></li>
<li class="chapter" data-level="2.2.3" data-path="tibble.html"><a href="tibble.html#取子集"><i class="fa fa-check"></i><b>2.2.3</b> 取子集</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="tibble.html"><a href="tibble.html#tibble-exercise"><i class="fa fa-check"></i><b>2.3</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="readr.html"><a href="readr.html"><i class="fa fa-check"></i><b>3</b> readr</a><ul>
<li class="chapter" data-level="3.1" data-path="readr.html"><a href="readr.html#base-r-中的数据读取"><i class="fa fa-check"></i><b>3.1</b> base R 中的数据读取</a></li>
<li class="chapter" data-level="3.2" data-path="readr.html"><a href="readr.html#readr-简介"><i class="fa fa-check"></i><b>3.2</b> readr 简介</a><ul>
<li class="chapter" data-level="3.2.1" data-path="readr.html"><a href="readr.html#写入文件"><i class="fa fa-check"></i><b>3.2.1</b> 写入文件</a></li>
<li class="chapter" data-level="3.2.2" data-path="readr.html"><a href="readr.html#练习-5"><i class="fa fa-check"></i><b>3.2.2</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="readr.html"><a href="readr.html#解析向量parsing-a-vector"><i class="fa fa-check"></i><b>3.3</b> 解析向量(Parsing a vector)</a><ul>
<li class="chapter" data-level="3.3.1" data-path="readr.html"><a href="readr.html#数值"><i class="fa fa-check"></i><b>3.3.1</b> 数值</a></li>
<li class="chapter" data-level="3.3.2" data-path="readr.html"><a href="readr.html#字符串"><i class="fa fa-check"></i><b>3.3.2</b> 字符串</a></li>
<li class="chapter" data-level="3.3.3" data-path="readr.html"><a href="readr.html#因子"><i class="fa fa-check"></i><b>3.3.3</b> 因子</a></li>
<li class="chapter" data-level="3.3.4" data-path="readr.html"><a href="readr.html#日期时间日期时间"><i class="fa fa-check"></i><b>3.3.4</b> 日期时间、日期、时间</a></li>
<li class="chapter" data-level="3.3.5" data-path="readr.html"><a href="readr.html#练习-6"><i class="fa fa-check"></i><b>3.3.5</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="readr.html"><a href="readr.html#解析文件"><i class="fa fa-check"></i><b>3.4</b> 解析文件</a><ul>
<li class="chapter" data-level="3.4.1" data-path="readr.html"><a href="readr.html#解析策略strategies"><i class="fa fa-check"></i><b>3.4.1</b> 解析策略(strategies)</a></li>
<li class="chapter" data-level="3.4.2" data-path="readr.html"><a href="readr.html#可能遇到的问题"><i class="fa fa-check"></i><b>3.4.2</b> 可能遇到的问题</a></li>
<li class="chapter" data-level="3.4.3" data-path="readr.html"><a href="readr.html#其他技巧"><i class="fa fa-check"></i><b>3.4.3</b> 其他技巧</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="readr.html"><a href="readr.html#readxl"><i class="fa fa-check"></i><b>3.5</b> readxl</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="lubridate.html"><a href="lubridate.html"><i class="fa fa-check"></i><b>4</b> lubridate</a><ul>
<li class="chapter" data-level="4.1" data-path="lubridate.html"><a href="lubridate.html#创建日期和时间"><i class="fa fa-check"></i><b>4.1</b> 创建日期和时间</a><ul>
<li class="chapter" data-level="4.1.1" data-path="lubridate.html"><a href="lubridate.html#通过字符串创建"><i class="fa fa-check"></i><b>4.1.1</b> 通过字符串创建</a></li>
<li class="chapter" data-level="4.1.2" data-path="lubridate.html"><a href="lubridate.html#通过各个成分创建"><i class="fa fa-check"></i><b>4.1.2</b> 通过各个成分创建</a></li>
<li class="chapter" data-level="4.1.3" data-path="lubridate.html"><a href="lubridate.html#日期时间型和日期型数据的相互转换"><i class="fa fa-check"></i><b>4.1.3</b> 日期时间型和日期型数据的相互转换</a></li>
<li class="chapter" data-level="4.1.4" data-path="lubridate.html"><a href="lubridate.html#练习-7"><i class="fa fa-check"></i><b>4.1.4</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="lubridate.html"><a href="lubridate.html#日期时间成分"><i class="fa fa-check"></i><b>4.2</b> 日期时间成分</a><ul>
<li class="chapter" data-level="4.2.1" data-path="lubridate.html"><a href="lubridate.html#获取成分"><i class="fa fa-check"></i><b>4.2.1</b> 获取成分</a></li>
<li class="chapter" data-level="4.2.2" data-path="lubridate.html"><a href="lubridate.html#舍入rouding"><i class="fa fa-check"></i><b>4.2.2</b> 舍入（Rouding）</a></li>
<li class="chapter" data-level="4.2.3" data-path="lubridate.html"><a href="lubridate.html#设置成分"><i class="fa fa-check"></i><b>4.2.3</b> 设置成分</a></li>
<li class="chapter" data-level="4.2.4" data-path="lubridate.html"><a href="lubridate.html#练习-8"><i class="fa fa-check"></i><b>4.2.4</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="lubridate.html"><a href="lubridate.html#时间间隔time-span"><i class="fa fa-check"></i><b>4.3</b> 时间间隔（Time Span）</a><ul>
<li class="chapter" data-level="4.3.1" data-path="lubridate.html"><a href="lubridate.html#时期-durations"><i class="fa fa-check"></i><b>4.3.1</b> 时期 Durations</a></li>
<li class="chapter" data-level="4.3.2" data-path="lubridate.html"><a href="lubridate.html#阶段-periods"><i class="fa fa-check"></i><b>4.3.2</b> 阶段 Periods</a></li>
<li class="chapter" data-level="4.3.3" data-path="lubridate.html"><a href="lubridate.html#区间-intervals"><i class="fa fa-check"></i><b>4.3.3</b> 区间 Intervals</a></li>
<li class="chapter" data-level="4.3.4" data-path="lubridate.html"><a href="lubridate.html#小结"><i class="fa fa-check"></i><b>4.3.4</b> 小结</a></li>
<li class="chapter" data-level="4.3.5" data-path="lubridate.html"><a href="lubridate.html#练习-9"><i class="fa fa-check"></i><b>4.3.5</b> 练习</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="forcats.html"><a href="forcats.html"><i class="fa fa-check"></i><b>5</b> forcats</a><ul>
<li class="chapter" data-level="5.1" data-path="forcats.html"><a href="forcats.html#简介"><i class="fa fa-check"></i><b>5.1</b> 简介</a><ul>
<li class="chapter" data-level="5.1.1" data-path="forcats.html"><a href="forcats.html#因子基础"><i class="fa fa-check"></i><b>5.1.1</b> 因子基础</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="forcats.html"><a href="forcats.html#排序"><i class="fa fa-check"></i><b>5.2</b> 排序</a><ul>
<li class="chapter" data-level="5.2.1" data-path="forcats.html"><a href="forcats.html#按照水平的频次排序"><i class="fa fa-check"></i><b>5.2.1</b> 按照水平的频次排序</a></li>
<li class="chapter" data-level="5.2.2" data-path="forcats.html"><a href="forcats.html#按照其他变量排序"><i class="fa fa-check"></i><b>5.2.2</b> 按照其他变量排序</a></li>
<li class="chapter" data-level="5.2.3" data-path="forcats.html"><a href="forcats.html#人工指定顺序"><i class="fa fa-check"></i><b>5.2.3</b> 人工指定顺序</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="forcats.html"><a href="forcats.html#改变水平个数"><i class="fa fa-check"></i><b>5.3</b> 改变水平个数</a><ul>
<li class="chapter" data-level="5.3.1" data-path="forcats.html"><a href="forcats.html#合并水平"><i class="fa fa-check"></i><b>5.3.1</b> 合并水平</a></li>
<li class="chapter" data-level="5.3.2" data-path="forcats.html"><a href="forcats.html#增加水平"><i class="fa fa-check"></i><b>5.3.2</b> 增加水平</a></li>
<li class="chapter" data-level="5.3.3" data-path="forcats.html"><a href="forcats.html#舍弃水平dropping-unused-levels"><i class="fa fa-check"></i><b>5.3.3</b> 舍弃水平(Dropping unused levels)</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="forcats.html"><a href="forcats.html#编码"><i class="fa fa-check"></i><b>5.4</b> 编码</a><ul>
<li class="chapter" data-level="5.4.1" data-path="forcats.html"><a href="forcats.html#练习-10"><i class="fa fa-check"></i><b>5.4.1</b> 练习：</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="forcats.html"><a href="forcats.html#合并因子"><i class="fa fa-check"></i><b>5.5</b> 合并因子</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="tidyr.html"><a href="tidyr.html"><i class="fa fa-check"></i><b>6</b> tidyr</a><ul>
<li class="chapter" data-level="6.1" data-path="tidyr.html"><a href="tidyr.html#tidyr-intro"><i class="fa fa-check"></i><b>6.1</b> 简介</a><ul>
<li class="chapter" data-level="6.1.1" data-path="tidyr.html"><a href="tidyr.html#练习-11"><i class="fa fa-check"></i><b>6.1.1</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="tidyr.html"><a href="tidyr.html#spread和gather"><i class="fa fa-check"></i><b>6.2</b> <code>spread()</code>和<code>gather()</code></a><ul>
<li class="chapter" data-level="6.2.1" data-path="tidyr.html"><a href="tidyr.html#gather"><i class="fa fa-check"></i><b>6.2.1</b> <code>gather()</code></a></li>
<li class="chapter" data-level="6.2.2" data-path="tidyr.html"><a href="tidyr.html#spread"><i class="fa fa-check"></i><b>6.2.2</b> <code>spread()</code></a></li>
<li class="chapter" data-level="6.2.3" data-path="tidyr.html"><a href="tidyr.html#练习-12"><i class="fa fa-check"></i><b>6.2.3</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="tidyr.html"><a href="tidyr.html#separate和untie"><i class="fa fa-check"></i><b>6.3</b> <code>separate()</code>和<code>untie()</code></a><ul>
<li class="chapter" data-level="6.3.1" data-path="tidyr.html"><a href="tidyr.html#separate"><i class="fa fa-check"></i><b>6.3.1</b> <code>separate()</code></a></li>
<li class="chapter" data-level="6.3.2" data-path="tidyr.html"><a href="tidyr.html#unite"><i class="fa fa-check"></i><b>6.3.2</b> <code>unite()</code></a></li>
<li class="chapter" data-level="6.3.3" data-path="tidyr.html"><a href="tidyr.html#练习-13"><i class="fa fa-check"></i><b>6.3.3</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="tidyr.html"><a href="tidyr.html#tidyr-missing"><i class="fa fa-check"></i><b>6.4</b> 缺失值</a></li>
<li class="chapter" data-level="6.5" data-path="tidyr.html"><a href="tidyr.html#case-study"><i class="fa fa-check"></i><b>6.5</b> Case Study</a><ul>
<li class="chapter" data-level="6.5.1" data-path="tidyr.html"><a href="tidyr.html#练习-14"><i class="fa fa-check"></i><b>6.5.1</b> 练习</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="tidyr.html"><a href="tidyr.html#non-tidy"><i class="fa fa-check"></i><b>6.6</b> 拓展：None-tidy data</a></li>
<li class="chapter" data-level="6.7" data-path="tidyr.html"><a href="tidyr.html#tidyr-1.0.0"><i class="fa fa-check"></i><b>6.7</b> <code>tidyr 1.0.0</code></a><ul>
<li class="chapter" data-level="6.7.1" data-path="tidyr.html"><a href="tidyr.html#pivot_longer-和-pivot_wider"><i class="fa fa-check"></i><b>6.7.1</b> <code>pivot_longer</code> 和 <code>pivot_wider</code></a></li>
<li class="chapter" data-level="6.7.2" data-path="tidyr.html"><a href="tidyr.html#pivot_wider"><i class="fa fa-check"></i><b>6.7.2</b> <code>pivot_wider()</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="broom.html"><a href="broom.html"><i class="fa fa-check"></i><b>7</b> broom</a></li>
<li class="chapter" data-level="8" data-path="purrr.html"><a href="purrr.html"><i class="fa fa-check"></i><b>8</b> purrr</a><ul>
<li class="chapter" data-level="8.1" data-path="purrr.html"><a href="purrr.html#map-family"><i class="fa fa-check"></i><b>8.1</b> <code>map()</code> family</a></li>
<li class="chapter" data-level="8.2" data-path="purrr.html"><a href="purrr.html#producing-atomic-vectors"><i class="fa fa-check"></i><b>8.2</b> Producing atomic vectors</a><ul>
<li class="chapter" data-level="8.2.1" data-path="purrr.html"><a href="purrr.html#purrr-style-anonymous-functions"><i class="fa fa-check"></i><b>8.2.1</b> purrr-style anonymous functions</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="purrr.html"><a href="purrr.html#predicate-functions"><i class="fa fa-check"></i><b>8.3</b> Predicate functions</a><ul>
<li class="chapter" data-level="8.3.1" data-path="purrr.html"><a href="purrr.html#basics"><i class="fa fa-check"></i><b>8.3.1</b> Basics</a></li>
<li class="chapter" data-level="8.3.2" data-path="purrr.html"><a href="purrr.html#map-variants"><i class="fa fa-check"></i><b>8.3.2</b> Map variants</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="purrr.html"><a href="purrr.html#group_"><i class="fa fa-check"></i><b>8.4</b> group_</a><ul>
<li class="chapter" data-level="8.4.1" data-path="purrr.html"><a href="purrr.html#group_mapgroup_modify"><i class="fa fa-check"></i><b>8.4.1</b> group_map、group_modify</a></li>
<li class="chapter" data-level="8.4.2" data-path="purrr.html"><a href="purrr.html#group_splitgroup_keysgroup_data"><i class="fa fa-check"></i><b>8.4.2</b> group_split、group_keys、group_data</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Importing and APIs</b></span></li>
<li class="chapter" data-level="9" data-path="vroom.html"><a href="vroom.html"><i class="fa fa-check"></i><b>9</b> vroom</a></li>
<li class="chapter" data-level="10" data-path="wdi.html"><a href="wdi.html"><i class="fa fa-check"></i><b>10</b> WDI</a><ul>
<li class="chapter" data-level="10.1" data-path="wdi.html"><a href="wdi.html#wdisearch"><i class="fa fa-check"></i><b>10.1</b> <code>WDIsearch()</code></a></li>
<li class="chapter" data-level="10.2" data-path="wdi.html"><a href="wdi.html#wdi-1"><i class="fa fa-check"></i><b>10.2</b> <code>WDI</code></a></li>
</ul></li>
<li class="part"><span><b>III Exploring and Wrangling</b></span></li>
<li class="chapter" data-level="11" data-path="skimr.html"><a href="skimr.html"><i class="fa fa-check"></i><b>11</b> skimr</a></li>
<li class="chapter" data-level="12" data-path="data-table.html"><a href="data-table.html"><i class="fa fa-check"></i><b>12</b> data.table</a><ul>
<li class="chapter" data-level="12.1" data-path="data-table.html"><a href="data-table.html#dtplyr"><i class="fa fa-check"></i><b>12.1</b> dtplyr</a></li>
<li class="chapter" data-level="12.2" data-path="data-table.html"><a href="data-table.html#maditr"><i class="fa fa-check"></i><b>12.2</b> maditr</a></li>
<li class="chapter" data-level="12.3" data-path="data-table.html"><a href="data-table.html#tidyfast"><i class="fa fa-check"></i><b>12.3</b> tidyfast</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="rowwise-operation.html"><a href="rowwise-operation.html"><i class="fa fa-check"></i><b>13</b> rowwise operation</a><ul>
<li class="chapter" data-level="13.1" data-path="rowwise-operation.html"><a href="rowwise-operation.html#do-rowwise"><i class="fa fa-check"></i><b>13.1</b> do() + rowwise()</a></li>
<li class="chapter" data-level="13.2" data-path="rowwise-operation.html"><a href="rowwise-operation.html#rap"><i class="fa fa-check"></i><b>13.2</b> rap</a></li>
</ul></li>
<li class="part"><span><b>IV Cleaning and Tidying</b></span></li>
<li class="chapter" data-level="14" data-path="janitor.html"><a href="janitor.html"><i class="fa fa-check"></i><b>14</b> Janitor</a><ul>
<li class="chapter" data-level="14.1" data-path="janitor.html"><a href="janitor.html#qingxi"><i class="fa fa-check"></i><b>14.1</b> 清洗</a><ul>
<li class="chapter" data-level="14.1.1" data-path="janitor.html"><a href="janitor.html#clean_names"><i class="fa fa-check"></i><b>14.1.1</b> <code>clean_names</code></a></li>
<li class="chapter" data-level="14.1.2" data-path="janitor.html"><a href="janitor.html#compare_df_cols"><i class="fa fa-check"></i><b>14.1.2</b> <code>compare_df_cols</code></a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="janitor.html"><a href="janitor.html#tansuo"><i class="fa fa-check"></i><b>14.2</b> 探索</a><ul>
<li class="chapter" data-level="14.2.1" data-path="janitor.html"><a href="janitor.html#tabyl"><i class="fa fa-check"></i><b>14.2.1</b> <code>tabyl</code></a></li>
<li class="chapter" data-level="14.2.2" data-path="janitor.html"><a href="janitor.html#get_dupes"><i class="fa fa-check"></i><b>14.2.2</b> <code>get_dupes</code></a></li>
<li class="chapter" data-level="14.2.3" data-path="janitor.html"><a href="janitor.html#remove_"><i class="fa fa-check"></i><b>14.2.3</b> <code>remove_</code></a></li>
<li class="chapter" data-level="14.2.4" data-path="janitor.html"><a href="janitor.html#round_half_up"><i class="fa fa-check"></i><b>14.2.4</b> <code>round_half_up</code></a></li>
<li class="chapter" data-level="14.2.5" data-path="janitor.html"><a href="janitor.html#excel_numeric_to_date"><i class="fa fa-check"></i><b>14.2.5</b> <code>excel_numeric_to_date</code></a></li>
<li class="chapter" data-level="14.2.6" data-path="janitor.html"><a href="janitor.html#top_levels"><i class="fa fa-check"></i><b>14.2.6</b> <code>top_levels</code></a></li>
<li class="chapter" data-level="14.2.7" data-path="janitor.html"><a href="janitor.html#row_to_names"><i class="fa fa-check"></i><b>14.2.7</b> <code>row_to_names</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="missing-values.html"><a href="missing-values.html"><i class="fa fa-check"></i><b>15</b> 处理缺失值</a><ul>
<li class="chapter" data-level="15.1" data-path="missing-values.html"><a href="missing-values.html#explore-missing"><i class="fa fa-check"></i><b>15.1</b> 探索</a></li>
<li class="chapter" data-level="15.2" data-path="missing-values.html"><a href="missing-values.html#fill-missing"><i class="fa fa-check"></i><b>15.2</b> 填充</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">written with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R for data science: tidyverse and beyond</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tidyr" class="section level1">
<h1><span class="header-section-number">6</span> tidyr</h1>
<div id="tidyr-intro" class="section level2">
<h2><span class="header-section-number">6.1</span> 简介</h2>
<blockquote>
<p>“Happy families are all alike; every unhappy family is unhappy in its own way.” –– Leo Tolstoy</p>
</blockquote>
<blockquote>
<p>“Tidy datasets are all alike, but every messy dataset is messy in its own way.” –– Hadley Wickham</p>
</blockquote>
<p>整洁的数据(Tidy data)是进行数据操作和 ggplot2 可视化的基础，所谓数据整理（清洗、清理），就是把 messy data 转换为 tidy data 的过程。在 tidyverse 生态中，<strong>tidyr</strong> 便负责数据的整理和变型：</p>
<p>如果一个数据集是整洁的，需要满足以下三个要素：<br />
1. 每个变量有一个专属列(Each variable must have its own column)<br />
2. 每个观测有一个专属行(Each observation must have its own row)<br />
3. 每个值必须都有一个专属的存储单元(Each value must its own cell)</p>
<p><img src="images/11.png" width="80%" /></p>
<p>这三条规则是互相关联的，你不可能只满足三条规则中的两条，所以我们可以更简化地把清洁数据的要求写成：<br />
1. 每列是一个变量(Variables go in columns)<br />
2. 每行是一个观测(Observatiosn go in rows)</p>
<p>同样的数据可以有不同的表现形式，但只有满足整洁数据的三个条件的数据集才是最容易使用的，这也是。以下的3个数据集背后的均来自1999年和2000年世界卫生组织在阿富汗、巴西和中国的一次肺结核病例调查，都有<code>country</code>、<code>year</code>、<code>cases</code>和<code>population</code>四个变量，但采用了不同的组织方式:</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb290-1" title="1">table1</a>
<a class="sourceLine" id="cb290-2" title="2"><span class="co">#&gt; # A tibble: 6 x 4</span></a>
<a class="sourceLine" id="cb290-3" title="3"><span class="co">#&gt;   country      year  cases population</span></a>
<a class="sourceLine" id="cb290-4" title="4"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt;  &lt;int&gt;      &lt;int&gt;</span></a>
<a class="sourceLine" id="cb290-5" title="5"><span class="co">#&gt; 1 Afghanistan  1999    745   19987071</span></a>
<a class="sourceLine" id="cb290-6" title="6"><span class="co">#&gt; 2 Afghanistan  2000   2666   20595360</span></a>
<a class="sourceLine" id="cb290-7" title="7"><span class="co">#&gt; 3 Brazil       1999  37737  172006362</span></a>
<a class="sourceLine" id="cb290-8" title="8"><span class="co">#&gt; 4 Brazil       2000  80488  174504898</span></a>
<a class="sourceLine" id="cb290-9" title="9"><span class="co">#&gt; 5 China        1999 212258 1272915272</span></a>
<a class="sourceLine" id="cb290-10" title="10"><span class="co">#&gt; 6 China        2000 213766 1280428583</span></a>
<a class="sourceLine" id="cb290-11" title="11">table2</a>
<a class="sourceLine" id="cb290-12" title="12"><span class="co">#&gt; # A tibble: 12 x 4</span></a>
<a class="sourceLine" id="cb290-13" title="13"><span class="co">#&gt;   country      year type           count</span></a>
<a class="sourceLine" id="cb290-14" title="14"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb290-15" title="15"><span class="co">#&gt; 1 Afghanistan  1999 cases            745</span></a>
<a class="sourceLine" id="cb290-16" title="16"><span class="co">#&gt; 2 Afghanistan  1999 population  19987071</span></a>
<a class="sourceLine" id="cb290-17" title="17"><span class="co">#&gt; 3 Afghanistan  2000 cases           2666</span></a>
<a class="sourceLine" id="cb290-18" title="18"><span class="co">#&gt; 4 Afghanistan  2000 population  20595360</span></a>
<a class="sourceLine" id="cb290-19" title="19"><span class="co">#&gt; 5 Brazil       1999 cases          37737</span></a>
<a class="sourceLine" id="cb290-20" title="20"><span class="co">#&gt; 6 Brazil       1999 population 172006362</span></a>
<a class="sourceLine" id="cb290-21" title="21"><span class="co">#&gt; # … with 6 more rows</span></a>
<a class="sourceLine" id="cb290-22" title="22">table3</a>
<a class="sourceLine" id="cb290-23" title="23"><span class="co">#&gt; # A tibble: 6 x 3</span></a>
<a class="sourceLine" id="cb290-24" title="24"><span class="co">#&gt;   country      year rate             </span></a>
<a class="sourceLine" id="cb290-25" title="25"><span class="co">#&gt; * &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;            </span></a>
<a class="sourceLine" id="cb290-26" title="26"><span class="co">#&gt; 1 Afghanistan  1999 745/19987071     </span></a>
<a class="sourceLine" id="cb290-27" title="27"><span class="co">#&gt; 2 Afghanistan  2000 2666/20595360    </span></a>
<a class="sourceLine" id="cb290-28" title="28"><span class="co">#&gt; 3 Brazil       1999 37737/172006362  </span></a>
<a class="sourceLine" id="cb290-29" title="29"><span class="co">#&gt; 4 Brazil       2000 80488/174504898  </span></a>
<a class="sourceLine" id="cb290-30" title="30"><span class="co">#&gt; 5 China        1999 212258/1272915272</span></a>
<a class="sourceLine" id="cb290-31" title="31"><span class="co">#&gt; 6 China        2000 213766/1280428583</span></a></code></pre></div>
<p><code>table4a</code>和<code>table4b</code>分别是以 cases 和 population 为值的数据透视表：</p>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb291-1" title="1">table4a</a>
<a class="sourceLine" id="cb291-2" title="2"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb291-3" title="3"><span class="co">#&gt;   country     `1999` `2000`</span></a>
<a class="sourceLine" id="cb291-4" title="4"><span class="co">#&gt; * &lt;chr&gt;        &lt;int&gt;  &lt;int&gt;</span></a>
<a class="sourceLine" id="cb291-5" title="5"><span class="co">#&gt; 1 Afghanistan    745   2666</span></a>
<a class="sourceLine" id="cb291-6" title="6"><span class="co">#&gt; 2 Brazil       37737  80488</span></a>
<a class="sourceLine" id="cb291-7" title="7"><span class="co">#&gt; 3 China       212258 213766</span></a>
<a class="sourceLine" id="cb291-8" title="8">table4b</a>
<a class="sourceLine" id="cb291-9" title="9"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb291-10" title="10"><span class="co">#&gt;   country         `1999`     `2000`</span></a>
<a class="sourceLine" id="cb291-11" title="11"><span class="co">#&gt; * &lt;chr&gt;            &lt;int&gt;      &lt;int&gt;</span></a>
<a class="sourceLine" id="cb291-12" title="12"><span class="co">#&gt; 1 Afghanistan   19987071   20595360</span></a>
<a class="sourceLine" id="cb291-13" title="13"><span class="co">#&gt; 2 Brazil       172006362  174504898</span></a>
<a class="sourceLine" id="cb291-14" title="14"><span class="co">#&gt; 3 China       1272915272 1280428583</span></a></code></pre></div>
<p>在上面的例子中，只有<code>table1</code> 符合清洁数据的标准。在<code>table2</code> 中，<code>type</code>不是一个变量，它的值 <code>cases</code> 和 <code>population</code> 才是变量，进而导致了每一行不是一个完整的观测。在 <code>table3</code> 中，<code>rate</code> 同样不是一个变量，<code>cases</code> 和 <code>population</code> 的值被挤在了一个单元里。至于 <code>table4a</code> 和<code>table4b</code>，<code>1999</code> 和 <code>2000</code>不是变量，而是一个表示年份的变量的值。</p>
<p>为什么要为获得清洁的数据如此大费周折呢？主要有两个优点：</p>
<ol style="list-style-type: decimal">
<li>清洁数据的规则使得我们可以遵从一个一致、明确的结构存储数据。学习处理这些数据的工具变得很容易，因为你的对象在底层是一致的。<br />
</li>
<li>把变量存储在列中可以把R的向量化函数优势发挥到极致。我们已经学过 <code>mutate()</code> 和 <code>summarize()</code> 函数，许多内置的 R 函数都是对向量进行操作的。只要有了清洁的数据，后面的数据变换工作就很容易：</li>
</ol>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb292-1" title="1"><span class="co"># Compute rate per 10,000</span></a>
<a class="sourceLine" id="cb292-2" title="2">table1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb292-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rate =</span> cases <span class="op">/</span><span class="st"> </span>population <span class="op">*</span><span class="st"> </span><span class="dv">10000</span>)</a>
<a class="sourceLine" id="cb292-4" title="4"><span class="co">#&gt; # A tibble: 6 x 5</span></a>
<a class="sourceLine" id="cb292-5" title="5"><span class="co">#&gt;   country      year  cases population  rate</span></a>
<a class="sourceLine" id="cb292-6" title="6"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt;  &lt;int&gt;      &lt;int&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb292-7" title="7"><span class="co">#&gt; 1 Afghanistan  1999    745   19987071 0.373</span></a>
<a class="sourceLine" id="cb292-8" title="8"><span class="co">#&gt; 2 Afghanistan  2000   2666   20595360 1.29 </span></a>
<a class="sourceLine" id="cb292-9" title="9"><span class="co">#&gt; 3 Brazil       1999  37737  172006362 2.19 </span></a>
<a class="sourceLine" id="cb292-10" title="10"><span class="co">#&gt; 4 Brazil       2000  80488  174504898 4.61 </span></a>
<a class="sourceLine" id="cb292-11" title="11"><span class="co">#&gt; 5 China        1999 212258 1272915272 1.67 </span></a>
<a class="sourceLine" id="cb292-12" title="12"><span class="co">#&gt; 6 China        2000 213766 1280428583 1.67</span></a>
<a class="sourceLine" id="cb292-13" title="13"><span class="co"># Compute cases per year</span></a>
<a class="sourceLine" id="cb292-14" title="14">table1 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb292-15" title="15"><span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb292-16" title="16"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">cases =</span> <span class="kw">sum</span>(cases)) </a>
<a class="sourceLine" id="cb292-17" title="17"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb292-18" title="18"><span class="co">#&gt;    year  cases</span></a>
<a class="sourceLine" id="cb292-19" title="19"><span class="co">#&gt;   &lt;int&gt;  &lt;int&gt;</span></a>
<a class="sourceLine" id="cb292-20" title="20"><span class="co">#&gt; 1  1999 250740</span></a>
<a class="sourceLine" id="cb292-21" title="21"><span class="co">#&gt; 2  2000 296920</span></a>
<a class="sourceLine" id="cb292-22" title="22"><span class="co"># 或者：</span></a>
<a class="sourceLine" id="cb292-23" title="23">table1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb292-24" title="24"><span class="st">  </span><span class="kw">count</span>(year, <span class="dt">wt =</span> cases)</a>
<a class="sourceLine" id="cb292-25" title="25"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb292-26" title="26"><span class="co">#&gt;    year      n</span></a>
<a class="sourceLine" id="cb292-27" title="27"><span class="co">#&gt;   &lt;int&gt;  &lt;int&gt;</span></a>
<a class="sourceLine" id="cb292-28" title="28"><span class="co">#&gt; 1  1999 250740</span></a>
<a class="sourceLine" id="cb292-29" title="29"><span class="co">#&gt; 2  2000 296920</span></a>
<a class="sourceLine" id="cb292-30" title="30"></a>
<a class="sourceLine" id="cb292-31" title="31"><span class="co"># Visualise changes over time</span></a>
<a class="sourceLine" id="cb292-32" title="32"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb292-33" title="33"><span class="kw">ggplot</span>(table1, <span class="kw">aes</span>(year, cases)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb292-34" title="34"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> country), <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb292-35" title="35"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> country))<span class="op">+</span></a>
<a class="sourceLine" id="cb292-36" title="36"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">1999</span>,<span class="dv">2000</span>),<span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;1999&quot;</span>,<span class="st">&quot;2000&quot;</span>))</a></code></pre></div>
<p><img src="tidyr_files/figure-html/unnamed-chunk-5-1.svg" width="80%" /></p>
<div id="练习-11" class="section level3">
<h3><span class="header-section-number">6.1.1</span> 练习</h3>
<blockquote>
<ol style="list-style-type: decimal">
<li>用<code>table2</code>计算<code>rate</code>(<span class="math inline">\(\frac{cases}{population}\)</span>)。提示：需要进行以下四步操作：</li>
</ol>
<ul>
<li>得到每个国家每年的<code>cases</code><br />
</li>
<li>得到每个国家每年的<code>population</code><br />
</li>
<li>计算<code>rate = cases / population</code><br />
</li>
<li>把算好的数据存储到正确的位置</li>
</ul>
</blockquote>
<p>首先，分别对<code>cases</code>和<code>population</code>建立一张表，并且确保两张表的排列顺序相同：</p>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb293-1" title="1">table2</a>
<a class="sourceLine" id="cb293-2" title="2"><span class="co">#&gt; # A tibble: 12 x 4</span></a>
<a class="sourceLine" id="cb293-3" title="3"><span class="co">#&gt;   country      year type           count</span></a>
<a class="sourceLine" id="cb293-4" title="4"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb293-5" title="5"><span class="co">#&gt; 1 Afghanistan  1999 cases            745</span></a>
<a class="sourceLine" id="cb293-6" title="6"><span class="co">#&gt; 2 Afghanistan  1999 population  19987071</span></a>
<a class="sourceLine" id="cb293-7" title="7"><span class="co">#&gt; 3 Afghanistan  2000 cases           2666</span></a>
<a class="sourceLine" id="cb293-8" title="8"><span class="co">#&gt; 4 Afghanistan  2000 population  20595360</span></a>
<a class="sourceLine" id="cb293-9" title="9"><span class="co">#&gt; 5 Brazil       1999 cases          37737</span></a>
<a class="sourceLine" id="cb293-10" title="10"><span class="co">#&gt; 6 Brazil       1999 population 172006362</span></a>
<a class="sourceLine" id="cb293-11" title="11"><span class="co">#&gt; # … with 6 more rows</span></a>
<a class="sourceLine" id="cb293-12" title="12"></a>
<a class="sourceLine" id="cb293-13" title="13">(t2_cases &lt;-<span class="st"> </span><span class="kw">filter</span>(table2, type <span class="op">==</span><span class="st"> &quot;cases&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb293-14" title="14"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">cases =</span> count) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb293-15" title="15"><span class="st">  </span><span class="kw">arrange</span>(country, year))</a>
<a class="sourceLine" id="cb293-16" title="16"><span class="co">#&gt; # A tibble: 6 x 4</span></a>
<a class="sourceLine" id="cb293-17" title="17"><span class="co">#&gt;   country      year type   cases</span></a>
<a class="sourceLine" id="cb293-18" title="18"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;  &lt;int&gt;</span></a>
<a class="sourceLine" id="cb293-19" title="19"><span class="co">#&gt; 1 Afghanistan  1999 cases    745</span></a>
<a class="sourceLine" id="cb293-20" title="20"><span class="co">#&gt; 2 Afghanistan  2000 cases   2666</span></a>
<a class="sourceLine" id="cb293-21" title="21"><span class="co">#&gt; 3 Brazil       1999 cases  37737</span></a>
<a class="sourceLine" id="cb293-22" title="22"><span class="co">#&gt; 4 Brazil       2000 cases  80488</span></a>
<a class="sourceLine" id="cb293-23" title="23"><span class="co">#&gt; 5 China        1999 cases 212258</span></a>
<a class="sourceLine" id="cb293-24" title="24"><span class="co">#&gt; 6 China        2000 cases 213766</span></a>
<a class="sourceLine" id="cb293-25" title="25"></a>
<a class="sourceLine" id="cb293-26" title="26">(t2_population &lt;-<span class="st"> </span><span class="kw">filter</span>(table2, type <span class="op">==</span><span class="st"> &quot;population&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb293-27" title="27"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">population =</span> count) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb293-28" title="28"><span class="st">  </span><span class="kw">arrange</span>(country, year))</a>
<a class="sourceLine" id="cb293-29" title="29"><span class="co">#&gt; # A tibble: 6 x 4</span></a>
<a class="sourceLine" id="cb293-30" title="30"><span class="co">#&gt;   country      year type       population</span></a>
<a class="sourceLine" id="cb293-31" title="31"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;           &lt;int&gt;</span></a>
<a class="sourceLine" id="cb293-32" title="32"><span class="co">#&gt; 1 Afghanistan  1999 population   19987071</span></a>
<a class="sourceLine" id="cb293-33" title="33"><span class="co">#&gt; 2 Afghanistan  2000 population   20595360</span></a>
<a class="sourceLine" id="cb293-34" title="34"><span class="co">#&gt; 3 Brazil       1999 population  172006362</span></a>
<a class="sourceLine" id="cb293-35" title="35"><span class="co">#&gt; 4 Brazil       2000 population  174504898</span></a>
<a class="sourceLine" id="cb293-36" title="36"><span class="co">#&gt; 5 China        1999 population 1272915272</span></a>
<a class="sourceLine" id="cb293-37" title="37"><span class="co">#&gt; 6 China        2000 population 1280428583</span></a></code></pre></div>
<p>计算<code>rate</code></p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb294-1" title="1">t2_cases_per_cap &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb294-2" title="2">  t2_cases<span class="op">$</span>country,</a>
<a class="sourceLine" id="cb294-3" title="3">  t2_cases<span class="op">$</span>year,</a>
<a class="sourceLine" id="cb294-4" title="4">  <span class="dt">cases =</span> t2_cases<span class="op">$</span>cases,</a>
<a class="sourceLine" id="cb294-5" title="5">  <span class="dt">population =</span> t2_population<span class="op">$</span>population</a>
<a class="sourceLine" id="cb294-6" title="6">)</a>
<a class="sourceLine" id="cb294-7" title="7"></a>
<a class="sourceLine" id="cb294-8" title="8">t2_cases_per_cap</a>
<a class="sourceLine" id="cb294-9" title="9"><span class="co">#&gt; # A tibble: 6 x 4</span></a>
<a class="sourceLine" id="cb294-10" title="10"><span class="co">#&gt;   `t2_cases$country` `t2_cases$year`  cases population</span></a>
<a class="sourceLine" id="cb294-11" title="11"><span class="co">#&gt;   &lt;chr&gt;                        &lt;int&gt;  &lt;int&gt;      &lt;int&gt;</span></a>
<a class="sourceLine" id="cb294-12" title="12"><span class="co">#&gt; 1 Afghanistan                   1999    745   19987071</span></a>
<a class="sourceLine" id="cb294-13" title="13"><span class="co">#&gt; 2 Afghanistan                   2000   2666   20595360</span></a>
<a class="sourceLine" id="cb294-14" title="14"><span class="co">#&gt; 3 Brazil                        1999  37737  172006362</span></a>
<a class="sourceLine" id="cb294-15" title="15"><span class="co">#&gt; 4 Brazil                        2000  80488  174504898</span></a>
<a class="sourceLine" id="cb294-16" title="16"><span class="co">#&gt; 5 China                         1999 212258 1272915272</span></a>
<a class="sourceLine" id="cb294-17" title="17"><span class="co">#&gt; 6 China                         2000 213766 1280428583</span></a>
<a class="sourceLine" id="cb294-18" title="18"></a>
<a class="sourceLine" id="cb294-19" title="19">t2_cases_per_cap <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb294-20" title="20"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rate =</span> cases<span class="op">/</span>population) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb294-21" title="21"><span class="st">  </span><span class="kw">select</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>) <span class="op">%&gt;%</span><span class="st">  </span></a>
<a class="sourceLine" id="cb294-22" title="22"><span class="st">  </span><span class="co">## 改变列名</span></a>
<a class="sourceLine" id="cb294-23" title="23"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb294-24" title="24">    <span class="dt">country =</span> t2_cases<span class="op">$</span>country,</a>
<a class="sourceLine" id="cb294-25" title="25">    <span class="dt">year =</span> t2_cases<span class="op">$</span>year</a>
<a class="sourceLine" id="cb294-26" title="26">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb294-27" title="27"><span class="st">  </span><span class="kw">select</span>(country,year,rate)</a>
<a class="sourceLine" id="cb294-28" title="28"><span class="co">#&gt; # A tibble: 6 x 3</span></a>
<a class="sourceLine" id="cb294-29" title="29"><span class="co">#&gt;   country      year      rate</span></a>
<a class="sourceLine" id="cb294-30" title="30"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb294-31" title="31"><span class="co">#&gt; 1 Afghanistan  1999 0.0000373</span></a>
<a class="sourceLine" id="cb294-32" title="32"><span class="co">#&gt; 2 Afghanistan  2000 0.000129 </span></a>
<a class="sourceLine" id="cb294-33" title="33"><span class="co">#&gt; 3 Brazil       1999 0.000219 </span></a>
<a class="sourceLine" id="cb294-34" title="34"><span class="co">#&gt; 4 Brazil       2000 0.000461 </span></a>
<a class="sourceLine" id="cb294-35" title="35"><span class="co">#&gt; 5 China        1999 0.000167 </span></a>
<a class="sourceLine" id="cb294-36" title="36"><span class="co">#&gt; 6 China        2000 0.000167</span></a></code></pre></div>
</div>
</div>
<div id="spread和gather" class="section level2">
<h2><span class="header-section-number">6.2</span> <code>spread()</code>和<code>gather()</code></h2>
<p>请看下面的两张表格：<br />
<img src="images/12.png" /></p>
<p>细看两表，不难发现它们实质上相同的数据(第二张表是以x为行字段，y为列字段，z为值的数据透视表)。第一种形式成为<strong>长数据(long data,indexed data，指标型数据)</strong>，在长数据（指标型）数据汇总，你需要看指标来找到需要变量的数值（变量x，y，z的值）。第二种称为<strong>宽数据(wide data,Cartesian data,笛卡尔型数据)</strong>，需要看行和列的交叉点来找到对应的值。我们不能简单的说哪一种格式梗优，因为两种形式都有可能是整洁的，这取决于值“A”、“B”、“C”、“D”的含义。</p>
<p>注意到上面的确实值：在一种形式下显示存在的缺失值在另一种格式下不一定能直接看得出来。NA代表了一种缺失情况，但有时数值确实单纯是因为那里没有值。（而不是因为记录失误，没有获取到等原因）</p>
<p>数据整理常需要化宽为长，称为聚集(gathering)，但偶尔也需要化长为宽，称为扩散(spreading)。<code>tidyr</code>包分别提供了<code>gather()</code>和<code>spread()</code>函数来实现以上操作。</p>
<div id="gather" class="section level3">
<h3><span class="header-section-number">6.2.1</span> <code>gather()</code></h3>
<p><code>gather()</code>函数用来处理messy data 的一个常见症状：部分列名不是变量的名子，而是变量的值(some of the column names are not names of variables, but <em>values</em> of a variale)，或者说一行中有多个观测。例如，在<code>table4a</code>中，<code>1999</code>和<code>2000</code>不是某个变量的名字，而是一个表示年份的变量的不同取值：</p>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb295-1" title="1">table4a</a>
<a class="sourceLine" id="cb295-2" title="2"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb295-3" title="3"><span class="co">#&gt;   country     `1999` `2000`</span></a>
<a class="sourceLine" id="cb295-4" title="4"><span class="co">#&gt; * &lt;chr&gt;        &lt;int&gt;  &lt;int&gt;</span></a>
<a class="sourceLine" id="cb295-5" title="5"><span class="co">#&gt; 1 Afghanistan    745   2666</span></a>
<a class="sourceLine" id="cb295-6" title="6"><span class="co">#&gt; 2 Brazil       37737  80488</span></a>
<a class="sourceLine" id="cb295-7" title="7"><span class="co">#&gt; 3 China       212258 213766</span></a></code></pre></div>
<p>可以将之与清洁数据<code>table1</code>相比对，不难看出，在<code>table4a</code>中的3行数据在<code>table1</code>中需要6行来表示，这就需要“化宽为长”的<code>gather()</code>函数。</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb296-1" title="1">table1</a>
<a class="sourceLine" id="cb296-2" title="2"><span class="co">#&gt; # A tibble: 6 x 4</span></a>
<a class="sourceLine" id="cb296-3" title="3"><span class="co">#&gt;   country      year  cases population</span></a>
<a class="sourceLine" id="cb296-4" title="4"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt;  &lt;int&gt;      &lt;int&gt;</span></a>
<a class="sourceLine" id="cb296-5" title="5"><span class="co">#&gt; 1 Afghanistan  1999    745   19987071</span></a>
<a class="sourceLine" id="cb296-6" title="6"><span class="co">#&gt; 2 Afghanistan  2000   2666   20595360</span></a>
<a class="sourceLine" id="cb296-7" title="7"><span class="co">#&gt; 3 Brazil       1999  37737  172006362</span></a>
<a class="sourceLine" id="cb296-8" title="8"><span class="co">#&gt; 4 Brazil       2000  80488  174504898</span></a>
<a class="sourceLine" id="cb296-9" title="9"><span class="co">#&gt; 5 China        1999 212258 1272915272</span></a>
<a class="sourceLine" id="cb296-10" title="10"><span class="co">#&gt; 6 China        2000 213766 1280428583</span></a></code></pre></div>
<p><code>gather()</code>有四个主要参数：</p>
<ul>
<li><code>data</code>: 需要调用的数据集<br />
</li>
<li><code>key</code>： 存放原来各列名的新变量的变量名（键列）<br />
</li>
<li><code>value</code> 存放原来单元格中的值的新变量的变量名（值列）<br />
</li>
<li><code>...</code>: 指定的要聚集（融合）的变量，可以通过枚举指定: <code>A</code>,<code>B</code>,<code>C</code> 或者通过范围进行指定<code>A:D</code>,也可以同过<code>-</code>号 指定不需要聚集的列：<code>-E,-F</code>。不管要聚集多少列，<code>gather()</code>函数都把它们聚集为一个键列和一个值列。</li>
</ul>
<p>接下来我们整理<code>table4a</code>数据集，这里需要聚集的列是<code>1999</code>和<code>2000</code>:</p>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb297-1" title="1"><span class="co">## 注意这里`1999`和`2000`的引用方法</span></a>
<a class="sourceLine" id="cb297-2" title="2"><span class="kw">gather</span>(table4a,<span class="dt">key =</span> year,<span class="dt">value =</span> cases,<span class="st">`</span><span class="dt">1999</span><span class="st">`</span>,<span class="st">`</span><span class="dt">2000</span><span class="st">`</span>)</a>
<a class="sourceLine" id="cb297-3" title="3"><span class="co">#&gt; # A tibble: 6 x 3</span></a>
<a class="sourceLine" id="cb297-4" title="4"><span class="co">#&gt;   country     year   cases</span></a>
<a class="sourceLine" id="cb297-5" title="5"><span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt;  &lt;int&gt;</span></a>
<a class="sourceLine" id="cb297-6" title="6"><span class="co">#&gt; 1 Afghanistan 1999     745</span></a>
<a class="sourceLine" id="cb297-7" title="7"><span class="co">#&gt; 2 Brazil      1999   37737</span></a>
<a class="sourceLine" id="cb297-8" title="8"><span class="co">#&gt; 3 China       1999  212258</span></a>
<a class="sourceLine" id="cb297-9" title="9"><span class="co">#&gt; 4 Afghanistan 2000    2666</span></a>
<a class="sourceLine" id="cb297-10" title="10"><span class="co">#&gt; 5 Brazil      2000   80488</span></a>
<a class="sourceLine" id="cb297-11" title="11"><span class="co">#&gt; 6 China       2000  213766</span></a></code></pre></div>
<p>图示变换过程：
<img src="images/13.png" /></p>
<p>另一个例子：美国劳工市场的月度数据，首先创建一个messy data：</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb298-1" title="1"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb298-2" title="2">ec2 &lt;-<span class="st"> </span>economics <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb298-3" title="3"><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">year =</span> <span class="kw">year</span>(date),</a>
<a class="sourceLine" id="cb298-4" title="4">            <span class="dt">month =</span> <span class="kw">month</span>(date),</a>
<a class="sourceLine" id="cb298-5" title="5">            <span class="dt">rate =</span> unemploy) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb298-6" title="6"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">&gt;</span><span class="st"> </span><span class="dv">2005</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb298-7" title="7"><span class="st">  </span><span class="kw">spread</span>(year,rate)</a>
<a class="sourceLine" id="cb298-8" title="8"></a>
<a class="sourceLine" id="cb298-9" title="9">ec2</a>
<a class="sourceLine" id="cb298-10" title="10"><span class="co">#&gt; # A tibble: 12 x 11</span></a>
<a class="sourceLine" id="cb298-11" title="11"><span class="co">#&gt;   month `2006` `2007` `2008` `2009` `2010` `2011` `2012` `2013` `2014` `2015`</span></a>
<a class="sourceLine" id="cb298-12" title="12"><span class="co">#&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb298-13" title="13"><span class="co">#&gt; 1     1   7064   7116   7685  12058  15046  14013  12797  12471  10202   8903</span></a>
<a class="sourceLine" id="cb298-14" title="14"><span class="co">#&gt; 2     2   7184   6927   7497  12898  15113  13820  12813  11950  10349   8610</span></a>
<a class="sourceLine" id="cb298-15" title="15"><span class="co">#&gt; 3     3   7072   6731   7822  13426  15202  13737  12713  11689  10380   8504</span></a>
<a class="sourceLine" id="cb298-16" title="16"><span class="co">#&gt; 4     4   7120   6850   7637  13853  15325  13957  12646  11760   9702   8526</span></a>
<a class="sourceLine" id="cb298-17" title="17"><span class="co">#&gt; 5     5   6980   6766   8395  14499  14849  13855  12660  11654   9859     NA</span></a>
<a class="sourceLine" id="cb298-18" title="18"><span class="co">#&gt; 6     6   7001   6979   8575  14707  14474  13962  12692  11751   9460     NA</span></a>
<a class="sourceLine" id="cb298-19" title="19"><span class="co">#&gt; # … with 6 more rows</span></a></code></pre></div>
<p>下面，将除了<code>month</code>列的所有列聚集为一个键列和一个值列</p>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb299-1" title="1">ec2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb299-2" title="2"><span class="st">  </span><span class="kw">gather</span>(<span class="op">-</span>month,<span class="dt">key =</span> year,<span class="dt">value =</span> unemploy)</a>
<a class="sourceLine" id="cb299-3" title="3"><span class="co">#&gt; # A tibble: 120 x 3</span></a>
<a class="sourceLine" id="cb299-4" title="4"><span class="co">#&gt;   month year  unemploy</span></a>
<a class="sourceLine" id="cb299-5" title="5"><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb299-6" title="6"><span class="co">#&gt; 1     1 2006      7064</span></a>
<a class="sourceLine" id="cb299-7" title="7"><span class="co">#&gt; 2     2 2006      7184</span></a>
<a class="sourceLine" id="cb299-8" title="8"><span class="co">#&gt; 3     3 2006      7072</span></a>
<a class="sourceLine" id="cb299-9" title="9"><span class="co">#&gt; 4     4 2006      7120</span></a>
<a class="sourceLine" id="cb299-10" title="10"><span class="co">#&gt; 5     5 2006      6980</span></a>
<a class="sourceLine" id="cb299-11" title="11"><span class="co">#&gt; 6     6 2006      7001</span></a>
<a class="sourceLine" id="cb299-12" title="12"><span class="co">#&gt; # … with 114 more rows</span></a></code></pre></div>
<p>为了让数据更好用，我们还可以增加两个额外的参数：</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb300-1" title="1">economics_<span class="dv">2</span> &lt;-<span class="st"> </span>ec2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb300-2" title="2"><span class="st">            </span><span class="kw">gather</span>(<span class="dt">key =</span> year,<span class="dt">value =</span> unemploy,<span class="st">`</span><span class="dt">2006</span><span class="st">`</span><span class="op">:</span><span class="st">`</span><span class="dt">2015</span><span class="st">`</span>,<span class="dt">convert =</span> T,<span class="dt">na.rm =</span> T)</a></code></pre></div>
<p><code>convert = TRUE</code>将键列<code>year</code>变量从字符串转换为数值型（在练习里会谈到为什么<code>year</code>变成了字符串），<code>na.rm = TRUE</code>则可以自动移除没有值的月份（其实这个确实并不是数据的丢失，而只是因为那个时间还有到而已）。</p>
<p>以上数据整理好之后，就很容易用<code>ggplot2</code>作的。如我们可以关注长期趋势，或者查看季节性变化：</p>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb301-1" title="1"><span class="co">## x轴为季度</span></a>
<a class="sourceLine" id="cb301-2" title="2"><span class="kw">ggplot</span>(economics_<span class="dv">2</span>,<span class="kw">aes</span>(<span class="dt">x=</span>(year<span class="op">+</span>(month<span class="dv">-1</span>)<span class="op">/</span><span class="dv">12</span>),<span class="dt">y=</span>unemploy))<span class="op">+</span></a>
<a class="sourceLine" id="cb301-3" title="3"><span class="st">  </span><span class="kw">geom_line</span>()</a></code></pre></div>
<p><img src="tidyr_files/figure-html/unnamed-chunk-14-1.svg" width="80%" /></p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb302-1" title="1"><span class="kw">ggplot</span>(economics_<span class="dv">2</span>,<span class="kw">aes</span>(month,unemploy))<span class="op">+</span></a>
<a class="sourceLine" id="cb302-2" title="2"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> year,<span class="dt">color =</span> <span class="kw">factor</span>(year)),<span class="dt">size =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="tidyr_files/figure-html/unnamed-chunk-15-1.svg" width="80%" /></p>
</div>
<div id="spread" class="section level3">
<h3><span class="header-section-number">6.2.2</span> <code>spread()</code></h3>
<p><code>spread()</code>函数是<code>gather()</code>的逆运算，当某个变量的值实际上是其他变量的名字，就需要将数据集化长为宽，也可以说这种“错误”的表现形式是一个观测分散到了多行中（an observation is scattered across multiple rows）。例如<code>table2()</code>:</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb303-1" title="1">table2</a>
<a class="sourceLine" id="cb303-2" title="2"><span class="co">#&gt; # A tibble: 12 x 4</span></a>
<a class="sourceLine" id="cb303-3" title="3"><span class="co">#&gt;   country      year type           count</span></a>
<a class="sourceLine" id="cb303-4" title="4"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb303-5" title="5"><span class="co">#&gt; 1 Afghanistan  1999 cases            745</span></a>
<a class="sourceLine" id="cb303-6" title="6"><span class="co">#&gt; 2 Afghanistan  1999 population  19987071</span></a>
<a class="sourceLine" id="cb303-7" title="7"><span class="co">#&gt; 3 Afghanistan  2000 cases           2666</span></a>
<a class="sourceLine" id="cb303-8" title="8"><span class="co">#&gt; 4 Afghanistan  2000 population  20595360</span></a>
<a class="sourceLine" id="cb303-9" title="9"><span class="co">#&gt; 5 Brazil       1999 cases          37737</span></a>
<a class="sourceLine" id="cb303-10" title="10"><span class="co">#&gt; 6 Brazil       1999 population 172006362</span></a>
<a class="sourceLine" id="cb303-11" title="11"><span class="co">#&gt; # … with 6 more rows</span></a></code></pre></div>
<p>例如，前两列结合起来，才能得到对1999年阿富汗在<code>cases</code>和<code>population</code>两个变量上的观测。</p>
<p>在<code>spread()</code>中，你只需要指定两个参数（除了<code>data</code>以外），<code>key</code>和<code>value</code>，这里分别是<code>type</code>和<code>count</code>:</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb304-1" title="1">table2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb304-2" title="2"><span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> type,<span class="dt">value =</span> count)</a>
<a class="sourceLine" id="cb304-3" title="3"><span class="co">#&gt; # A tibble: 6 x 4</span></a>
<a class="sourceLine" id="cb304-4" title="4"><span class="co">#&gt;   country      year  cases population</span></a>
<a class="sourceLine" id="cb304-5" title="5"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt;  &lt;int&gt;      &lt;int&gt;</span></a>
<a class="sourceLine" id="cb304-6" title="6"><span class="co">#&gt; 1 Afghanistan  1999    745   19987071</span></a>
<a class="sourceLine" id="cb304-7" title="7"><span class="co">#&gt; 2 Afghanistan  2000   2666   20595360</span></a>
<a class="sourceLine" id="cb304-8" title="8"><span class="co">#&gt; 3 Brazil       1999  37737  172006362</span></a>
<a class="sourceLine" id="cb304-9" title="9"><span class="co">#&gt; 4 Brazil       2000  80488  174504898</span></a>
<a class="sourceLine" id="cb304-10" title="10"><span class="co">#&gt; 5 China        1999 212258 1272915272</span></a>
<a class="sourceLine" id="cb304-11" title="11"><span class="co">#&gt; 6 China        2000 213766 1280428583</span></a></code></pre></div>
<p>观察<code>table2</code>经过扩散的结果，不难看出<code>spread(key,value)</code>其实是构造透视表的过程。<code>key</code>列将被用作列字段，<code>value</code>列被用作透视表中的值字段，其他列将被当做行字段。</p>
<p>变换的图示：<br />
<img src="images/14.png" /></p>
</div>
<div id="练习-12" class="section level3">
<h3><span class="header-section-number">6.2.3</span> 练习</h3>
<blockquote>
<ol style="list-style-type: decimal">
<li>在下面的例子中，研究为什么<code>spread()</code>和<code>gather()</code>不是完美对称的。</li>
</ol>
</blockquote>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb305-1" title="1">(stocks &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb305-2" title="2">  <span class="dt">year =</span> <span class="kw">c</span>(<span class="dv">2015</span>, <span class="dv">2015</span>, <span class="dv">2016</span>, <span class="dv">2016</span>),</a>
<a class="sourceLine" id="cb305-3" title="3">  <span class="dt">half =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb305-4" title="4">  <span class="dt">return =</span> <span class="kw">c</span>(<span class="fl">1.88</span>, <span class="fl">0.59</span>, <span class="fl">0.92</span>, <span class="fl">0.17</span>)</a>
<a class="sourceLine" id="cb305-5" title="5">))</a>
<a class="sourceLine" id="cb305-6" title="6"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb305-7" title="7"><span class="co">#&gt;    year  half return</span></a>
<a class="sourceLine" id="cb305-8" title="8"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb305-9" title="9"><span class="co">#&gt; 1  2015     1   1.88</span></a>
<a class="sourceLine" id="cb305-10" title="10"><span class="co">#&gt; 2  2015     2   0.59</span></a>
<a class="sourceLine" id="cb305-11" title="11"><span class="co">#&gt; 3  2016     1   0.92</span></a>
<a class="sourceLine" id="cb305-12" title="12"><span class="co">#&gt; 4  2016     2   0.17</span></a>
<a class="sourceLine" id="cb305-13" title="13">stocks <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb305-14" title="14"><span class="st">  </span><span class="kw">spread</span>(year, return) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb305-15" title="15"><span class="st">  </span><span class="kw">gather</span>(<span class="st">`</span><span class="dt">2015</span><span class="st">`</span><span class="op">:</span><span class="st">`</span><span class="dt">2016</span><span class="st">`</span>, <span class="dt">key =</span> <span class="st">&quot;year&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;return&quot;</span>)</a>
<a class="sourceLine" id="cb305-16" title="16"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb305-17" title="17"><span class="co">#&gt;    half year  return</span></a>
<a class="sourceLine" id="cb305-18" title="18"><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb305-19" title="19"><span class="co">#&gt; 1     1 2015    1.88</span></a>
<a class="sourceLine" id="cb305-20" title="20"><span class="co">#&gt; 2     2 2015    0.59</span></a>
<a class="sourceLine" id="cb305-21" title="21"><span class="co">#&gt; 3     1 2016    0.92</span></a>
<a class="sourceLine" id="cb305-22" title="22"><span class="co">#&gt; 4     2 2016    0.17</span></a></code></pre></div>
<p>先后使用<code>spread()</code>和<code>gather()</code>无法得到一个相同的数据集（除了列的顺序）是因为，数据整理有时会丢失列的类型信息。当<code>spread()</code>将变量<code>year</code>的值<code>2015</code>和<code>2016</code>用作列的名字时，它们自然被转化为了字符串<code>"2015"</code>和<code>"2016"</code>；随后<code>gather()</code>把列名用作键列<code>year</code>的值，从而<code>year</code>自然变成了一个字符向量。</p>
<p>如果想要复原这个数据集，可以在<code>gather()</code>中使用<code>convert = T</code>，不过这时返回的数据类型是R经过猜测的结果，并不总保证和原数据一致，数据整理带来的不可避免的信息损耗。</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb306-1" title="1">stocks <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb306-2" title="2"><span class="st">  </span><span class="kw">spread</span>(year, return) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb306-3" title="3"><span class="st">  </span><span class="kw">gather</span>(<span class="st">`</span><span class="dt">2015</span><span class="st">`</span><span class="op">:</span><span class="st">`</span><span class="dt">2016</span><span class="st">`</span>, <span class="dt">key =</span> <span class="st">&quot;year&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;return&quot;</span>,<span class="dt">convert =</span> T)</a>
<a class="sourceLine" id="cb306-4" title="4"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb306-5" title="5"><span class="co">#&gt;    half  year return</span></a>
<a class="sourceLine" id="cb306-6" title="6"><span class="co">#&gt;   &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb306-7" title="7"><span class="co">#&gt; 1     1  2015   1.88</span></a>
<a class="sourceLine" id="cb306-8" title="8"><span class="co">#&gt; 2     2  2015   0.59</span></a>
<a class="sourceLine" id="cb306-9" title="9"><span class="co">#&gt; 3     1  2016   0.92</span></a>
<a class="sourceLine" id="cb306-10" title="10"><span class="co">#&gt; 4     2  2016   0.17</span></a></code></pre></div>
<blockquote>
<p>2.为什么下面的数据框不能应用<code>spread()</code>？可以添加一列解决这个问题吗？</p>
</blockquote>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb307-1" title="1">people &lt;-<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb307-2" title="2">  <span class="op">~</span>name, <span class="op">~</span>key, <span class="op">~</span>value,</a>
<a class="sourceLine" id="cb307-3" title="3">  <span class="st">&quot;Phillip Woods&quot;</span>, <span class="st">&quot;age&quot;</span>, <span class="dv">45</span>,</a>
<a class="sourceLine" id="cb307-4" title="4">  <span class="st">&quot;Phillip Woods&quot;</span>, <span class="st">&quot;height&quot;</span>, <span class="dv">186</span>,</a>
<a class="sourceLine" id="cb307-5" title="5">  <span class="st">&quot;Phillip Woods&quot;</span>, <span class="st">&quot;age&quot;</span>, <span class="dv">50</span>,</a>
<a class="sourceLine" id="cb307-6" title="6">  <span class="st">&quot;Jessica Cordero&quot;</span>, <span class="st">&quot;age&quot;</span>, <span class="dv">37</span>,</a>
<a class="sourceLine" id="cb307-7" title="7">  <span class="st">&quot;Jessica Cordero&quot;</span>, <span class="st">&quot;height&quot;</span>, <span class="dv">156</span></a>
<a class="sourceLine" id="cb307-8" title="8">)</a></code></pre></div>
<p>因为这个数据集里有两个对于“Phillip Woods”在变量<code>age</code>上年龄的观测，<code>spread()</code>就要把由<code>(Phillips Woods,age)</code>确定的单元格里“塞进两个值”。本质上因为<code>name</code>和<code>key</code>这两个变量上的值不能唯一确定一行，所以我们只要添加一列，让<code>name</code>、<code>key</code>和新列可以唯一确定一行即可：</p>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb308-1" title="1">people2 &lt;-<span class="st"> </span>people <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb308-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(name, key) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb308-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">obs =</span> <span class="kw">row_number</span>())</a>
<a class="sourceLine" id="cb308-4" title="4"></a>
<a class="sourceLine" id="cb308-5" title="5">people2</a>
<a class="sourceLine" id="cb308-6" title="6"><span class="co">#&gt; # A tibble: 5 x 4</span></a>
<a class="sourceLine" id="cb308-7" title="7"><span class="co">#&gt; # Groups:   name, key [4]</span></a>
<a class="sourceLine" id="cb308-8" title="8"><span class="co">#&gt;   name            key    value   obs</span></a>
<a class="sourceLine" id="cb308-9" title="9"><span class="co">#&gt;   &lt;chr&gt;           &lt;chr&gt;  &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb308-10" title="10"><span class="co">#&gt; 1 Phillip Woods   age       45     1</span></a>
<a class="sourceLine" id="cb308-11" title="11"><span class="co">#&gt; 2 Phillip Woods   height   186     1</span></a>
<a class="sourceLine" id="cb308-12" title="12"><span class="co">#&gt; 3 Phillip Woods   age       50     2</span></a>
<a class="sourceLine" id="cb308-13" title="13"><span class="co">#&gt; 4 Jessica Cordero age       37     1</span></a>
<a class="sourceLine" id="cb308-14" title="14"><span class="co">#&gt; 5 Jessica Cordero height   156     1</span></a>
<a class="sourceLine" id="cb308-15" title="15"></a>
<a class="sourceLine" id="cb308-16" title="16"><span class="kw">spread</span>(people2,key,value)</a>
<a class="sourceLine" id="cb308-17" title="17"><span class="co">#&gt; # A tibble: 3 x 4</span></a>
<a class="sourceLine" id="cb308-18" title="18"><span class="co">#&gt; # Groups:   name [2]</span></a>
<a class="sourceLine" id="cb308-19" title="19"><span class="co">#&gt;   name              obs   age height</span></a>
<a class="sourceLine" id="cb308-20" title="20"><span class="co">#&gt;   &lt;chr&gt;           &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb308-21" title="21"><span class="co">#&gt; 1 Jessica Cordero     1    37    156</span></a>
<a class="sourceLine" id="cb308-22" title="22"><span class="co">#&gt; 2 Phillip Woods       1    45    186</span></a>
<a class="sourceLine" id="cb308-23" title="23"><span class="co">#&gt; 3 Phillip Woods       2    50     NA</span></a></code></pre></div>
</div>
</div>
<div id="separate和untie" class="section level2">
<h2><span class="header-section-number">6.3</span> <code>separate()</code>和<code>untie()</code></h2>
<p><code>spread()</code>函数和<code>gather()</code>函数可以帮你解决数据中的变量放错了位置的问题。而<code>separate()</code>和<code>untie()</code>函数则是为了解决以下问题：多个变量挤在了同一列中，或者一个变量分散到了不同列中。</p>
<div id="separate" class="section level3">
<h3><span class="header-section-number">6.3.1</span> <code>separate()</code></h3>
<p>现在我们知道了如何用<code>spread()</code>和<code>gather()</code>将<code>table2</code>和<code>table4</code>整理为tidy data，现在要学会如何用<code>separate()</code>处理<code>table3</code>了：</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb309-1" title="1">table3</a>
<a class="sourceLine" id="cb309-2" title="2"><span class="co">#&gt; # A tibble: 6 x 3</span></a>
<a class="sourceLine" id="cb309-3" title="3"><span class="co">#&gt;   country      year rate             </span></a>
<a class="sourceLine" id="cb309-4" title="4"><span class="co">#&gt; * &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;            </span></a>
<a class="sourceLine" id="cb309-5" title="5"><span class="co">#&gt; 1 Afghanistan  1999 745/19987071     </span></a>
<a class="sourceLine" id="cb309-6" title="6"><span class="co">#&gt; 2 Afghanistan  2000 2666/20595360    </span></a>
<a class="sourceLine" id="cb309-7" title="7"><span class="co">#&gt; 3 Brazil       1999 37737/172006362  </span></a>
<a class="sourceLine" id="cb309-8" title="8"><span class="co">#&gt; 4 Brazil       2000 80488/174504898  </span></a>
<a class="sourceLine" id="cb309-9" title="9"><span class="co">#&gt; 5 China        1999 212258/1272915272</span></a>
<a class="sourceLine" id="cb309-10" title="10"><span class="co">#&gt; 6 China        2000 213766/1280428583</span></a></code></pre></div>
<p>在<code>table3</code>中，<code>rate</code>同时包含了<code>cases</code>和<code>population</code>两个变量，我们需要把它拆分(separate)为两列，<code>separate()</code>函数可以将这一混杂的列拆分成多个变量，它包含以下四个主要参数：</p>
<ul>
<li><code>data</code>: 需要调整的数据框<br />
</li>
<li><code>col</code>: 需要进行拆分的列的列名<br />
</li>
<li><code>into</code>: 拆分后新生成变量的列名，格式为字符串向量<br />
</li>
<li><code>sep</code>: 对如何拆分原变量的描述，其可以是正则表达式，如<code>_</code>表示通过下划线拆分，或<code>[^a-z]</code>表示通过任意非字符字母拆分，或一个指定位置的整数。默认情况下，<code>sep</code>将认定一个非字符字母进行划分</li>
</ul>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb310-1" title="1"><span class="co">## 这个例子里，sep不是必需的</span></a>
<a class="sourceLine" id="cb310-2" title="2">table3 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb310-3" title="3"><span class="st">  </span><span class="kw">separate</span>(<span class="dt">col =</span> rate,<span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;cases&quot;</span>,<span class="st">&quot;population&quot;</span>))</a>
<a class="sourceLine" id="cb310-4" title="4"><span class="co">#&gt; # A tibble: 6 x 4</span></a>
<a class="sourceLine" id="cb310-5" title="5"><span class="co">#&gt;   country      year cases  population</span></a>
<a class="sourceLine" id="cb310-6" title="6"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;     </span></a>
<a class="sourceLine" id="cb310-7" title="7"><span class="co">#&gt; 1 Afghanistan  1999 745    19987071  </span></a>
<a class="sourceLine" id="cb310-8" title="8"><span class="co">#&gt; 2 Afghanistan  2000 2666   20595360  </span></a>
<a class="sourceLine" id="cb310-9" title="9"><span class="co">#&gt; 3 Brazil       1999 37737  172006362 </span></a>
<a class="sourceLine" id="cb310-10" title="10"><span class="co">#&gt; 4 Brazil       2000 80488  174504898 </span></a>
<a class="sourceLine" id="cb310-11" title="11"><span class="co">#&gt; 5 China        1999 212258 1272915272</span></a>
<a class="sourceLine" id="cb310-12" title="12"><span class="co">#&gt; 6 China        2000 213766 1280428583</span></a></code></pre></div>
<p>整理的图示：<br />
<img src="images/15.png" /></p>
<p>注意，以上输出的tibble中，<code>cases</code>和<code>population</code>被设定为字符串类型，使用<code>convert = T</code>将其转换为数值变量</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb311-1" title="1">table3 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb311-2" title="2"><span class="st">  </span><span class="kw">separate</span>(rate, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;cases&quot;</span>, <span class="st">&quot;population&quot;</span>), <span class="dt">convert =</span> T)</a>
<a class="sourceLine" id="cb311-3" title="3"><span class="co">#&gt; # A tibble: 6 x 4</span></a>
<a class="sourceLine" id="cb311-4" title="4"><span class="co">#&gt;   country      year  cases population</span></a>
<a class="sourceLine" id="cb311-5" title="5"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt;  &lt;int&gt;      &lt;int&gt;</span></a>
<a class="sourceLine" id="cb311-6" title="6"><span class="co">#&gt; 1 Afghanistan  1999    745   19987071</span></a>
<a class="sourceLine" id="cb311-7" title="7"><span class="co">#&gt; 2 Afghanistan  2000   2666   20595360</span></a>
<a class="sourceLine" id="cb311-8" title="8"><span class="co">#&gt; 3 Brazil       1999  37737  172006362</span></a>
<a class="sourceLine" id="cb311-9" title="9"><span class="co">#&gt; 4 Brazil       2000  80488  174504898</span></a>
<a class="sourceLine" id="cb311-10" title="10"><span class="co">#&gt; 5 China        1999 212258 1272915272</span></a>
<a class="sourceLine" id="cb311-11" title="11"><span class="co">#&gt; 6 China        2000 213766 1280428583</span></a></code></pre></div>
</div>
<div id="unite" class="section level3">
<h3><span class="header-section-number">6.3.2</span> <code>unite()</code></h3>
<p><code>unite()</code>函数是<code>separate()</code>的逆运算——它可以将多列合并为一列。尽管它不太常用，但是知道这个函数还是很重要的。</p>
<p>在<code>table5</code>中，原来的<code>year</code>变量被拆成了两个列，可以用<code>unite()</code>，只需要指定要合并后的列名和要合并的列。默认情况下，新列中将用<code>_</code>分隔符</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb312-1" title="1">table5</a>
<a class="sourceLine" id="cb312-2" title="2"><span class="co">#&gt; # A tibble: 6 x 4</span></a>
<a class="sourceLine" id="cb312-3" title="3"><span class="co">#&gt;   country     century year  rate             </span></a>
<a class="sourceLine" id="cb312-4" title="4"><span class="co">#&gt; * &lt;chr&gt;       &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;            </span></a>
<a class="sourceLine" id="cb312-5" title="5"><span class="co">#&gt; 1 Afghanistan 19      99    745/19987071     </span></a>
<a class="sourceLine" id="cb312-6" title="6"><span class="co">#&gt; 2 Afghanistan 20      00    2666/20595360    </span></a>
<a class="sourceLine" id="cb312-7" title="7"><span class="co">#&gt; 3 Brazil      19      99    37737/172006362  </span></a>
<a class="sourceLine" id="cb312-8" title="8"><span class="co">#&gt; 4 Brazil      20      00    80488/174504898  </span></a>
<a class="sourceLine" id="cb312-9" title="9"><span class="co">#&gt; 5 China       19      99    212258/1272915272</span></a>
<a class="sourceLine" id="cb312-10" title="10"><span class="co">#&gt; 6 China       20      00    213766/1280428583</span></a>
<a class="sourceLine" id="cb312-11" title="11"><span class="kw">unite</span>(table5,<span class="dt">col =</span> year, century,year)</a>
<a class="sourceLine" id="cb312-12" title="12"><span class="co">#&gt; # A tibble: 6 x 3</span></a>
<a class="sourceLine" id="cb312-13" title="13"><span class="co">#&gt;   country     year  rate             </span></a>
<a class="sourceLine" id="cb312-14" title="14"><span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;            </span></a>
<a class="sourceLine" id="cb312-15" title="15"><span class="co">#&gt; 1 Afghanistan 19_99 745/19987071     </span></a>
<a class="sourceLine" id="cb312-16" title="16"><span class="co">#&gt; 2 Afghanistan 20_00 2666/20595360    </span></a>
<a class="sourceLine" id="cb312-17" title="17"><span class="co">#&gt; 3 Brazil      19_99 37737/172006362  </span></a>
<a class="sourceLine" id="cb312-18" title="18"><span class="co">#&gt; 4 Brazil      20_00 80488/174504898  </span></a>
<a class="sourceLine" id="cb312-19" title="19"><span class="co">#&gt; 5 China       19_99 212258/1272915272</span></a>
<a class="sourceLine" id="cb312-20" title="20"><span class="co">#&gt; 6 China       20_00 213766/1280428583</span></a></code></pre></div>
<p>设置<code>sep</code>参数可以取消分隔符：</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb313-1" title="1"><span class="kw">unite</span>(table5,<span class="dt">col =</span> year,century,year,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb313-2" title="2"><span class="co">#&gt; # A tibble: 6 x 3</span></a>
<a class="sourceLine" id="cb313-3" title="3"><span class="co">#&gt;   country     year  rate             </span></a>
<a class="sourceLine" id="cb313-4" title="4"><span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;            </span></a>
<a class="sourceLine" id="cb313-5" title="5"><span class="co">#&gt; 1 Afghanistan 1999  745/19987071     </span></a>
<a class="sourceLine" id="cb313-6" title="6"><span class="co">#&gt; 2 Afghanistan 2000  2666/20595360    </span></a>
<a class="sourceLine" id="cb313-7" title="7"><span class="co">#&gt; 3 Brazil      1999  37737/172006362  </span></a>
<a class="sourceLine" id="cb313-8" title="8"><span class="co">#&gt; 4 Brazil      2000  80488/174504898  </span></a>
<a class="sourceLine" id="cb313-9" title="9"><span class="co">#&gt; 5 China       1999  212258/1272915272</span></a>
<a class="sourceLine" id="cb313-10" title="10"><span class="co">#&gt; 6 China       2000  213766/1280428583</span></a></code></pre></div>
<p>整理的图示：
<img src="images/16.png" /></p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb314-1" title="1">table6 &lt;-<span class="st"> </span><span class="kw">unite</span>(table5,<span class="dt">col =</span> year,century,year,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb314-2" title="2">table5</a>
<a class="sourceLine" id="cb314-3" title="3"><span class="co">#&gt; # A tibble: 6 x 4</span></a>
<a class="sourceLine" id="cb314-4" title="4"><span class="co">#&gt;   country     century year  rate             </span></a>
<a class="sourceLine" id="cb314-5" title="5"><span class="co">#&gt; * &lt;chr&gt;       &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;            </span></a>
<a class="sourceLine" id="cb314-6" title="6"><span class="co">#&gt; 1 Afghanistan 19      99    745/19987071     </span></a>
<a class="sourceLine" id="cb314-7" title="7"><span class="co">#&gt; 2 Afghanistan 20      00    2666/20595360    </span></a>
<a class="sourceLine" id="cb314-8" title="8"><span class="co">#&gt; 3 Brazil      19      99    37737/172006362  </span></a>
<a class="sourceLine" id="cb314-9" title="9"><span class="co">#&gt; 4 Brazil      20      00    80488/174504898  </span></a>
<a class="sourceLine" id="cb314-10" title="10"><span class="co">#&gt; 5 China       19      99    212258/1272915272</span></a>
<a class="sourceLine" id="cb314-11" title="11"><span class="co">#&gt; 6 China       20      00    213766/1280428583</span></a></code></pre></div>
</div>
<div id="练习-13" class="section level3">
<h3><span class="header-section-number">6.3.3</span> 练习</h3>
<blockquote>
<ol style="list-style-type: decimal">
<li><code>separate()</code>中的<code>extra</code>和<code>fill</code>参数的作用是什么？用下面两个数据框进行实验：</li>
</ol>
</blockquote>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb315-1" title="1"><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="st">&quot;a,b,c&quot;</span>, <span class="st">&quot;d,e,f,g&quot;</span>, <span class="st">&quot;h,i,j&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb315-2" title="2"><span class="st">  </span><span class="kw">separate</span>(x, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;one&quot;</span>, <span class="st">&quot;two&quot;</span>, <span class="st">&quot;three&quot;</span>))</a>
<a class="sourceLine" id="cb315-3" title="3"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb315-4" title="4"><span class="co">#&gt;   one   two   three</span></a>
<a class="sourceLine" id="cb315-5" title="5"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></a>
<a class="sourceLine" id="cb315-6" title="6"><span class="co">#&gt; 1 a     b     c    </span></a>
<a class="sourceLine" id="cb315-7" title="7"><span class="co">#&gt; 2 d     e     f    </span></a>
<a class="sourceLine" id="cb315-8" title="8"><span class="co">#&gt; 3 h     i     j</span></a>
<a class="sourceLine" id="cb315-9" title="9"><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="st">&quot;a,b,c&quot;</span>, <span class="st">&quot;d,e&quot;</span>, <span class="st">&quot;f,g,i&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb315-10" title="10"><span class="st">  </span><span class="kw">separate</span>(x, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;one&quot;</span>, <span class="st">&quot;two&quot;</span>, <span class="st">&quot;three&quot;</span>))</a>
<a class="sourceLine" id="cb315-11" title="11"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb315-12" title="12"><span class="co">#&gt;   one   two   three</span></a>
<a class="sourceLine" id="cb315-13" title="13"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></a>
<a class="sourceLine" id="cb315-14" title="14"><span class="co">#&gt; 1 a     b     c    </span></a>
<a class="sourceLine" id="cb315-15" title="15"><span class="co">#&gt; 2 d     e     &lt;NA&gt; </span></a>
<a class="sourceLine" id="cb315-16" title="16"><span class="co">#&gt; 3 f     g     i</span></a></code></pre></div>
<p><code>extra</code>用来告诉<code>separate()</code>函数如何处理分列过程中多出来的元素(too many pieces，即<code>into</code>指定的列数小于原数据中某行可分的元素个数)，<code>fill</code>负责如何处理元素不够的情况(not enough pieces，即<code>into</code>指定的列数大于原数据中某行可分的元素个数)。默认情况下，<code>extra = "drop"</code>，<code>separate()</code>将丢弃多余的元素，并生成一条警告信息：</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb316-1" title="1"><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="st">&quot;a,b,c&quot;</span>, <span class="st">&quot;d,e,f,g&quot;</span>, <span class="st">&quot;h,i,j&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb316-2" title="2"><span class="st">  </span><span class="kw">separate</span>(x, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;one&quot;</span>, <span class="st">&quot;two&quot;</span>, <span class="st">&quot;three&quot;</span>),<span class="dt">extra =</span> <span class="st">&quot;drop&quot;</span>)</a>
<a class="sourceLine" id="cb316-3" title="3"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb316-4" title="4"><span class="co">#&gt;   one   two   three</span></a>
<a class="sourceLine" id="cb316-5" title="5"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></a>
<a class="sourceLine" id="cb316-6" title="6"><span class="co">#&gt; 1 a     b     c    </span></a>
<a class="sourceLine" id="cb316-7" title="7"><span class="co">#&gt; 2 d     e     f    </span></a>
<a class="sourceLine" id="cb316-8" title="8"><span class="co">#&gt; 3 h     i     j</span></a></code></pre></div>
<p><code>extra = "merge"</code>将把多余的元素和前一个元素当做一个整体：</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb317-1" title="1"><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="st">&quot;a,b,c&quot;</span>, <span class="st">&quot;d,e,f,g&quot;</span>, <span class="st">&quot;h,i,j&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb317-2" title="2"><span class="st">  </span><span class="kw">separate</span>(x, <span class="kw">c</span>(<span class="st">&quot;one&quot;</span>, <span class="st">&quot;two&quot;</span>, <span class="st">&quot;three&quot;</span>),<span class="dt">extra =</span> <span class="st">&quot;merge&quot;</span>)</a>
<a class="sourceLine" id="cb317-3" title="3"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb317-4" title="4"><span class="co">#&gt;   one   two   three</span></a>
<a class="sourceLine" id="cb317-5" title="5"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></a>
<a class="sourceLine" id="cb317-6" title="6"><span class="co">#&gt; 1 a     b     c    </span></a>
<a class="sourceLine" id="cb317-7" title="7"><span class="co">#&gt; 2 d     e     f,g  </span></a>
<a class="sourceLine" id="cb317-8" title="8"><span class="co">#&gt; 3 h     i     j</span></a></code></pre></div>
<p>对于元素过少的情况，默认的<code>fill = "warn"</code>将会用<code>NA</code>进行填充，但会生成一条警告。<code>fill = "right"</code>会尽可能让靠左的列拥有可用的元素，用<code>NA</code>填充右边的列；<code>fill = "left"</code>正好相反。这两种手动设置都不会产生<code>warning</code>:</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb318-1" title="1"><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="st">&quot;a,b,c&quot;</span>, <span class="st">&quot;d,e,&quot;</span>, <span class="st">&quot;h,i,j&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb318-2" title="2"><span class="st">  </span><span class="kw">separate</span>(x, <span class="kw">c</span>(<span class="st">&quot;one&quot;</span>, <span class="st">&quot;two&quot;</span>, <span class="st">&quot;three&quot;</span>),<span class="dt">fill =</span> <span class="st">&quot;left&quot;</span>)</a>
<a class="sourceLine" id="cb318-3" title="3"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb318-4" title="4"><span class="co">#&gt;   one   two   three</span></a>
<a class="sourceLine" id="cb318-5" title="5"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></a>
<a class="sourceLine" id="cb318-6" title="6"><span class="co">#&gt; 1 a     b     c    </span></a>
<a class="sourceLine" id="cb318-7" title="7"><span class="co">#&gt; 2 d     e     &quot;&quot;   </span></a>
<a class="sourceLine" id="cb318-8" title="8"><span class="co">#&gt; 3 h     i     j</span></a>
<a class="sourceLine" id="cb318-9" title="9"><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="st">&quot;a,b,c&quot;</span>, <span class="st">&quot;d,e,&quot;</span>, <span class="st">&quot;h,i,j&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb318-10" title="10"><span class="st">  </span><span class="kw">separate</span>(x, <span class="kw">c</span>(<span class="st">&quot;one&quot;</span>, <span class="st">&quot;two&quot;</span>, <span class="st">&quot;three&quot;</span>),<span class="dt">fill =</span> <span class="st">&quot;right&quot;</span>)</a>
<a class="sourceLine" id="cb318-11" title="11"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb318-12" title="12"><span class="co">#&gt;   one   two   three</span></a>
<a class="sourceLine" id="cb318-13" title="13"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></a>
<a class="sourceLine" id="cb318-14" title="14"><span class="co">#&gt; 1 a     b     c    </span></a>
<a class="sourceLine" id="cb318-15" title="15"><span class="co">#&gt; 2 d     e     &quot;&quot;   </span></a>
<a class="sourceLine" id="cb318-16" title="16"><span class="co">#&gt; 3 h     i     j</span></a></code></pre></div>
<blockquote>
<p>2.<code>unite()</code>和<code>separate()</code>均有一个<code>remove</code>参数，它的作用是什么？</p>
</blockquote>
<p><code>remove</code>控制是否在<code>unite()</code>或<code>separate()</code>输出的数据框中保留原来的列，默认<code>remove = T</code>。如果想保留原来未合并/分离的格列，可以设置<code>remove = F</code></p>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb319-1" title="1">table5 </a>
<a class="sourceLine" id="cb319-2" title="2"><span class="co">#&gt; # A tibble: 6 x 4</span></a>
<a class="sourceLine" id="cb319-3" title="3"><span class="co">#&gt;   country     century year  rate             </span></a>
<a class="sourceLine" id="cb319-4" title="4"><span class="co">#&gt; * &lt;chr&gt;       &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;            </span></a>
<a class="sourceLine" id="cb319-5" title="5"><span class="co">#&gt; 1 Afghanistan 19      99    745/19987071     </span></a>
<a class="sourceLine" id="cb319-6" title="6"><span class="co">#&gt; 2 Afghanistan 20      00    2666/20595360    </span></a>
<a class="sourceLine" id="cb319-7" title="7"><span class="co">#&gt; 3 Brazil      19      99    37737/172006362  </span></a>
<a class="sourceLine" id="cb319-8" title="8"><span class="co">#&gt; 4 Brazil      20      00    80488/174504898  </span></a>
<a class="sourceLine" id="cb319-9" title="9"><span class="co">#&gt; 5 China       19      99    212258/1272915272</span></a>
<a class="sourceLine" id="cb319-10" title="10"><span class="co">#&gt; 6 China       20      00    213766/1280428583</span></a>
<a class="sourceLine" id="cb319-11" title="11"></a>
<a class="sourceLine" id="cb319-12" title="12">table5 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unite</span>(<span class="dt">col =</span> year_unite,century,year,<span class="dt">sep =</span> <span class="st">&quot;&quot;</span>,<span class="dt">remove =</span> F)</a>
<a class="sourceLine" id="cb319-13" title="13"><span class="co">#&gt; # A tibble: 6 x 5</span></a>
<a class="sourceLine" id="cb319-14" title="14"><span class="co">#&gt;   country     year_unite century year  rate             </span></a>
<a class="sourceLine" id="cb319-15" title="15"><span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt;      &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;            </span></a>
<a class="sourceLine" id="cb319-16" title="16"><span class="co">#&gt; 1 Afghanistan 1999       19      99    745/19987071     </span></a>
<a class="sourceLine" id="cb319-17" title="17"><span class="co">#&gt; 2 Afghanistan 2000       20      00    2666/20595360    </span></a>
<a class="sourceLine" id="cb319-18" title="18"><span class="co">#&gt; 3 Brazil      1999       19      99    37737/172006362  </span></a>
<a class="sourceLine" id="cb319-19" title="19"><span class="co">#&gt; 4 Brazil      2000       20      00    80488/174504898  </span></a>
<a class="sourceLine" id="cb319-20" title="20"><span class="co">#&gt; 5 China       1999       19      99    212258/1272915272</span></a>
<a class="sourceLine" id="cb319-21" title="21"><span class="co">#&gt; 6 China       2000       20      00    213766/1280428583</span></a></code></pre></div>
<blockquote>
<ol start="3" style="list-style-type: decimal">
<li>探究<code>tidyr</code>中一个与<code>separate()</code>类似的函数<code>extract()</code>的用法</li>
</ol>
</blockquote>
<p><code>separate()</code>函数的分列操作是基于参数<code>sep</code>的，无论是给<code>sep</code>传入字符串指定分隔符，还是用数值指定分隔的位置，<code>separate()</code>必须要有一个分隔符才能正常运作（可以把<code>sep = n</code>看做第n个和第n+1个元素之间的一个空白分隔符）</p>
<p><code>extract()</code>用一个正则表达式<code>regex</code>描述要分隔的列<code>col</code>中存在的模式，在正则表达式中的每个子表达式(用<code>()</code>定义)将被认为是<code>into</code>中的一个元素，因此，<code>extract()</code>比<code>separate()</code>使用起来更加广泛灵活。例如下面的数据集无法用<code>separate()</code>分列，因为无法用一个各行的分隔符(的位置)不一样，但用<code>extract()</code>中的正则表达式就很简单：</p>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb320-1" title="1"></a>
<a class="sourceLine" id="cb320-2" title="2"><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="st">&quot;X1&quot;</span>, <span class="st">&quot;X20&quot;</span>, <span class="st">&quot;AA11&quot;</span>, <span class="st">&quot;AA2&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb320-3" title="3"><span class="st">  </span><span class="kw">extract</span>(x, <span class="kw">c</span>(<span class="st">&quot;variable&quot;</span>, <span class="st">&quot;id&quot;</span>), <span class="dt">regex =</span> <span class="st">&quot;([A-Z]+)([0-9]+)&quot;</span>)</a>
<a class="sourceLine" id="cb320-4" title="4"><span class="co">#&gt; # A tibble: 4 x 2</span></a>
<a class="sourceLine" id="cb320-5" title="5"><span class="co">#&gt;   variable id   </span></a>
<a class="sourceLine" id="cb320-6" title="6"><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;</span></a>
<a class="sourceLine" id="cb320-7" title="7"><span class="co">#&gt; 1 X        1    </span></a>
<a class="sourceLine" id="cb320-8" title="8"><span class="co">#&gt; 2 X        20   </span></a>
<a class="sourceLine" id="cb320-9" title="9"><span class="co">#&gt; 3 AA       11   </span></a>
<a class="sourceLine" id="cb320-10" title="10"><span class="co">#&gt; 4 AA       2</span></a></code></pre></div>
<p>适当设计<code>regex</code>，实现的效果可以与设置<code>sep</code>完全一致：</p>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb321-1" title="1"><span class="co"># example with separators</span></a>
<a class="sourceLine" id="cb321-2" title="2"><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="st">&quot;X_1&quot;</span>, <span class="st">&quot;X_2&quot;</span>, <span class="st">&quot;AA_1&quot;</span>, <span class="st">&quot;AA_2&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb321-3" title="3"><span class="st">  </span><span class="kw">extract</span>(x, <span class="kw">c</span>(<span class="st">&quot;variable&quot;</span>, <span class="st">&quot;id&quot;</span>), <span class="dt">regex =</span> <span class="st">&quot;([A-Z]+)_([0-9])&quot;</span>)</a>
<a class="sourceLine" id="cb321-4" title="4"><span class="co">#&gt; # A tibble: 4 x 2</span></a>
<a class="sourceLine" id="cb321-5" title="5"><span class="co">#&gt;   variable id   </span></a>
<a class="sourceLine" id="cb321-6" title="6"><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;</span></a>
<a class="sourceLine" id="cb321-7" title="7"><span class="co">#&gt; 1 X        1    </span></a>
<a class="sourceLine" id="cb321-8" title="8"><span class="co">#&gt; 2 X        2    </span></a>
<a class="sourceLine" id="cb321-9" title="9"><span class="co">#&gt; 3 AA       1    </span></a>
<a class="sourceLine" id="cb321-10" title="10"><span class="co">#&gt; 4 AA       2</span></a>
<a class="sourceLine" id="cb321-11" title="11"></a>
<a class="sourceLine" id="cb321-12" title="12"><span class="co"># example with position</span></a>
<a class="sourceLine" id="cb321-13" title="13"><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="st">&quot;X1&quot;</span>, <span class="st">&quot;X2&quot;</span>, <span class="st">&quot;Y1&quot;</span>, <span class="st">&quot;Y2&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb321-14" title="14"><span class="st">  </span><span class="kw">extract</span>(x, <span class="kw">c</span>(<span class="st">&quot;variable&quot;</span>, <span class="st">&quot;id&quot;</span>), <span class="dt">regex =</span> <span class="st">&quot;([A-Z])([0-9])&quot;</span>)</a>
<a class="sourceLine" id="cb321-15" title="15"><span class="co">#&gt; # A tibble: 4 x 2</span></a>
<a class="sourceLine" id="cb321-16" title="16"><span class="co">#&gt;   variable id   </span></a>
<a class="sourceLine" id="cb321-17" title="17"><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;</span></a>
<a class="sourceLine" id="cb321-18" title="18"><span class="co">#&gt; 1 X        1    </span></a>
<a class="sourceLine" id="cb321-19" title="19"><span class="co">#&gt; 2 X        2    </span></a>
<a class="sourceLine" id="cb321-20" title="20"><span class="co">#&gt; 3 Y        1    </span></a>
<a class="sourceLine" id="cb321-21" title="21"><span class="co">#&gt; 4 Y        2</span></a></code></pre></div>
</div>
</div>
<div id="tidyr-missing" class="section level2">
<h2><span class="header-section-number">6.4</span> 缺失值</h2>
<p>数据整理改变了数据的呈现方式，随之而来的一个话题便是缺失值。通常当我们泛泛地使用“缺失值 (missing value)” 这个名词的时候，其实是指以下两种“缺失”方式中的某一种：</p>
<ul>
<li>显式缺失(Explicitly missing): 在数据中用<code>NA</code>标识</li>
<li>隐式缺失(Implicitly missing): 未出现在数据中的值</li>
</ul>
<p><code>R for Data Science</code>中对这两种缺失的概括：</p>
<blockquote>
<p>An explicit missing value is the presence of an absence; an implicit missing value is the absence of a presence.</p>
</blockquote>
<p>通过一个简单的数据框区分两种数据缺失的方式：</p>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb322-1" title="1">stocks &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb322-2" title="2">  <span class="dt">year   =</span> <span class="kw">c</span>(<span class="dv">2015</span>, <span class="dv">2015</span>, <span class="dv">2015</span>, <span class="dv">2015</span>, <span class="dv">2016</span>, <span class="dv">2016</span>, <span class="dv">2016</span>),</a>
<a class="sourceLine" id="cb322-3" title="3">  <span class="dt">qtr    =</span> <span class="kw">c</span>(   <span class="dv">1</span>,    <span class="dv">2</span>,    <span class="dv">3</span>,    <span class="dv">4</span>,    <span class="dv">2</span>,    <span class="dv">3</span>,    <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb322-4" title="4">  <span class="dt">return =</span> <span class="kw">c</span>(<span class="fl">1.88</span>, <span class="fl">0.59</span>, <span class="fl">0.35</span>,   <span class="ot">NA</span>, <span class="fl">0.92</span>, <span class="fl">0.17</span>, <span class="fl">2.66</span>)</a>
<a class="sourceLine" id="cb322-5" title="5">)</a>
<a class="sourceLine" id="cb322-6" title="6"></a>
<a class="sourceLine" id="cb322-7" title="7">stocks</a>
<a class="sourceLine" id="cb322-8" title="8"><span class="co">#&gt; # A tibble: 7 x 3</span></a>
<a class="sourceLine" id="cb322-9" title="9"><span class="co">#&gt;    year   qtr return</span></a>
<a class="sourceLine" id="cb322-10" title="10"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb322-11" title="11"><span class="co">#&gt; 1  2015     1   1.88</span></a>
<a class="sourceLine" id="cb322-12" title="12"><span class="co">#&gt; 2  2015     2   0.59</span></a>
<a class="sourceLine" id="cb322-13" title="13"><span class="co">#&gt; 3  2015     3   0.35</span></a>
<a class="sourceLine" id="cb322-14" title="14"><span class="co">#&gt; 4  2015     4  NA   </span></a>
<a class="sourceLine" id="cb322-15" title="15"><span class="co">#&gt; 5  2016     2   0.92</span></a>
<a class="sourceLine" id="cb322-16" title="16"><span class="co">#&gt; 6  2016     3   0.17</span></a>
<a class="sourceLine" id="cb322-17" title="17"><span class="co">#&gt; # … with 1 more row</span></a></code></pre></div>
<p>我们很容易找到<code>stocks</code>第四条观测在变量<code>return</code>上的一个<code>NA</code>，因为它是显式缺失的。另一个隐式缺失的值是<code>(year = 2016,qtr = 1)</code>对应的观测，它没有出现在数据集中。</p>
<p>数据呈现方式上的改变可以将隐式缺失值变成显式。比如，用<code>spread()</code>函数构造以<code>year</code>为行字段，以<code>return</code>为值的透视表,这样就会产生一个属于水平<code>(year = 2016,qtr = 1)</code>的单元格：</p>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb323-1" title="1">stocks <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb323-2" title="2"><span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> year,<span class="dt">value =</span> return)</a>
<a class="sourceLine" id="cb323-3" title="3"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb323-4" title="4"><span class="co">#&gt;     qtr `2015` `2016`</span></a>
<a class="sourceLine" id="cb323-5" title="5"><span class="co">#&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb323-6" title="6"><span class="co">#&gt; 1     1   1.88  NA   </span></a>
<a class="sourceLine" id="cb323-7" title="7"><span class="co">#&gt; 2     2   0.59   0.92</span></a>
<a class="sourceLine" id="cb323-8" title="8"><span class="co">#&gt; 3     3   0.35   0.17</span></a>
<a class="sourceLine" id="cb323-9" title="9"><span class="co">#&gt; 4     4  NA      2.66</span></a></code></pre></div>
<p>现在，再使用<code>gather()</code>不能得到原来的数据框，因为将比原来多出一行显示的缺失值</p>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb324-1" title="1">stocks <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb324-2" title="2"><span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> year,<span class="dt">value =</span> return) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb324-3" title="3"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> year,<span class="dt">value =</span> return,<span class="st">`</span><span class="dt">2015</span><span class="st">`</span><span class="op">:</span><span class="st">`</span><span class="dt">2016</span><span class="st">`</span>)</a>
<a class="sourceLine" id="cb324-4" title="4"><span class="co">#&gt; # A tibble: 8 x 3</span></a>
<a class="sourceLine" id="cb324-5" title="5"><span class="co">#&gt;     qtr year  return</span></a>
<a class="sourceLine" id="cb324-6" title="6"><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb324-7" title="7"><span class="co">#&gt; 1     1 2015    1.88</span></a>
<a class="sourceLine" id="cb324-8" title="8"><span class="co">#&gt; 2     2 2015    0.59</span></a>
<a class="sourceLine" id="cb324-9" title="9"><span class="co">#&gt; 3     3 2015    0.35</span></a>
<a class="sourceLine" id="cb324-10" title="10"><span class="co">#&gt; 4     4 2015   NA   </span></a>
<a class="sourceLine" id="cb324-11" title="11"><span class="co">#&gt; 5     1 2016   NA   </span></a>
<a class="sourceLine" id="cb324-12" title="12"><span class="co">#&gt; 6     2 2016    0.92</span></a>
<a class="sourceLine" id="cb324-13" title="13"><span class="co">#&gt; # … with 2 more rows</span></a></code></pre></div>
<p>如果研究者认为这些缺失值是无足轻重的,<code>na.rm = T</code>将在<code>gather()</code>生成的数据框中移除含有缺失值的行：</p>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb325-1" title="1"><span class="co">## 现在输出数据框比原来少一行</span></a>
<a class="sourceLine" id="cb325-2" title="2">stocks <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb325-3" title="3"><span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> year,<span class="dt">value =</span> return) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb325-4" title="4"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> year,<span class="dt">value =</span> return,<span class="st">`</span><span class="dt">2015</span><span class="st">`</span><span class="op">:</span><span class="st">`</span><span class="dt">2016</span><span class="st">`</span>,<span class="dt">na.rm =</span> T)</a>
<a class="sourceLine" id="cb325-5" title="5"><span class="co">#&gt; # A tibble: 6 x 3</span></a>
<a class="sourceLine" id="cb325-6" title="6"><span class="co">#&gt;     qtr year  return</span></a>
<a class="sourceLine" id="cb325-7" title="7"><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb325-8" title="8"><span class="co">#&gt; 1     1 2015    1.88</span></a>
<a class="sourceLine" id="cb325-9" title="9"><span class="co">#&gt; 2     2 2015    0.59</span></a>
<a class="sourceLine" id="cb325-10" title="10"><span class="co">#&gt; 3     3 2015    0.35</span></a>
<a class="sourceLine" id="cb325-11" title="11"><span class="co">#&gt; 4     2 2016    0.92</span></a>
<a class="sourceLine" id="cb325-12" title="12"><span class="co">#&gt; 5     3 2016    0.17</span></a>
<a class="sourceLine" id="cb325-13" title="13"><span class="co">#&gt; 6     4 2016    2.66</span></a></code></pre></div>
<p>另一个用于处理确实值的有用工具是<code>complete()</code>函数，它将生成一个指定列集合里面所有的水平组合，并自动将原本隐式的缺失值填充为<code>NA</code></p>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb326-1" title="1">stocks <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb326-2" title="2"><span class="st">  </span><span class="kw">complete</span>(year, qtr)</a>
<a class="sourceLine" id="cb326-3" title="3"><span class="co">#&gt; # A tibble: 8 x 3</span></a>
<a class="sourceLine" id="cb326-4" title="4"><span class="co">#&gt;    year   qtr return</span></a>
<a class="sourceLine" id="cb326-5" title="5"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb326-6" title="6"><span class="co">#&gt; 1  2015     1   1.88</span></a>
<a class="sourceLine" id="cb326-7" title="7"><span class="co">#&gt; 2  2015     2   0.59</span></a>
<a class="sourceLine" id="cb326-8" title="8"><span class="co">#&gt; 3  2015     3   0.35</span></a>
<a class="sourceLine" id="cb326-9" title="9"><span class="co">#&gt; 4  2015     4  NA   </span></a>
<a class="sourceLine" id="cb326-10" title="10"><span class="co">#&gt; 5  2016     1  NA   </span></a>
<a class="sourceLine" id="cb326-11" title="11"><span class="co">#&gt; 6  2016     2   0.92</span></a>
<a class="sourceLine" id="cb326-12" title="12"><span class="co">#&gt; # … with 2 more rows</span></a></code></pre></div>
<p><code>fill()</code> 函数专门用来填充缺失值,它接受一些需要填充缺失值的列，并用最近的值调换 <code>NA</code>，<code>.direction</code> 参数控制用填充的方向：<code>direction = “up"</code> 将由下往上填充，<code>NA</code> 将被替换为它下面那一列的值；<code>direction = "donw"</code> 反之</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb327-1" title="1">treatment &lt;-<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb327-2" title="2">  <span class="op">~</span><span class="st"> </span>person,           <span class="op">~</span><span class="st"> </span>treatment, <span class="op">~</span>response,</a>
<a class="sourceLine" id="cb327-3" title="3">  <span class="st">&quot;Derrick Whitmore&quot;</span>, <span class="dv">1</span>,           <span class="dv">7</span>,</a>
<a class="sourceLine" id="cb327-4" title="4">  <span class="ot">NA</span>,                 <span class="dv">2</span>,           <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb327-5" title="5">  <span class="ot">NA</span>,                 <span class="dv">3</span>,           <span class="dv">9</span>,</a>
<a class="sourceLine" id="cb327-6" title="6">  <span class="st">&quot;Katherine Burke&quot;</span>,  <span class="dv">1</span>,           <span class="dv">4</span></a>
<a class="sourceLine" id="cb327-7" title="7">)</a>
<a class="sourceLine" id="cb327-8" title="8"></a>
<a class="sourceLine" id="cb327-9" title="9">treatment <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb327-10" title="10"><span class="st">  </span><span class="kw">fill</span>(person,<span class="dt">.direction =</span> <span class="st">&quot;up&quot;</span>)</a>
<a class="sourceLine" id="cb327-11" title="11"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb327-12" title="12"><span class="co">#&gt;   person           treatment response</span></a>
<a class="sourceLine" id="cb327-13" title="13"><span class="co">#&gt;   &lt;chr&gt;                &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb327-14" title="14"><span class="co">#&gt; 1 Derrick Whitmore         1        7</span></a>
<a class="sourceLine" id="cb327-15" title="15"><span class="co">#&gt; 2 Katherine Burke          2       10</span></a>
<a class="sourceLine" id="cb327-16" title="16"><span class="co">#&gt; 3 Katherine Burke          3        9</span></a>
<a class="sourceLine" id="cb327-17" title="17"><span class="co">#&gt; 4 Katherine Burke          1        4</span></a>
<a class="sourceLine" id="cb327-18" title="18"></a>
<a class="sourceLine" id="cb327-19" title="19">treatment <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb327-20" title="20"><span class="st">  </span><span class="kw">fill</span>(person,<span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>)</a>
<a class="sourceLine" id="cb327-21" title="21"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb327-22" title="22"><span class="co">#&gt;   person           treatment response</span></a>
<a class="sourceLine" id="cb327-23" title="23"><span class="co">#&gt;   &lt;chr&gt;                &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb327-24" title="24"><span class="co">#&gt; 1 Derrick Whitmore         1        7</span></a>
<a class="sourceLine" id="cb327-25" title="25"><span class="co">#&gt; 2 Derrick Whitmore         2       10</span></a>
<a class="sourceLine" id="cb327-26" title="26"><span class="co">#&gt; 3 Derrick Whitmore         3        9</span></a>
<a class="sourceLine" id="cb327-27" title="27"><span class="co">#&gt; 4 Katherine Burke          1        4</span></a></code></pre></div>
</div>
<div id="case-study" class="section level2">
<h2><span class="header-section-number">6.5</span> Case Study</h2>
<p>To finish off the chapter, let’s pull together everything you’ve learned to tackle a realistic data tidying problem. The <code>tidyr::who</code> dataset contains tuberculosis (TB) cases broken down by year, country, age, gender, and diagnosis method. The data comes from the <em>2014 World Health Organization Global Tuberculosis Report</em>, available at <a href="http://www.who.int/tb/country/data/download/en/">http://www.who.int/tb/country/data/download/en/</a>.</p>
<p>There’s a wealth of epidemiological information in this dataset, but it’s challenging to work with the data in the form that it’s provided:</p>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb328-1" title="1">who</a>
<a class="sourceLine" id="cb328-2" title="2"><span class="co">#&gt; # A tibble: 7,240 x 60</span></a>
<a class="sourceLine" id="cb328-3" title="3"><span class="co">#&gt;   country iso2  iso3   year new_sp_m014 new_sp_m1524 new_sp_m2534 new_sp_m3544</span></a>
<a class="sourceLine" id="cb328-4" title="4"><span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;int&gt;       &lt;int&gt;        &lt;int&gt;        &lt;int&gt;        &lt;int&gt;</span></a>
<a class="sourceLine" id="cb328-5" title="5"><span class="co">#&gt; 1 Afghan… AF    AFG    1980          NA           NA           NA           NA</span></a>
<a class="sourceLine" id="cb328-6" title="6"><span class="co">#&gt; 2 Afghan… AF    AFG    1981          NA           NA           NA           NA</span></a>
<a class="sourceLine" id="cb328-7" title="7"><span class="co">#&gt; 3 Afghan… AF    AFG    1982          NA           NA           NA           NA</span></a>
<a class="sourceLine" id="cb328-8" title="8"><span class="co">#&gt; 4 Afghan… AF    AFG    1983          NA           NA           NA           NA</span></a>
<a class="sourceLine" id="cb328-9" title="9"><span class="co">#&gt; 5 Afghan… AF    AFG    1984          NA           NA           NA           NA</span></a>
<a class="sourceLine" id="cb328-10" title="10"><span class="co">#&gt; 6 Afghan… AF    AFG    1985          NA           NA           NA           NA</span></a>
<a class="sourceLine" id="cb328-11" title="11"><span class="co">#&gt; # … with 7,234 more rows, and 52 more variables: new_sp_m4554 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-12" title="12"><span class="co">#&gt; #   new_sp_m5564 &lt;int&gt;, new_sp_m65 &lt;int&gt;, new_sp_f014 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-13" title="13"><span class="co">#&gt; #   new_sp_f1524 &lt;int&gt;, new_sp_f2534 &lt;int&gt;, new_sp_f3544 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-14" title="14"><span class="co">#&gt; #   new_sp_f4554 &lt;int&gt;, new_sp_f5564 &lt;int&gt;, new_sp_f65 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-15" title="15"><span class="co">#&gt; #   new_sn_m014 &lt;int&gt;, new_sn_m1524 &lt;int&gt;, new_sn_m2534 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-16" title="16"><span class="co">#&gt; #   new_sn_m3544 &lt;int&gt;, new_sn_m4554 &lt;int&gt;, new_sn_m5564 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-17" title="17"><span class="co">#&gt; #   new_sn_m65 &lt;int&gt;, new_sn_f014 &lt;int&gt;, new_sn_f1524 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-18" title="18"><span class="co">#&gt; #   new_sn_f2534 &lt;int&gt;, new_sn_f3544 &lt;int&gt;, new_sn_f4554 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-19" title="19"><span class="co">#&gt; #   new_sn_f5564 &lt;int&gt;, new_sn_f65 &lt;int&gt;, new_ep_m014 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-20" title="20"><span class="co">#&gt; #   new_ep_m1524 &lt;int&gt;, new_ep_m2534 &lt;int&gt;, new_ep_m3544 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-21" title="21"><span class="co">#&gt; #   new_ep_m4554 &lt;int&gt;, new_ep_m5564 &lt;int&gt;, new_ep_m65 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-22" title="22"><span class="co">#&gt; #   new_ep_f014 &lt;int&gt;, new_ep_f1524 &lt;int&gt;, new_ep_f2534 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-23" title="23"><span class="co">#&gt; #   new_ep_f3544 &lt;int&gt;, new_ep_f4554 &lt;int&gt;, new_ep_f5564 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-24" title="24"><span class="co">#&gt; #   new_ep_f65 &lt;int&gt;, newrel_m014 &lt;int&gt;, newrel_m1524 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-25" title="25"><span class="co">#&gt; #   newrel_m2534 &lt;int&gt;, newrel_m3544 &lt;int&gt;, newrel_m4554 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-26" title="26"><span class="co">#&gt; #   newrel_m5564 &lt;int&gt;, newrel_m65 &lt;int&gt;, newrel_f014 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-27" title="27"><span class="co">#&gt; #   newrel_f1524 &lt;int&gt;, newrel_f2534 &lt;int&gt;, newrel_f3544 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb328-28" title="28"><span class="co">#&gt; #   newrel_f4554 &lt;int&gt;, newrel_f5564 &lt;int&gt;, newrel_f65 &lt;int&gt;</span></a></code></pre></div>
<p>This is a very typical real-life example dataset. It contains redundant columns, odd variable codes, and many missing values. In short, <code>who</code> is messy, and we’ll need multiple steps to tidy it. Like <code>dplyr</code>, <code>tidyr</code> is designed so that each function does one thing well. That means in real-life situations you’ll usually need to string together multiple verbs into a pipeline.</p>
<p>The best place to start is almost always to gather together the columns that are not variables. Let’s have a look at what we’ve got:</p>
<ul>
<li>It looks like <code>country</code>, <code>iso2</code>, and <code>iso3</code> are three variables that redundantly specify the country.<br />
</li>
<li><code>year</code> is also a variable<br />
</li>
<li>We don’t know what all the other columns are yet, but given the structure in the variable names (e.g. <code>new_sp_m014</code>, <code>new_ep_m014</code>, <code>new_ep_f014</code>) these are likely to be values, not variables.</li>
</ul>
<p>So we need to gather together all the columns from <code>new_sp_m014</code> to <code>newrel_f65</code>. We don’t know what those values represent yet, so we’ll give them the generic name <code>"key"</code>. We know the cells represent the count of cases, so we’ll use the variable <code>cases</code>. There are a lot of missing values in the current representation, so for now we’ll use <code>na.rm</code> just so we can focus on the values that are present.</p>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb329-1" title="1">who1 &lt;-<span class="st"> </span>who <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb329-2" title="2"><span class="st">  </span><span class="kw">gather</span>(key,<span class="dt">value =</span> <span class="st">&quot;cases&quot;</span>,<span class="op">-</span>country<span class="op">:-</span>year,<span class="dt">na.rm =</span> T)</a>
<a class="sourceLine" id="cb329-3" title="3"></a>
<a class="sourceLine" id="cb329-4" title="4">who1</a>
<a class="sourceLine" id="cb329-5" title="5"><span class="co">#&gt; # A tibble: 76,046 x 6</span></a>
<a class="sourceLine" id="cb329-6" title="6"><span class="co">#&gt;   country     iso2  iso3   year key         cases</span></a>
<a class="sourceLine" id="cb329-7" title="7"><span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt;       &lt;int&gt;</span></a>
<a class="sourceLine" id="cb329-8" title="8"><span class="co">#&gt; 1 Afghanistan AF    AFG    1997 new_sp_m014     0</span></a>
<a class="sourceLine" id="cb329-9" title="9"><span class="co">#&gt; 2 Afghanistan AF    AFG    1998 new_sp_m014    30</span></a>
<a class="sourceLine" id="cb329-10" title="10"><span class="co">#&gt; 3 Afghanistan AF    AFG    1999 new_sp_m014     8</span></a>
<a class="sourceLine" id="cb329-11" title="11"><span class="co">#&gt; 4 Afghanistan AF    AFG    2000 new_sp_m014    52</span></a>
<a class="sourceLine" id="cb329-12" title="12"><span class="co">#&gt; 5 Afghanistan AF    AFG    2001 new_sp_m014   129</span></a>
<a class="sourceLine" id="cb329-13" title="13"><span class="co">#&gt; 6 Afghanistan AF    AFG    2002 new_sp_m014    90</span></a>
<a class="sourceLine" id="cb329-14" title="14"><span class="co">#&gt; # … with 7.604e+04 more rows</span></a></code></pre></div>
<p>We can get some hint of the structure of the values in the new <code>key</code> column by counting them:</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb330-1" title="1">who1 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb330-2" title="2"><span class="st">  </span><span class="kw">count</span>(key)</a>
<a class="sourceLine" id="cb330-3" title="3"><span class="co">#&gt; # A tibble: 56 x 2</span></a>
<a class="sourceLine" id="cb330-4" title="4"><span class="co">#&gt;   key              n</span></a>
<a class="sourceLine" id="cb330-5" title="5"><span class="co">#&gt;   &lt;chr&gt;        &lt;int&gt;</span></a>
<a class="sourceLine" id="cb330-6" title="6"><span class="co">#&gt; 1 new_ep_f014   1032</span></a>
<a class="sourceLine" id="cb330-7" title="7"><span class="co">#&gt; 2 new_ep_f1524  1021</span></a>
<a class="sourceLine" id="cb330-8" title="8"><span class="co">#&gt; 3 new_ep_f2534  1021</span></a>
<a class="sourceLine" id="cb330-9" title="9"><span class="co">#&gt; 4 new_ep_f3544  1021</span></a>
<a class="sourceLine" id="cb330-10" title="10"><span class="co">#&gt; 5 new_ep_f4554  1017</span></a>
<a class="sourceLine" id="cb330-11" title="11"><span class="co">#&gt; 6 new_ep_f5564  1017</span></a>
<a class="sourceLine" id="cb330-12" title="12"><span class="co">#&gt; # … with 50 more rows</span></a></code></pre></div>
<p>You might be able to parse this out by yourself with a little thought and some experimentation, but luckily we have the data dictionary handy. It tells us:<br />
1. The first three letters of each column denote whether the column contains new or old cases of TB. <strong>In this dataset, each column contains new cases</strong>.<br />
2. The next two letters describe the type of TB:
* <code>rel</code> stands for cases of relapse<br />
* <code>ep</code> stands for cases of extrapulmonary TB<br />
* <code>sn</code> stands for cases of pulmonary TB that could not be diagnosed by a pulmonary smear (smear negative)<br />
* <code>sp</code> stands for cases of pulmonary TB that could be diagnosed be a pulmonary smear (smear positive)</p>
<ol start="3" style="list-style-type: decimal">
<li><p>The sixth letter gives the sex of TB patients. The dataset groups cases by males (<code>m</code>) and females (<code>f</code>).</p></li>
<li><p>The remaining numbers gives the age group. The dataset groups cases into seven age groups:<br />
</p></li>
</ol>
<ul>
<li><code>014</code> = 0 – 14 years old<br />
</li>
<li><code>1524</code> = 15 – 24 years old<br />
</li>
<li><code>2534</code> = 25 – 34 years old<br />
</li>
<li><code>3544</code> = 35 – 44 years old<br />
</li>
<li><code>4554</code> = 45 – 54 years old<br />
</li>
<li><code>5564</code> = 55 – 64 years old<br />
</li>
<li><code>65</code> = 65 or older</li>
</ul>
<p>We need to make a minor fix to the format of the column names: unfortunately the names are slightly inconsistent because instead of <code>new_rel</code> we have <code>newrel</code> (it’s hard to spot this here but if you don’t fix it we’ll get errors in subsequent steps). You’ll learn about <code>str_replace()</code> in strings, but the basic idea is pretty simple: replace the characters “newrel” with “new_rel”. This makes all variable names consistent.</p>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb331-1" title="1">who2 &lt;-<span class="st"> </span>who1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb331-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">key =</span> stringr<span class="op">::</span><span class="kw">str_replace</span>(key, <span class="st">&quot;newrel&quot;</span>, <span class="st">&quot;new_rel&quot;</span>))</a>
<a class="sourceLine" id="cb331-3" title="3">who2</a>
<a class="sourceLine" id="cb331-4" title="4"><span class="co">#&gt; # A tibble: 76,046 x 6</span></a>
<a class="sourceLine" id="cb331-5" title="5"><span class="co">#&gt;   country     iso2  iso3   year key         cases</span></a>
<a class="sourceLine" id="cb331-6" title="6"><span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt;       &lt;int&gt;</span></a>
<a class="sourceLine" id="cb331-7" title="7"><span class="co">#&gt; 1 Afghanistan AF    AFG    1997 new_sp_m014     0</span></a>
<a class="sourceLine" id="cb331-8" title="8"><span class="co">#&gt; 2 Afghanistan AF    AFG    1998 new_sp_m014    30</span></a>
<a class="sourceLine" id="cb331-9" title="9"><span class="co">#&gt; 3 Afghanistan AF    AFG    1999 new_sp_m014     8</span></a>
<a class="sourceLine" id="cb331-10" title="10"><span class="co">#&gt; 4 Afghanistan AF    AFG    2000 new_sp_m014    52</span></a>
<a class="sourceLine" id="cb331-11" title="11"><span class="co">#&gt; 5 Afghanistan AF    AFG    2001 new_sp_m014   129</span></a>
<a class="sourceLine" id="cb331-12" title="12"><span class="co">#&gt; 6 Afghanistan AF    AFG    2002 new_sp_m014    90</span></a>
<a class="sourceLine" id="cb331-13" title="13"><span class="co">#&gt; # … with 7.604e+04 more rows</span></a></code></pre></div>
<p><strong>We can separate the values in each code with two passes of <code>separate()</code>. The first pass will split the codes at each underscore</strong>.</p>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb332-1" title="1">who3 &lt;-<span class="st"> </span>who2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb332-2" title="2"><span class="st">  </span><span class="kw">separate</span>(key, <span class="kw">c</span>(<span class="st">&quot;new&quot;</span>, <span class="st">&quot;type&quot;</span>, <span class="st">&quot;sexage&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)</a>
<a class="sourceLine" id="cb332-3" title="3">who3</a>
<a class="sourceLine" id="cb332-4" title="4"><span class="co">#&gt; # A tibble: 76,046 x 8</span></a>
<a class="sourceLine" id="cb332-5" title="5"><span class="co">#&gt;   country     iso2  iso3   year new   type  sexage cases</span></a>
<a class="sourceLine" id="cb332-6" title="6"><span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;int&gt;</span></a>
<a class="sourceLine" id="cb332-7" title="7"><span class="co">#&gt; 1 Afghanistan AF    AFG    1997 new   sp    m014       0</span></a>
<a class="sourceLine" id="cb332-8" title="8"><span class="co">#&gt; 2 Afghanistan AF    AFG    1998 new   sp    m014      30</span></a>
<a class="sourceLine" id="cb332-9" title="9"><span class="co">#&gt; 3 Afghanistan AF    AFG    1999 new   sp    m014       8</span></a>
<a class="sourceLine" id="cb332-10" title="10"><span class="co">#&gt; 4 Afghanistan AF    AFG    2000 new   sp    m014      52</span></a>
<a class="sourceLine" id="cb332-11" title="11"><span class="co">#&gt; 5 Afghanistan AF    AFG    2001 new   sp    m014     129</span></a>
<a class="sourceLine" id="cb332-12" title="12"><span class="co">#&gt; 6 Afghanistan AF    AFG    2002 new   sp    m014      90</span></a>
<a class="sourceLine" id="cb332-13" title="13"><span class="co">#&gt; # … with 7.604e+04 more rows</span></a></code></pre></div>
<p>Then we might as well drop the <code>new</code> column because it’s constant in this dataset. While we’re dropping columns, let’s also drop <code>iso2</code> and <code>iso3</code> since they’re redundant.</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb333-1" title="1">who3 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb333-2" title="2"><span class="st">  </span><span class="kw">count</span>(new)</a>
<a class="sourceLine" id="cb333-3" title="3"><span class="co">#&gt; # A tibble: 1 x 2</span></a>
<a class="sourceLine" id="cb333-4" title="4"><span class="co">#&gt;   new       n</span></a>
<a class="sourceLine" id="cb333-5" title="5"><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb333-6" title="6"><span class="co">#&gt; 1 new   76046</span></a>
<a class="sourceLine" id="cb333-7" title="7"></a>
<a class="sourceLine" id="cb333-8" title="8">who4 &lt;-<span class="st"> </span>who3 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb333-9" title="9"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>new, <span class="op">-</span>iso2, <span class="op">-</span>iso3)</a></code></pre></div>
<p>Next we’ll separate <code>sexage</code> into <code>sex</code> and <code>age</code> by splitting after the first character:</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb334-1" title="1">who5 &lt;-<span class="st"> </span>who4 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb334-2" title="2"><span class="st">  </span><span class="kw">separate</span>(sexage, <span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>, <span class="st">&quot;age&quot;</span>), <span class="dt">sep =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb334-3" title="3">who5</a>
<a class="sourceLine" id="cb334-4" title="4"><span class="co">#&gt; # A tibble: 76,046 x 6</span></a>
<a class="sourceLine" id="cb334-5" title="5"><span class="co">#&gt;   country      year type  sex   age   cases</span></a>
<a class="sourceLine" id="cb334-6" title="6"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb334-7" title="7"><span class="co">#&gt; 1 Afghanistan  1997 sp    m     014       0</span></a>
<a class="sourceLine" id="cb334-8" title="8"><span class="co">#&gt; 2 Afghanistan  1998 sp    m     014      30</span></a>
<a class="sourceLine" id="cb334-9" title="9"><span class="co">#&gt; 3 Afghanistan  1999 sp    m     014       8</span></a>
<a class="sourceLine" id="cb334-10" title="10"><span class="co">#&gt; 4 Afghanistan  2000 sp    m     014      52</span></a>
<a class="sourceLine" id="cb334-11" title="11"><span class="co">#&gt; 5 Afghanistan  2001 sp    m     014     129</span></a>
<a class="sourceLine" id="cb334-12" title="12"><span class="co">#&gt; 6 Afghanistan  2002 sp    m     014      90</span></a>
<a class="sourceLine" id="cb334-13" title="13"><span class="co">#&gt; # … with 7.604e+04 more rows</span></a></code></pre></div>
<p>The <code>who</code> dataset is now tidy!</p>
<p>I’ve shown you the code a piece at a time, assigning each interim result to a new variable. This typically isn’t how you’d work interactively. Instead, you’d gradually build up a complex pipe:</p>
<div class="sourceCode" id="cb335"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb335-1" title="1">who <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb335-2" title="2"><span class="st">  </span><span class="kw">gather</span>(key, value, new_sp_m014<span class="op">:</span>newrel_f65, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb335-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">key =</span> stringr<span class="op">::</span><span class="kw">str_replace</span>(key, <span class="st">&quot;newrel&quot;</span>, <span class="st">&quot;new_rel&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb335-4" title="4"><span class="st">  </span><span class="kw">separate</span>(key, <span class="kw">c</span>(<span class="st">&quot;new&quot;</span>, <span class="st">&quot;var&quot;</span>, <span class="st">&quot;sexage&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb335-5" title="5"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>new, <span class="op">-</span>iso2, <span class="op">-</span>iso3) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb335-6" title="6"><span class="st">  </span><span class="kw">separate</span>(sexage, <span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>, <span class="st">&quot;age&quot;</span>), <span class="dt">sep =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb335-7" title="7"><span class="co">#&gt; # A tibble: 76,046 x 6</span></a>
<a class="sourceLine" id="cb335-8" title="8"><span class="co">#&gt;   country      year var   sex   age   value</span></a>
<a class="sourceLine" id="cb335-9" title="9"><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb335-10" title="10"><span class="co">#&gt; 1 Afghanistan  1997 sp    m     014       0</span></a>
<a class="sourceLine" id="cb335-11" title="11"><span class="co">#&gt; 2 Afghanistan  1998 sp    m     014      30</span></a>
<a class="sourceLine" id="cb335-12" title="12"><span class="co">#&gt; 3 Afghanistan  1999 sp    m     014       8</span></a>
<a class="sourceLine" id="cb335-13" title="13"><span class="co">#&gt; 4 Afghanistan  2000 sp    m     014      52</span></a>
<a class="sourceLine" id="cb335-14" title="14"><span class="co">#&gt; 5 Afghanistan  2001 sp    m     014     129</span></a>
<a class="sourceLine" id="cb335-15" title="15"><span class="co">#&gt; 6 Afghanistan  2002 sp    m     014      90</span></a>
<a class="sourceLine" id="cb335-16" title="16"><span class="co">#&gt; # … with 7.604e+04 more rows</span></a></code></pre></div>
<div id="练习-14" class="section level3">
<h3><span class="header-section-number">6.5.1</span> 练习</h3>
<blockquote>
<ol style="list-style-type: decimal">
<li>在清理<code>who</code>数据框时，我们说<code>iso2</code>和<code>iso3</code>在有了<code>country</code>之后是冗余的，证明这一点</li>
</ol>
</blockquote>
<p>如果<code>iso2</code>和<code>iso3</code>相对于<code>country</code>是冗余的，则在数据集中对于变量<code>country</code>的每个值，仅有一个<code>iso2</code>和<code>iso3</code>的水平组合(<code>country</code>能唯一确定一条观测)。</p>
<p>这里要用到<code>distinct()</code>函数，它将返回数据框中某些列出现的的全部不重复的水平组合（注意<code>complete()</code>是”制造出“全部可能的水平组合），和<code>unique()</code>类似，但速度更快：</p>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb336-1" title="1">who6 &lt;-<span class="st"> </span>who <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb336-2" title="2"><span class="st">          </span><span class="kw">distinct</span>(country,iso2,iso3) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb336-3" title="3"><span class="st">          </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb336-4" title="4"><span class="st">          </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>())</a>
<a class="sourceLine" id="cb336-5" title="5"></a>
<a class="sourceLine" id="cb336-6" title="6">who6 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb336-7" title="7"><span class="st">  </span><span class="kw">filter</span>(n<span class="op">&gt;</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb336-8" title="8"><span class="co">#&gt; # A tibble: 0 x 2</span></a>
<a class="sourceLine" id="cb336-9" title="9"><span class="co">#&gt; # … with 2 variables: country &lt;chr&gt;, n &lt;int&gt;</span></a></code></pre></div>
</div>
</div>
<div id="non-tidy" class="section level2">
<h2><span class="header-section-number">6.6</span> 拓展：None-tidy data</h2>
<p>Before we continue on to other topics, it’s worth talking briefly about non-tidy data. Earlier in the chapter, I used the pejorative term “messy” to refer to non-tidy data. That’s an oversimplification: there are lots of useful and well-founded data structures that are not tidy data. There are two main reasons to use other data structures:</p>
<ul>
<li>Alternative representations may have substantial performance or space advantages.<br />
</li>
<li>Specialised fields have evolved their own conventions for storing data that may be quite different to the conventions of tidy data.</li>
</ul>
<p>Either of these reasons means you’ll need something other than a tibble (or data frame). If your data does fit naturally into a rectangular structure composed of observations and variables, I think tidy data should be your default choice. But there are good reasons to use other structures; tidy data is not the only way.</p>
<p>If you’d like to learn more about non-tidy data, I’d highly recommend this thoughtful blog post by Jeff Leek: <a href="http://simplystatistics.org/2016/02/17/non-tidy-data/">http://simplystatistics.org/2016/02/17/non-tidy-data/</a></p>
</div>
<div id="tidyr-1.0.0" class="section level2">
<h2><span class="header-section-number">6.7</span> <code>tidyr 1.0.0</code></h2>
<p>tidyr 于 2019 年 9 月 14 日发布了版本 1.0.0，有以下重大变化：</p>
<ul>
<li><p>New <code>pivot_longer()</code> and <code>pivot_wider()</code> provide improved tools for reshaping, superceding <code>spread()</code> and <code>gather()</code>.</p></li>
<li><p>New <code>unnest_auto()</code>, <code>unnest_longer()</code>, <code>unnest_wider()</code>, and <code>hoist()</code> provide new tools for rectangling, converting deeply nested lists into tidy data frames.</p></li>
<li><p><code>nest()</code> and <code>unnest()</code> have been changed to match an emerging principle for the design of <code>...</code> interfaces. Four new functions (<code>pack()</code>/<code>unpack()</code>, and <code>chop()</code>/<code>unchop()</code>) reveal that nesting is the combination of two simpler steps.</p></li>
<li><p>New <code>expand_grid()</code>, a variant of <code>base::expand.grid()</code>. This is a useful function to know about, but also serves as a good reason to discuss the important role that <code>vctrs</code> plays behind the scenes. You shouldn’t ever have to learn about <code>vctrs</code>, but it brings improvements to consistency and performance.</p></li>
</ul>
<p>参考 <a href="https://www.tidyverse.org/articles/2019/09/tidyr-1-0-0/" class="uri">https://www.tidyverse.org/articles/2019/09/tidyr-1-0-0/</a></p>
<p>文档：</p>
<ul>
<li><a href="https://tidyr.tidyverse.org/articles/pivot.html"><code>vignette("pivot")</code></a>、<a href="https://tidyr.tidyverse.org/articles/rectangle.html"><code>vignette("rectangle")</code></a> and <a href="https://tidyr.tidyverse.org/articles/nest.html"><code>vignette("nest")</code></a> provide detailed documentation and case studies of pivotting, rectangling, and nesting respectively.<br />
</li>
<li><a href="https://tidyr.tidyverse.org/articles/in-packages.html"><code>vignette("in-packages")</code></a> provides best practices for using tidyr inside another package, and detailed advice on working with multiple versions of tidyr if an interface change has affected your package.</li>
</ul>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb337-1" title="1"><span class="kw">library</span>(tidyverse)</a></code></pre></div>
<div id="pivot_longer-和-pivot_wider" class="section level3">
<h3><span class="header-section-number">6.7.1</span> <code>pivot_longer</code> 和 <code>pivot_wider</code></h3>
<p><code>pivot_longer()</code> 和 <code>pivot_wider()</code> 分别对应原来的 <code>gather()</code> 和 <code>spread()</code>，如今 API 更加容易理解：</p>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb338-1" title="1"><span class="kw">pivot_longer</span>(data, </a>
<a class="sourceLine" id="cb338-2" title="2">  cols,</a>
<a class="sourceLine" id="cb338-3" title="3">  <span class="dt">names_to =</span> <span class="st">&quot;name&quot;</span>,</a>
<a class="sourceLine" id="cb338-4" title="4">  <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>,)</a></code></pre></div>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb339-1" title="1"><span class="kw">pivot_wider</span>(data, </a>
<a class="sourceLine" id="cb339-2" title="2">  <span class="dt">names_from =</span> name,</a>
<a class="sourceLine" id="cb339-3" title="3">  <span class="dt">values_from =</span> value)</a></code></pre></div>
<div id="pivot_longer" class="section level4">
<h4><span class="header-section-number">6.7.1.1</span> <code>pivot_longer()</code></h4>
<p>基本用法：</p>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb340-1" title="1">relig_income</a>
<a class="sourceLine" id="cb340-2" title="2"><span class="co">#&gt; # A tibble: 18 x 11</span></a>
<a class="sourceLine" id="cb340-3" title="3"><span class="co">#&gt;   religion `&lt;$10k` `$10-20k` `$20-30k` `$30-40k` `$40-50k` `$50-75k` `$75-100k`</span></a>
<a class="sourceLine" id="cb340-4" title="4"><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb340-5" title="5"><span class="co">#&gt; 1 Agnostic      27        34        60        81        76       137        122</span></a>
<a class="sourceLine" id="cb340-6" title="6"><span class="co">#&gt; 2 Atheist       12        27        37        52        35        70         73</span></a>
<a class="sourceLine" id="cb340-7" title="7"><span class="co">#&gt; 3 Buddhist      27        21        30        34        33        58         62</span></a>
<a class="sourceLine" id="cb340-8" title="8"><span class="co">#&gt; 4 Catholic     418       617       732       670       638      1116        949</span></a>
<a class="sourceLine" id="cb340-9" title="9"><span class="co">#&gt; 5 Don’t k…      15        14        15        11        10        35         21</span></a>
<a class="sourceLine" id="cb340-10" title="10"><span class="co">#&gt; 6 Evangel…     575       869      1064       982       881      1486        949</span></a>
<a class="sourceLine" id="cb340-11" title="11"><span class="co">#&gt; # … with 12 more rows, and 3 more variables: `$100-150k` &lt;dbl&gt;, `&gt;150k` &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb340-12" title="12"><span class="co">#&gt; #   `Don&#39;t know/refused` &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb340-13" title="13"></a>
<a class="sourceLine" id="cb340-14" title="14">relig_income <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb340-15" title="15"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="dt">cols =</span> <span class="op">-</span>religion, </a>
<a class="sourceLine" id="cb340-16" title="16">               <span class="dt">names_to =</span> <span class="st">&quot;income&quot;</span>,</a>
<a class="sourceLine" id="cb340-17" title="17">               <span class="dt">values_to =</span> <span class="st">&quot;count&quot;</span>)</a>
<a class="sourceLine" id="cb340-18" title="18"><span class="co">#&gt; # A tibble: 180 x 3</span></a>
<a class="sourceLine" id="cb340-19" title="19"><span class="co">#&gt;   religion income  count</span></a>
<a class="sourceLine" id="cb340-20" title="20"><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb340-21" title="21"><span class="co">#&gt; 1 Agnostic &lt;$10k      27</span></a>
<a class="sourceLine" id="cb340-22" title="22"><span class="co">#&gt; 2 Agnostic $10-20k    34</span></a>
<a class="sourceLine" id="cb340-23" title="23"><span class="co">#&gt; 3 Agnostic $20-30k    60</span></a>
<a class="sourceLine" id="cb340-24" title="24"><span class="co">#&gt; 4 Agnostic $30-40k    81</span></a>
<a class="sourceLine" id="cb340-25" title="25"><span class="co">#&gt; 5 Agnostic $40-50k    76</span></a>
<a class="sourceLine" id="cb340-26" title="26"><span class="co">#&gt; 6 Agnostic $50-75k   137</span></a>
<a class="sourceLine" id="cb340-27" title="27"><span class="co">#&gt; # … with 174 more rows</span></a></code></pre></div>
<p><code>names_to</code> 和 <code>values_to</code> 参数相当于原来 <code>gather()</code> 中的 <code>key</code> 和 <code>value</code>，其中 “键” 列的默认名称变为 “name”</p>
<hr />
<p><strong>Numeric data in column names</strong></p>
<p><code>pivot_longer()</code> 现在提供了 <code>names_ptype</code> 和 <code>values_ptypes</code> 两个参数调整数据集变长后键列和值列的数据类别。看一下 billboard 数据集：</p>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb341-1" title="1">billboard</a>
<a class="sourceLine" id="cb341-2" title="2"><span class="co">#&gt; # A tibble: 317 x 79</span></a>
<a class="sourceLine" id="cb341-3" title="3"><span class="co">#&gt;   artist track date.entered   wk1   wk2   wk3   wk4   wk5   wk6   wk7   wk8</span></a>
<a class="sourceLine" id="cb341-4" title="4"><span class="co">#&gt;   &lt;chr&gt;  &lt;chr&gt; &lt;date&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb341-5" title="5"><span class="co">#&gt; 1 2 Pac  Baby… 2000-02-26      87    82    72    77    87    94    99    NA</span></a>
<a class="sourceLine" id="cb341-6" title="6"><span class="co">#&gt; 2 2Ge+h… The … 2000-09-02      91    87    92    NA    NA    NA    NA    NA</span></a>
<a class="sourceLine" id="cb341-7" title="7"><span class="co">#&gt; 3 3 Doo… Kryp… 2000-04-08      81    70    68    67    66    57    54    53</span></a>
<a class="sourceLine" id="cb341-8" title="8"><span class="co">#&gt; 4 3 Doo… Loser 2000-10-21      76    76    72    69    67    65    55    59</span></a>
<a class="sourceLine" id="cb341-9" title="9"><span class="co">#&gt; 5 504 B… Wobb… 2000-04-15      57    34    25    17    17    31    36    49</span></a>
<a class="sourceLine" id="cb341-10" title="10"><span class="co">#&gt; 6 98^0   Give… 2000-08-19      51    39    34    26    26    19     2     2</span></a>
<a class="sourceLine" id="cb341-11" title="11"><span class="co">#&gt; # … with 311 more rows, and 68 more variables: wk9 &lt;dbl&gt;, wk10 &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb341-12" title="12"><span class="co">#&gt; #   wk11 &lt;dbl&gt;, wk12 &lt;dbl&gt;, wk13 &lt;dbl&gt;, wk14 &lt;dbl&gt;, wk15 &lt;dbl&gt;, wk16 &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb341-13" title="13"><span class="co">#&gt; #   wk17 &lt;dbl&gt;, wk18 &lt;dbl&gt;, wk19 &lt;dbl&gt;, wk20 &lt;dbl&gt;, wk21 &lt;dbl&gt;, wk22 &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb341-14" title="14"><span class="co">#&gt; #   wk23 &lt;dbl&gt;, wk24 &lt;dbl&gt;, wk25 &lt;dbl&gt;, wk26 &lt;dbl&gt;, wk27 &lt;dbl&gt;, wk28 &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb341-15" title="15"><span class="co">#&gt; #   wk29 &lt;dbl&gt;, wk30 &lt;dbl&gt;, wk31 &lt;dbl&gt;, wk32 &lt;dbl&gt;, wk33 &lt;dbl&gt;, wk34 &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb341-16" title="16"><span class="co">#&gt; #   wk35 &lt;dbl&gt;, wk36 &lt;dbl&gt;, wk37 &lt;dbl&gt;, wk38 &lt;dbl&gt;, wk39 &lt;dbl&gt;, wk40 &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb341-17" title="17"><span class="co">#&gt; #   wk41 &lt;dbl&gt;, wk42 &lt;dbl&gt;, wk43 &lt;dbl&gt;, wk44 &lt;dbl&gt;, wk45 &lt;dbl&gt;, wk46 &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb341-18" title="18"><span class="co">#&gt; #   wk47 &lt;dbl&gt;, wk48 &lt;dbl&gt;, wk49 &lt;dbl&gt;, wk50 &lt;dbl&gt;, wk51 &lt;dbl&gt;, wk52 &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb341-19" title="19"><span class="co">#&gt; #   wk53 &lt;dbl&gt;, wk54 &lt;dbl&gt;, wk55 &lt;dbl&gt;, wk56 &lt;dbl&gt;, wk57 &lt;dbl&gt;, wk58 &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb341-20" title="20"><span class="co">#&gt; #   wk59 &lt;dbl&gt;, wk60 &lt;dbl&gt;, wk61 &lt;dbl&gt;, wk62 &lt;dbl&gt;, wk63 &lt;dbl&gt;, wk64 &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb341-21" title="21"><span class="co">#&gt; #   wk65 &lt;dbl&gt;, wk66 &lt;lgl&gt;, wk67 &lt;lgl&gt;, wk68 &lt;lgl&gt;, wk69 &lt;lgl&gt;, wk70 &lt;lgl&gt;,</span></a>
<a class="sourceLine" id="cb341-22" title="22"><span class="co">#&gt; #   wk71 &lt;lgl&gt;, wk72 &lt;lgl&gt;, wk73 &lt;lgl&gt;, wk74 &lt;lgl&gt;, wk75 &lt;lgl&gt;, wk76 &lt;lgl&gt;</span></a></code></pre></div>
<p>显然，我们希望将所有以 <code>"wk"</code>开头的列聚合以得到整洁数据，键列和值列分别命名为 “week” 和 “rank”。另外要考虑的一点是，我们很可能之后想计算歌曲保持在榜单上的周数，故需要将 “week” 列转换为数值类型：</p>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb342-1" title="1">billboard_tidy &lt;-<span class="st"> </span>billboard <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb342-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="dt">cols =</span> <span class="kw">starts_with</span>(<span class="st">&quot;wk&quot;</span>),</a>
<a class="sourceLine" id="cb342-3" title="3">               <span class="dt">names_to =</span> <span class="st">&quot;week&quot;</span>,</a>
<a class="sourceLine" id="cb342-4" title="4">               <span class="dt">values_to =</span> <span class="st">&quot;rank&quot;</span>,</a>
<a class="sourceLine" id="cb342-5" title="5">               <span class="dt">names_prefix =</span> <span class="st">&quot;wk&quot;</span>,</a>
<a class="sourceLine" id="cb342-6" title="6">               <span class="dt">names_ptypes =</span> <span class="kw">list</span>(<span class="dt">week =</span> <span class="kw">integer</span>()),</a>
<a class="sourceLine" id="cb342-7" title="7">               <span class="dt">values_drop_na =</span> T)</a>
<a class="sourceLine" id="cb342-8" title="8">billboard_tidy</a>
<a class="sourceLine" id="cb342-9" title="9"><span class="co">#&gt; # A tibble: 5,307 x 5</span></a>
<a class="sourceLine" id="cb342-10" title="10"><span class="co">#&gt;   artist track                   date.entered  week  rank</span></a>
<a class="sourceLine" id="cb342-11" title="11"><span class="co">#&gt;   &lt;chr&gt;  &lt;chr&gt;                   &lt;date&gt;       &lt;int&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb342-12" title="12"><span class="co">#&gt; 1 2 Pac  Baby Don&#39;t Cry (Keep... 2000-02-26       1    87</span></a>
<a class="sourceLine" id="cb342-13" title="13"><span class="co">#&gt; 2 2 Pac  Baby Don&#39;t Cry (Keep... 2000-02-26       2    82</span></a>
<a class="sourceLine" id="cb342-14" title="14"><span class="co">#&gt; 3 2 Pac  Baby Don&#39;t Cry (Keep... 2000-02-26       3    72</span></a>
<a class="sourceLine" id="cb342-15" title="15"><span class="co">#&gt; 4 2 Pac  Baby Don&#39;t Cry (Keep... 2000-02-26       4    77</span></a>
<a class="sourceLine" id="cb342-16" title="16"><span class="co">#&gt; 5 2 Pac  Baby Don&#39;t Cry (Keep... 2000-02-26       5    87</span></a>
<a class="sourceLine" id="cb342-17" title="17"><span class="co">#&gt; 6 2 Pac  Baby Don&#39;t Cry (Keep... 2000-02-26       6    94</span></a>
<a class="sourceLine" id="cb342-18" title="18"><span class="co">#&gt; # … with 5,301 more rows</span></a></code></pre></div>
<p><code>names_prefix</code> 去除前缀 <code>"wk"</code>，<code>names_ptype</code> 以列表的形式转换键列的数据类型</p>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb343-1" title="1"><span class="co">## 计算保持周数</span></a>
<a class="sourceLine" id="cb343-2" title="2">billboard_tidy <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb343-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(track) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb343-4" title="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">stay =</span> <span class="kw">max</span>(week) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(week) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb343-5" title="5"><span class="st">  </span><span class="kw">arrange</span>(stay)</a>
<a class="sourceLine" id="cb343-6" title="6"><span class="co">#&gt; # A tibble: 316 x 2</span></a>
<a class="sourceLine" id="cb343-7" title="7"><span class="co">#&gt;   track                    stay</span></a>
<a class="sourceLine" id="cb343-8" title="8"><span class="co">#&gt;   &lt;chr&gt;                   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb343-9" title="9"><span class="co">#&gt; 1 Cherchez LaGhost            1</span></a>
<a class="sourceLine" id="cb343-10" title="10"><span class="co">#&gt; 2 No Me Dejes De Quere...     1</span></a>
<a class="sourceLine" id="cb343-11" title="11"><span class="co">#&gt; 3 Souljas                     1</span></a>
<a class="sourceLine" id="cb343-12" title="12"><span class="co">#&gt; 4 Toca&#39;s Miracle              1</span></a>
<a class="sourceLine" id="cb343-13" title="13"><span class="co">#&gt; 5 Deck The Halls              2</span></a>
<a class="sourceLine" id="cb343-14" title="14"><span class="co">#&gt; 6 Got Beef                    2</span></a>
<a class="sourceLine" id="cb343-15" title="15"><span class="co">#&gt; # … with 310 more rows</span></a></code></pre></div>
<hr />
<p><strong>Many variables in column names</strong></p>
<p><code>pivot_longer()</code> 现在可以方便地拆分键列，之前曾处理过 <code>who</code> 数据集：</p>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb344-1" title="1">who</a>
<a class="sourceLine" id="cb344-2" title="2"><span class="co">#&gt; # A tibble: 7,240 x 60</span></a>
<a class="sourceLine" id="cb344-3" title="3"><span class="co">#&gt;   country iso2  iso3   year new_sp_m014 new_sp_m1524 new_sp_m2534 new_sp_m3544</span></a>
<a class="sourceLine" id="cb344-4" title="4"><span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;int&gt;       &lt;int&gt;        &lt;int&gt;        &lt;int&gt;        &lt;int&gt;</span></a>
<a class="sourceLine" id="cb344-5" title="5"><span class="co">#&gt; 1 Afghan… AF    AFG    1980          NA           NA           NA           NA</span></a>
<a class="sourceLine" id="cb344-6" title="6"><span class="co">#&gt; 2 Afghan… AF    AFG    1981          NA           NA           NA           NA</span></a>
<a class="sourceLine" id="cb344-7" title="7"><span class="co">#&gt; 3 Afghan… AF    AFG    1982          NA           NA           NA           NA</span></a>
<a class="sourceLine" id="cb344-8" title="8"><span class="co">#&gt; 4 Afghan… AF    AFG    1983          NA           NA           NA           NA</span></a>
<a class="sourceLine" id="cb344-9" title="9"><span class="co">#&gt; 5 Afghan… AF    AFG    1984          NA           NA           NA           NA</span></a>
<a class="sourceLine" id="cb344-10" title="10"><span class="co">#&gt; 6 Afghan… AF    AFG    1985          NA           NA           NA           NA</span></a>
<a class="sourceLine" id="cb344-11" title="11"><span class="co">#&gt; # … with 7,234 more rows, and 52 more variables: new_sp_m4554 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-12" title="12"><span class="co">#&gt; #   new_sp_m5564 &lt;int&gt;, new_sp_m65 &lt;int&gt;, new_sp_f014 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-13" title="13"><span class="co">#&gt; #   new_sp_f1524 &lt;int&gt;, new_sp_f2534 &lt;int&gt;, new_sp_f3544 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-14" title="14"><span class="co">#&gt; #   new_sp_f4554 &lt;int&gt;, new_sp_f5564 &lt;int&gt;, new_sp_f65 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-15" title="15"><span class="co">#&gt; #   new_sn_m014 &lt;int&gt;, new_sn_m1524 &lt;int&gt;, new_sn_m2534 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-16" title="16"><span class="co">#&gt; #   new_sn_m3544 &lt;int&gt;, new_sn_m4554 &lt;int&gt;, new_sn_m5564 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-17" title="17"><span class="co">#&gt; #   new_sn_m65 &lt;int&gt;, new_sn_f014 &lt;int&gt;, new_sn_f1524 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-18" title="18"><span class="co">#&gt; #   new_sn_f2534 &lt;int&gt;, new_sn_f3544 &lt;int&gt;, new_sn_f4554 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-19" title="19"><span class="co">#&gt; #   new_sn_f5564 &lt;int&gt;, new_sn_f65 &lt;int&gt;, new_ep_m014 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-20" title="20"><span class="co">#&gt; #   new_ep_m1524 &lt;int&gt;, new_ep_m2534 &lt;int&gt;, new_ep_m3544 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-21" title="21"><span class="co">#&gt; #   new_ep_m4554 &lt;int&gt;, new_ep_m5564 &lt;int&gt;, new_ep_m65 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-22" title="22"><span class="co">#&gt; #   new_ep_f014 &lt;int&gt;, new_ep_f1524 &lt;int&gt;, new_ep_f2534 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-23" title="23"><span class="co">#&gt; #   new_ep_f3544 &lt;int&gt;, new_ep_f4554 &lt;int&gt;, new_ep_f5564 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-24" title="24"><span class="co">#&gt; #   new_ep_f65 &lt;int&gt;, newrel_m014 &lt;int&gt;, newrel_m1524 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-25" title="25"><span class="co">#&gt; #   newrel_m2534 &lt;int&gt;, newrel_m3544 &lt;int&gt;, newrel_m4554 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-26" title="26"><span class="co">#&gt; #   newrel_m5564 &lt;int&gt;, newrel_m65 &lt;int&gt;, newrel_f014 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-27" title="27"><span class="co">#&gt; #   newrel_f1524 &lt;int&gt;, newrel_f2534 &lt;int&gt;, newrel_f3544 &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb344-28" title="28"><span class="co">#&gt; #   newrel_f4554 &lt;int&gt;, newrel_f5564 &lt;int&gt;, newrel_f65 &lt;int&gt;</span></a>
<a class="sourceLine" id="cb344-29" title="29"></a>
<a class="sourceLine" id="cb344-30" title="30"><span class="co">## tidyr 一章中使用的方法</span></a>
<a class="sourceLine" id="cb344-31" title="31">who <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb344-32" title="32"><span class="st">  </span><span class="kw">gather</span>(<span class="kw">starts_with</span>(<span class="st">&quot;new&quot;</span>), </a>
<a class="sourceLine" id="cb344-33" title="33">         <span class="dt">key =</span> key, </a>
<a class="sourceLine" id="cb344-34" title="34">         <span class="dt">value =</span> value,</a>
<a class="sourceLine" id="cb344-35" title="35">         <span class="dt">na.rm =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb344-36" title="36"><span class="st">  </span><span class="kw">extract</span>(key,</a>
<a class="sourceLine" id="cb344-37" title="37">          <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;diagnosis&quot;</span>, <span class="st">&quot;gender&quot;</span>, <span class="st">&quot;age&quot;</span>),</a>
<a class="sourceLine" id="cb344-38" title="38">          <span class="dt">regex =</span> <span class="st">&quot;new_?(.*)_(.)(.*)&quot;</span>)</a>
<a class="sourceLine" id="cb344-39" title="39"><span class="co">#&gt; # A tibble: 76,046 x 8</span></a>
<a class="sourceLine" id="cb344-40" title="40"><span class="co">#&gt;   country     iso2  iso3   year diagnosis gender age   value</span></a>
<a class="sourceLine" id="cb344-41" title="41"><span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;  &lt;chr&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb344-42" title="42"><span class="co">#&gt; 1 Afghanistan AF    AFG    1997 sp        m      014       0</span></a>
<a class="sourceLine" id="cb344-43" title="43"><span class="co">#&gt; 2 Afghanistan AF    AFG    1998 sp        m      014      30</span></a>
<a class="sourceLine" id="cb344-44" title="44"><span class="co">#&gt; 3 Afghanistan AF    AFG    1999 sp        m      014       8</span></a>
<a class="sourceLine" id="cb344-45" title="45"><span class="co">#&gt; 4 Afghanistan AF    AFG    2000 sp        m      014      52</span></a>
<a class="sourceLine" id="cb344-46" title="46"><span class="co">#&gt; 5 Afghanistan AF    AFG    2001 sp        m      014     129</span></a>
<a class="sourceLine" id="cb344-47" title="47"><span class="co">#&gt; 6 Afghanistan AF    AFG    2002 sp        m      014      90</span></a>
<a class="sourceLine" id="cb344-48" title="48"><span class="co">#&gt; # … with 7.604e+04 more rows</span></a></code></pre></div>
<p>由于聚合后的键列包含了多个变量，还要再用一次 <code>extract()</code> 使之分离，现在可以直接在 <code>names_to</code> 中传入一个向量表示分裂后的各个键列，并在 <code>names_pattern</code> 中用正则表达式指定分裂的模式：</p>
<div class="sourceCode" id="cb345"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb345-1" title="1">who <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb345-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="dt">cols =</span> <span class="kw">starts_with</span>(<span class="st">&quot;new&quot;</span>),</a>
<a class="sourceLine" id="cb345-3" title="3">               <span class="dt">names_to =</span> <span class="kw">c</span>(<span class="st">&quot;diagonosis&quot;</span>, <span class="st">&quot;gender&quot;</span>, <span class="st">&quot;age&quot;</span>),</a>
<a class="sourceLine" id="cb345-4" title="4">               <span class="dt">names_pattern =</span> <span class="st">&quot;new_?(.*)_(.)(.*)&quot;</span>,</a>
<a class="sourceLine" id="cb345-5" title="5">               <span class="dt">values_to =</span> <span class="st">&quot;count&quot;</span>,</a>
<a class="sourceLine" id="cb345-6" title="6">               <span class="dt">values_drop_na =</span> T)</a>
<a class="sourceLine" id="cb345-7" title="7"><span class="co">#&gt; # A tibble: 76,046 x 8</span></a>
<a class="sourceLine" id="cb345-8" title="8"><span class="co">#&gt;   country     iso2  iso3   year diagonosis gender age   count</span></a>
<a class="sourceLine" id="cb345-9" title="9"><span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb345-10" title="10"><span class="co">#&gt; 1 Afghanistan AF    AFG    1997 sp         m      014       0</span></a>
<a class="sourceLine" id="cb345-11" title="11"><span class="co">#&gt; 2 Afghanistan AF    AFG    1997 sp         m      1524     10</span></a>
<a class="sourceLine" id="cb345-12" title="12"><span class="co">#&gt; 3 Afghanistan AF    AFG    1997 sp         m      2534      6</span></a>
<a class="sourceLine" id="cb345-13" title="13"><span class="co">#&gt; 4 Afghanistan AF    AFG    1997 sp         m      3544      3</span></a>
<a class="sourceLine" id="cb345-14" title="14"><span class="co">#&gt; 5 Afghanistan AF    AFG    1997 sp         m      4554      5</span></a>
<a class="sourceLine" id="cb345-15" title="15"><span class="co">#&gt; 6 Afghanistan AF    AFG    1997 sp         m      5564      2</span></a>
<a class="sourceLine" id="cb345-16" title="16"><span class="co">#&gt; # … with 7.604e+04 more rows</span></a></code></pre></div>
<p>更进一步，顺便设定好整理后 <code>gender</code> 和 <code>age</code> 的类型：</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb346-1" title="1">who <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb346-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="dt">cols =</span> <span class="kw">starts_with</span>(<span class="st">&quot;new&quot;</span>),</a>
<a class="sourceLine" id="cb346-3" title="3">               <span class="dt">names_to =</span> <span class="kw">c</span>(<span class="st">&quot;diagonosis&quot;</span>, <span class="st">&quot;gender&quot;</span>, <span class="st">&quot;age&quot;</span>),</a>
<a class="sourceLine" id="cb346-4" title="4">               <span class="dt">names_pattern =</span> <span class="st">&quot;new_?(.*)_(.)(.*)&quot;</span>,</a>
<a class="sourceLine" id="cb346-5" title="5">               <span class="dt">names_ptypes =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb346-6" title="6">                 <span class="dt">gender =</span> <span class="kw">factor</span>(<span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;f&quot;</span>, <span class="st">&quot;m&quot;</span>)),</a>
<a class="sourceLine" id="cb346-7" title="7">                 <span class="dt">age =</span> <span class="kw">factor</span>(</a>
<a class="sourceLine" id="cb346-8" title="8">                        <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;014&quot;</span>, <span class="st">&quot;1524&quot;</span>, <span class="st">&quot;2534&quot;</span>, <span class="st">&quot;3544&quot;</span>, <span class="st">&quot;4554&quot;</span>, <span class="st">&quot;5564&quot;</span>, <span class="st">&quot;65&quot;</span>), </a>
<a class="sourceLine" id="cb346-9" title="9">                        <span class="dt">ordered =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb346-10" title="10">               ),</a>
<a class="sourceLine" id="cb346-11" title="11">               <span class="dt">values_to =</span> <span class="st">&quot;count&quot;</span>,</a>
<a class="sourceLine" id="cb346-12" title="12">               <span class="dt">values_drop_na =</span> T)</a>
<a class="sourceLine" id="cb346-13" title="13"><span class="co">#&gt; # A tibble: 76,046 x 8</span></a>
<a class="sourceLine" id="cb346-14" title="14"><span class="co">#&gt;   country     iso2  iso3   year diagonosis gender age   count</span></a>
<a class="sourceLine" id="cb346-15" title="15"><span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt;      &lt;fct&gt;  &lt;ord&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb346-16" title="16"><span class="co">#&gt; 1 Afghanistan AF    AFG    1997 sp         m      014       0</span></a>
<a class="sourceLine" id="cb346-17" title="17"><span class="co">#&gt; 2 Afghanistan AF    AFG    1997 sp         m      1524     10</span></a>
<a class="sourceLine" id="cb346-18" title="18"><span class="co">#&gt; 3 Afghanistan AF    AFG    1997 sp         m      2534      6</span></a>
<a class="sourceLine" id="cb346-19" title="19"><span class="co">#&gt; 4 Afghanistan AF    AFG    1997 sp         m      3544      3</span></a>
<a class="sourceLine" id="cb346-20" title="20"><span class="co">#&gt; 5 Afghanistan AF    AFG    1997 sp         m      4554      5</span></a>
<a class="sourceLine" id="cb346-21" title="21"><span class="co">#&gt; 6 Afghanistan AF    AFG    1997 sp         m      5564      2</span></a>
<a class="sourceLine" id="cb346-22" title="22"><span class="co">#&gt; # … with 7.604e+04 more rows</span></a></code></pre></div>
<hr />
<p><strong>Multiple observations per row</strong></p>
<p>(多个值列)</p>
<p>So far, we have been working with data frames that have one observation per row, but many important pivotting problems involve multiple observations per row. You can usually recognise this case because <strong>name of the column that you want to appear in the output is part of the column name in the input</strong>. In this section, you’ll learn how to pivot this sort of data.</p>
<div class="sourceCode" id="cb347"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb347-1" title="1">family &lt;-<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb347-2" title="2">  <span class="op">~</span>family,  <span class="op">~</span>dob_child1,  <span class="op">~</span>dob_child2, <span class="op">~</span>gender_child1, <span class="op">~</span>gender_child2,</a>
<a class="sourceLine" id="cb347-3" title="3">       1L, <span class="st">&quot;1998-11-26&quot;</span>, <span class="st">&quot;2000-01-29&quot;</span>,             1L,             2L,</a>
<a class="sourceLine" id="cb347-4" title="4">       2L, <span class="st">&quot;1996-06-22&quot;</span>,           <span class="ot">NA</span>,             2L,             <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb347-5" title="5">       3L, <span class="st">&quot;2002-07-11&quot;</span>, <span class="st">&quot;2004-04-05&quot;</span>,             2L,             2L,</a>
<a class="sourceLine" id="cb347-6" title="6">       4L, <span class="st">&quot;2004-10-10&quot;</span>, <span class="st">&quot;2009-08-27&quot;</span>,             1L,             1L,</a>
<a class="sourceLine" id="cb347-7" title="7">       5L, <span class="st">&quot;2000-12-05&quot;</span>, <span class="st">&quot;2005-02-28&quot;</span>,             2L,             1L,</a>
<a class="sourceLine" id="cb347-8" title="8">)</a>
<a class="sourceLine" id="cb347-9" title="9">family &lt;-<span class="st"> </span>family <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">&quot;dob&quot;</span>)), parse_date)</a>
<a class="sourceLine" id="cb347-10" title="10">family</a>
<a class="sourceLine" id="cb347-11" title="11"><span class="co">#&gt; # A tibble: 5 x 5</span></a>
<a class="sourceLine" id="cb347-12" title="12"><span class="co">#&gt;   family dob_child1 dob_child2 gender_child1 gender_child2</span></a>
<a class="sourceLine" id="cb347-13" title="13"><span class="co">#&gt;    &lt;int&gt; &lt;date&gt;     &lt;date&gt;             &lt;int&gt;         &lt;int&gt;</span></a>
<a class="sourceLine" id="cb347-14" title="14"><span class="co">#&gt; 1      1 1998-11-26 2000-01-29             1             2</span></a>
<a class="sourceLine" id="cb347-15" title="15"><span class="co">#&gt; 2      2 1996-06-22 NA                     2            NA</span></a>
<a class="sourceLine" id="cb347-16" title="16"><span class="co">#&gt; 3      3 2002-07-11 2004-04-05             2             2</span></a>
<a class="sourceLine" id="cb347-17" title="17"><span class="co">#&gt; 4      4 2004-10-10 2009-08-27             1             1</span></a>
<a class="sourceLine" id="cb347-18" title="18"><span class="co">#&gt; 5      5 2000-12-05 2005-02-28             2             1</span></a></code></pre></div>
<p>理想中的数据格式</p>
<table>
<thead>
<tr class="header">
<th align="center">family</th>
<th align="center">child</th>
<th align="center">dob</th>
<th align="center">gender</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1998-11-26</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">2</td>
<td align="center">2000-01-29</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">1</td>
<td align="center">1996-06-22</td>
<td align="center">2</td>
</tr>
<tr class="even">
<td align="center">3</td>
<td align="center">1</td>
<td align="center">2002-07-11</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="center">3</td>
<td align="center">2</td>
<td align="center">2004-04-05</td>
<td align="center">2</td>
</tr>
<tr class="even">
<td align="center">4</td>
<td align="center">1</td>
<td align="center">2004-10-10</td>
<td align="center">1</td>
</tr>
<tr class="odd">
<td align="center">4</td>
<td align="center">2</td>
<td align="center">2009-08-27</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">5</td>
<td align="center">1</td>
<td align="center">2000-12-05</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="center">5</td>
<td align="center">2</td>
<td align="center">2005-02-28</td>
<td align="center">1</td>
</tr>
</tbody>
</table>
<p>Note that we have two pieces of information (or values) for each child: their <code>gender and</code> their <code>dob</code> (date of birth). These need to go into separate columns in the result. Again we supply multiple variables to <code>names_to</code>, using <code>names_sep</code> to split up each variable name. Note the special name <code>.value</code>: this tells <code>pivot_longer()</code> that that part of the column name specifies the “value” being measured (which will become a variable in the output)</p>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb348-1" title="1">family <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb348-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(</a>
<a class="sourceLine" id="cb348-3" title="3">    <span class="op">-</span>family, </a>
<a class="sourceLine" id="cb348-4" title="4">    <span class="dt">names_to =</span> <span class="kw">c</span>(<span class="st">&quot;.value&quot;</span>, <span class="st">&quot;child&quot;</span>),   <span class="co">## child 为每个 family 中的标识变量</span></a>
<a class="sourceLine" id="cb348-5" title="5">    <span class="dt">names_sep =</span> <span class="st">&quot;_&quot;</span>, </a>
<a class="sourceLine" id="cb348-6" title="6">    <span class="dt">values_drop_na =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb348-7" title="7">  )</a>
<a class="sourceLine" id="cb348-8" title="8"><span class="co">#&gt; # A tibble: 9 x 4</span></a>
<a class="sourceLine" id="cb348-9" title="9"><span class="co">#&gt;   family child  dob        gender</span></a>
<a class="sourceLine" id="cb348-10" title="10"><span class="co">#&gt;    &lt;int&gt; &lt;chr&gt;  &lt;date&gt;      &lt;int&gt;</span></a>
<a class="sourceLine" id="cb348-11" title="11"><span class="co">#&gt; 1      1 child1 1998-11-26      1</span></a>
<a class="sourceLine" id="cb348-12" title="12"><span class="co">#&gt; 2      1 child2 2000-01-29      2</span></a>
<a class="sourceLine" id="cb348-13" title="13"><span class="co">#&gt; 3      2 child1 1996-06-22      2</span></a>
<a class="sourceLine" id="cb348-14" title="14"><span class="co">#&gt; 4      3 child1 2002-07-11      2</span></a>
<a class="sourceLine" id="cb348-15" title="15"><span class="co">#&gt; 5      3 child2 2004-04-05      2</span></a>
<a class="sourceLine" id="cb348-16" title="16"><span class="co">#&gt; 6      4 child1 2004-10-10      1</span></a>
<a class="sourceLine" id="cb348-17" title="17"><span class="co">#&gt; # … with 3 more rows</span></a></code></pre></div>
<p>在这里，<code>dob_child1</code>、<code>dob_child2</code>、<code>gender_child1</code>、<code>gender_child2</code>四个列名的<strong>后半部分</strong>被当做键列的值。例如，可以认为对于 <code>family == 1</code>的观测，首先生成了如下的结构：</p>
<table>
<thead>
<tr class="header">
<th align="center">family</th>
<th align="center">child</th>
<th align="center">dob</th>
<th align="center">dob</th>
<th align="center">gender</th>
<th align="center">gender</th>
<th align="center"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">child1</td>
<td align="center">1998-11-16</td>
<td align="center">2000-01-29</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">child2</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody>
</table>
<p>而后名称相同的值列合并：</p>
<table>
<thead>
<tr class="header">
<th align="center">family</th>
<th align="center">child</th>
<th align="center">dob</th>
<th align="center">gender</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">child1</td>
<td align="center">1998-11-26</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">child2</td>
<td align="center">2000-01-29</td>
<td align="center">2</td>
</tr>
</tbody>
</table>
<p>另一个例子：</p>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb349-1" title="1">anscombe </a>
<a class="sourceLine" id="cb349-2" title="2"><span class="co">#&gt;    x1 x2 x3 x4    y1   y2    y3    y4</span></a>
<a class="sourceLine" id="cb349-3" title="3"><span class="co">#&gt; 1  10 10 10  8  8.04 9.14  7.46  6.58</span></a>
<a class="sourceLine" id="cb349-4" title="4"><span class="co">#&gt; 2   8  8  8  8  6.95 8.14  6.77  5.76</span></a>
<a class="sourceLine" id="cb349-5" title="5"><span class="co">#&gt; 3  13 13 13  8  7.58 8.74 12.74  7.71</span></a>
<a class="sourceLine" id="cb349-6" title="6"><span class="co">#&gt; 4   9  9  9  8  8.81 8.77  7.11  8.84</span></a>
<a class="sourceLine" id="cb349-7" title="7"><span class="co">#&gt; 5  11 11 11  8  8.33 9.26  7.81  8.47</span></a>
<a class="sourceLine" id="cb349-8" title="8"><span class="co">#&gt; 6  14 14 14  8  9.96 8.10  8.84  7.04</span></a>
<a class="sourceLine" id="cb349-9" title="9"><span class="co">#&gt; 7   6  6  6  8  7.24 6.13  6.08  5.25</span></a>
<a class="sourceLine" id="cb349-10" title="10"><span class="co">#&gt; 8   4  4  4 19  4.26 3.10  5.39 12.50</span></a>
<a class="sourceLine" id="cb349-11" title="11"><span class="co">#&gt; 9  12 12 12  8 10.84 9.13  8.15  5.56</span></a>
<a class="sourceLine" id="cb349-12" title="12"><span class="co">#&gt; 10  7  7  7  8  4.82 7.26  6.42  7.91</span></a>
<a class="sourceLine" id="cb349-13" title="13"><span class="co">#&gt; 11  5  5  5  8  5.68 4.74  5.73  6.89</span></a>
<a class="sourceLine" id="cb349-14" title="14"></a>
<a class="sourceLine" id="cb349-15" title="15">anscombe <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb349-16" title="16"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">everything</span>(),</a>
<a class="sourceLine" id="cb349-17" title="17">               <span class="dt">names_to =</span> <span class="kw">c</span>(<span class="st">&quot;.value&quot;</span>, <span class="st">&quot;set&quot;</span>),</a>
<a class="sourceLine" id="cb349-18" title="18">               <span class="dt">names_pattern =</span> <span class="st">&quot;([xy])([1234])&quot;</span>)</a>
<a class="sourceLine" id="cb349-19" title="19"><span class="co">#&gt; # A tibble: 44 x 3</span></a>
<a class="sourceLine" id="cb349-20" title="20"><span class="co">#&gt;   set       x     y</span></a>
<a class="sourceLine" id="cb349-21" title="21"><span class="co">#&gt;   &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb349-22" title="22"><span class="co">#&gt; 1 1        10  8.04</span></a>
<a class="sourceLine" id="cb349-23" title="23"><span class="co">#&gt; 2 2        10  9.14</span></a>
<a class="sourceLine" id="cb349-24" title="24"><span class="co">#&gt; 3 3        10  7.46</span></a>
<a class="sourceLine" id="cb349-25" title="25"><span class="co">#&gt; 4 4         8  6.58</span></a>
<a class="sourceLine" id="cb349-26" title="26"><span class="co">#&gt; 5 1         8  6.95</span></a>
<a class="sourceLine" id="cb349-27" title="27"><span class="co">#&gt; 6 2         8  8.14</span></a>
<a class="sourceLine" id="cb349-28" title="28"><span class="co">#&gt; # … with 38 more rows</span></a></code></pre></div>
<p>叕一个例子：</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb350-1" title="1">pnl &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb350-2" title="2">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>,</a>
<a class="sourceLine" id="cb350-3" title="3">  <span class="dt">a =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>,<span class="dv">0</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb350-4" title="4">  <span class="dt">b =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb350-5" title="5">  <span class="dt">y1 =</span> <span class="kw">rnorm</span>(<span class="dv">4</span>),</a>
<a class="sourceLine" id="cb350-6" title="6">  <span class="dt">y2 =</span> <span class="kw">rnorm</span>(<span class="dv">4</span>),</a>
<a class="sourceLine" id="cb350-7" title="7">  <span class="dt">z1 =</span> <span class="kw">rep</span>(<span class="dv">3</span>, <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb350-8" title="8">  <span class="dt">z2 =</span> <span class="kw">rep</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb350-9" title="9">)</a>
<a class="sourceLine" id="cb350-10" title="10">pnl</a>
<a class="sourceLine" id="cb350-11" title="11"><span class="co">#&gt; # A tibble: 4 x 7</span></a>
<a class="sourceLine" id="cb350-12" title="12"><span class="co">#&gt;       x     a     b      y1     y2    z1    z2</span></a>
<a class="sourceLine" id="cb350-13" title="13"><span class="co">#&gt;   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb350-14" title="14"><span class="co">#&gt; 1     1     1     0  0.788  -1.59      3    -2</span></a>
<a class="sourceLine" id="cb350-15" title="15"><span class="co">#&gt; 2     2     1     1 -0.422   0.597     3    -2</span></a>
<a class="sourceLine" id="cb350-16" title="16"><span class="co">#&gt; 3     3     0     1  0.0569  1.22      3    -2</span></a>
<a class="sourceLine" id="cb350-17" title="17"><span class="co">#&gt; 4     4     0     1  0.711  -0.312     3    -2</span></a></code></pre></div>
<div class="sourceCode" id="cb351"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb351-1" title="1">pnl <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb351-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>(x<span class="op">:</span>b),</a>
<a class="sourceLine" id="cb351-3" title="3">               <span class="dt">names_to =</span> <span class="kw">c</span>(<span class="st">&quot;.value&quot;</span>, <span class="st">&quot;time&quot;</span>),</a>
<a class="sourceLine" id="cb351-4" title="4">               <span class="dt">names_pattern =</span> <span class="st">&quot;([yz])([12])&quot;</span>)</a>
<a class="sourceLine" id="cb351-5" title="5"><span class="co">#&gt; # A tibble: 8 x 6</span></a>
<a class="sourceLine" id="cb351-6" title="6"><span class="co">#&gt;       x     a     b time        y     z</span></a>
<a class="sourceLine" id="cb351-7" title="7"><span class="co">#&gt;   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb351-8" title="8"><span class="co">#&gt; 1     1     1     0 1      0.788      3</span></a>
<a class="sourceLine" id="cb351-9" title="9"><span class="co">#&gt; 2     1     1     0 2     -1.59      -2</span></a>
<a class="sourceLine" id="cb351-10" title="10"><span class="co">#&gt; 3     2     1     1 1     -0.422      3</span></a>
<a class="sourceLine" id="cb351-11" title="11"><span class="co">#&gt; 4     2     1     1 2      0.597     -2</span></a>
<a class="sourceLine" id="cb351-12" title="12"><span class="co">#&gt; 5     3     0     1 1      0.0569     3</span></a>
<a class="sourceLine" id="cb351-13" title="13"><span class="co">#&gt; 6     3     0     1 2      1.22      -2</span></a>
<a class="sourceLine" id="cb351-14" title="14"><span class="co">#&gt; # … with 2 more rows</span></a></code></pre></div>
<hr />
<p><strong>Duplicated column names</strong></p>
<p>如果某个数据框中的变量有重复的名字，用 <code>gather()</code>聚合这些变量所在的列时会返回一条错误：</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb352-1" title="1">Error<span class="op">:</span><span class="st"> </span>Can<span class="st">&#39;t bind data because some arguments have the same name</span></a></code></pre></div>
<p>这是因为被聚合的列名被当做 <code>key</code> 列的值，又因这些值是重复的，故不能唯一标识一条记录。<code>pivot_longer</code> 针对这一点做了优化，尝试聚合这些列时，会自动生成一个标识列：</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb353-1" title="1"><span class="co">#  To create a tibble with duplicated names</span></a>
<a class="sourceLine" id="cb353-2" title="2"><span class="co"># you have to explicitly opt out of the name repair </span></a>
<a class="sourceLine" id="cb353-3" title="3"><span class="co"># that usually prevents you from creating such a dataset:</span></a>
<a class="sourceLine" id="cb353-4" title="4"></a>
<a class="sourceLine" id="cb353-5" title="5">df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">y =</span> <span class="dv">4</span><span class="op">:</span><span class="dv">6</span>, <span class="dt">y =</span> <span class="dv">5</span><span class="op">:</span><span class="dv">7</span>, <span class="dt">y =</span> <span class="dv">7</span><span class="op">:</span><span class="dv">9</span>, <span class="dt">.name_repair =</span> <span class="st">&quot;minimal&quot;</span>) </a>
<a class="sourceLine" id="cb353-6" title="6">df</a>
<a class="sourceLine" id="cb353-7" title="7"><span class="co">#&gt; # A tibble: 3 x 4</span></a>
<a class="sourceLine" id="cb353-8" title="8"><span class="co">#&gt;       x     y     y     y</span></a>
<a class="sourceLine" id="cb353-9" title="9"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb353-10" title="10"><span class="co">#&gt; 1     1     4     5     7</span></a>
<a class="sourceLine" id="cb353-11" title="11"><span class="co">#&gt; 2     2     5     6     8</span></a>
<a class="sourceLine" id="cb353-12" title="12"><span class="co">#&gt; 3     3     6     7     9</span></a></code></pre></div>
<div class="sourceCode" id="cb354"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb354-1" title="1">df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb354-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>x, <span class="dt">names_to =</span> <span class="st">&quot;y&quot;</span>)</a>
<a class="sourceLine" id="cb354-3" title="3"><span class="co">#&gt; # A tibble: 9 x 4</span></a>
<a class="sourceLine" id="cb354-4" title="4"><span class="co">#&gt;       x y     .copy value</span></a>
<a class="sourceLine" id="cb354-5" title="5"><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb354-6" title="6"><span class="co">#&gt; 1     1 y         1     4</span></a>
<a class="sourceLine" id="cb354-7" title="7"><span class="co">#&gt; 2     1 y         2     5</span></a>
<a class="sourceLine" id="cb354-8" title="8"><span class="co">#&gt; 3     1 y         3     7</span></a>
<a class="sourceLine" id="cb354-9" title="9"><span class="co">#&gt; 4     2 y         1     5</span></a>
<a class="sourceLine" id="cb354-10" title="10"><span class="co">#&gt; 5     2 y         2     6</span></a>
<a class="sourceLine" id="cb354-11" title="11"><span class="co">#&gt; 6     2 y         3     8</span></a>
<a class="sourceLine" id="cb354-12" title="12"><span class="co">#&gt; # … with 3 more rows</span></a></code></pre></div>
</div>
</div>
<div id="pivot_wider" class="section level3">
<h3><span class="header-section-number">6.7.2</span> <code>pivot_wider()</code></h3>
<p>The <code>fish_encounters</code> dataset, contributed by <a href="https://fishsciences.github.io/post/visualizing-fish-encounter-histories/">Myfanwy Johnston</a>, describes when fish swimming down a river are detected by automatic monitoring stations:</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb355-1" title="1">fish_encounters</a>
<a class="sourceLine" id="cb355-2" title="2"><span class="co">#&gt; # A tibble: 114 x 3</span></a>
<a class="sourceLine" id="cb355-3" title="3"><span class="co">#&gt;   fish  station  seen</span></a>
<a class="sourceLine" id="cb355-4" title="4"><span class="co">#&gt;   &lt;fct&gt; &lt;fct&gt;   &lt;int&gt;</span></a>
<a class="sourceLine" id="cb355-5" title="5"><span class="co">#&gt; 1 4842  Release     1</span></a>
<a class="sourceLine" id="cb355-6" title="6"><span class="co">#&gt; 2 4842  I80_1       1</span></a>
<a class="sourceLine" id="cb355-7" title="7"><span class="co">#&gt; 3 4842  Lisbon      1</span></a>
<a class="sourceLine" id="cb355-8" title="8"><span class="co">#&gt; 4 4842  Rstr        1</span></a>
<a class="sourceLine" id="cb355-9" title="9"><span class="co">#&gt; 5 4842  Base_TD     1</span></a>
<a class="sourceLine" id="cb355-10" title="10"><span class="co">#&gt; 6 4842  BCE         1</span></a>
<a class="sourceLine" id="cb355-11" title="11"><span class="co">#&gt; # … with 108 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb356"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb356-1" title="1">fish_encounters <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb356-2" title="2"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> station,</a>
<a class="sourceLine" id="cb356-3" title="3">              <span class="dt">values_from =</span> seen,</a>
<a class="sourceLine" id="cb356-4" title="4">              )</a>
<a class="sourceLine" id="cb356-5" title="5"><span class="co">#&gt; # A tibble: 19 x 12</span></a>
<a class="sourceLine" id="cb356-6" title="6"><span class="co">#&gt;   fish  Release I80_1 Lisbon  Rstr Base_TD   BCE   BCW  BCE2  BCW2   MAE   MAW</span></a>
<a class="sourceLine" id="cb356-7" title="7"><span class="co">#&gt;   &lt;fct&gt;   &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb356-8" title="8"><span class="co">#&gt; 1 4842        1     1      1     1       1     1     1     1     1     1     1</span></a>
<a class="sourceLine" id="cb356-9" title="9"><span class="co">#&gt; 2 4843        1     1      1     1       1     1     1     1     1     1     1</span></a>
<a class="sourceLine" id="cb356-10" title="10"><span class="co">#&gt; 3 4844        1     1      1     1       1     1     1     1     1     1     1</span></a>
<a class="sourceLine" id="cb356-11" title="11"><span class="co">#&gt; 4 4845        1     1      1     1       1    NA    NA    NA    NA    NA    NA</span></a>
<a class="sourceLine" id="cb356-12" title="12"><span class="co">#&gt; 5 4847        1     1      1    NA      NA    NA    NA    NA    NA    NA    NA</span></a>
<a class="sourceLine" id="cb356-13" title="13"><span class="co">#&gt; 6 4848        1     1      1     1      NA    NA    NA    NA    NA    NA    NA</span></a>
<a class="sourceLine" id="cb356-14" title="14"><span class="co">#&gt; # … with 13 more rows</span></a></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="forcats.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="broom.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/enixam/rfordatascience/edit/master/tidyr.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
