<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>ggplot2 | Qiushi Yan</title>
    <link>/tags/ggplot2/</link>
      <atom:link href="/tags/ggplot2/index.xml" rel="self" type="application/rss+xml" />
    <description>ggplot2</description>
    <generator>Source Themes Academic (https://sourcethemes.com/academic/)</generator><language>en-us</language><copyright>Qiushi Yan © 2019</copyright><lastBuildDate>Fri, 29 Nov 2019 00:00:00 +0000</lastBuildDate>
    <image>
      <url>/img/icon-192.png</url>
      <title>ggplot2</title>
      <link>/tags/ggplot2/</link>
    </image>
    
    <item>
      <title>Reorder within facets: reorder_within</title>
      <link>/post/reorder-varible-within-facets-reorder-within/</link>
      <pubDate>Fri, 29 Nov 2019 00:00:00 +0000</pubDate>
      <guid>/post/reorder-varible-within-facets-reorder-within/</guid>
      <description>


&lt;p&gt;This blog post is inspired by Julia Silge’s &lt;a href=&#34;https://juliasilge.com/blog/reorder-within/&#34;&gt;Reordering and facetting for ggplot2&lt;/a&gt;. By reproducing the original post using another different dataset, I hope this could still shed some light on a handful of ggplot2 tips.&lt;/p&gt;
&lt;div id=&#34;most-common-words-in-jane-austens-books&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Most common words in Jane Austen’s books&lt;/h2&gt;
&lt;p&gt;Here is a simple task: we want to find the top-10 most common words in several Jane Austen’s books, draw a bar graph, and then put them into different facets.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# load package
library(tidyverse)
library(tidytext)
library(janeaustenr)&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;austen_books()
#&amp;gt; # A tibble: 73,422 x 2
#&amp;gt;    text                    book               
#&amp;gt;  * &amp;lt;chr&amp;gt;                   &amp;lt;fct&amp;gt;              
#&amp;gt;  1 &amp;quot;SENSE AND SENSIBILITY&amp;quot; Sense &amp;amp; Sensibility
#&amp;gt;  2 &amp;quot;&amp;quot;                      Sense &amp;amp; Sensibility
#&amp;gt;  3 &amp;quot;by Jane Austen&amp;quot;        Sense &amp;amp; Sensibility
#&amp;gt;  4 &amp;quot;&amp;quot;                      Sense &amp;amp; Sensibility
#&amp;gt;  5 &amp;quot;(1811)&amp;quot;                Sense &amp;amp; Sensibility
#&amp;gt;  6 &amp;quot;&amp;quot;                      Sense &amp;amp; Sensibility
#&amp;gt;  7 &amp;quot;&amp;quot;                      Sense &amp;amp; Sensibility
#&amp;gt;  8 &amp;quot;&amp;quot;                      Sense &amp;amp; Sensibility
#&amp;gt;  9 &amp;quot;&amp;quot;                      Sense &amp;amp; Sensibility
#&amp;gt; 10 &amp;quot;CHAPTER 1&amp;quot;             Sense &amp;amp; Sensibility
#&amp;gt; # … with 73,412 more rows&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note that the raw data generated by calling &lt;code&gt;austen_books()&lt;/code&gt;, provided in the &lt;strong&gt;janeaustenr&lt;/strong&gt; package &lt;span class=&#34;citation&#34;&gt;(Silge &lt;a href=&#34;#ref-R-janeaustenr&#34; role=&#34;doc-biblioref&#34;&gt;2017&lt;/a&gt;)&lt;/span&gt;, is not in its most sensible format for analysis. Since each row is made up of multiple combined words.&lt;/p&gt;
&lt;p&gt;Here we use &lt;code&gt;unnest_tokens&lt;/code&gt; from the &lt;strong&gt;tidytext&lt;/strong&gt; package &lt;span class=&#34;citation&#34;&gt;(Robinson and Silge &lt;a href=&#34;#ref-R-tidytext&#34; role=&#34;doc-biblioref&#34;&gt;2019&lt;/a&gt;)&lt;/span&gt; to break the text into individual tokens and transform it into a tidy structure:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# calculate 10 most common words in each book
common_words &amp;lt;- austen_books() %&amp;gt;%
  unnest_tokens(word, text) %&amp;gt;% 
  anti_join(stop_words) %&amp;gt;% 
  count(book, word) %&amp;gt;% 
  group_by(book) %&amp;gt;% 
  top_n(10)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Take a look at our prepared data:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;common_words
#&amp;gt; # A tibble: 60 x 3
#&amp;gt; # Groups:   book [6]
#&amp;gt;    book                word           n
#&amp;gt;    &amp;lt;fct&amp;gt;               &amp;lt;chr&amp;gt;      &amp;lt;int&amp;gt;
#&amp;gt;  1 Sense &amp;amp; Sensibility dashwood     231
#&amp;gt;  2 Sense &amp;amp; Sensibility edward       220
#&amp;gt;  3 Sense &amp;amp; Sensibility elinor       623
#&amp;gt;  4 Sense &amp;amp; Sensibility jennings     199
#&amp;gt;  5 Sense &amp;amp; Sensibility marianne     492
#&amp;gt;  6 Sense &amp;amp; Sensibility miss         210
#&amp;gt;  7 Sense &amp;amp; Sensibility mother       213
#&amp;gt;  8 Sense &amp;amp; Sensibility sister       229
#&amp;gt;  9 Sense &amp;amp; Sensibility time         239
#&amp;gt; 10 Sense &amp;amp; Sensibility willoughby   181
#&amp;gt; # … with 50 more rows&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For details many and other useful text mining techniques in R, I recommend reading &lt;a href=&#34;Text%20Mining%20with%20R:%20A%20tidy%20approach&#34;&gt;Text mining with R: A tidy approach&lt;/a&gt; by Julia Silge and David Robinson&lt;span class=&#34;citation&#34;&gt;(&lt;a href=&#34;#ref-silge2017text&#34; role=&#34;doc-biblioref&#34;&gt;2017&lt;/a&gt;)&lt;/span&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# plot
common_words %&amp;gt;% 
  ggplot(aes(word, n, fill = book)) +
  geom_col() + 
  coord_flip() + 
  facet_wrap(~ book, ncol = 2, scales = &amp;quot;free_y&amp;quot;) + 
  theme_classic() + 
  theme(legend.position = &amp;quot;none&amp;quot;, 
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 14)) +
  rcartocolor::scale_fill_carto_d(palette = &amp;quot;PurpOr&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2019-11-29-reorder-varible-within-facets-reorder-within_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;In its default setting, &lt;strong&gt;ggplot2&lt;/strong&gt; puts the names in alphabetical order, because they are of type character. One common solution is to use &lt;code&gt;fct_reorder()&lt;/code&gt; or its equivalent &lt;code&gt;reorder()&lt;/code&gt; in baes R`:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;common_words %&amp;gt;% 
  ggplot(aes(fct_reorder(word, n), n, fill = book)) +
  geom_col() + 
  coord_flip() + 
  facet_wrap(~ book, ncol = 2, scales = &amp;quot;free_y&amp;quot;) + 
  theme_classic() + 
  theme(legend.position = &amp;quot;none&amp;quot;, 
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 14)) +
  rcartocolor::scale_fill_carto_d(palette = &amp;quot;PurpOr&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2019-11-29-reorder-varible-within-facets-reorder-within_files/figure-html/unnamed-chunk-7-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Well, our plot improve a bit, but is still wanting in some respects. In each facet, the order of words is not strictly in line with its frequency. In fact, &lt;code&gt;fct_reorder()&lt;/code&gt; or &lt;code&gt;reorder&lt;/code&gt; only reorder all of these together, meaning that &lt;code&gt;word&lt;/code&gt; are reordered in an overall level so that it cannot guarantee order in any specific subset of data.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;reorder_within-and-scale_x_reordered&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;&lt;code&gt;reorder_within()&lt;/code&gt; and &lt;code&gt;scale_x_reordered()&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;The &lt;strong&gt;tidytext&lt;/strong&gt; package provides 2 new functions to reorder a variable on a facet level.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;reorder_within()&lt;/code&gt; takes three arguments:
- &lt;strong&gt;x&lt;/strong&gt;: the item we want to reorder
- &lt;strong&gt;by&lt;/strong&gt;: what we want to reorder by
- &lt;strong&gt;within&lt;/strong&gt;: the groups or categories we want to reorder within&lt;/p&gt;
&lt;p&gt;After that, we use &lt;code&gt;scale_x_reordered()&lt;/code&gt;(or &lt;code&gt;scale_y_reordered()&lt;/code&gt;) to finish the plot, these 2 scales can take any argument in common scale functions(e.g., &lt;strong&gt;name&lt;/strong&gt;, &lt;strong&gt;labels&lt;/strong&gt;, &lt;strong&gt;expand&lt;/strong&gt;).&lt;/p&gt;
&lt;p&gt;Here is a final plot:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# reorder word by n, grouped by book
common_words %&amp;gt;% 
  ggplot(aes(reorder_within(word, n, book), n, fill = book)) +
  geom_col() + 
  coord_flip() + 
  scale_x_reordered() + 
  facet_wrap(~ book, ncol = 2, scales = &amp;quot;free_y&amp;quot;) + 
  theme_classic() + 
  theme(legend.position = &amp;quot;none&amp;quot;, 
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 14)) +
  rcartocolor::scale_fill_carto_d(palette = &amp;quot;PurpOr&amp;quot;) +
  labs(title = &amp;quot;What are the most common words in Jane Austen&amp;#39;s books?&amp;quot;,
       x = NULL,
       y = NULL)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2019-11-29-reorder-varible-within-facets-reorder-within_files/figure-html/unnamed-chunk-8-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Without using &lt;code&gt;scale_x_reordered&lt;/code&gt; to overide ggplot2’s default scale, the label of the reordered variable will carry a suffix related to the group variable, which make its label way too long. Here is an simple example using the &lt;a href=&#34;https://github.com/hadley/babynames&#34;&gt;babynames&lt;/a&gt; data:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(babynames)&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;top_names &amp;lt;- babynames %&amp;gt;% 
  filter(year &amp;gt;= 1950,
           year &amp;lt; 1990) %&amp;gt;% 
  mutate(decade = (year %/% 10) * 10) %&amp;gt;% 
  group_by(decade) %&amp;gt;%
  count(name, wt = n) %&amp;gt;% 
  group_by(decade) %&amp;gt;% 
  top_n(10)

top_names %&amp;gt;% 
  ggplot(aes(reorder_within(name, n, decade), n, fill = factor(decade))) + 
  geom_col() + 
  coord_flip() + 
  facet_wrap(~ decade, scales = &amp;quot;free_y&amp;quot;) + 
  theme(legend.position = &amp;quot;none&amp;quot;) + 
  labs(x = NULL, y = NULL)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2019-11-29-reorder-varible-within-facets-reorder-within_files/figure-html/unnamed-chunk-10-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;references&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;p&gt;Nowosad, J. (2018). ‘CARTOColors’ Palettes. R package version 1.0.0. &lt;a href=&#34;https://nowosad.github.io/rcartocolor&#34; class=&#34;uri&#34;&gt;https://nowosad.github.io/rcartocolor&lt;/a&gt;&lt;/p&gt;
&lt;div id=&#34;refs&#34; class=&#34;references&#34;&gt;
&lt;div id=&#34;ref-R-tidytext&#34;&gt;
&lt;p&gt;Robinson, David, and Julia Silge. 2019. &lt;em&gt;Tidytext: Text Mining Using ’Dplyr’, ’Ggplot2’, and Other Tidy Tools&lt;/em&gt;. &lt;a href=&#34;https://CRAN.R-project.org/package=tidytext&#34;&gt;https://CRAN.R-project.org/package=tidytext&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;ref-R-janeaustenr&#34;&gt;
&lt;p&gt;Silge, Julia. 2017. &lt;em&gt;Janeaustenr: Jane Austen’s Complete Novels&lt;/em&gt;. &lt;a href=&#34;https://CRAN.R-project.org/package=janeaustenr&#34;&gt;https://CRAN.R-project.org/package=janeaustenr&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;ref-silge2017text&#34;&gt;
&lt;p&gt;Silge, Julia, and David Robinson. 2017. &lt;em&gt;Text Mining with R: A Tidy Approach&lt;/em&gt;. &#34; O’Reilly Media, Inc.&#34;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
  </channel>
</rss>
